---
title: 小売チャンネルの引当可能在庫数量の計算
description: このトピックでは、会社が Microsoft Dynamics 365 Commerce を使用して、オンラインおよび店舗チャネルの製品の見積済手持在庫を表示する方法について説明します。
author: hhainesms
ms.date: 04/23/2021
ms.topic: article
ms.prod: ''
ms.technology: ''
audience: Application User
ms.reviewer: v-chgri
ms.custom: ''
ms.assetid: ''
ms.search.region: Global
ms.author: hhaines
ms.search.validFrom: 2020-02-11
ms.dyn365.ops.version: Release 10.0.10
ms.openlocfilehash: 2b6f9663ed08ab431ffc6ffe3154854250c1b092
ms.sourcegitcommit: c08a9d19eed1df03f32442ddb65a2adf1473d3b6
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/06/2021
ms.locfileid: "6350477"
---
# <a name="calculate-inventory-availability-for-retail-channels"></a>小売チャンネルの引当可能在庫数量の計算

[!include [banner](../includes/banner.md)]

このトピックでは、会社が Microsoft Dynamics 365 Commerce を使用して、オンラインおよび店舗チャネルの製品の見積済手持在庫を表示する方法について説明します。

## <a name="accuracy-of-inventory-availability"></a>引当可能在庫数量の正確性

コマースでは、拡張性とパフォーマンスを確保するために複数のサーバーとデータベースを使用します。 したがって、販売時点管理 (POS) アプリケーションによって提供される使用可能な在庫値、E コマースの在庫状態のアプリケーション プログラミング インターフェイス (API)、および手持在庫ページについて理解しておくことが重要です。Commerce 本社では、リアルタイムで 100 パーセントの正確性を達成できない場合があります。 オンラインまたは店舗チャネルの製品に対して作成されたトランザクションが、本社と同期していない場合、本社の手持在庫ページには、これらの製品に対して正確なリアルタイム在庫値が表示されないことがあります。 逆に、本社または他の統合アプリケーションのユーザーが在庫から在庫を引き出したり、返品したり、その他の方法で調整できるように会社をコンフィギュレーションしている場合は、POS またはオンライン チャネルでは、品目に対して正確なリアルタイム値を示すために必要なすべての情報がない場合があります。

営業日に提供されている手持在庫データすべては予測値と見なされていることを理解しておくことは重要です。 したがって、アプリケーションが棚の実在庫によって提供する手持在庫情報を比較しようとした場合や、POS に表示されている手持在庫の値を同じ倉庫を見つける手持在庫の値と比較しようとした場合など、本社では値が異なる場合があります。 営業日中のこの差異は予想されますが、問題とは限りません。 データを監査して、POS、API、および本社で提供されている値が、店舗または倉庫の棚にある実際の物理単位と一致していることを確認する場合、その最適なタイミングは、チャネルの操作がその日に停止し、すべてのトランザクションが本社とチャネル間で正しく同期された後です。

## <a name="channel-side-inventory-calculation"></a>チャネル側の在庫計算

チャネル側の在庫計算は、ベースラインとしての Commerce 本社の最新のチャネル在庫データと、ほぼリアルタイムの手持在庫の見積を計算するためのベースラインに含まれていないチャネルで発生した追加の在庫変更の要素を取得するメカニズムです。 

現在、次の在庫変更はチャネル側の在庫計算ロジックで考慮されます。

- 店舗の現金売りを通して販売された在庫
- 店舗またはオンライン チャネルの顧客注文を通して販売された在庫
- 店舗に返品される在庫
- 店舗倉庫からフルフィルメントされた在庫 (ピッキング、梱包、出荷)

チャネル側の在庫計算を使用するには、前提条件として、**製品の使用可能性** ジョブによって作成された本社の在庫データのスナップショットを定期的にチャネル データベースに送信する必要があります。 このスナップショットは、製品または製品バリアントと倉庫の特定の組み合わせについて、本社が在庫の有無に関して持っている情報を表します。 このトランザクションには、スナップショットの取得の時点で本社で処理および転記された在庫トランザクションだけが含まれるため、分散サーバー間で発生する定数的な販売プロセスにより、リアルタイムでは 100% 正確ではない可能性があります。

- POS アプリケーションで現金払いまたは非同期の顧客注文販売を介して店舗にある製品の在庫が販売された場合、本社ではその販売に関連する在庫払出トランザクションに関する情報を直ちに取得することはありません。 P-ジョブが関連するトランザクションを店舗のチャネル データベースから本社へアップロードした後になって、本社には店舗販売のタイプで販売されている在庫情報が含まれます。関連する販売注文は、明細転記またはトリクル フィード転記のプロセスを介して作成されます。 本社の注文を作成するプロセスによって、関連する在庫トランザクションが作成されます。 
- E コマース チャネル注文では、トランザクションが P-ジョブを通じて本社に送信され、注文の同期処理が完了した後にのみ、在庫トランザクションに関する情報が含まれます。

Commerce 本社で在庫のスナップショットを行うには、次の手順を実行します。

1. **Retail とコマース \> Retail とコマース IT \> 製品と在庫 \> 製品の可用性** の順に移動します。
1. **OK** を選択し、**製品の可用性** ジョブを実行します。 バッチで実行されるように、このジョブをスケジュール設定することもできます。

**製品の可用性** ジョブの実行が完了したら、取得したデータをチャネルのデータベースにプッシュして、最新の本社の在庫スナップショットを、見積済手持在庫のチャネル側計算で考慮する必要があります。

本社からチャネル データベースにスナップショット データを同期するには、次の手順に従います。

1. **Retail とコマース \> Retail とコマース IT \> 配送スケジュール** の順に移動します。
1. **1130** (**製品の可用性**) ジョブを実行し、**製品の可用性** ジョブによって本社からチャネル データベースに作成されたスナップショット データを同期します。

## <a name="inventory-availability-apis-for-e-commerce"></a>E コマースの在庫可用性 API

E コマースのシナリオにおいて製品の引当可能在庫数量のクエリを実行するために、Commerce は次の API を提供します。

- **GetEstimatedAvailability** – この API を使用して、オンライン チャネルの倉庫またはオンライン チャネルのフルフィルメント グループにリンクされている倉庫の製品または製品バリアントの在庫のクエリを実行します。
- **GetEstimatedProductWarehouseAvailability** – 特定の倉庫からの製品または製品バリアントのクエリを実行するには、この API を使用してください。

> [!NOTE]
> こららの API は、Commerce 10.0.7 およびそれ以前のリリースの **GetProductAvailabilities** と **GetAvailableInventoryNearby** API を置き換えます。

両方の API は内部的にチャネル側の計算ロジックを使用し、要求された製品と倉庫の **引当可能な現物** の見積数量、**利用可能な合計** 数量、**測定単位 (UoM)**、および **在庫レベル** を返します。 戻り値は、必要に応じて E コマース サイトに表示するか、または E コマース サイトで他のビジネス ロジックのトリガーとして使用することができます。 たとえば、在庫レベルが「在庫切れ」である製品の購入を防止することができます。

コマースで利用可能なその他の API が直接本社へアクセスし、製品の手持在庫数量をフェッチすることができでも、潜在的なパフォーマンスの問題と、これらの頻繁な要求が本社のサーバーに与える可能性のある影響のため、E コマースの環境で使用することはお勧めしません。 また、チャネル側の計算を使用し、上記の 2 つの API は、本社にはまだ知らされていないチャネルで作成されたトランザクションを考慮に入れることにより、製品の可用性に関するより正確な見積を提供することができます。

2 つの API を使用するには、本社の **機能の管理** ワークスペースを使用して、**最適化された製品在庫計算** 機能を有効にする必要があります。 オンラインおよび店舗チャネルが同じフルフィルメント倉庫を使用する場合、店舗チャネルで作成された未転記のトランザクション (現金売り、顧客注文、返品) の要素に対する 2 つの API 内にチャネル側の計算ロジックが含まれるように、**E コマースのチャネル側在庫計算の拡張ロジック** 機能を有効にする必要があります。 これらの機能を有効にした後、**1070** (**チャネル コンフィギュレーション**) ジョブを実行する必要があります。

API の出力で製品数量を返す方法を定義するには、次の手順に従います。

1. **Retail と Commerce \> 本社の設定 \> パラメーター \> コマース パラメーター** の順にクリックします。
1. **在庫** タブを選択し、**E コマースの在庫可用性 API** クイックタブで、**数量の API 出力** 設定を構成します。
1. **1070** (**チャネル構成**) ジョブを実行し、チャネルに最新の設定を同期します。

**数量の API 出力** 設定には、3 つのオプションがあります。

- **在庫数量を返す** - API の出力で、要求された製品の引当可能現物数と利用可能な合計数量を返します。
- **在庫バッファーを差し引いた在庫数量を返す** - API 出力で返される数量は在庫バッファー値を差し引いて調整されます。 在庫バッファーの詳細については、[在庫バッファーと在庫レベルのコンフィギュレーション](inventory-buffers-levels.md)を参照してください。
- **在庫数量は返さない** - 在庫レベルだけが API 出力で返されます。 在庫レベルの詳細については、[在庫バッファーと在庫レベルのコンフィギュレーション](inventory-buffers-levels.md)を参照してください。

`QuantityUnitTypeValue` API パラメーターを使用して、API で数量を返す単位のタイプを指定できます。 このパラメーターは、**在庫単位** (既定)、**購入単位**、および **販売単位** のオプションをサポートします。 返品数量は、本社で定義された対応する測定単位 (UOM) の精度に丸められます。

**GetEstimatedAvailability** API は、さまざまなクエリ シナリオをサポートするために次の入力パラメーターを提供します。

- `DefaultWarehouseOnly` - このパラメーターを使用して、オンライン チャネルの既定の倉庫にある製品の在庫のクエリを実行します。 
- `FilterByChannelFulfillmentGroup` および `SearchArea` - これら 2 つのパラメーターを使用し、`longitude`、`latitude`、および `radius` に基づいて、特定の検索領域内でのすべての集荷場所から製品在庫のクエリを実行します。 
- `FilterByChannelFulfillmentGroup` および `DeliveryModeTypeFilterValue` - これら 2 つのパラメーターを使用し、オンライン チャネルのフルフィルメント グループにリンクされ、指定された配送モードをサポートするよう構成されている特定の倉庫から製品在庫のクエリを実行します。 `DeliveryModeTypeFilterValue` パラメーターは、**すべて** (既定)、**出荷**、および **集荷** のオプションをサポートします。 たとえば、オンライン注文が複数の出荷倉庫からフルフィルメントされる場合、これら 2 つのパラメーターを使用して、すべての出荷倉庫における製品の引当可能在庫数量のクエリを実行できます。 この場合、API は、出荷倉庫の製品の手持数量と在庫レベルに加えて、クエリ スコープ内のすべての出荷倉庫からの集計数量と集計在庫レベルを返します。
 
Commerce の購入ボックス、店舗セレクター、欲しい物リスト、買い物カゴ、および買い物カゴ アイコン モジュールは、上記の API とパラメーターを使用して、E コマース サイト間の在庫レベル メッセージを表示します。 Commerce のサイト ビルダーは、販売促進と購入の動作を制御するためにさまざまな在庫設定を提供します。 詳細については、[在庫設定を適用する](inventory-settings.md) を参照してください。

## <a name="pos-inventory-lookup-with-channel-side-calculation"></a>チャネル側の計算を使用した POS 在庫検索

リリース 10.0.9 およびそれ以前の Commerce では、本社に対するリアル タイム サービスで使用される POS の **在庫検索** 操作が、店舗のチャネル コンフィギュレーションの一部としてフルフィルメント グループ用に構成されているユーザーの現店舗と他の店舗の両方で選択された製品の在庫情報を取得します。 Commerce のリリース 10.0.10 およびそれ以降では、本社へのリアルタイムのサービス呼び出しをオフにし、代わりに Commerce サーバー上でのチャネル側計算を使用して、店舗およびフルフィルメント グループで定義されている他の全ての場所において物理的に使用可能な手持在庫を決定することができます。 また、このチャネル計算による在庫構成は、オンラインでなくても本社から在庫検索を取得する必要がないため、インターネット接続が不安定な場所でも役立ちます。

チャネル側の計算が正しく構成および管理されている場合は、コマースのサーバー データベースにあるトランザクション データを使用しているが、まだ本社に含まれていない情報の可能性があるため、現在の店舗在庫より信頼性の高い見積もりを提供できます。 たとえば、POS の在庫検索に既存のリアルタイム サービス コールを使用している場合、本社では製品に対してのみ発生した現金店頭払いの売上に関する情報がまだ得られていない可能性があります。 したがって、本社がその製品に対して返す手持在庫値は、おそらく店舗の実手持在庫を 1 ユニット上回る可能性があります。 ただし、チャネル側計算を使用する場合は、現金店頭払い売上を計算に含めることができ、表示される手持在庫値から差し引かれます。 チャネル側計算とリアルタイムのサービス コールの両方が提供する値は手持在庫の推定値のみでも、チャネル計算によって提供される値は現店舗に対して正確である可能性が高くなります。

チャネル側の計算ロジックを使用してリアルタイム サービス呼び出しを無効化するために Commerce Headquarters で POS **在庫検索** 操作を構成するには、まず、Commerce Headquarters の **機能の管理** ワークスペースを使用して、**最適化された製品在庫計算** 機能を有効にし、次の手順に従います。

1. **Retail とコマース \> チャネル設定 \> POS 設定 \> POS プロファイル \> 機能プロファイル** の順に移動します。
1. 機能プロファイルを選択します。
1. **機能** クイックタブの **在庫の利用可能性の計算** セクションで、**在庫の利用可能性の計算モード** の値を **リアルタイム サービス** から **チャネル** に変更します。 既定では、すべての機能プロファイルでリアルタイム サービス コールが使用されます。 チャネル側の計算ロジックを使用する場合、このフィールドの値を変更する必要があります。 選択した機能プロファイルにリンクされているすべての小売用店舗は、この変更によって影響を受けます。

続いて、以下のこれらの手順を実行して、本社の配送スケジュール プロセスを介してチャネルに変更を同期させる必要があります。

1. **Retail とコマース \> Retail とコマース IT \> 配送スケジュール** の順に移動します。
1. **1070** (**チャネル コンフィギュレーション**) ジョブを実行します。

コンフィギュレーションが完了した後、POS アプリケーションのユーザーが **在庫検索** 工程 (標準およびマトリックス ビュー) を使用する場合、物理的に利用できる在庫についての情報は、リアルタイム サービス コールを使用しなくなります。 代わりに、現店舗の現物在庫とフルフィルメント グループのすべての店舗に関するデータが、コマース本社からチャネル データベースに配信された最新の既知のスナップショットに基づいて計算されます。 1130 ジョブから最後の同期スナップショットに含まれなかったチャネル データベースで選択した製品に存在する追加の売上または返品トランザクションを基に、スナップショットの値はチャネル計算によってさらに絞り込み、物理的に利用可能な値を調整することができます。 チャネル データベースがフルフィルメント グループのいずれかの倉庫または店舗のトランザクション データを含まない場合、値の再計算に因数分解できる追加のトランザクションを含みません。 したがって、これらの倉庫または店舗に対して表示できる最適な手持在庫の見積は、最新のコマース本社スナップショットからのデータです。

POS の **注文フルフィルメント** スクリーンでは、注文フルフィルメント行が選択されユーザーが選択した品目の手持在庫の **詳細** パネルを表示する際に、品目の手持在庫を表示するためにチャネル側計算も活用されます。

## <a name="optimize-your-inventory-data"></a>在庫データの最適化

在庫の最適予測を保証するには、次のコマース バッチジョブを使用し、それらを頻繁に実行することが重要です。

- **P- ジョブ** – P- ジョブは **配送スケジュール** ページで検出され、頻繁に実行する必要があります。 このジョブでは、E コマース注文、POS で作成された非同期の顧客注文、およびチャネル データベースからコマース本社に作成された現金店頭払い注文を取得し、それらをさらに処理できるようにします。 このデータがコマース本社へチャネルから同期されるまで、コマース本社ではこれらのトランザクションによって発生した倉庫内の製品に対する在庫調整についての情報がありません。
- **注文の同期** – このジョブでは、P- ジョブが E コマースと非同期な顧客注文トランザクションを提供およびコマース本社の販売注文に変換するようコマース本社の非加工トランザクション データを処理します。 このジョブが処理および販売注文が作成されるまで、在庫トランザクションは作成されません。 したがって、コマース本社の手持在庫についてはトランザクションが考慮されません。
- **バッチのトランザクション明細書の計算** – 店舗で作成された現金店頭払いのトランザクションについては、トリクル フィード転記のプロセスにより、売上に関する在庫が確実に更新されます。 現金店頭払い注文の在庫トランザクションを最も効率的に処理するには、[トリクル フィード転記](./trickle-feed.md) を使用してシステムを構成する必要があります。
- **バッチのトランザクション明細書を転記** – このジョブは、トリクル フィード転記にも必要です。 **バッチのトランザクション明細書の計算** ジョブに従います。 このジョブでは、計算された明細書が系統的に転記されるので、現金店頭払い売上の販売注文がコマース本社で作成され、店舗の在庫が正確に反映されます。
- **製品の可用性** – このジョブでは、コマース本社からの在庫のスナップショットが作成されます。
- **1130 (製品の可用性)** – このジョブは **配送スケジュール** ページにあり、**製品の可用性** ジョブの直後に実行する必要があります。 このジョブでは、コマース本社からチャネル データベースに対して、在庫スナップショット データを転送します。

> [!NOTE]
> - **製品の可用性** と **1130** のジョブを毎時ごとに実行し、P-ジョブのスケジュール、注文の同期、およびトリクル フィードの転記関連ジョブを同じまたはそれ以上の頻度で実行することがベスト プラクティスです。
> - パフォーマンス上の理由から、チャネル側在庫の可用性計算が E コマース API または POS チャネル側の在庫ロジックを使用して、在庫の可用性依頼を作成するために使用される際、計算によって再度計算ロジックの実行が正当化するのに十分な時間が経過したかどうか特定するためのキャッシュが使用されます。 既定のキャッシュは 60 秒に設定されています。 たとえば、店舗のチャネル側計算を有効にして、**在庫検索** ページで製品の手持在庫を表示しているとします。 その後、製品の 1 つのユニットが販売された場合、**在庫検索** ページではキャッシュがクリアーされるまで、在庫の減少が示されません。 POS でトランザクションを転記した後、手持在庫が削減されたことを確認する前に、60 秒待機する必要があります。

ビジネス シナリオが短いキャッシュ時間を要求する場合、製品サポート担当者に問い合わせてください。


[!INCLUDE[footer-include](../includes/footer-banner.md)]
