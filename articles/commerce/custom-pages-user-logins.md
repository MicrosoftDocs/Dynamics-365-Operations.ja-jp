---
title: ユーザーのサインインに対するカスタム ページの設定
description: このトピックでは Microsoft Dynamics 365 Commerce で、Azure Active Directory (Azure AD) 企業と顧客間 (B2C) テナントのユーザー向けにカスタマイズされたサインインを処理するカスタム ページを構築する方法について説明します。
author: brianshook
ms.date: 03/17/2021
ms.topic: article
ms.prod: ''
ms.technology: ''
audience: Application user
ms.reviewer: v-chgri
ms.custom: ''
ms.assetid: ''
ms.search.region: Global
ms.author: brshoo
ms.search.validFrom: 2019-10-31
ms.dyn365.ops.version: Release 10.0.5
ms.openlocfilehash: 0318814f421ab862559965bb4b003308d6279812
ms.sourcegitcommit: 3cdc42346bb653c13ab33a7142dbb7969f1f6dda
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/31/2021
ms.locfileid: "5799448"
---
# <a name="set-up-custom-pages-for-user-sign-ins"></a>ユーザーのサインインに対するカスタム ページの設定

[!include [banner](includes/banner.md)]

このトピックでは Microsoft Dynamics 365 Commerce で、Azure Active Directory (Azure AD) 企業と顧客間 (B2C) テナントのユーザー向けにカスタマイズされたサインインを処理するカスタム ページを構築する方法について説明します。

Dynamics 365 Commerce で作成されたカスタム ページを利用してユーザー サインイン フローを処理するには、コマース環境で参照される Azure AD ポリシーを設定する必要があります。 Azure AD B2C アプリケーションを使用して、「登録してサインイン」、「プロファイル編集」、および「パスワード リセット」 Azure AD B2C ポリシーをコンフィギュレーションできます。 その後、Microsoft Dynamics Lifecycle Services (LCS) を使用してコマース環境で実行されるプロビジョニング プロセス中に、Azure AD B2C テナントとポリシー名を参照できます。

カスタム Commerce ページは、サインイン、登録、アカウント プロファイル編集、パスワード リセット、汎用の AAD モジュールを使用して構築できます。 これらのカスタム ページ用に公開されたページ URL は、Azure ポータルの Azure AD B2C ポリシー コンフィギュレーションで参照する必要があります。

> [!WARNING] 
> Azure AD B2C は、2021 年 8 月 1 日までに古い (レガシ) ユーザー フローを破棄します。 したがって、ユーザー フローを新しい推奨バージョンに移行する必要があります。 新しいバージョンでは、機能パリティと新しい機能が提供されます。 詳細については、[Azure Active Directory B2C のユーザー フロー](https://docs.microsoft.com/azure/active-directory-b2c/user-flow-overview) を参照してください。

>推奨される B2C ユーザー フローには、Commerce のバージョン 10.0.15 以上のモジュール ライブラリを使用する必要があります。 また、Azure AD B2C で提供されている既定のユーザー ポリシー ページを使用して、企業のブランディングに合わせて背景画像やロゴ、背景色を変更することができます。 デザインの機能については制限がありますが、既定のユーザー ポリシー ページは、専用のカスタム ページを作成・設定しなくても、Azure AD の B2C ポリシーの機能を提供します。 

## <a name="set-up-b2c-policies"></a>B2C ポリシーを設定する

Azure AD B2C テナントを設定し、コマース環境に関連付けた後、Azure ポータル **Azure AD B2C** ページに移動し、メニューの **ポリシー** で、**ユーザー フロー (ポリシー)** を選択します。

![メニューのユーザー フロー (ポリシー) コマンド](./media/B2C_CustomPage_PoliciesMenu.png)

「登録してサインイン」、「プロファイル編集」、および「パスワード リセット」 ユーザー サインイン フローをコンフィギュレーションできるようになりました。

### <a name="configure-the-sign-up-and-sign-in-policy"></a>「登録とサインイン」 ポリシーのコンフィギュレーション

「登録とサインイン」 ポリシーをコンフィギュレーションするには、次の手順を実行します。

1. **新しいユーザー フロー** を選択し、**登録とサインイン** を選択し、**推奨** タブの **作成** を選択します。
1. ポリシーの名前を入力します (たとえば、**B2C\_1\_SignInSignUp**)。
1. **ID プロバイダー** セクションで、ポリシーに使用する ID プロバイダーを選択します。 少なくとも、**電子メールの登録** を選択する必要があります。
1. **属性の収集** の列で、**電子メール アドレス**、**指定された名前**、および **姓** のチェック ボックスをオンにします。
1. **返品クレーム** の列で、**電子メール アドレス**、**指定された名前**、**ID プロバイダー**、**姓**、および **ユーザー オブジェクト ID** のチェック ボックスをオンにします。

    ![選択された属性とクレーム](./media/B2C_SignInSignUp_Attributes.png)

1. **OK** を選択してポリシーを作成します。
1. 新しいポリシー名をダブルクリックし、ナビゲーション ウィンドウで **プロパティ** を選択します。
1. **JavaScript を使用したページ レイアウト (プレビュー) を有効にする** のオプションを **オン** に設定します。

    ![新しいポリシーのプロパティ ページ](./media/B2C_SignInSignUp_EnableJavascript.png)

> [!NOTE]
> ポリシー名は、コマース環境で完全に参照されます。 (**B2C\_1\_** の接頭語は参照に含まれます。) 作成したポリシーの名前を変更することはできません。 既存のコマース環境のポリシーを置き換える場合は、元のポリシーを削除して、同じ名前の新しいポリシーを作成することができます。 または、環境が既にプロビジョニングされている場合は、サービス要求を通じて新しいポリシー名を送信することもできます。

カスタム ページを作成した後、このポリシーに戻り設定を完了します。 ここでは、ポリシーを閉じて、Azure ポータルの **ユーザー フロー (ポリシー)** ページに戻ります。

### <a name="configure-the-profile-editing-policy"></a>「プロファイル編集」ポリシーのコンフィギュレーション

「プロファイル編集」をコンフィギュレーションするには、次の手順を実行します。

1. **新しいユーザー フロー** を選択し、**プロフィールの設定** を選択し、**推奨** タブの **作成** を選択します。
1. ポリシーの名前を入力します (たとえば、**B2C\_1\_EditProfile**)。
1. **ID プロバイダー** セクションで、ポリシーに使用する ID プロバイダーを選択します。 少なくとも、**ローカル アカウント サインイン** を選択する必要があります。
1. **属性の収集** の列で、**名** と **姓** のチェック ボックスをオンにします。
1. **返品クレーム** の列で、**電子メール アドレス**、**指定された名前**、**ID プロバイダー**、**姓**、および **ユーザー オブジェクト ID** のチェック ボックスをオンにします。
1. **OK** を選択してポリシーを作成します。
1. 新しいポリシー名をダブルクリックし、ナビゲーション ウィンドウで **プロパティ** を選択します。
1. **JavaScript を使用したページ レイアウト (プレビュー) を有効にする** のオプションを **オン** に設定します。

カスタム ページを作成した後、このポリシーに戻り設定を完了します。 ここでは、ポリシーを閉じて、Azure ポータルの **ユーザー フロー (ポリシー)** ページに戻ります。

### <a name="configure-the-password-reset-policy"></a>「パスワードのリセット」 ポリシーのコンフィギュレーション

「パスワードのリセット」 ポリシーをコンフィギュレーションするには、次の手順を実行します。

1. **新しいユーザー フロー** を選択し、**パスワード リセット オプション** を選択して、**推奨** タブを選択して、**作成** をクリック します。
1. ポリシーの名前を入力します (たとえば、**B2C\_1\_ForgetPassword**)。
1. **ID プロバイダー** セクションで、**電子メールアドレスを使用したパスワードのリセット** を選択します。
1. **返品クレーム** の列で、**電子メール アドレス**、**指定された名前**、**姓**、および **ユーザー オブジェクト ID** のチェックボックスをオンにします。
1. **OK** を選択してポリシーを作成します。
1. 新しいポリシー名をダブルクリックし、ナビゲーション ウィンドウで **プロパティ** を選択します。
1. **JavaScript を使用したページ レイアウト (プレビュー) を有効にする** のオプションを **オン** に設定します。

カスタム ページを作成した後、このポリシーに戻り設定を完了します。 ここでは、ポリシーを閉じて、Azure ポータルの **ユーザー フロー (ポリシー)** ページに戻ります。

## <a name="build-the-custom-pages"></a>カスタム ページの構築

専用の Azure AD モジュールは、Azure AD B2C ユーザー ポリシー用のカスタム ページを作成する Commerce に含まれています。 以下の主な Azure AD B2C モジュールを使用して、各ユーザー ポリシー ページのレイアウトに特化したページを構築することができます。 また、**汎用 AAD** モジュールは、 Azure AD B2Cのすべてのページ レイアウトとポリシーに使用することができます (以下に記載されていないポリシー内のページレイアウト オプションにも使用できます)。 

- ページ固有の Azure AD のモジュールは、Azure AD の B2C でレンダリングされたデータ入力項目に結合されます。 これらのモジュールでは、ページ内の要素の位置をより細かく制御することができます。 しかし、以下に説明する既定の設定以外の差異を考慮して、さらに多くのページやモジュール拡張を構築する必要がある場合があります。
- **汎用の AAD** モジュールは、Azure AD B2C 用の "div "要素を作成し、ユーザーポリシーのページレイアウト内のすべての要素をレンダリングします。これにより、ページの B2C 機能に柔軟性が与えられますが、ポジショニングとスタイリングのコントロールは少なくなります (また、CSS は、サイトのルック＆フィールに合わせて使用することができます)。

**汎用の AAD** モジュールを使ってひとつのページを作成し、それをすべてのユーザーポリシーページに使用することも、サインイン、サインアップ、プロファイル編集、パスワードリセット、パスワードリセット確認用の各 Azure AD モジュールを使って特定のページを構築することもできます。 また、以下に示すページ レイアウトには特定の Azure AD ページを使用し、これらのページまたは他のユーザーポリシー ページ内の残りのページ レイアウトには汎用の AAD モジュール ページを使用するなど、両方を混在させることも可能です。

モジュール ライブラリに同梱されている Azure AD モジュールについては、[アイデンティティ管理のページとモジュール](identity-mgmt-modules.md)を参照してください。

ユーザーのサイン インを処理する特定の ID モジュールを持つカスタム ページを構築するには、以下の手順に従います。

1. Commerce サイト ビルダーで、ご利用のサイトに移動します。
1. 次の5つのテンプレートとページを作成します (サイトにまだ存在していない場合) :
    - サインイン モジュールを使用する **サインイン** テンプレートとページ。
    - 登録モジュールを使用する **登録** テンプレートとページ。
    - パスワード リセット モジュールを使用する **パスワードのリセット** テンプレートとページ。
    - パスワード リセット検証モジュールを使用する **パスワードのリセット検証** テンプレートとページ。
    - アカウント プロファイルの編集モジュールを使用する **プロファイル編集** テンプレートとページ。

プロパティを作成するときは、次のガイドラインに従います。

- 各ページまたは各モジュールについて、ビジネス要件に最も適したレイアウトとスタイルを使用します。
- Azure AD B2C の設定で使用する必要があるすべてのページと URL を公開します。
- ページと URL を公開した後、Azure AD B2C ポリシーのコンフィギュレーションに使用する必要がある URL を収集します。 **?preloadscripts=true** 接尾語は、使用時にすべての URL に追加されます。

> [!IMPORTANT]
> Azure AD の B2C で参照されるように構築されたページは、Azure AD の B2C テナントのドメインから直接提供されます。 相対リンクが設定されている汎用のヘッダーおよびフッターは再利用しないでください。 これらのページは、使用時に Azure AD B2C ドメインでホストされるので、すべてのリンクに対して絶対 URL を使用する必要があります。 Azure AD 関連のカスタム ページは、絶対的な URL で特定のヘッダーとフッターを作成し、Retail サーバーへの接続を必要とする Commerce 固有のモジュールは削除することをお勧めします。 たとえば、お気に入り、検索バー、サインイン リンク、カート モジュールは、Azure AD B2C ユーザー フローで使用されるページには含めないようにしてください。

## <a name="configure-azure-ad-b2c-policies-with-custom-page-information"></a>カスタム ページ情報を使用して、Azure AD B2C ポリシーをコンフィギュレーションする 

Azure ポータルで、**Azure AD B2C** ページに戻り、メニューの **ポリシー** で、**ユーザー フロー (ポリシー)** を選択します。

### <a name="update-the-sign-up-and-sign-in-policy-with-custom-page-information"></a>カスタム ページ情報で「登録とサインイン」 ポリシーを更新する

カスタム ページ情報で「登録とサインイン」 ポリシーを更新するには、次の手順を実行します。

1. 以前にコンフィギュレーションした **サインインと登録** ポリシーで、ナビゲーション ウィンドウで、**ページ レイアウト** を選択します。
1. **統一登録またはサインインのページ** のレイアウトを選択します。
1. **カスタム ページ コンテンツの使用** オプションを、**はい** に設定します。
1. **カスタム ページのURI** フィールドに、完全なサインイン URL を入力します。 **preloadscripts=true** 接尾語を含めます。 たとえば、「``www.<my domain>.com/sign-in?preloadscripts=true``」を入力します。
1. **ページ レイアウト バージョン** フィールドで、バージョン **2.1.0** またはそれ以降を選択します (Commerce バージョン 10.0.15 以上のモジュール ライブラリが必要です)。
1. **保存** を選択します。
1. **ローカル アカウントの登録ページ** のレイアウトを選択します。
1. **カスタム ページ コンテンツの使用** オプションを、**はい** に設定します。
1. **カスタム ページの URI** フィールドに、完全なサインアップ URL を入力します。 **preloadscripts=true** 接尾語を含めます。 たとえば、「``www.<my domain>.com/sign-up?preloadscripts=true``」を入力します。
1. **ページ レイアウト バージョン** フィールドで、バージョン **2.1.0** またはそれ以降を選択します (Commerce バージョン 10.0.15 以上のモジュール ライブラリが必要です)。
1. **ユーザー属性** セクションで、次の手順を実行します。
    1. **名** と **姓** の属性については、**検証を要求する** 列に **いいえ** を選択します。
    1. **電子メール アドレス** 属性に対しては、**検証を要求する** 列を既定値の **はい** のままにしておくことを推奨します。 このオプションにより、入力されたメール アドレスでサインアップしたユーザーが、そのメール アドレスを所有していることを確認することができます。
    1. **電子メール アドレス**、**名**、**姓** の属性に対して、**オプション** 列で、**いいえ** を選択します。
1. **保存** を選択します。

    ![ローカル アカウントの登録ページ ポリシーの構成](./media/B2C_SignInSignUp_Recommended_PageLayoutExample.png)

### <a name="update-the-profile-editing-policy-with-custom-page-information"></a>カスタム ページ情報で「プロファイル編集」ポリシーを更新する

カスタム ページ情報で「プロファイル編集」ポリシーを更新するには、次の手順を実行します。

1. 以前にコンフィギュレーションした **プロファイル編集** ポリシーで、ナビゲーション ウィンドウで、**ページ レイアウト** を選択します。
1. **プロファイル編集 ページ** レイアウトを選択します (画面によっては、下にスクロールして他のレイアウト オプションを表示する必要があります)。
1. **カスタム ページ コンテンツの使用** オプションを、**はい** に設定します。
1. **カスタム ページの URI** フィールドに、完全なプロファイル編集 URL を入力します。 **preloadscripts=true** 接尾語を含めます。 たとえば、「``www.<my domain>.com/profile-edit?preloadscripts=true``」を入力します。
1. **ページ レイアウト バージョン** に対しては、バージョン **2.1.0** またはそれ以上を選択します (Commerce バージョン 10.0.15 以上のモジュール ライブラリが必要です)。
1. **ユーザー属性** セクションで、次の手順を実行します。
    1. **名** と **姓** の属性に対しては、**オプション** 列で、**いいえ** を選択します。
    1. **名** と **姓** の属性については、**検証を要求する** 列に **いいえ** を選択します。
1. **保存** を選択します。

### <a name="update-the-password-reset-policy-with-custom-page-information"></a>カスタム ページ情報で「パスワードのリセット」 ポリシーを更新する

カスタム ページ情報で「パスワードのリセット」 ポリシーを更新するには、次の手順を実行します。

1. 以前にコンフィギュレーションした **パスワードのリセット** ポリシーで、ナビゲーション ウィンドウで、**ページ レイアウト** を選択します。
1. **パスワードを忘れた場合のページ** のレイアウトを選択します。
1. **カスタム ページ コンテンツの使用** オプションを、**はい** に設定します。
1. **カスタム ページの URI** フィールドに、完全なパスワード リセット検証 URL を入力します。 **preloadscripts=true** 接尾語を含めます。 たとえば、「``www.<my domain>.com/password-reset-verification?preloadscripts=true``」を入力します。
1. **ページ レイアウト バージョン** フィールドで、バージョン **2.1.0** またはそれ以上を選択します (Commerce バージョン 10.0.15 以上のモジュール ライブラリが必要です)。
2. **保存** を選択します。
3. **パスワードを変更するページ** のレイアウトを選択します。
4. **カスタム ページ コンテンツの使用** オプションを、**はい** に設定します。
5. **カスタム ページの URI** フィールドに、完全なパスワード リセット URL を入力します。 **preloadscripts=true** 接尾語を含めます。 たとえば、「``www.<my domain>.com/password-reset?preloadscripts=true``」を入力します。
6. **ページ レイアウト バージョン** フィールドで、バージョン **2.1.0** またはそれ以上を選択します (Commerce バージョン 10.0.15 以上のモジュール ライブラリが必要です)。
7. **保存** を選択します。

## <a name="customize-default-text-strings-for-labels-and-descriptions"></a>ラベルと説明の既定のテキスト文字列のカスタマイズ

モジュール ライブラリでは、サインイン モジュールにはラベルと説明の既定のテキスト文字列が事前に入力されています。 文字列のカスタマイズは、作業中のモジュールのプロパティ ペインで行うことができます。 ページ上の追加文字列 (**パスワードをお忘れですか？** リンク テキストや **アカウント作成** などの呼びかけテキスト) は、Commerce ソフトウェア開発キット (SDK) を使用して、サインイン モジュールの global.json ファイルの値を更新する必要があります。

たとえば、パスワード リンクを忘れた場合の既定のテキストは **パスワードをお忘れですか** です。 以下は、サインイン ページに表示される既定のテキストを示しています。

![サインイン ページでパスワード リンクを忘れた場合の既定のテキスト](./media/B2C_SignUp_ModuleFace.png)

ただし、モジュール ライブラリ サインイン モジュールの global.json ファイルでは、次の図に示すように、**パスワードをお忘れですか？** のテキストを編集することができます。

![サインイン モジュール global.json ファイルの更新されたリンク テキスト](./media/B2C_CustomizingStringsForModule.png)

global.json ファイルを更新して変更内容を公開すると、コマースとライブ サインイン ページの両方のサイン イン モジュールに新しいリンク テキストが表示されます。

## <a name="additional-resources"></a>追加リソース

[ドメイン名のコンフィギュレーション](configure-your-domain-name.md)

[新しい eコマース テナントのデプロイ](deploy-ecommerce-site.md)

[E コマース サイトの作成](create-ecommerce-site.md)

[オンライン チャンネルと Dynamics 365 Commerce サイトの関連付け](associate-site-online-store.md)

[robots.txt ファイルの管理](manage-robots-txt-files.md)

[URL リダイレクトの一括アップロード](upload-bulk-redirects.md)

[B2C テナントを Commerce に 設定](set-up-B2C-tenant.md)

[Commerce 環境での複数の B2C テナントのコンフィギュレーション](configure-multi-B2C-tenants.md)

[コンテンツ配信ネットワーク (CDN) のサポートの追加](add-cdn-support.md)

[場所に基づく店舗検出の有効化](enable-store-detection.md)


[!INCLUDE[footer-include](../includes/footer-banner.md)]
