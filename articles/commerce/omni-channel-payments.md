---
title: オムニ チャネル支払の概要
description: このトピックでは、Dynamics 365 Commerce でのオムニ チャネルの支払概要を示します。
author: rubendel
manager: AnnBe
ms.date: 09/17/2020
ms.topic: article
ms.prod: ''
ms.service: dynamics-365-retail
ms.technology: ''
audience: Application user
ms.reviewer: josaw
ms.custom: 141393
ms.assetid: ''
ms.search.region: Global
ms.search.industry: Retail
ms.author: rubendel
ms.search.validFrom: 2019-01-01
ms.dyn365.ops.version: AX 8.1.3
ms.openlocfilehash: 6ecfd518298021e08cf73934b450d175cf699a46
ms.sourcegitcommit: 38d40c331c8894acb7b119c5073e3088b54776c1
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 01/15/2021
ms.locfileid: "4985864"
---
# <a name="omni-channel-payments-overview"></a>オムニ チャネル支払の概要

[!include [banner](../includes/banner.md)]

このトピックでは、Dynamics 365 Commerce でのオムニ チャネルの支払概要を示します。 ここには、サポートされるシナリオの包括的な一覧、機能、セットアップ、トラブルシューティングについての情報、および一般的な問題の説明が含まれています。

## <a name="key-terms"></a>重要な用語

| 相談 | 説明 |
|---|---|
| トークン | 支払プロセッサが参照として提供する一連のデータ。 トークンは、支払カード番号、支払認証、前回の支払キャプチャを表すことができます。 トークンは、販売時点管理 (POS) システムの外で機密データを保持するのに役立つため重要です。 *参照* と呼ばれることもあります。 |
| カード トークン | POS システムのストレージに対して支払プロセッサが提供するトークン。 カード トークンは、それを受け取る販売者のみが使用できます。 カード トークンは、*カード参照* と呼ばれることもあります。 |
| 承認 (認証) トークン | POS システムが支払プロセッサに承認要求をした後、支払プロセッサが POS システムに送信する応答の一部として提供する固有の ID です。 承認を取り消したり無効にしたりするなどのアクションを実行するためにプロセッサが呼び出された場合、この承認トークンを後で使用できます ただし、注文が履行されたとき、またはトランザクションが確定したときに、資金を取得するために最もよく使用されます。 承認トークンは、*承認参照* と呼ばれることもあります。 |
| キャプチャ トークン | 支払が完了またはキャプチャされるときに、支払プロセッサが POS システムに提供する参照です。 これにより、キャプチャ トークンを使用して、返金要求など、その後の工程の支払キャプチャを参照できます。 | 
| カードなし | 現物カードが記載されていない支払トランザクションを参照する用語です。 たとえば、これらのトランザクションは、電子商取引またはコール センターのシナリオで発生する可能性があります。 これらのトランザクションに向けて、支払に関連する情報は、電子商取引 Web サイト、コール センター フロー、または POS または支払ターミナルにて手動で入力されます。 |
| カードあり | 物理的なカードが、Microsoft Dynamics 365 POS システムにつながる支払ターミナル コネクタで提示および使用される支払トランザクションを参照する用語です。 |

## <a name="overview"></a>概要

一般的に、*オムニ チャネル支払* という用語は、1 つのチャネルで注文を作成し、それを別のチャネルで満たすための機能を表します。 オムニ チャネル支払のサポートの鍵は、支払詳細を他の注文詳細の残りと一緒に保存し、別のチャネルで注文が取り消されたり処理されたりしたときに、支払詳細を使用することです。 古典的な例として、「オンラインで購入、店舗で受取」というシナリオがあります。 このシナリオでは、注文をオンラインで作成したときに、支払詳細が追加されます。 その後、受取り時に顧客の支払カードを請求するために POS で呼び戻されます。 

このトピックで説明されるすべてのシナリオは、Commerce で提供される標準の支払ソフトウェア開発キット (SDK) を使用して実装できます。 [Dynamics 365 Payment Connector for Adyen](https://docs.microsoft.com/dynamics365/unified-operations/retail/dev-itpro/adyen-connector?tabs=8-1-3) では、こちらで説明されるすべてのシナリオの直ぐに使える実装を提供します。 

### <a name="prerequisites"></a>必要条件

このトピックで説明されるすべてのシナリオでは、オムニ チャネル支払をサポートする支払コネクタが必要です。 直ぐに使える Adyen コネクタは、支払 SDK を通じて使用可能となるシナリオをサポートするため、使うこともできます。 支払コネクタの実装方法および一般的な Retail SDK の詳細については、[IT プロおよび開発者向けの小売ホーム ページ](https://docs.microsoft.com/dynamics365/unified-operations/retail/dev-itpro/dev-retail-home-page#payment-connectors) にアクセスしてください。

#### <a name="supported-versions"></a>サポートされているバージョン

このトピックで説明されているオムニ チャネル支払の機能は、Microsoft Dynamics 365 for Retail 8.1.3 の一部としてリリースされました。 

#### <a name="card-present-and-card-not-present-connectors"></a>「カードあり」と「カードなし」のコネクタ

支払 SDK は、2 セットの支払い用アプリケーション プログラミング インターフェイス (APIs) に依存します。 最初の APIs セットは、**iPaymentProcessor** と呼ばれます。 これは、コール センターおよび Microsoft Dynamics 電子商取引プラットフォームで使用できる「カードなし」の支払コネクタを実装するために使用されます。 **iPaymentProcessor** インターファイスについては、支払いをカバーする[支払コネクタと支払デバイスの実装](https://download.microsoft.com/download/e/2/7/e2735c65-1e66-4b8d-8a3c-e6ef3a319137/The%20Guide%20to%20Implementing%20Payment%20Connector%20and%20Payment%20Device_update.pdf) ホワイト ペーパーを参照してください。 

2 番目の APIs セットは、**iNamedRequestHandler** と呼ばれます。 この機能は、支払ターミナルを使用する「カードあり」の支払統合をサポートします。 **INamedRequestHandler** インターフェイスの詳細については、[支払ターミナルの支払統合を作成](https://docs.microsoft.com/dynamics365/unified-operations/retail/dev-itpro/end-to-end-payment-extension) を参照してください。 

### <a name="setup-and-configuration"></a>設定およびコンフィギュレーション

次のコンポーネントと設定手順が必要です。

- **E コマースの統合:** Commerce との統合は、注文がオンライン店舗で発生するシナリオをサポートするために必要です。 小売の電子商取引 SDK の詳細は[電子商取引プラットフォーム ソフトウェア開発キット (SDK)](https://docs.microsoft.com/dynamics365/unified-operations/retail/dev-itpro/ecommerce-platform-sdk) を参照してください。 デモ環境では、参照ストアがオムニ チャネル支払のシナリオをサポートします。 
- **オンライン支払構成:** オンライン チャネルの設定には、オムニ チャネル支払をサポートするように、更新された支払コネクタを含める必要があります。 代わりに、直ぐに使える支払コネクタを使用することができます。 オンライン ストアの Adyen 支払コネクタを構成する方法については [Adyen 支払コネクタ](https://docs.microsoft.com/dynamics365/unified-operations/retail/dev-itpro/adyen-connector?tabs=8-1-3#e-commerce) を参照してください。 そのトピックで説明されている電子商取引の設定に加えて、**電子商取引で支払情報の保存を許可する** パラメーターでは、Adyen コネクタの設定で **True** と設定する必要があります。 
- **オムニ チャネルの支払コンフィギュレーション:** バック オフィスで **Retail および Commerce\>Headquarters の設定 \>パラメーター \>Commerce 共有パラメーター** の順に移動します。 次に **オムニ チャネルの支払** タブで **オムニ チャネルの支払を使用する** オプションを **はい** に設定します。 Commerce のバージョン 10.0.12 では、この設定は **機能管理** ワークスペースにあります。 **オムニ チャネル支払** 機能を選択して、**今すぐ有効にする** をクリックします。 
- **支払サービス:** コールセンターでは、**支払サービス** ページの既定の支払コネクタを使用して支払を処理します。 「コールセンターで購入」や「店舗で受取り」などのシナリオをサポートするには、この既定の支払コネクタは、オムニ チャネル支払に向けた実装要望を満たす Adyen 支払コネクタまたはオムニ チャネル支払である必要があります。
- **EFT サービス:** 支払ターミナルを通じた支払は、ハードウェア プロファイルの **EFT サービス** FastTab で設定する必要があります。 Adyen コネクタでは、そのままオムニ チャネル支払のシナリオがサポートされています。 **INamedRequestHandler** インターフェイスをサポートする他の支払コネクタは、オムニ チャネル支払をサポートする場合にも使用できます。
- **支払コネクタの使用可能性:** 注文が取り消されると、支払い入札明細では、その注文に関連付けられている承認の作成に使用された支払コネクタの名前が注文と共に取り消されます。 注文が満たされると、支払 SDK は、元の承認の作成に使用されたものと同じコネクタを使おうとします。 したがって、同じ商社プロパティを持つ支払コネクタはキャプチャ可能でなければなりません。 
- **カード タイプ:** オムニ チャネルのシナリオが正常に機能するには、各チャネルで、オムニ チャネルに使用できる支払/入金タイプについて同じ設定を行う必要があります。 この設定には、支払方法 ID とカードタイプ ID が含まれます。 たとえば、オンライン店舗設定で **カード** 支払/入金タイプが **2** の ID である場合、小売用店舗設定で同じ ID を使用する必要があります。 同じ要件が、カードタイプ ID にも適用されます。 カード番号 **12** がオンライン店舗で **VISA** に設定されている場合、小売店舗に対して同じ ID が設定されている必要があります。 
- 組み込みハードウェア ステーションを含む Windows または Android 用  Retail Modern POS   または-
- 共有ハードウェア ステーションが接続されている iOS またはクラウド POS のモダン POS。 

### <a name="basic-principle-supporting-omni-channel-payments"></a>オムニ チャネル支払をサポートする基本原則

支払コネクタと支払プロセッサは、トークンまたは参照を使用して、カード支払に関連する相互作用を参照します。 たとえば、支払承認を要求すると、その承認への参照が提供されます。 したがって、履行時に資金が取得される際、後から承認を参照できます。 商社、支払コネクタ、およびプロセッサに固有の承認です。 

オンラインで作成された注文を店舗で受け取る場合、その注文に対して同じ支払詳細をリコールして使用する必要があります。 元の承認に対して支払をキャプチャする要求の一部として元の詳細が提供されているとき、支払プロセッサはその要求を処理し、支払を取り込むことができます。 

オンライン注文を正しく参照するには、同じプロセッサをサポートする「カードなし」の支払コネクタも使用可能である必要があります。 この方法で、POS システムは「カードあり」の支払に対して 1 つのプロセッサを持つことができますが、別の支払プロセッサにアクセスすることにより、異なる支払プロセッサを使い他のチャネルで作成された注文を満たすことができるようになります。 

## <a name="supported-scenarios"></a>サポートされているシナリオ

次のオムニ チャネル支払のシナリオがサポートされています。

- オンラインで購入し、店舗で受取り
- コール センターで購入し、店舗で受取る
- 店舗 A で購入し、店舗 B で受取る
- 店舗 A で購入し、顧客へ出荷

    > [!NOTE]
    > コール センターで "通常" の支払機能にマップされている支払は、POS で注文を取り消すときに支払額に反映されるように、**前払** = **はい** とマークされる必要があります。 POSで注文が取り消されるときに、タイプ "通常" の前払以外の支払は認識されません。 

これらのシナリオのバリエーションもサポートされています。 たとえば、オンライン注文には、顧客に出荷される明細行と、店舗で受取れる両方の明細行が含まれている場合があります。 すべての注文フルフィルメント オプションは、オムニ チャネル支払を通じてサポートされます。 

次のセクションでは、シナリオごとに手順を説明し、デモ データを使用してシナリオの実行方法を示します。 

### <a name="buy-online-pick-up-in-store"></a>オンラインで購入し、店舗で受取り

始める前に、次の条件が満たされていることを確認します。

- Adyen コネクタがコンフィギュレーションされている参照ストアがあります。
- **Commerce 共有パラメーター** ページの **オムニ チャネル支払** オプションを、**True** に設定します。 それ以降のバージョンでは、この設定が **フィーチャー管理** ワークスペースに移動され、**オムニ チャネル支払** 機能を選択して、**今すぐ有効にする** をクリックできるようになっています。 
- ヒューストンの POS レジスターに対して、Adyen 支払コネクタがコンフィギュレーションされています。
- 組み込みハードウェア ステーションを含む Windows または Android 用  Retail Modern POS   または-
- 共有ハードウェア ステーションが接続されている iOS またはクラウド POS のモダン POS。 

次の手順に従い、シナリオを実行します。

1. 参照店舗内で、店舗内での受取注文を作成します。 必ず **ヒューストン** 店舗を選択してください。 
2. チェックアウトの手順を実行し、テスト クレジットカード番号を使用して支払を行います。 テスト クレジットカード番号は、[Adyen テスト カード番号のページ](https://docs.adyen.com/development-resources/test-cards/test-card-numbers/#description) で確認できます。
3. Commerce で、**同期注文** バッチ ジョブと **P-001** 配送スケジュールを使用して、バック オフィスに注文を作成します。
4. POS の開始ページで、店舗の受取の注文を確認するため、**受取注文** の操作を選択します。 
5. 参照ストアで作成された注文から 1 つ以上の明細行を選択し、**受取** を選択します。

    注文はバック オフィスから取得されます。 

6. 注文明細行の詳細がバック オフィスから取得され、オムニ チャネルに使用できるカード支払が検出された場合は、支払方法が使用可能であると通知されます。
7. **利用可能な支払方法を使用** を選択し、参照ストアに入力されたカード詳細を使用してトランザクションを完了します。

    注文明細行はトランザクション ページに読み込まれ、請求額は 0 (ゼロ) になります。 

8. **支払** タブを選択し、オンライン注文から引き出された支払/入金明細行を表示します。 
9. 任意の支払方法を選択し、トランザクションを完了します。 

### <a name="buy-in-call-center-pick-up-in-store"></a>コール センターで購入し、店舗で受取る

1. Commerce の **顧客サービス** ページで、検索バーの **Karen Berg** を入力し、**検索** を選択します。 
3. 検索結果で、**Karen Berg** を選択します。
4. Karen が **顧客サービス** ページに読み込まれた後、**新しい販売注文** を選択します。
5. 新しい販売注文ページで、**ヘッダー** を選択し、注文ヘッダーを表示します。 
6. **注文ヘッダー** ページで、サイトを **セントラル** に設定し、倉庫を **ヒューストン** に設定します。
7. **配送** タブで、顧客が受け取れるよう、**配送のモード** フィールドを **60** に設定します。
8. **明細行** を選択し、注文に 1 つ以上の明細行を追加します。 
9. **完了** を選択して、注文完了フローを入力します。
10. 支払セクションまでスクロールし、**追加** を選択し、支払方法のタイプが **カード** に設定されている明細行を選択します。 
11. 追加サイン (**+**) を選択し、カード支払に追加します。 
12. [Adyen のテストカード番号のページ](https://docs.adyen.com/development-resources/test-cards/test-card-numbers/#description) で検出されたテスト クレジットカード番号の詳細を入力し、**OK** を選択します。

    > [!NOTE]
    > 入力したカード番号のカードのブランドが、支払を開始したときに選択されたブランドと異なる場合は、支払が続行されます。 ただし、ステップ 10 で選択したカード ブランドにマップされている勘定に転記されます。

12. **OK** をもう一度選択し、**注文完了支払** ダイアログ ボックスを閉じます。
13. **販売注文の集計** ページで、**送信** を選択します。
14. POS の開始ページで、店舗の受取の注文を確認するため、**受取注文** の操作を選択します。 
15. 参照ストアで作成された注文から 1 つ以上の明細行を選択し、**受取** を選択します。

    注文はバック オフィスから取得されます。 

16. 注文明細行の詳細がバック オフィスから取得され、オムニ チャネルに使用できるカード支払が検出された場合は、支払方法が使用可能であると通知されます。
17. **利用可能な支払方法を使用** を選択し、参照ストアに入力されたカード詳細を使用してトランザクションを完了します。

    注文明細行はトランザクション ページに読み込まれ、請求額は 0 (ゼロ) になります。

18. **支払** タブを選択し、オンライン注文から引き出された支払/入金明細行を表示します。 
19. 任意の支払方法を選択し、トランザクションを完了します。 

### <a name="buy-in-store-a-pick-up-in-store-b"></a>店舗 A で購入し、店舗 B で受取る

1. ヒューストンの店舗の POS を起動します。
2. **トランザクション** ページで、数値パッドを使用して **2001** を入力することにより、Karen Berg をトランザクションに追加します。
3. トランザクションに 1 つ以上の明細行を追加します。
4. **注文** を選択して、注文オプションを表示します。
5. **すべて受取** を選択し、メッセージが表示されたら、**顧客注文** を選択します。
6. 検索バーで **シアトル** と入力し、受取のため **シアトル** の店舗を選択します。 
7. **OK** を選択し、現在の日付が受取の集配の日付として使用されます。
9. **支払カード** を選択し、支払を開始します。
10. 預金の期日を迎える金額のカード支払/入金を行います。 
11. 支払ターミナルで預金支払を完了します。 
12. 預金が支払われたら、オプションを選択してフルフィルメントの同じカードを使用し、注文が完了するまで待機します。 
13. シアトル店舗の POS を起動します。
14. POS の開始ページで、店舗の受取の注文を確認するため、**受取注文** の操作を選択します。 
15. 参照ストアで作成された注文から 1 つ以上の明細行を選択し、**受取** を選択します。

    注文はバック オフィスから取得されます。 

16. 注文明細行の詳細がバック オフィスから取得され、オムニ チャネルに使用できるカード支払が検出された場合は、支払方法が使用可能であると通知されます。
17. **利用可能な支払方法を使用** を選択し、参照ストアに入力されたカード詳細を使用してトランザクションを完了します。

    注文明細行はトランザクション ページに読み込まれ、請求額は 0 (ゼロ) になります。

18. **支払** タブを選択し、オンライン注文から引き出された支払/入金明細行を表示します。 
19. 任意の支払方法を選択し、トランザクションを完了します。 

### <a name="buy-in-store-a-ship-to-customer"></a>店舗 A で購入し、顧客へ出荷

1. ヒューストンの店舗の POS を起動します。
2. **トランザクション** ページで、数値パッドを使用して **2001** を入力することにより、Karen Berg をトランザクションに追加します。
3. トランザクションに 1 つ以上の明細行を追加します。
4. **注文** を選択して、注文オプションを表示します。
5. **すべて出荷** を選択し、メッセージが表示されたら、**顧客注文** を選択します。
6. 配送方法ページで、**標準翌日配達** を選択し、**OK** を選択して、今日の日付を配送日として受け入れます。 
7. **OK** を選択し、現在の日付が受取の集配の日付として使用されます。
8. **支払カード** を選択し、支払を開始します。
9. 預金の期日を迎える金額のカード支払/入金を行います。 
10. 支払ターミナルで預金支払を完了します。 
11. 預金が支払われたら、オプションを選択してフルフィルメントの同じカードを使用し、注文が完了するまで待機します。

注文が受取、集荷、梱包、およびバック オフィスで請求されると、POS で提供される支払詳細を使用して、顧客に出荷される商品のための資金がキャプチャされます。 

## <a name="scenario-details"></a>シナリオの詳細

説明した基本的なシナリオに加えて、オムニ チャネル支払をサポートするために、支払 SDK にいくつかの拡張が行われています。 

### <a name="pos"></a>POS

#### <a name="single-swipedip-for-customer-orders"></a>顧客注文用のシングル スワイプ/dip

オムニ チャネル支払機能が実装されていない前に、預金を含む顧客注文が POS で作成されるとき、顧客はカードを 2 回スワイプ (または dip) する必要があります。1 回は預金を支払うためで、もう 1 回は次の注文フルフィルメントをトークン化するためです。 オムニ チャネルのトークン化機能がオンになっているとき、顧客は両方に預金を支払うためカードを 1 回だけスワイプする必要があります。また、後で履行される商品のための金額を承認する必要があります。 履行の時点で、認定されたファンドが取得されます。 オムニ チャネルのトークン化機能が実装される前に、定期カードのトークンだけが次の注文のフルフィルメントのために作成されます。 したがって、保留中のフルフィルメントの資金は承認されておらず、資金が特定の購買に対して保留中ではないため、後で回収できる可能性は低くなりました。

> [!NOTE]
> シングル スワイプは、小売バージョン 8.1.3 でサポートされていません。 バージョン 8.1.3での顧客注文は、オムニ チャネルのトークン化機能が実装される前に使われたものと同じフローが使用されます。 

### <a name="cards-that-cant-issue-recurring-card-tokens"></a>定期カード トークンを発行できないカード

定期カード トークンの発行をサポートしていないので、一部のカードはオムニ チャネル支払に使用できません。 POS で注文が作成されるとき、定期カード トークンをサポートしていないカードを使用して預金が支払われた場合は、前のカードのトークン化フローが使用されます。 したがって、次の注文フルフィルメントで使用される支払を提供する顧客は、2 番目のカードを提示する必要があります。 2 番目のカードが定期的なカード トークンをサポートしていない場合、トークン化のアクションが拒否され、レジ担当者は別のカードを提供するよう顧客に求めるメッセージが表示されます。 

### <a name="using-a-different-card"></a>別のカードを使用

注文受取の店舗に来る顧客には、別のカードを使用するためのオプションが用意されています。 受注受取時に、レジ担当者が **使用可能な支払方法の利用** プロンプトを受け取ると、顧客が同じカードを使用するかどうかをたずねることができます。 注文の作成に使用されたカードを顧客が失い、別のカードを使用して注文の支払を行う場合は、レジ担当者が **別の支払方法を使用** に選択できます。 顧客が同じ注文に対してより多くの品目を受取るため戻ってきた場合、元のカードの認証がまだ有効であれば、レジ担当者はそのカードを使用するかどうかを再度確認することができます。

### <a name="invalid-authorizations"></a>無効な認証

注文の作成に使用されたカードが有効でなくなった場合、商品が受取に対して選択されたときは、支払キャプチャの要求が失敗します。 そして、POS 支払コネクタでは、同じカードの詳細を使用して、新しい承認とキャプチャを作成しようと試みます。 新しい承認またはキャプチャに失敗した場合、レジ担当者は支払を処理できなかったことを通知されます。 レジ担当者は、顧客から新しい支払を取得する必要があります。 

### <a name="multiple-available-payments"></a>複数の使用可能な支払

複数の入金/支払方法および明細行がある注文が受取されると、まずレジ担当者に **利用可能な支払方法を使用** の確認メッセージが表示されます。 複数のカードがある場合、レジ担当者が **利用可能な支払方法を使用** 選択するとき、既存カードの支払/入金明細行は現在受取されている商品の残高が満たされるまでキャプチャされます。 レジ担当者には、受取する商品に使うカードを選択するためのオプションはありません。 

## <a name="related-topics"></a>関連トピック

- [支払に関するよく寄せられる質問](https://docs.microsoft.com/dynamics365/unified-operations/retail/dev-itpro/payments-retail)
- [Adyen 向け Dynamics 365 Payment Connector](https://docs.microsoft.com/dynamics365/unified-operations/retail/dev-itpro/adyen-connector?tabs=8-1-3)
- [Dynamics 365 Commerce 評価環境で BOPIS を構成する](https://docs.microsoft.com/dynamics365/commerce/cpe-bopis)



[!INCLUDE[footer-include](../includes/footer-banner.md)]