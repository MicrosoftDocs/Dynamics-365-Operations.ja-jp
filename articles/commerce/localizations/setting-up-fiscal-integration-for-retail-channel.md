---
title: コマース チャネルの会計統合の設定
description: このトピックでは、コマース チャネルの会計統合機能を設定するためのガイドラインを提供します。
author: josaw
ms.date: 02/01/2019
ms.topic: article
ms.prod: ''
ms.technology: ''
ms.search.form: RetailFunctionalityProfile, RetailFormLayout, RetailParameters
audience: Application User
ms.reviewer: josaw
ms.search.region: Global
ms.search.industry: Retail
ms.author: epopov
ms.search.validFrom: 2018-11-1
ms.dyn365.ops.version: 8.1.1
ms.openlocfilehash: 2ac8dc8787ab0bdb796ec849f9ede3f697b09680
ms.sourcegitcommit: 74e47075eab2b0b28f82b0d57f439719847ecb01
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 06/07/2021
ms.locfileid: "6193647"
---
# <a name="set-up-the-fiscal-integration-for-commerce-channels"></a>コマース チャネルの会計統合の設定

[!include [banner](../includes/banner.md)]

## <a name="introduction"></a>はじめに

このトピックでは、コマース チャネルの会計統合機能を設定するためのガイドラインを提供します。 会計統合の詳細については、[コマースチャネルの会計統合の概要](fiscal-integration-for-retail-channel.md) を参照してください。

会計統合を設定するプロセスには、次のタスクが含まれます。

1. 会計プリンターなどの会計登録目的で使用される会計デバイスまたはサービスを表す、会計コネクタをコンフィギュレーションします。
2. 会計コネクタによって会計デバイスまたはサービスに登録される会計ドキュメントを生成するドキュメント プロバイダーをコンフィギュレーションします。
3. 一連の会計登録のステップと、各ステップごとに使用される会計コネクタおよび会計ドキュメント プロバイダーを定義する会計登録プロセスをコンフィギュレーションします。
4. 会計登録プロセスを販売時点管理 (POS) 機能プロファイルに割り当てます。
5. コネクタ技術プロファイルをハードウェア プロファイルに割り当てます。

## <a name="set-up-a-fiscal-registration-process"></a>会計登録プロセスの設定

会計統合機能を使用する前に、次の設定をコンフィギュレーションする必要があります:

1. コマース パラメーターを更新します。

    1. **コマース共有パラメーター** ページの、**一般** タブで、**会計統合の有効化** オプションを **はい** に設定します。 **番号順序** タブで、次の参照の番号順序を定義します。

        - 会計技術プロファイル番号
        - 会計コネクタ グループ番号
        - 登録プロセス番号

    2. **コマース パラメーター** ページで、会計機能プロファイル番号の番号順序を定義します。

    > [!NOTE]
    > 番号順序はオプションです。 会計統合エンティティのすべての番号は、番号順序からまたは手動で生成できます。

2. 会計コネクタおよび会計ドキュメント プロバイダーのコンフィギュレーションをアップロードします。

    会計ドキュメント プロバイダーは、会計デバイスまたはサービスとのやり取りにも使用される形式で POS に登録されているトランザクションおよびイベントを表す会計ドキュメントを生成を担当します。 たとえば、会計ドキュメント プロバイダーは、XML 形式表記の会計レシートを生成する可能性があります。

    会計コネクタは、会計デバイスまたはサービスとの通信を担当します。 たとえば、会計コネクタは、会計ドキュメント プロバイダーが XML 形式で作成した会計レシートを会計プリンターに送信する可能性があります。 会計統合コンポーネントの詳細については、「[会計デバイスの会計登録プロセスおよび会計統合サンプル](fiscal-integration-for-retail-channel.md#fiscal-registration-process-and-fiscal-integration-samples-for-fiscal-devices)」を参照してください。

    1. **会計コネクタ** ページ (**小売とコマース \> チャネル設定 \> 会計統合 \> 会計コネクタ**) で、会計統合のために使用する予定のデバイスまたはサービスごとに XML コンフィギュレーションをアップロードします。

        > [!TIP]
        > **表示** を選択することによって、現在の会計コネクタに関連するすべての機能および技術プロファイルを表示できます。

    2. **会計ドキュメント プロバイダー** ページ (**小売とコマース \> チャネル設定 \> 会計統合 \> 会計ドキュメント プロバイダー**) で、使用する予定のデバイスまたはサービスごとに XML コンフィギュレーションをアップロードします。

        > [!TIP]
        > **表示** を選択することによって、現在の会計ドキュメント プロバイダーに関連するすべての機能プロファイルを表示できます。

    会計コネクタおよび会計ドキュメント プロバイダーのコンフィギュレーションの例については、「[Retail SDK の会計統合サンプル](fiscal-integration-for-retail-channel.md#fiscal-integration-samples-in-the-retail-sdk)」を参照してください。

    > [!NOTE]
    > データ マッピングは、会計ドキュメント プロバイダーの一部と見なされます。 同じコネクター (たとえば、州固有の規則) に異なるデータ マッピングを設定するには、異なる会計文書プロバイダーを作成する必要があります。

3. コネクタ機能プロファイルおよびコネクタ技術プロファイルを作成します。

    1. **コネクタ機能プロファイル** ページ (**小売とコマース \> チャネル設定 \> 会計統合 \> コネクタ機能プロファイル**) で、この会計コネクタに関連する会計コネクタおよび会計ドキュメント プロバイダーの組み合わせごとにコネクタ機能プロファイルを作成します。

        1. コネクタ名を選択します。
        2. ドキュメント プロバイダーを選択します。

        コネクタ機能プロファイルのデータ マッピング パラメーターを変更できます。 会計ドキュメント プロバイダー構成で定義されている既定のパラメーターを復元するには、**更新** を選択します。

        **例**

        | パラメーター  | 書式設定 | 例 |
        |---|--------|---------|
        | **VAT 率の設定** | 値 : VATrate | 1 : 2000, 2 : 1800 |
        | **VAT コードのマッピング** | VATcode : 値 | vat20: 1、vat18: 2 |
        | **支払/入金タイプのマッピング** | TenderType: 値 | 現金 : 1, カード : 2 |

        > [!NOTE]
        > コネクタ機能プロファイルは、会社に固有です。 異なる会社で会計コネクタと会計ドキュメント プロバイダーの同じ組み合わせを使用する予定の場合は、会社ごとにコネクタ機能プロファイルを作成する必要があります。

    2. **コネクタ技術プロファイル** ページ (**小売とコマース \> チャネル設定 \> 会計統合 \> コネクタ技術プロファイル**) で、会計コネクタごとにコネクタ技術プロファイルを作成します。

        1. コネクタ名を選択します。
        2. コネクタ タイプを選択します。 ハードウェア ステーションに接続されているデバイスについては、**ローカル** を選択します。

            > [!NOTE]
            > ローカル コネクタだけが現在サポートされています。

        コネクタ技術プロファイルの **デバイス** および **設定** タブで、パラメーターを変更できます。 会計コネクタ構成で定義されている既定のパラメーターを復元するには、**更新** を選択します。 XML 構成の新しいバージョンが読み込まれている間は、現在の会計コネクタまたは会計ドキュメント プロバイダーが既に使用されていることを示すメッセージが表示されます。 この手順では、コネクタ機能プロファイルとコネクタ技術プロファイルで以前に行われた手動変更を上書きしません。 新しいコンフィギュレーションから既定のパラメーター セットを適用するには、**コネクタ機能プロファイル** ページまたは **コネクタ技術プロファイル** ページで、**更新** を選択します。

4. 会計コネクタ グループを作成します。

    会計コネクタ グループは、同じ機能を実行し、会計登録プロセスの同じ手順で使用される会計コネクタの機能プロファイルを組み合わせます たとえば、店舗で複数の会計処理用プリンター モデルが使用できる場合、それらの会計プリンターの会計コネクタは会計コネクタ グループで組み合わされます。

    1. **会計コネクタ グループ** ページ (**小売とコマース \> チャネル設定 \> 会計統合 \> 会計コネクタグループ**) で、新しい会計コネクタ グループを作成します。
    2. 機能プロファイルをコネクタ グループに追加します。 **機能プロファイル** タブで **追加** を選択してから、プロファイル番号を選択します。 コネクタ グループの各会計コネクタには 1 つの機能プロファイルしか含めることができません。
    3. 機能プロファイルの使用を中断するには、**無効化** オプションを **はい** に設定します。 この変更は、現在のコネクタ グループのみに影響します。 他のコネクタ グループで同じ機能プロファイルを引き続き使用できます。

5. 会計登録プロセスを作成します。

    会計登録プロセスは、登録ステップおよび各ステップで使用されるコネクタ グループの順序によって定義されます。

    1. **会計登録プロセス** ページ (**小売とコマース \> チャネル設定 \> 会計統合 \> 会計登録プロセス**) で、会計統合の固有のプロセスごとに新しいレコードを作成します。
    2. プロセスに登録ステップを追加します:

        1. **追加** を選択します。
        2. 会計コネクタ タイプを選択します。
        3. **グループ番号** フィールドで、適切な会計コネクタ グループを選択します。

6. 会計登録プロセスのエンティティを POS プロファイルに割り当てます。

    1. **POS 機能プロファイル** ページ (**Retail とコマース \> チャネル設定 \> POS 設定 \> POS プロファイル \> 機能プロファイル**) で、会計登録プロセスを POS 機能プロファイルに割り当てます。 **編集** を選択してから、**会計登録プロセス** タブの **プロセス番号** フィールドで、プロセスを選択します。
    2. **POS ハードウェア プロファイル** ページ (**Retail とコマース \> チャネル設定 \> POS 設定 \> POS プロファイル \> ハードウェア プロファイル**) で、コネクタ技術プロファイルをハードウェア プロファイルに割り当てます。 **編集** を選択し、**会計周辺機器** タブに明細行を追加してから、**プロファイル番号** フィールドで、コネクタ技術プロファイルを選択します。

    > [!NOTE]
    > 同じハードウェア プロファイルに、複数の技術プロファイルを追加できます。 ただし、ハードウェア プロファイルまたは POS 機能プロファイルには、各会計コネクタ グループとの共通部分が 1 つしかありません。

    会計登録フローは会計登録プロセスおよび会計統合コンポーネントのいくつかのパラメーターによって定義されます。会計ドキュメント プロバイダーの Commerce runtime 拡張機能および会計コネクタのハードウェア ステーション拡張機能。

    - イベントのサブスクリプションおよび会計登録のトランザクションは、会計ドキュメント プロバイダーで事前定義されます。
    - 会計ドキュメント プロバイダーは、会計登録に使用される会計コネクタを識別することも担当します。 会計登録プロセスの現在のステップに対して指定されている会計コネクタ グループに含まれるコネクタ機能プロファイルと、POS が対になっているハードウェア ステーションのハードウェア プロファイルに割り当てられているコネクタ技術プロファイルが一致します。
    - 会計ドキュメント プロバイダーは、会計ドキュメント プロバイダー構成からのデータのマッピング設定を使用し、会計ドキュメントの生成中に税金や支払などのトランザクション/イベント データを変換します。
    - 会計ドキュメント プロバイダーが会計ドキュメントを生成する場合、通信方法に応じて、会計コネクタはそれを会計デバイスにそのまま送信するか、またはそれを解析しデバイスのアプリケーション プログラミング インターフェイス (API) の一連のコマンドに変換できます。

7. **会計登録プロセス** ページ (**Retail とコマース \> チャネル設定 \> 会計統合 \> 会計登録プロセス**) で、**検証** を選択して会計統合プロセスを検証します。

    次の例で示すように、このタイプの検証を実行することをお勧めします。

    - 新しい登録プロセスをPOS 機能プロファイルおよびハードウェア プロファイルへ割り当てる場合を含む、新しい登録プロセスのすべての設定が完了した後。
    - 既存の会計登録プロセスに変更を加え、それらの変更が原因で異なる会計コネクタが実行時に選択されるようになった後 (たとえば、会計登録プロセス手順のコネクタ グループを変更して、コネクタ グループのコネクタ機能プロファイルを有効にする、またはコネクタ グループに新しいコネクタ機能プロファイルを追加する場合)。
    - コネクタ技術プロファイルのハードウェア プロファイルへの割り当てで変更を加えた後。

8. **配送スケジュール** ページで、**1070** および **1090** ジョブを実行してチャネル データベースにデータを転送します。

## <a name="set-up-fiscal-texts-for-discounts"></a>割引用の会計テキストの設定

場合によっては、割引が適用される場合に特別なテキストが会計レシートに印刷される必要があります。 **会計コネクタ グループ** ページ (**Retail とコマース \> チャネル設定 \> 会計統合 \> 会計コネクタ グループ**) で、割引用の会計テキストを設定できます。

- POS で適用される手動割引の場合は、POS 機能プロファイルで **製品割引** 情報コードとして指定されている情報コードまたは情報コードグループの会計テキストを設定する必要があります。

    1. **会計コネクタ グループ** ページで、**会計レシートのテキスト** を選択します。
    2. **情報コード** タブで、**追加** を選択し、情報コードまたは情報コード グループを選択します。
    3. **情報コード番号** で、値を選択します。
    4. **サブコード番号** フィールドで、選択されている情報コードにサブコードが必要な場合は、値を選択します。
    5. **会計レシートのテキスト** フィールドで、会計レシートに印刷する必要がある会計テキストを指定します。
    6. **ユーザー入力を会計レシートに印刷** オプションを **はい** に設定して、会計レシート上のテキストをユーザーが POS で手動で入力する情報で上書きします。 このオプションは、**テキスト** の入力タイプである情報コードにのみ適用されます。

    > [!NOTE]
    > 情報コード グループ、リンクされた情報コード、トリガーされた情報コードが使用されるシナリオをサポートするため、いくつかの情報コードの会計テキストを指定できます。 これらのシナリオでは、会計レシートには、割引が適用されたトランザクション明細行にリンクされているすべての情報コードからの会計テキストが含まれます。

- チャネル固有の割引については、割引 ID の会計テキストを定義する必要があります。

    1. **会計コネクタ グループ** ページで、**会計レシートのテキスト** を選択します。
    2. **割引** タブで、**追加** を選択し、割引 ID を選択します。
    3. **会計レシートのテキスト** フィールドで、会計レシートに印刷する必要がある会計テキストを指定します。

    > [!NOTE]
    > 同じトランザクション明細行にいくつかの割引が適用される場合、会計レシートにはそれらのトランザクション明細行にリンクされているすべての割引からの会計テキストが含まれます。

## <a name="set-error-handling-settings"></a>エラーの処理の設定

会計統合で使用可能なエラー処理オプションは、会計登録プロセスで設定されます。 会計統合のエラー処理の詳細については、「[エラー処理](fiscal-integration-for-retail-channel.md#error-handling)」を参照してください。

1. **会計登録プロセス** ページ (**Retail とコマース \> チャネル設定 \> 会計統合 \> 会計登録プロセス**) で、会計統合プロセスごとに次のパラメーターを設定できます。

    - **スキップを許可** – このパラメーターは、エラー処理ダイアログ ボックスで **スキップ** オプションを有効にします。
    - **登録済としてマークを許可** – このパラメーターは、エラー処理ダイアログ ボックスで、**登録済としてマーク** オプションを有効にします。
    - **エラーでも続行** : このパラメーターが有効になっている場合、トランザクションまたはイベントの会計登録が失敗しても、会計登録プロセスは POS レジスターで続行できます。 それ以外の場合、次の取引またはイベントの会計登録を実行するため、オペレーターは失敗した会計登録を再試行するか、スキップ、あるいは取引またはイベントを登録済としてマークする必要があります。 詳細については、[任意の会計登録](fiscal-integration-for-retail-channel.md#optional-fiscal-registration) を参照してください。

    > [!NOTE]
    > **エラーでも続行** パラメーターが有効になっている場合、**スキップを許可** および **登録済としてマークを許可** パラメータは自動的に無効になります。

2. エラー処理ダイアログ ボックスの **スキップ** および **登録済としてマーク** オプションには、**登録をスキップまたは登録済としてマークを許可** のアクセス許可が必要です。 したがって、**アクセス許可グループ** ページ (**Retail とコマース \> 従業員 \> アクセス許可グループ**) で、**登録のスキップまたは登録済としてマークを許可** のアクセス許可を有効にします。
3. **スキップ** および **登録済としてマーク** オプションは、会計登録が失敗した場合に演算子が追加情報を入力するようにします。 この機能を使用可能にするには、会計コネクタ グループの **スキップ** および **登録済としてマーク** 情報コードを指定する必要があります。 これにより、演算子が入力した情報は、会計トランザクションにリンクされている情報コード トランザクションとして保存されます。 情報コードの詳細については、「[情報コードおよび情報コード グループ](../info-codes-retail.md)」を参照してください。

    > [!NOTE]
    > **製品** トリガー関数は、会計コネクタ グループの **スキップ** および **登録済としてマーク** に使用される情報コード用にはサポートされていません。

    - **会計コネクタ グループ** ページの、**情報コード** タブで、**スキップ** および **登録済としてマーク** フィールドの情報コードまたは情報コード グループを選択します。

    > [!NOTE]
    > 1 つの会計ドキュメントおよび 1 つの非会計ドキュメントは、会計登録プロセスのどの手順においても生成できます。 会計ドキュメント プロバイダー拡張機能は、会計または非会計ドキュメントに関連するものとして、すべてのタイプのトランザクションまたはイベントを識別します。 エラー処理機能は、会計ドキュメントのみに適用されます。
    >
    > - **会計ドキュメント** – 正常に登録される必要がある必須ドキュメント (たとえば、会計レシート)。
    > - **非会計ドキュメント** – トランザクションまたはイベントの補足ドキュメント (たとえば、ギフト カード明細)。

4. 正常性エラーが発生した後、オペレータが現在の操作（取引の作成または終了処理など）の処理を続行する必要がある場合は、**アクセス許可グループ** ページ (**Retail とコマース \>従業員\>アクセス許可グループ**) で **正常性チェック エラーのスキップを許可** のアクセス許可を有効にする必要があります。 正常性チェック手順の詳細については、[会計登録正常性チェック](fiscal-integration-for-retail-channel.md#fiscal-registration-health-check)を参照してください。

## <a name="set-up-fiscal-xz-reports-from-the-pos"></a>POS からの会計 X/Z レポートの設定

会計 X/Z レポートの POS での実行を有効にするには、POS レイアウトに新しいボタンを追加する必要があります。

- **ボタン グリッド** ページで、[ボタン グリッド デザイナーを使用して POS レイアウトに POS 操作を追加する](../dev-itpro/add-pos-operations.md#add-a-custom-operation-button-to-the-pos-layout-in-retail-headquarters) の手順に従って、デザイナーをインストールし、POS レイアウトを更新します。

    1. 更新するレイアウトを選択します。 
    2. 新しいボタンを追加し、**会計 X を印刷** ボタン プロパティを設定します。
    3. 新しいボタンを追加し、**会計 Z を印刷** ボタン プロパティを設定します。
    4. **配送スケジュール** ページで、**1090** ジョブを実行してチャネル データベースに変更を転送します。

## <a name="enable-manual-execution-of-postponed-fiscal-registration"></a>延期された会計登録の手動実行を有効化

延期された会計登録の手動実行を有効にするには、POS レイアウトに新しいボタンを追加する必要があります。

- **ボタン グリッド** ページで、[ボタン グリッド デザイナーを使用して POS レイアウトに POS 操作を追加する](../dev-itpro/add-pos-operations.md#add-a-custom-operation-button-to-the-pos-layout-in-retail-headquarters) の手順に従って、デザイナーをインストールし、POS レイアウトを更新します。

    1. 更新するレイアウトを選択します。
    2. 新しいボタンを追加し、**会計登録のプロセスを完了** ボタン プロパティを設定します。
    3. **配送スケジュール** ページで、**1090** ジョブを実行してチャネル データベースに変更を転送します。


[!INCLUDE[footer-include](../../includes/footer-banner.md)]