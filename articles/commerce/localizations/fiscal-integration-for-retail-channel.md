---
title: Commerce チャネルの会計統合の概要
description: このトピックでは、Dynamics 365 Commerce で使用できる会計統合の機能の概要を提供します。
author: EvgenyPopovMBS
ms.date: 03/04/2022
ms.topic: article
audience: Application User, Developer, IT Pro
ms.reviewer: v-chgriffin
ms.search.region: Global
ms.author: epopov
ms.search.validFrom: 2017-06-20
ms.openlocfilehash: 46e0afd5a8cb692da56a7d5f261ca30d9b3aaa80
ms.sourcegitcommit: b80692c3521dad346c9cbec8ceeb9612e4e07d64
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/05/2022
ms.locfileid: "8388316"
---
# <a name="fiscal-integration-overview-for-commerce-channels"></a>Commerce チャネルの会計統合の概要

[!include [banner](../includes/banner.md)]
[!include[banner](../includes/preview-banner.md)]

このトピックは、Dynamics 365 Commerce で使用できる会計統合の機能についての概要です。 

会計統合には、小売業界での税金の詐欺防止を目的とした地方の会計法に従って、販売の会計登録を可能にするさまざまな会計デバイスおよびサービスとの統合が含まれます。 会計統合を使用してカバーすることができる典型的なシナリオを以下に示します:

- 会計プリンターのような、POS (販売時点管理) に接続している会計デバイスに販売を登録してから、顧客に会計レシートを印刷します。
- Retail POS で完了した販売と返品に関する情報を、税務当局が運営する外部の Web サービスに安全に送信します。
- デジタル署名での販売トランザクション データの改ざん防止を徹底するのに役立ちます。

会計統合機能は、Retail POS と会計デバイスおよび会計サービスとの統合のさらなる開発とカスタマイズのための共通のソリューションを提供するフレームワークです。 この機能には、特定の国または地域の基本的なシナリオをサポートし、特定の会計デバイスまたはサービスと連携する会計統合サンプルも含まれています。 会計統合サンプルは、コマース コンポーネントのいくつかの拡張機能で構成され、ソフトウェア開発キット (SDK) が含まれます。 会計統合のサンプルの詳細については、[Commerce SDK の会計統合のサンプル](#fiscal-integration-samples-in-the-commerce-sdk) を参照してください。 Commerce SDK のインストールと使用方法については、[Retail ソフトウェア開発キット (SDK) のアーキテクチャ](../dev-itpro/retail-sdk/retail-sdk-overview.md) を参照してください。

他の会計デバイスまたはサービスと Retail POS を統合する、または他の国や地域の要件をカバーするために、会計統合サンプルでサポートされていない他のシナリオをサポートするには、既存の会計統合サンプルを拡張するか、例として既存のサンプルを使用することによって新しいサンプルを作成する必要があります。

## <a name="fiscal-registration-process-and-fiscal-integration-samples-for-fiscal-devices-and-services"></a>会計デバイスおよび会計サービスの会計登録プロセスおよび会計統合サンプル

Retail POS の会計登録プロセスは、1 つまたは複数のステップで構成できます。 各ステップには、1 つの会計デバイスまたはサービスでの特定の取引またはイベントの会計登録が含まれます。 次のソリューション コンポーネントは、会計デバイスまたはサービスの会計登録に参加します:

- **会計ドキュメント プロバイダー** - このコンポーネントは、会計デバイスまたはサービスとのやり取りにも使用される形式でトランザクション/イベント データをシリアル化し、会計デバイスまたはサービスからの応答を解析し、その応答をチャネル データベースに格納します。 拡張機能は、登録する必要がある特定のトランザクションおよびイベントも定義します。
- **会計コネクタ**- このコンポーネントは、会計デバイスまたはサービスとの通信を初期化し、会計ドキュメントから抽出されたトランザクション/イベント データに基づいて会計デバイスまたはサービスに要求やダイレクト コマンドを送信し、会計デバイスまたはサービスからの応答を受信します

会計統合サンプルには、会計ドキュメント プロバイダーおよび会計コネクター用の、Commerce Runtime (CRT)、Hardware Station、POS 拡張機能が含まれる場合があります。 次のコンポーネントの構成も含まれます:

- **会計ドキュメント プロバイダー構成** - この構成は、出力メソッドおよび会計ドキュメントの形式を定義します。 また、Retail POS からのデータと、会計デバイスまたはサービス ファームウェアで事前定義されている値との互換性を維持するための、税金と支払い方法のデータ マッピングも含まれています。
- **会計コネクタ構成** - この構成は、特定の会計デバイスまたはサービスとの物理的な通信を定義します。

特定の POS レジスターの会計登録プロセスは、POS 機能プロファイルの対応する設定によって定義されます。 会計登録プロセスの構成、会計ドキュメント プロバイダーおよび会計コネクタ構成のアップロード、構成パラメーターを変更する方法の詳細については、[会計登録プロセスの設定](setting-up-fiscal-integration-for-retail-channel.md#set-up-a-fiscal-registration-process) を参照してください。

> [!NOTE]
> 製品カタログ検索、顧客ルックアップ、トランザクション ドラフトの作成など、会計以外の工程にデバイスが必要な場合は、会計処理制限を適用するレジスターとして選択できます。 詳細については、[会計登録制限を使用したレジスターの設定](setting-up-fiscal-integration-for-retail-channel.md#set-up-registers-with-fiscal-registration-restrictions)を参照してください。

次の一般的な会計登録フローは、POS のイベント (例えば、販売トランザクションの完了) から始まり、他の Commerce コンポーネント (CRT や Hardware Station など) を含む事前定義済の一連のステップを実装します。

1. POS は、会計統合フレームワーク (FIF) に会計ドキュメントを要求します。
1. FIF は、現在のイベントが会計登録を必要とするかどうかを決定します。
1. 会計登録プロセスの設定に基づいて、FIF は、会計登録に使用する会計コネクタおよび対応する会計ドキュメント プロバイダーを識別します。
1. FIF は、トランザクションまたはイベントを表す会計ドキュメント (たとえば、XML ドキュメント) を生成する会計ドキュメント プロバイダーを実行します。
1. FIF は、生成された会計ドキュメントを POS に返します。
1. POS は、FIF が会計デバイスまたはサービスに会計ドキュメントを送信することを要求します。
1. FIF は、会計ドキュメントを処理し、会計デバイスまたはサービスに送信する会計コネクタを実行します。
1. FIF は会計応答 (つまり、会計デバイスまたはサービスの応答) を POS に返します。
1. POS は、会計応答を分析して、会計登録が成功したかどうかを判断します。 必要に応じて、POS は、FIF が発生したエラーを処理するように要求します。 
1. POS は、FIF が会計応答を処理して保存することを要求します。
1. 会計ドキュメント プロバイダーは、会計応答を処理します。 この処理の一環として、会計ドキュメント プロバイダーは応答を解析し、そこから拡張データを抽出します。
1. FIF は応答および拡張データをチャンネル データベースに保存します。
1. 必要に応じて、POS は Hardware Station に接続された通常のレシート プリンターでレシートを印刷します。 レシートには、会計応答から必要なデータを含めることができます。
 
次の例は、一般的な会計デバイスまたはサービスの会計登録実行フローを示します。
 
### <a name="fiscal-registration-is-done-via-a-device-connected-to-the-hardware-station"></a>会計登録は Hardware Station に接続されたデバイスにより行われます

この構成は、会計プリンタなどの物理的な会計デバイスが Hardware station に接続されている場合に使用されます。 また、会計デバイスまたはサービスとの通信が、Hardware station にインストールされたソフトウェアにより行われる場合にも適用されます。 この場合、会計ドキュメント プロバイダーは CRT 上にあり、会計コネクタは Hardware station 上にあります。

![Hardware Station に接続されたデバイスにより行われる会計登録。](media/FIF-CRT-HWS.png)

### <a name="fiscal-registration-is-done-via-an-external-service"></a>会計登録は外部サービスにより行われます

この構成は、税務当局が運用する Web サービスなどの外部サービスにより会計登録を行う場合に使用されます。 この場合、会計ドキュメント プロバイダーと会計コネクタは両方とも CRT 上にあります。

![外部サービスにより行われる会計登録。](media/FIF-CRT-CRT.png)
 
### <a name="fiscal-registration-is-done-internally-in-the-crt"></a>会計登録は CRT で内部的に行われます

この構成は、会計登録に外部会計デバイスまたはサービスが必要ない場合に使用されます。 たとえば、販売トランザクションのデジタル署名により会計登録が行われる場合に使用されます。 この場合、会計ドキュメント プロバイダーと会計コネクタは両方とも CRT 上にあります。

![会計登録は CRT で内部的に行われます。](media/FIF-CRT-CRT-SGN.png)

### <a name="fiscal-registration-is-done-via-a-device-or-service-in-the-local-network"></a>会計登録はローカル ネットワークのデバイスまたはサービスにより行われます

この構成は、物理的な会計デバイスまたは会計サービスが店舗のローカル ネットワークに存在し、HTTPS アプリケーション プログラミング インターフェイス (API) を提供する場合に使用されます。 この場合、会計ドキュメント プロバイダーは CRT 上にあり、会計コネクタは POS 上にあります。

![会計登録はローカル ネットワークのデバイスまたはサービスにより行われます。](media/FIF-CRT-POS.png)

## <a name="error-handling"></a>エラー処理

会計統合フレームワークは、会計登録中のエラーを処理するための次のオプションを提供します:

- **再試行** – オペレーターは、エラーが迅速に解決され、会計登録が再実行される場合にこのオプションを使用することができます。 たとえば、会計デバイスが接続されていないときや、会計プリンターが用紙切れ、または会計プリンターで紙詰まりがあるときに、このオプションを使用することができます。
- **キャンセル** – このオプションを使用すると、オペレーターは現在のトランザクションまたはイベントの会計登録が失敗した場合に延期することができます。 登録が延期された後も、オペレーターは POS の作業を続けることができ、会計登録に必要のない操作を完了することができます。 会計登録を必要とするイベントが POS で発生すると (たとえば、新しいトランザクションが開かれると)、エラー処理ダイアログ ボックスが自動的に表示され、前のトランザクションが正しく登録されなかったことをオペレーターに通知し、エラー処理オプションを提供します。
- **スキップ** – 特定の条件下で会計登録を省略でき、POS で通常の操作を続行できる場合、オペレーターはこのオプションを使用できます。 たとえば、このオプションは、会計登録が失敗した販売トランザクションを特別な紙の仕訳帳に登録できる場合に使用できます。
- **登録済としてマーク** – オペレーターは、トランザクションが会計デバイスに実際に登録されている (たとえば、会計レシートが印刷された) ときにこのオプションを使用できますが、会計応答がチャネル データベースに保存されているときにはエラーが発生しました。
- **延期** – 登録サービスが利用できなかったためにトランザクションを変更した場合、オペレーターはこのオプションを使用できます。 

> [!NOTE]
> **スキップ**、**登録済としてマーク**、**延期** のオプションは、使用する前に会計登録プロセスで有効化する必要があります。 さらに、対応するアクセス許可をオペレーターに付与する必要があります。

**スキップ**、**登録済としてマーク**、**延期** のオプションでは、エラーの理由や会計登録をスキップしたりトランザクションを登録済としてマークすることの妥当性など、エラーに関する特定の情報を情報コードで取得できます。 エラー処理のパラメーターを設定する方法の詳細については、[エラー処理の設定](setting-up-fiscal-integration-for-retail-channel.md#set-error-handling-settings) を参照してください。

### <a name="optional-fiscal-registration"></a>任意の会計登録

会計登録は、いくつかの操作では必須ですが、他の操作ではオプションの場合があります。 たとえば、通常の販売および返品の会計登録は必須かもしれませんが、顧客預金に関連する操作の会計登録はオプションの場合があります。 この場合、販売の会計登録を完了していないとそれ以降の販売はブロックされますが、顧客預金の会計登録が完了していなくても、販売はブロックされません。 必須操作とオプション操作を区別するために、さまざまなドキュメント プロバイダーを介してそれらを処理し、それらのプロバイダーの会計登録プロセスに別々のステップを設定することをお勧めします。 オプションの会計登録に関連するすべてのステップで、**エラーでも続行** パラメーターを有効にする必要があります。 エラー処理のパラメーターを設定する方法の詳細については、[エラー処理の設定](setting-up-fiscal-integration-for-retail-channel.md#set-error-handling-settings) を参照してください。

### <a name="manually-rerun-fiscal-registration"></a>会計登録を手動で再実行

トランザクションまたはイベントの会計登録が失敗後に延期された場合 (たとえば、オペレーターがエラー処理ダイアログ ボックスで **キャンセル** を選択した場合)、 対応する操作を呼び出して手動で会計登録を再実行できます。 詳細については、[延期された会計登録の手動実行を有効にする](setting-up-fiscal-integration-for-retail-channel.md#enable-manual-execution-of-postponed-fiscal-registration)を参照してください。

### <a name="postpone-option"></a>延期オプション

**延期** オプションを使用すると、現在のステップが失敗した場合に会計登録プロセスを続行できます。 会計登録のバックアップ オプションがある場合に使用できます。

### <a name="fiscal-registration-health-check"></a>会計登録の正常性チェック

会計登録の正常性チェック手順では、特定のイベントが発生したときに会計デバイスまたはサービスの使用可能性を確認します。 会計登録を現在完了することができない場合は、オペレーターに事前に通知されます。

次のイベントが発生すると、POS は正常性チェックを実行します。

- 新しいトランザクションが開く。
- 一時停止したトランザクションが呼び出される。
- 販売または返品トランザクションが確定する。

正常性チェックが失敗すると、POS は正常性チェック ダイアログ ボックスを表示します。 このダイアログ ボックスには、次のボタンが表示されます。

- **OK**: このボタンをクリックすると、オペレーターは正常性チェックのエラーを無視して操作の処理を続行できます。 **正常性チェック エラーのスキップを許可** が有効になっている場合にのみ、オペレーターはこのボタンを選択することができます。
- **キャンセル** : オペレーターがこのボタンを選択すると、POS は最後のアクションをキャンセルします (たとえば、アイテムは新しいトランザクションに追加されません)。

> [!NOTE]
> 正常性チェックは、現在の操作で会計登録が必要な場合、および会計登録プロセスの現在のステップで **エラーでも続行** パラメーターが無効になっている場合のみ実行されます。 詳細については、[エラー処理の設定](setting-up-fiscal-integration-for-retail-channel.md#set-error-handling-settings)を参照してください。

## <a name="storing-fiscal-response-in-fiscal-transaction"></a>会計トランザクションの会計応答を保存しています。

トランザクションまたはイベントの会計登録が成功すると、チャネル データベースに会計トランザクションが作成され、元のトランザクションまたはイベントにリンクされます。 同様に、**スキップ** または **登録済としてマーク** オプションが、失敗した会計登録に対して選択されている場合、この情報は会計トランザクションに格納されます。 会計トランザクションには、会計デバイスまたはサービスの会計応答が保持されます。 会計登録プロセスがいくつかのステップで構成されている場合は、登録の成功または失敗をもたらしたプロセスの各ステップに対して会計トランザクションが作成されます。

会計トランザクションは、トランザクションと共に *P ジョブ* によって本社に転送されます。 **店舗のトランザクション** ページの **トランザクション** クイック タブで、小売トランザクションにリンクされている会計トランザクションを表示することができます。

会計トランザクションには、次の詳細が格納されます:

- 会計登録プロセスの詳細 (プロセス、コネクタ グループ、コネクタなど)。 この情報が会計応答に含まれている場合は、**登録番号** フィールドに、会計デバイスのシリアル番号も格納します。
- 会計登録のステータス: 登録が成功した場合は **完了**、オペレーターが失敗した登録に **スキップ** オプションを選択した場合は **スキップ**、オペレーターが **登録済としてマーク** オプションを選択した場合は **登録済としてマーク**、オペレーターが **延期** オプションを選択した場合は **延期**。
- 選択した会計トランザクションに関連する情報コード トランザクション。 情報コード トランザクションを表示するには、**会計トランザクション** FastTab で、ステータスが **スキップ**、**登録済としてマーク**、または **延期** になっている会計トランザクションを選択してから、**情報コード トランザクション** を選択します。

**拡張データ** を選択すると、会計トランザクションの一部のプロパティも表示できます。 表示できるプロパティの一覧は、会計トランザクションを生成した会計登録機能に固有です。 たとえば、フランスのデジタル署名機能のために、デジタル署名、連番、証明書の拇印、ハッシュ アルゴリズムの ID、および他の会計トランザクションのプロパティを表示できます。

## <a name="fiscal-texts-for-discounts"></a>割引用の会計テキスト

国や地域によっては、さまざまな種類の割引が適用される場合に、会計レシートに印刷する必要がある追加のテキストについての特別な要件があります。 会計統合機能を使用すると、会計レシートの割引明細行の後に印刷される割引用の特別なテキストを設定できます。 手動割引の場合は、POS 機能プロファイルで **製品割引** 情報コードとして指定されている情報コードの会計テキストを構成できます。 割引用の会計テキストを設定する方法の詳細については、[割引用の会計のテキストの設定](setting-up-fiscal-integration-for-retail-channel.md#set-up-fiscal-texts-for-discounts) を参照してください。

## <a name="printing-fiscal-x-and-fiscal-z-reports"></a>会計 X および会計 Z レポートの印刷

会計統合機能は、統合された会計デバイスまたはサービスに固有の、営業終了時の明細書の生成をサポートします:

- POS 画面レイアウトには、対応する操作を実行する新しいボタンを追加する必要があります。 詳細については、[会計 X/Z レポートを POS から設定する](setting-up-fiscal-integration-for-retail-channel.md#set-up-fiscal-xz-reports-from-the-pos) を参照してください。
- 会計統合サンプルでは、これらの操作は会計デバイスの対応する操作に一致する必要があります。

## <a name="fiscal-integration-samples-in-the-commerce-sdk"></a>Commerce SDK の会計統合サンプル

次の会計統合サンプルは、現在 Commerce SDK で使用できます:

- [イタリア向け会計プリンター統合サンプル](./emea-ita-fpi-sample.md)
- [ポーランド向け会計プリンター統合サンプル](./emea-pol-fpi-sample.md)
- [オーストリア向け会計登録サービス統合サンプル](./emea-aut-fi-sample.md)
- [チェコ共和国向け会計登録サービス統合サンプル](./emea-cze-fi-sample.md)
- [スウェーデン向け制御ユニットの統合サンプル](./emea-swe-fi-sample.md)
- [ドイツ向け会計登録サービス統合サンプル](./emea-deu-fi-sample.md)
- [ロシア向け会計プリンター統合サンプル](./rus-fpi-sample.md)

会計統合フレームワークを使用して次の会計統合機能も実装されますが、この機能はそのまま使用でき、Commerce SDK には含まれていません。

- [ブラジル向け会計登録](./latam-bra-commerce-localization.md#fiscal-registration-for-brazil)
- [フランス向けデジタル署名](./emea-fra-cash-registers.md)

次の会計統合機能は、Commerce SDK でも利用可能ですが、現在は会計統合フレームワークを利用していません。 この機能の会計統合フレームワークへの移行は、今後の更新で予定されています。

- [ノルウェー向けデジタル署名](./emea-nor-cash-registers.md)

Commerce SDK で使用可能な次のレガシ会計統合機能は、会計統合フレームワークを使用せず、それ以降の更新では非推奨になります。

- [スウェーデン向け制御ユニットの統合サンプル (レガシ)](./retail-sdk-control-unit-sample.md)
- [フランス向けデジタル署名 (レガシ)](./emea-fra-deployment.md)

[!INCLUDE[footer-include](../../includes/footer-banner.md)]
