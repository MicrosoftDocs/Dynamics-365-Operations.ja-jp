---
title: 支払トークンの使用を制限する
description: この記事では、Microsoft Dynamics 365 Commerce で支払トークンの使用を制限する機能について説明します。
author: BrianShook
ms.date: 10/20/2022
ms.topic: article
audience: Application User, Developer, IT Pro
ms.reviewer: v-chgriffin
ms.search.region: Global
ms.author: brshoo
ms.search.validFrom: 2022-09-20
ms.openlocfilehash: 8092ab0724f33f21759aa84d25e0bdcb5b2ad5dd
ms.sourcegitcommit: 6bd8822f7aa781d596b70956bead834117cf302c
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 10/20/2022
ms.locfileid: "9709657"
---
# <a name="limit-payment-token-usage"></a>支払トークンの使用を制限する

[!include [banner](../includes/banner.md)]
[!include [banner](../includes/preview-banner.md)]

この記事では、Microsoft Dynamics 365 Commerce で支払トークンの使用を制限する機能について説明します。 トークンの使用は販売注文の範囲に限定される場合や、顧客の同意を得た場合はカードとしてファイルに保存されます。

## <a name="key-terms"></a>重要な用語

| 相談 | Description |
|---|---|
| トークン | トランザクション用に支払参照を保存する Dynamics 365 システムの参照 XML BLOB。 |
| ファイル上のカード | Dynamics 365 システムまたは支払ゲートウェイで今後の使用に合意を得ており、顧客のアカウントに固有で保存済みのカード参照トークン。 |

支払トークンの使用に関する制限は、定期的なトークンが採用されている支払ゲートウェイ サービスを使用している環境に適用されます。 すぐに使用できる [Adyen 向け Dynamics 365 Payment Connector](adyen-connector.md) は、定期支払トークンを使用して、認証調整や再承認など後続する注文アクションを実行します。

**支払トークンの使用を注文コンテキストに制限** 機能が、システム内の販売注文の範囲で使用する定期トークンを制限して、定期支払トークンの使用をコントロールします。 この機能を有効にすると、支払入力ページが更新され、新しいトランザクション インスタンスで使用する過去の顧客支払参照を選択できる機能が制限されて、Commerce headquarters のユーザー インターフェイス (UI) が変更されます。

この機能を使用すると、Visa などの支払発行者の使用ルールを満たすことができます。 [Visa のコア ルール、および Visa の製品とサービスに関するルール](https://usa.visa.com/content/dam/VCOM/download/about-visa/visa-rules-public.pdf) では、カード所有者が合意しない限り、支払トークンの使用をトランザクションの範囲に制限しています。

**支払トークンの使用を注文コンテキストに制限する** 機能は、定期的な支払トークン参照を採用する支払ゲートウェイ サービスを使用している場合にのみ有効です。

## <a name="enable-the-feature"></a>機能の有効化

**支払いトークンの使用を注文コンテキストに制限する** 機能を有効にするには、使用している環境の Commerce headquarters で、**ワークスペース \> 機能管理** の順に移動し、リストで **支払いトークンの使用を注文コンテキストに制限する** を検索して選択し、**今すぐ有効にする** を選択します。

## <a name="limit-payment-token-usage"></a>支払トークンの使用を制限する

この機能が有効な場合、支払方法を取り込む際に使用するCommerce headquarters ページでは、顧客用のファイルにある顧客の支払方法を参照する方法が更新されます。 この更新は主に、次の 2 つの操作領域に影響します。

- 顧客の代わりにファイルの顧客カードを入力する方法
- 今後の販売注文の支払エントリについて、顧客に対する支払情報を保存する方法

顧客が Commerce チャネルと取引を行う場合、支払詳細は販売注文コンテキストと一緒に保存されます。 販売注文コンテキストは支払トークンを制限し、Commerce headquarters の新しいまたは編集された販売注文支払の支払ページにある顧客レコードに対する支払参照として使用されないようにします。

### <a name="payment-form-changes"></a>支払フォームの変更

コール センターまたは Commerce headquarters のユーザーが販売注文に対する顧客の支払を実行する場合、支払ページには支払方法の選択の詳細が表示されます。 **支払トークンの使用を注文コンテキストに制限する** 機能が有効になっている場合、ユーザーが支払ページでプラス記号 (**+**) を選択すると、保存されている "ファイルのカード" レコードだけが表示されます。 変更を行う場合は、コール センターまたは Commerce headquarters のユーザーが、顧客が新しい販売注文トランザクションの **顧客支払情報の入力** ページに入力した際に使用した支払詳細のすべてを入力する必要があります。

**番号** フィールドの一覧には、ファイルにカードがある顧客に関連付けられているカード参照だけが含まれます。 これは、販売注文の範囲が設定されていない過去の支払参照をフィルター処理します。

**番号** フィールドのプラス記号 (**+**) は引き続き使用することができ、処理済みの販売注文に関連付けられているトランザクションに対して顧客が指定した支払情報を入力する際に使用できます。

### <a name="how-cards-on-file-work"></a>ファイルのカードの機能

**支払トークンの使用を注文コンテキストに制限する** 機能が有効な場合、ファイルのカードは顧客レコードに対して保存される定期的な支払トークンで、販売注文の範囲に限定されません。 ファイルのカードを使用すると、新しい販売注文の支払用の支払ページに入力したときに、Commerce headquarters ユーザーのクイック リファレンスが有効になります。 このトークン参照は、Dynamics 365環境 にのみ適用できます。 今後支払 iFrame モジュールで使用するときに支払方法を保存できる支払ゲートウェイ サービスを使用するオンライン チャネルの場合、支払ゲートウェイは、これらの参照を Dynamics 365 カードへの別の参照としてファイルに安全に保存します。

たとえば、Adyen 用 Dynamics 365 Commerce Payment Connector をオンライン チャネルで使用している場合、支払い iFrame モジュールでクレジット カードの情報を入力した顧客には、認証時に次回のオンライン購入で保存済みゲートウェイ サービスのカード参照のみが表示されます。 ファイルに保存されている Dynamics 365 環境のカードは、支払 iFrame モジュールのオプションとして表示されません。 同様に、コール センターから注文する場合、オンラインで保存されたカード参照は、コール センターのユーザーのオプションとして表示されません。 コール センターのユーザーには、Dynamics 365 システムからファイル参照にある以前のカードのみが表示され (顧客から合意を得た上で)、今後の注文で使用できるように保存します。

Commerce headquarters のユーザーは、**小売とコマース \> 顧客** に移動して顧客アカウント レコードを選択して顧客のファイルのカードを保存することができます。 支払いページを処理する権限のあるユーザーは、**顧客 \> 設定** セクションで、**クレジット カード** エントリー ページを使用して、今後のトランザクション用のファイルに保存される支払カードを入力できます。 この操作により、今後、顧客の販売注文の支払を処理する場合に時間を節約できます。 コール センターとCommerce headquarters のユーザーは、今後のトランザクションでカード参照を使用することに顧客が合意した場合にのみ、ファイル カードの詳細にカードを入力する必要があります。

Commerce headquarters 支払ページの下方にある **今後の使用のために保存する** チェックボックスを使用して、ユーザーは今後使用するカードをファイルに保存できます。 このチェックボックスは、今後のトランザクションで顧客がファイルのカードを使用することに合意した場合にのみ使用します。 Commerce headquarters の **コール センター パラメーター** ページにある **支払い** タブで、**顧客がファイルのカードを使用することを許可** オプションを使用して、**今後の使用のために保存する** チェックボックスを表示または制限することができます。 **はい** に設定すると、支払ページを処理する権限のある Commerce headquarters のユーザーは、**今後の使用のために保存する** チェックボックスを使用して、ファイルのカードを保存することができます。 このオプションが **いいえ** に設定されている場合、支払ページを処理する権限のある Commerce headquarters のユーザーは、このチェックボックスを使用できません。 **顧客がファイルのカードを使用することを許可する** オプションは、会社が Commerce headquarters での定期的なトークンの使用を制限できますが、顧客の同意を確認する手順に従わない場合は、ファイルのカードを保存することはできません。

### <a name="commerce-headquarters-pages-where-the-recurring-token-restrictions-are-enforced"></a>定期的なトークンの制限が適用される Commerce headquarters ページ

トークンの制限範囲は、機能が有効なときに Commerce headquarters の次の領域に影響します。

- **販売注文 \> 支払 \> 顧客の支払を入力** に表示される顧客の支払情報
- 連続注文
- 分割支払
- 売掛金勘定クレジット カード支払

### <a name="manage-payment-tokens-archiving-or-removal"></a>支払トークンの管理 (アーカイブまたは削除)

**支払トークンの使用を注文コンテキストに制限する** 機能のフラグが有効になる前に (またはこの機能が無効になっている間に) 作成された支払トークンは、システムで "スコープが未指定" のままになり、Commerce headquarters 支払ページの選択リストで参照できます。 これらのトークンは、Commerce headquarters で 2 とおりの方法で定期的に削除できます。

- **クレジット カードのトランザクション データをアーカイブする** ページを使用して、支払トークンを定期的に削除またはアーカイブするジョブを設定します。 **アーカイブせずにデータを削除する** オプションを **はい** に設定する場合、**トランザクションの期間 (日) を最小限にする** 設定を満たすトークンは削除されます。 詳細については、[クレジット カードのトランザクション データをアーカイブ](archive-cc-data.md) を参照してください。
- 新しい **クレジット カード トークンを削除** ページ (**売掛金勘定 \> 照会とレポート \>クリーンアップ \> クレジット カード トークンを削除する**) を使用すると、支払トークンを削除するバッチ ジョブを設定することができます。 次のパラメーターを設定します。

    - **トークンの最短日数** の値は、90 日以上である必要があります。
    - **バックグラウンドで実行** 設定は、**定期的** か **警告** 設定を定義するために使用します。
    - 特定のグループにタスクを実行するためにバッチ グループを割り当てることができます。
    - **プライベート** オプションを **はい** に設定している場合、そのジョブを作成したユーザーのみが実行できます。
    - **重要なジョブ** オプションを **はい** に設定すると、システムがジョブの状態を確実に追跡します。

削除したトークンは取得できません。 **トークンの最短日数** フィールドを、環境で実行されるトランザクションの有効期限が一番長い範囲に設定します (認証から取得や払戻しまで)。

## <a name="additional-resources"></a>追加リソース

[支払に関するよく寄せられる質問](payments-retail.md)

[チェックアウト モジュール](../add-checkout-module.md)

[支払モジュール](../payment-module.md)
