---
title: Commerce Scale Unit のコンフィギュレーションとインストール (自己ホスト)
description: このトピックでは、セルフサービスを使用して、従来型の店舗にあるコンピューターに Commerce Scale Unit (自己ホスト) を構成し、インストールする方法について説明します。
author: jashanno
ms.date: 05/11/2021
ms.topic: article
ms.prod: ''
ms.technology: ''
ms.search.form: SysAADClientTable, RetailCDXDataStore, RetailCDXDataGroup, RetailChannelProfile, RetailSharedParameters, RetailStoreTable
audience: IT Pro
ms.reviewer: tfehr
ms.custom: 219744
ms.assetid: 5e28948f-d40a-40e8-843b-8c2747916546
ms.search.region: Global
ms.search.industry: Retail
ms.author: jashanno
ms.search.validFrom: 2016-11-30
ms.dyn365.ops.version: Version 1611
ms.openlocfilehash: 7eadcefdf3bc057c7a55a45d58f2f15f11b223e7
ms.sourcegitcommit: 9acfb9ddba9582751f53501b82a7e9e60702a613
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 11/10/2021
ms.locfileid: "7782106"
---
# <a name="configure-and-install-commerce-scale-unit-self-hosted"></a>Commerce Scale Unit のコンフィギュレーションとインストール (自己ホスト)

[!include [banner](../includes/banner.md)]

このトピックでは、セルフ サービスを使用して、Microsoft Dynamics 365 Commerce バックオフィスで Commerce Scale Unit (自己ホスト。以前は Retail Store Scale Unit と呼ばれていました) を構成し、ダウンロードして、従来型の店舗にある 1 台以上のコンピューターにインストールする方法について説明します。 Commerce Scale Unit は、コマース チャネル データベース、Commerce Async Client、Retail Server、およびクラウド販売時点管理 (POS) コンポーネントを組み合わせたものです。 コマース環境では、クラウドでこれらのコンポーネントが既に提供されています。 ただし、単一コンピューターのセットアップ (既定のオプション) または複数コンピューターのセットアップのいずれかで、ストアまたはデータ センター内でローカルに動作するように構成できるようになりました。 このトピックは、Commerce Scale Unit のアンインストールとトラブルシューティングの方法についても説明します。

> [!IMPORTANT]
> 基本的な設計原則は、Commerce Scale Unit (クラウド) 上で要求された方法でカスタマイズできない場合は、CSU (自己ホスト) を使用してこの方法をカスタマイズしないことです。  直接データベース アクセスはサポートされていないため、この概念を使用するカスタマイズが容易に中断される可能性があることを理解しておくことが重要です。  CSU (自己ホスト) は、主にクロス ターミナル シナリオの有効化、WAN 接続の不良に備えた待機時間またはバックアップの短縮、および複数の CSU コンポーネント間での POS 端末の負荷を分散するためのスケールアウトの提供を行います。
>
> このコンポーネントは、Azure サービス間の認証に加えてサーバー証明書を利用することに注意してください。  生成された Azure Web アプリケーション キー (旧 *シークレット*) とサーバー証明書の両方が、有効期限に対して管理されている必要があります。  既定では、証明書と生成された Azure web アプリケーション キーは 1 つの暦年 (365日) で期限切れになります。

## <a name="before-you-begin"></a>準備

> [!IMPORTANT]
> 会社全体で高いレベルのセキュリティを維持するために、作成する店舗ごとに新しいアプリケーション ID (クライアント ID) とキー (シークレット) を作成することを強くお勧めします。 このステップでは、新しい Web アプリが必要です。

1. アプリケーション ID (クライアント ID) とキー (シークレット) を作成する Microsoft Azure Active Directory (Azure AD) アプリ登録を生成します。 手順については、[Azure Active Directory アプリケーションを作成する](/azure/azure-resource-manager/resource-group-create-service-principal-portal#create-an-azure-active-directory-application) を参照してください。 このトピックでは、Azure ユーザーのアクセス許可と要件を確認し、アプリ登録を生成する方法について説明します。

    > [!IMPORTANT]
    > Azure ではなく Active Directory Federation Services を使用するオンプレミス環境で使用する Commerce Scale Unit をインストールする場合は、オンプレミス環境の Commerce インストール ドキュメントの手順に従います。 詳細については、[オンプレミス環境での Commerce チャネル コンポーネントのインストール手順](../../fin-ops-core/dev-itpro/deployment/deploy-retail-onprem.md) を参照してください。

2. Commerce Scale Unit のアプリケーション ID (クライアント ID) とキーが作成された後、Commerce でクライアント ID を受け入れる必要があります。 **システム管理** &gt; **設定** &gt; **Azure Active Directory アプリケーション** の順に移動します。 アプリケーション ID (クライアントID) を **クライアント ID** 列に入力し、説明のテキストを **名** 列に入力および **RetailServiceAccount** を **ユーザー ID** 列に入力します。

## <a name="configure-a-new-commerce-scale-unit"></a>新しい Commerce Scale Unit の構成

機能する Commerce Scale Unit を作成するには、「複数のコンピューターのインストール」セクションまでこのトピックのすべてのセクションの手順を完了します。 構成とインストールを完了するには、まず Headquarters で初期構成を行う必要があります。 次に、インストールを完了する必要があります。 最後に、Commerce Scale Unit が正しく動作するよう、Headquarters に戻って構成を完了する必要があります。

> [!IMPORTANT]
> オンプレミス環境では、チャネル機能は Commerce Scale Unit (自己ホスト) の使用により排他的に有効になります。 概要については、Commerce Scale Unit (自己ホスト) を参照してください。 クラウド展開とは異なり、オンプレミス環境では Lifecycle Services (LCS) 経由でチャネル コンポーネントのシームレスで可用性の高い展開は有効になりません。 Commerce Scale Unit (自己ホスト) をインストールすることによってのみ、チャネル コンポーネントを使用できます。
>
> 設置配置では、次の手順に従います。
>   1. **Retail と Commerce** &gt; **Headquarters の設定** &gt; **Commerce スケジューラ** &gt; **チャネル データベース グループ** の順に移動します。
>   2. アクション ウィンドウで、**新規** を選択します。
>   3. **名前** フィールドに、**既定** と入力します。 必要に応じて、**説明** フィールドに説明を入力します。
>   4. **チャネル スキーマ** フィールドで、**AX7** を選択します。
>   5. **作業フォルダー** フィールドで、**ファイル ストレージ** を選択します。
>   6. アクション ウィンドウで、**保存** を選択します。

1. Headquarters で、**Retail と Commerce** &gt; **Headquarters の設定** &gt; **Commerce スケジューラ** &gt; **チャネル データベース** の順に移動します。
2. **チャネル データベース** ページの、アクション ウィンドウで、**新規** を選択します。
3. **チャネル データベース ID** フィールドに、固有の値を入力します。
4. **チャンル データ グループ** フィールドで、**既定** オプションを選択します。 作成されている任意のオプションを選択します。

    > [!IMPORTANT]
    > オンプレミス配置では、この値が前にこのトピックで説明した **既定** 値になります。

5. **タイプ** フィールドで、既定値 (**チャネル データベース**) を選択したままにします。
6. **データ同期間隔** フィールドは空白のままにすることができます。 あるいは、このフィールドで値を選択することができます。 たとえば、デモ データでは、**D60-U15** の値が 15 分の同期間隔を指定します。

    **データ同期間隔** の値は、チャネル データベース (Commerce Scale Unit) および Headquarters 間でデータを同期する頻度を決定します。 値が入力されていない場合は、Commerce Scale Unit で設定されている既定の間隔が使用されます。 この既定の間隔は、3 分です。

7. **Commerce チャネル** クイック タブで、**追加** を選択し、**チャネル フィールド** で、適切な店舗のチャネルを選択します。 このデータベースを使用するすべてのチャンネルを追加するには、この手順を繰り返します。

    また、このデータベースを使用しないチャンネルを追加することもできます。 この方法で、Commerce Scale Unit のチャネル データベースのチャネルのデータを保持します。 このデータベースを頻繁に使用するチャネルは、ローカルでそのデータにアクセスできます。

    > [!IMPORTANT]
    > オンプレミス配置では、アクション ウィンドウの **ダウンロード** ボタンを選択し、**Commerce Scale Unit パッケージ** を選択します。  これにより、既知のエラーが発生し、このドキュメントの次の手順を正しく完了できるように、アップロード ロジックが開始されます。 アップロード ロジックが完了するまで少なくとも 1 分以上待ってください。

8. **Commerce Scale Unit パッケージ** クイック タブの、**パッケージ参照** フィールドで、適切な Commerce Scale Unit パッケージを選択します。  各環境は、基本の Commerce Scale Unit パッケージを生成します。 したがって、このフィールドには常に少なくとも 1 つのオプションが含まれます。
9. アクション ウィンドウで、**保存** を選択します。
10. **Retail と Commerce** &gt; **チャネル設定** &gt; **チャネル プロファイル** の順に移動します。
11. アクション ウィンドウで、**新規** を選択します。
12. **名前** フィールドに、チャネル プロセスの一意な名前を入力します。

    > [!IMPORTANT]
    > オンプレミス配置の場合、このフィールドにはどのような値も入力できますが、 **既定** の値は一般となります。

13. アクション ウィンドウで、**保存** を選択します。
14. 新しいチャネル プロファイルの **プロファイルのプロパティ** クイック タブで、**追加** を選択します。
15. **プロパティ キー** フィールドで、**Retail Server URL** を選択します。
16. **プロパティ値** フィールドに、インストールする Retail Server の URL を入力します。

    Commerce Scale Unit の URL の標準形式は、`https://<Computer Name>:<Port>/RetailServer/Commerce` です。 この形式で、**&lt;コンピューター名&gt;** は Commerce Scale Unit がインストールされているコンピューター、またはドメイン、フル コンピューター名に結合されていないシステムの完全修飾ドメイン名 (FQDN) のどちらかです。 **&lt;ポート&gt;** はインストールに使用するポート番号です。 ポート番号は、 1 ～ 65535 の範囲の値である必要があります。 既定の HTTPS ポート (443) を使用している場合、ポート番号を指定する必要はありません。

17. 新しいチャネル プロファイルの **プロファイルのプロパティ** クイック タブで、**追加** を選択します。
18. **プロパティ キー** フィールドで、**クラウド POS URL** を選択します。
19. **プロパティ値** フィールドに、Commerce Scale Unit にインストールする必要のあるクラウド POS インスタンスの URL を入力します。

    Cloud POS の URL の標準形式は `https://<Computer Name>:<Port>/POS` です。 この形式で、**&lt;コンピューター名&gt;** は Commerce Scale Unit がインストールされているコンピューター、またはドメイン、フル コンピューター名に結合されていないシステムの FQDN のどちらかです。 **&lt;ポート&gt;** はインストールに使用するポート番号です。 ポート番号は、 1 ～ 65535 の範囲の値である必要があります。 既定の HTTPS ポート (443) を使用している場合、ポート番号を指定する必要はありません。

20. アクション ウィンドウで、**保存** を選択します。

    > [!NOTE]
    > メディアがよく使用される場合、プロファイルの **メディア サーバー ベース URL** を生成する必要があります。  テストとわかりやすくするために、**既定の** チャネル プロファイルに存在する URL を再利用できます。
    >
    > オンプレミス配置では、**メディア サーバー ベースの URL** は、POS デバイスのすべてのメディアが格納されている場所になります。

21. **Retail と Commerce** &gt; **チャネル** &gt; **店舗** &gt; **すべての店舗** の順に移動します。
22. 新しいチャネル データベースを使用する店舗のチャネル ID を選択します。
23. 選択したストアの詳細ページにある、アクション ウィンドウで、**編集** を選択します。
24. 店舗の **一般** クイック タブの、**ライブ チャネル データベース** フィールドで、手順 3 で作成したチャネル データベースを選択します。
25. アクション ウィンドウで、**保存** を選択します。
26. 店舗の **一般** クイック タブの、**チャネル プロファイル** フィールドで、手順 12 で作成したチャネル プロファイルを選択します。
27. **Retail と Commerce** &gt; **Headquarters の設定** &gt; **Commerce スケジューラ** &gt; **チャネル データ グループ** の順に移動します。
28. **既定** データ グループを選択した後、アクション ウィンドウで、**完全データ同期** を選択します。**配送スケジュールの選択** のフィールドで、ジョブ **9999** を選択し、**OK** を選択します。 表示されるダイアログ ボックスで、**OK** を選択して完全同期を確認します。 チャンネル データベース内のすべてのデータはダウンロードの準備をします。

    > [!IMPORTANT]
    > オンプレミス配置の場合、 **既定** のチャンネルのデータ グループはありません。  新しいデータ グループを作成します (そしてそれをチャネル データベースとディストリビューション スケジュールジョブに関連付けます)。

### <a name="download-the-commerce-scale-unit-installer"></a>Commerce Scale Unit インストーラーのダウンロード

1. Headquarters で、**Retail と Commerce** &gt; **Headquarters の設定** &gt; **Commerce スケジューラ** &gt; **チャネル データベース** の順に移動します。
2. 左のチャネル データベースの一覧で、以前に作成したチャネル データベースを選択します。
3. アクション ウィンドウで、**ダウンロード** を選択します。
4. ドロップダウン メニューで、**コンフィギュレーション ファイル** を選択します。

    > [!NOTE]
    > Commerce Scale Unit インストーラーが構成ファイル (XML ファイル) を正しく使用するためには、構成ファイルをインストーラーと同じ場所に保存する必要があります。 構成ファイルが、実行可能なインストーラーと同じファイル名でない場合は、コマンド ラインを使用して実行可能ファイルを実行して構成ファイルを指定するか、XML 構成ファイルの名前を実行可能ファイル名と同じベース名に変更する必要があります。
    >
    > オンプレミス配置では、構成ファイル (この時点で) を手動で編集する必要があります。
    > - StoreSystemAosUrl には、Headquarters (AX) へのアクセスに使用される値が必要です。  この URL の末尾にスラッシュを保持することが重要です (たとえば、`https://myContosoURL.com/namespaces/AXSF/`)。
    > - AADTokenIssuerPrefix には値 `https://NOTUSED.microsoft.com` が必要です
    > - TransactionServiceAzureAuthority には値 `https://<ADFS FQDN including .com>/adfs` が必要です。
    > - TransactionServiceAzureResourceには、上記のように編集された **StoreSystemAosUrl** のベースURL値が必要です。 たとえば、上記の例に基づいて `https://myContosoURL.com` が値として使用され、URLの **/namespaces/AXSF/** 部分が削除されます。

5. Internet Explorer ウィンドウの下部に表示される通知バーで、**保存** を選択します。 (通知バーは、他のブラウザでは別の場所に表示される場合があります。)

    ブラウザーは、生成されたダウンロード ポップアップをブロックする可能性があります。 **1 回許可** または **このサイトのオプション** &gt; **常に許可** を選択します。 その後、再度 **ダウンロード** を選択します。

6. アクション ウィンドウで、**ダウンロード** を選択します。
7. ドロップダウン メニューで、**Commerce Scale Unit パッケージ** を選択します。
8. Internet Explorer ウィンドウの下部に表示される通知バーで、**保存** を選択します。 (通知バーは、他のブラウザでは別の場所に表示される場合があります。)

    選択したチャネル データベースの Commerce Scale Unit パッケージに基づいて、適切なインストール パッケージがダウンロード用に自動的に選択されます。

9. セットアップ インストーラが保存されたら、通知バーの、**実行** を選択します。 (この手順はブラウザの種類によって異なる場合があります。)

### <a name="run-the-commerce-scale-unit-installer"></a>Commerce Scale Unit インストーラーの実行

> [!NOTE]
> Commerce Scale Unit (自己ホスト) インストーラーを実行する前に、インストーラーの実行可能ファイルと同じ名前の構成ファイルがあることを確認してください。 これは、**ExecutableInstallerName.xml** のように表示され、両方のファイルを同じフォルダに配置します。 別の方法として、構成ファイルを手動で指定するためのコマンド ライン区切り記号があります。
> Retail Cloud POS をインストールして使用する場合は、次の手順に従って、インストーラーを初めて実行するときに構成を初期化する必要があります。

Commerce Scale Unit インストーラーを実行する前に、すべての[システム要件](../../fin-ops-core/fin-ops/get-started/system-requirements.md) が満たされていることを確認してください。

> [!IMPORTANT]
> オンプレミス環境で使用する Commerce Scale Unit をインストールする場合は、次のように、管理者権限を使用して、コマンド ラインから起動する必要があります: StoreSystemSetup.exe -UseAdfsAuthentication

Commerce Scale Unit インストーラーは、まず、関連付けられているファイルを展開します。 インストールを開始します。

1. インストーラーの最初のページで、インストールするコンポーネントを選択します。 次のコンポーネントをインストールすることができます。

   - Commerce チャネル データベースと Async Client
   - Retail Server
   - クラウド POS

     > [!NOTE]
     > - クラウド POS をインストールするには、Retail Server も選択してインストールする必要があります。 店舗内で Modern POS のみを使用する場合は、**Retail クラウド POS** チェック ボックスをオフにして、ここで説明されているようにインストール プロセスを続行します。
     > - 既定では、インストーラーはすべてのコンポーネントを 1 台のコンピュータにインストールします。 複数のコンピューターにコンポーネントをインストールするには、追加の手動手順を完了する必要があります。 詳細については、「複数のコンピューターのインストール」セクションを参照してください。

     インストールするすべてのコンポーネントを選択した後、**次** を選択して続行します。

2. インストーラーは、すべての前提条件が満たされていることを検証します。 有効なバージョンの Microsoft SQL Server が見つからない場合、前提条件の確認中にインストーラーは失敗します。  サポートされているバージョンの SQL Server をインストールし、インストーラーを再試行します。

    > [!NOTE]
    > - この前提条件を満たすためには、SQL Server に全文検索機能を搭載し、最低限トランスポート層セキュリティ (TLS) 1.2 がサポートされている必要があります。 サポートされているバージョンの SQL Server のシステム要件を確認してください。 [SQL Server のバージョンとライセンス](../dev-itpro/implementation-considerations-cdx.md#sql-server-versions-and-licenses) を確認することを強くお勧めします。
    > - システムの再起動が必要な場合、インストーラーはユーザーにプロンプトを表示します。  このプロンプトは、再起動が必要な場合すべてのアプリケーションに通知する Windows システム レジストリ キーに基づいています。 インストールを続行する前に再起動することをお勧めしますが、再起動は必須ではなく、インストーラーはコンピュータを再起動せずに続行することができます。

3. Application Object Server (AOS) の URL を確認し、**次へ** を選択します。 (AOS URL とは、Headquarters にアクセスするために使用される URL のことです。)

    > [!NOTE]
    > Retail Server URL は、構成ファイルから自動的に入力されます。

4. HTTPS 通信に使用する、有効な Secure Sockets Layer (SSL) 証明書を選択します。

    証明書は秘密キー ストレージを使用する必要があり、サーバー認証は拡張キー使用プロパティにリストされている必要があります。 また、証明書はローカルに信頼される必要があり、期限切れにすることはできません。 ローカル コンピューターの個人用証明書格納場所に保存する必要があります。

5. 特定のユーザーが必要な場合は、アプリケーション プールを実行するために必要なユーザー名とパスワードを入力します。 既定では、インストーラーは自動的に使用するサービス アカウントを生成します。 この方法は、安全性がより向上するためお勧めします。

    > [!NOTE]
    > 最初から用意されているサービス アカウントは、他のすべてのアカウントに定義されているのと同じパスワード ポリシー下で引き続き機能する点に留意することは重要です。  つまり、最小限のパスワード有効期間ポリシーが引き続き Retail Server サービス アカウントに適用されるため、必要な場合に更新する必要があります。  既定では、Windows Server 2012 R2 では通常 42 日です。  使用されるサービス アカウントのパスワードが期限切れの場合、問題が解決されるまで Commerce Scale Unit コンポーネントが機能しなくなります。

6. 次のページで、小売サーバー アプリケーション プールと Async Client のユーザー アカウントとパスワードを入力します。 既定では、このアカウントは自動的に生成されます。 ただし、ユーザー アカウントとパスワードを手動で入力できます。
7. 使用する HTTPS ポートを入力し、コンピューターのホスト名が正しいことを確認します。 その後、**次へ** を選択して続行します。

    > [!NOTE]
    > - インストーラーは自動的にホスト名を入力します。 何らかの理由で、インストールのためにホスト名を変更する必要がある場合は、ここで変更します。 ホスト名はシステムの FQDN でなければなりません。また、選択した Store システム エントリの **ホスト名** フィールドに入力する必要があります。

8. アプリケーション ID (クライアント ID) およびこの Commerce Scale Unit インストールと関連するキー (シークレット) を入力します。 また、コンフィギュレーション ファイルから自動的に入力されるチャネル データベース ID を確認します。 その後、**インストール** を選択します。 Retail Cloud POS を使用する場合は、ページの下部にある **Retail Cloud POS のコンフィギュレーション** チェック ボックスが選択されていることを確認します。 この構成では Azure AD サインインが要求され、必要なすべての情報が Azure で自動的に生成され、Retail Cloud POS をオンプレミスで使用できるようになります。 オンプレミス環境で使用する Commerce Scale Unit をインストールする場合、このオプションをオフにする必要があります。

    Azure で Web アプリケーションを作成する方法については、[Azure Active Directory アプリケーションを作成する](/azure/azure-resource-manager/resource-group-create-service-principal-portal#create-an-azure-active-directory-application) を参照してください。

    > [!IMPORTANT]
    > - オンプレミス環境で使用する Commerce Scale Unit をインストールするとき、クラウド POS は Azure または AD FS アプリケーションの構成を要求しないため、**Retail クラウド POS の構成** のマークを解除することが重要です。
    > - オンプレミス環境で使用する Commerce Scale Unit をインストールするとき、使用されるクライアント ID (アプリケーション ID) およびシークレット (キー) は、[オンプレミス環境の Commerce チャネル コンポーネントのインストール手順](../../fin-ops-core/dev-itpro/deployment/deploy-retail-onprem.md) トピックの手順 6 ～ 8 で実行される構成手順で実行される PowerShell スクリプトによって生成される値になります。 (手順 6 ではクライアント ID を作成し、手順 8 ではコピーされるシークレットをリセットします)。

    Web アプリを作成するとき、最初の URI と URL は特定の値である必要はありません。 作成されるアプリケーション ID (クライアント ID) とキー (シークレット) のみ重要です。

9. Commerce Scale Unit のアプリケーション ID (クライアント ID) とキー (シークレット) が作成された後、Commerce でアプリケーション ID (クライアント ID) を受け入れる必要があります。 次の手順に従って、Headquarters で構成を完了します。
10. インストールが完了すると、最終正常性ページが表示されます。 このページには、インストールが成功したかどうかが表示されます。 また、基本的な接続テストに基づいた各コンポーネントの正常性と、このトピックの場所について示します。 インストールに失敗した場合は、ページにログ ファイルの場所が表示されます。 Commerce Scale Unit の構成を完了して、すべてのコンポーネントが正しく動作するまで、この最終正常性ページを開いたままにしておくことをお勧めします (次のセクションを完了することが必要)。

### <a name="finish-the-configuration-in-headquarters"></a>Headquarters で構成を完了する

最後のステップでは、Azure アプリケーション ID (クライアント ID) とキー (シークレット) が Headquarters で正しく受け入れられ、環境と新しい Commerce Scale Unit との接続が可能であることを検証し、確認する必要があります。

1. Commerce Scale Unit にアプリケーション ID (クライアント ID) とキー (シークレット) が作成され、インストーラーに入力された後、Headquarters でアプリケーション ID (クライアント ID) を受け入れる必要があります。

    Headquarters で、**システム管理** &gt; **設定** &gt; **Azure Active Directory アプリケーション** の順に移動します。 アプリケーション ID (クライアントID) を **クライアント ID** 列に入力し、説明のテキストを **名** 列に入力および **RetailServiceAccount** を **ユーザー ID** 列に入力します。

2. クラウド POS を使用するように構成されている場合、インストールの最後にクライアント ID が表示されます。 このクライアント ID を Commerce の **Commerce 共有パラメーター** ページに追加する必要があります。

    > [!IMPORTANT]
    > オンプレミス型環境では、このステップは必須ではありません。

    1. バックオフィスで、**Retail とコマース** &gt; **バックオフィスの設定** &gt; **パラメーター** &gt; **コマースの共有パラメーター** の順に移動します。
    2. **ID プロバイダー** を選択します。
    3. **ID プロバイダー** クイック タブで、`HTTPS://sts.windows.net/` で始まるプロバイダーを選択します。 選択に基づいて、**依存する関係者** FastTab の値が設定されます。
    4. **依存する関係者** クイック タブで、**追加** を選択します。 Commerce Scale Unit インストーラーの最終正常性ページに表示されているクライアント ID を入力します。 **Type** フィールドを **Public** に、**UserType** フィールドを **Worker** に設定します。 [アクション] ウィンドウで、**保存** を選択します。
    5. 新しい依存する関係者を選択し、**サーバー リソース ID** クイック タブで **追加** を選択します。 **サーバー リソース ID** 列に、`https://retailstorescaleunit.retailserver.com` と入力します。
    6. アクション ウィンドウで、**保存** を選択します。

3. バックオフィスで、**Retail とコマース** &gt; **バックオフィスの設定** &gt; **パラメーター** &gt; **コマースの共有パラメーター** の順に移動します。
4. **ID プロバイダー** を選択します。
5. **ID プロバイダー** クイック タブで、**追加** を選択します。
6. 新しい **発行者** 行に、新たにインストールした Commerce Scale Unit の URL を入力します。 URL の末尾に **/auth** を追加します。URL は `https://<My Case-Sensitive Computer Name>:<Port Number>/RetailServer/auth` のようになります。

    > [!NOTE]
    > 上記 URL では、大文字と小文字を区別します。
    > インストールされている各 Commerce Scale Unit に新しい ID プロバイダー行があります。 それぞれに、この URL に似た URL が作成されます。

7. **名前** 列に、URL が属する店舗の説明を入力します。
8. **タイプ** 列で、**OpenID 接続** を選択します。

    > [!NOTE]
    > この新しい行は、すべての Commerce Scale Unit のインストール (つまり、一意の URL ごと) に複製する必要があります。

9. アクション ウィンドウで、**保存** を選択します。
10. **ID プロバイダー** クイック タブで、新しく作成された明細行を選択します。 選択に基づいて、**依存する関係者** FastTab の値が設定されます。
11. **依存する関係者** クイック タブで、**追加** を選択し、次の 2 つのエントリを追加します。

    - **ClientId** 列に、**クラウド POS** を入力します。 **Type** フィールドを **Public** に、**UserType** フィールドを **Worker** に設定します。
    - **ClientId** 列に、**Modern POS** を入力します。 **Type** フィールドを **Public** に、**UserType** フィールドを **Worker** に設定します。

12. アクション ウィンドウで、**保存** を選択します。
13. コマースで、**Retail とコマース** &gt; **Retail とコマース IT** &gt; **配送スケジュール** の順に移動し、CDX ジョブ **1110** を実行します。
14. 完了したら、インストーラーに戻り、**完了** を選択します。

    インストーラーの最後のページには、すべてのコンポーネントが正しく動作することをテストして検証するために使用できる貴重な情報が含まれています。 このページは、検証が完了する段階まで開いたままにしておきます。

> [!NOTE]
> インストーラーが Retail Server または Async Client のチェック マークを表示しない場合は、10 分待って、キャッシュされた値をクラウドで更新できるようにします。 再び確認します。 それでもインストーラーが完全に成功しない場合は、このインストールを使用する新しいチャンネル データベースで完全同期を実行します。
>
> すべての手順を正しく実行する場合、構成には次の特性が必要です。
>
> - Azure では、2 つの Web アプリケーションはインストーラー経由で自動的に生成されています。
>
>   - Retail Store Scale Unitクラウド POS
>   - Retail Store Scale Unit Cloud POS 用 Retail サーバー
>
> - Azure では、Web アプリケーション (つまり、新しい Azure ポータルでのアプリ登録) は各 Commerce Scale Unit のインストールに対して手動で作成されています (たとえば、CommerceScaleUnitHouston)。 作成されたキー (シークレット) は、前述のようにインストーラーで使用できます。
> - 手動で作成した Web アプリケーションのアプリケーション ID (クライアント ID) は、前の手順のステップ 1 で説明したように、Commerce の **Azure Active Directory アプリケーション** ページに追加されています。
> - Commerce Scale Unit インストーラーの最後に表示されるクラウド POS アプリケーション ID (クライアント ID) は、「Commerce Scale Unit インストーラーを実行」セクションの最後の手順で説明されているように、**ID プロバイダー** クイック タブに追加されています。

### <a name="multiple-computer-installation"></a>複数のコンピューターのインストール

上級者のみ、複数のコンピューターに Commerce Scale Unit をインストールする必要があります。 次の一連の手順では、1 台のコンピューターにコマース チャネル データベースと Async Client、2 台目のコンピューターに Retail Server とクラウド POS をインストールする方法について説明します。 指示では、両方のシステムが同じドメイン上にあり、インストールされるサービスのユーザーが両方のシステムで既に作成されていることが前提です。 Headquarters ですべての構成を行うことが重要です。

#### <a name="installation-on-the-first-computer"></a>最初のコンピューターへのインストール

最初のコンピューターで、このトピックで前述されているように、Commerce Scale Unit セルフ サービス インストーラーを実行しますが、次の変更を行います。

1. インストールするコンポーネントとして Commerce チャネル データベースと Async Client のみを選択します。 その後 **次へ** を選択して、インストールを続行します。

    > [!NOTE]
    > Async Client はインストールされたコンピューターの外部からアクセスすることができないため、Async Client のために生成されたサービス アカウントを使用することができます。

2. クライアント ID およびキー (シークレット) を入力します。 2 台目のコンピューターで再度使用できるように、これらの詳細情報を使用可能な状態にしておきます。
3. Commerce Scale Unit のクライアント ID とキー (シークレット) が作成された後、Commerce でクライアント ID を受け入れる必要があります。 **システム管理** &gt; **設定** &gt; **Azure Active Directory アプリケーション** の順に移動します。 クライアント ID を **クライアント ID** 列に入力し、説明のテキストを **名** 列に入力および **RetailServiceAccount** を **ユーザー ID** 列に入力します。
4. セットアップが正常に行われたときは、SQL Server 構成マネージャーを起動します。
5. SQL Server インスタンスの **SQL Server ネットワークの構成** &gt; **プロトコル** に移動します。
6. 右クリックし、**プロパティ** を選択します。
7. **フラグ** セクションで、**強制暗号化の設定** の値を **はい** に変更します。
8. **証明書** セクションで、ドロップダウン メニューから SSL 証明書を選択します。 この SQL Server SSL 証明書は、インストーラーで使用されているのと同じ証明書です。
9. **OK** を選択します。
10. SQL Server 構成マネージャで **プロトコル** に戻り、次のプロトコルを有効にします。

    - 名前付きパイプ
    - TCP/IP

11. **TCP/IP** プロトコルを右クリックし、**プロパティ** を選択します。
12. **IP アドレス** セクションで、一覧を **IPALL** まで下方向にスクロールします。
13. **TCPPort = 1433** と入力します。
14. **OK** を選択します。
15. 高度なセキュリティの Microsoft Windows ファイアウォールを起動します。
16. Windows ファイアウォールで、TCP ポート 1433 を開放する受信ルールを作成します。

SQL Server および Windows ファイアウォールに関する詳細については、[データベース エンジンへ アクセス用の Windows ファイアウォールをコンフィギュレーションする](/sql/database-engine/configure-windows/configure-a-windows-firewall-for-database-engine-access) を参照してください。

#### <a name="installation-on-the-second-computer"></a>2 台目のコンピューターへのインストール

2 台目のコンピューターで、このトピックで前述されているように、Commerce Scale Unit セルフ サービス インストーラーを実行しますが、次の変更を行います。

1. インストールするコンポーネントとして Retail Server とクラウド POS のみを選択します。 Retail Server をインストールしている場合は、Cloud POS を選択できません。 その後 **次へ** を選択して、インストールを続行します。
2. 最初のコンピュータで、SQL Server にアクセスする権限を持つドメイン ユーザーの資格情報 (ユーザー名およびパスワード) を入力します。 その後、**次へ** を選択します。

    > [!NOTE]
    > Retail サーバーでは、最初のコンピューター上の SQL データベースへのアクセスが必要なため、生成されたサービス アカウントは使用できません。 ドメイン アカウントを使用する必要があります。

3. 最初のコンピューターで使用される同じクライアント ID およびキー (シークレット) を入力します。

    > [!IMPORTANT]
    > 前述のようにコマース バックオフィスにこのクライアント ID を追加することが重要です。

4. **クラウド POS のコンフィギュレーション** を選択し、Azure Web アプリケーションを作成するための適切なアクセス許可を持つ Azure AD 資格情報を入力します。

    Azure Web アプリ、それを作成する方法、および新しいキー (シークレット) を生成する方法の詳細については、[リソースにアクセスできる Azure Active Directory アプリケーションおよびサービス プリンシパルを作成するポータルの使用](/azure/active-directory/develop/howto-create-service-principal-portal) を参照してください。 サインイン URL やアプリ ID URI は重要ではないことに注意してください。

5. セットアップが正常に行われたときは、インストーラーを終了しません。

    > [!NOTE]
    > 最初は、データベースがまだ正しく設定されていないため、ヘルスチェック ping は成功しません。 この手順の残りのステップを完了した後は、再度稼働状況チェックをテストできます。

6. **Microsoft インターネット インフォメーション サービス (IIS)** を起動し、**Retail Server** Web サイトを選択して、**Retail Server** Web アプリケーションを選択します。
7. 作業ディレクトリを検証します。
8. Web.config ファイルを開いて、**connectionStrings** セクションで、**サーバー名** を追加します。 **サーバー名** はユーザーがコンポーネントをインストールした最初のコンピュータの名前です。 ファイル保存します。
9. 使用されている証明書が信頼できる機関の有効な信頼できる証明書でない場合は、CERTMGR.MSC を開いて次の手順を実行します。

    1. 前に作成した SQL Server SSL 証明書をインポートし、信頼されたルートに追加します。
    2. 管理者として **コマンド プロンプト** ウィンドウを開き、**IISRESET** と入力し、Enter キーを押します。

10. クラウド POS を使用するように構成されている場合は、クライアント ID が表示されます。 このクライアント ID を **Commerce 共有パラメーター** ページに追加する必要があります。

    1. コマースで、**Retail とコマース** &gt; **バックオフィスの設定** &gt; **パラメーター** &gt; **コマースの共有パラメーター** の順に移動します。
    2. **ID プロバイダー** を選択します。
    3. **ID プロバイダー** クイック タブで、`HTTPS://sts.windows.net/` で始まるプロバイダーを選択します。 選択に基づいて、**依存する関係者** FastTab の値が設定されます。
    4. **依存する関係者** クイック タブで、**追加** を選択します。 Commerce Scale Unit インストーラーに表示されているクライアント ID を入力します。 **Type** フィールドを **Public** に、**UserType** フィールドを **Worker** に設定します。 [アクション] ウィンドウで、**保存** を選択します。
    5. 新しい依存する関係者を選択し、**サーバー リソース ID** クイック タブで **追加** を選択します。 **サーバー リソース ID** 列に、`https://retailstorescaleunit.retailserver.com` と入力します。
    6. アクション ウィンドウで、**保存** を選択します。

11. コマースで、**Retail とコマース** &gt; **バックオフィスの設定** &gt; **コマース スケジューラ** &gt; **チャネル データベース** の順に移動し、これらの手順に従います。

    1. このトピックの先頭に作成したチャネルのデータベースを選択します。
    2. アクション ウィンドウで、**完全な同期** &gt; **ジョブ 9999** を選択します。 完全な同期には数分間かかる場合があります。
    3. Commerce Scale Unit のインストーラーで、すべての機能が正常に機能していることを確認するために再テストします。

12. POS 操作を使用しているコンピューターからクラウド POS を起動します。 (このコンピューターは、Commerce Scale Unit システムとは別の 3 台目のコンピューターです。)
13. このコンピューターで使用しているクラウド POS デバイスを有効化します。
14. 完全なエンド ツー エンドの機能を確認する簡易販売を実行します。

### <a name="help-secure-commerce-scale-unit"></a>Commerce Scale Unit のセキュリティ強化

現在のセキュリティ基準によると、実稼動環境で次のオプションを設定する必要があります。

- コンピューターの SSL (v2およびv3) を完全に無効にする必要があります。
- TLS バージョン 1.2 (または、現時点で最も新しいバージョン) のみを有効にし、使用する必要があります。

    > [!NOTE]
    > 既定では、SSL および TLS 1.2 を除くすべてのバージョンの TLS は無効です。 これらの設定を編集または有効にするには、次の手順を実行します。
    >
    > 1. Windows ロゴキーと R キーを同時に押して、**実行** ウィンドウを開きます。
    > 2. **開く** フィールドに、**Regedit** と入力してから **OK** を選択します。
    > 3. **ユーザー アカウント制御** ウィンドウで、**はい** (この手順が必要である場合) を選択してから、新しい **レジストリ エディター** ウィンドウで **HKEY\_LOCAL\_MACHINE\\System\\CurrentControlSet\\SecurityProviders\\SCHANNEL\\Protocols** に移動します。
    > 4. 次のキーは自動的に入力され、TLS 1.2 のみが有効になります。
    >
    >     - TLS 1.2\\Server:Enabled=1
    >     - TLS 1.2\\Server:DisabledByDefault=0
    >     - TLS 1.2\\Client:Enabled=1
    >     - TLS 1.2\\Client:DisabledByDefault=0
    >     - TLS 1.1\\Server:Enabled=0
    >     - TLS 1.1\\Client:Enabled=0
    >     - TLS 1.0\\Server:Enabled=0
    >     - TLS 1.0\\Client:Enabled=0
    >     - SSL 3.0\\Server:Enabled=0
    >     - SSL 3.0\\Client:Enabled=0
    >     - SSL 2.0\\Server:Enabled=0
    >     - SSL 2.0\\Client:Enabled=0

- 知られている特定の理由で必要とされない限り、追加のネットワーク ポートを開かないでください。
- クロスオリジンのリソース共有を無効にし、許可され承認されたオリジンを指定する必要があります。
- Commerce Scale Unit コンピューターで使用する証明書の取得には、信頼された証明機関のみを活用してください。

> [!IMPORTANT]
> IIS と Payment Card Industry (PCI) の要件向けのセキュリティ ガイドラインを確認することが重要です。

### <a name="troubleshoot-commerce-scale-unit"></a>Commerce Scale Unit のトラブルシューティング

確認する項目のチェックリストを次に示します。

1. 構成ファイルを開き、指定された Retail サーバーの URLに接尾語 **/Commerce** が含まれていて、使用しているコンピューター名とポートに対して期待されている値に基づいて正しく形成されていることを確認します。  URL 内または末尾にスラッシュ (**/** 文字) が含められていないか確認します。
2. Commerce の **Commerce 共有パラメーター** ページで、適切なクライアント ID が **依存する関係者** クイック タブに追加されていることを確認します。 また、正しい `https://retailstorescaleunit.retailserver.com` エントリが **サーバー リソース ID** クイック タブに追加されていることを確認します。
3. Commerce で、各店舗に生成されたすべてのクライアント ID が **Azure Active Directory アプリケーション** ページに存在することを確認します。
4. Commerce の **チャネル プロファイル** ページで、URL が正しいことを確認します。 これを行うには、各 URL のコンピューター名が正しいこと、URL が正しく書式設定されていることなどを確認します。
5. Commerce の **チャネル データベース** ページで、新しいチャネル データベースに完全同期が正しく発生したことを確認します。
6. 新しいチャネル データベースを使用するように店舗が正しく構成されていることを確認します。

Retail Server が一定時間の後に停止した場合、確認すべき 2 つの簡単なことがあります。

- パスワード ポリシーにより、パスワード (パスワードの有効期限) を変更するために生成されたサービス アカウントが求められているかどうかを確認します。
- 現在のインストール (非べき等) で同一のインストーラーを再実行します。これにより、サービス アカウントのパスワードが更新されるか、選択したアカウントのパスワードの更新が許可されます。

[SQL Server のバージョンとライセンス](../dev-itpro/implementation-considerations-cdx.md#sql-server-versions-and-licenses) を確認することも強くお勧めします。

### <a name="uninstall-commerce-scale-unit"></a>Commerce Scale Unit のアンインストール

Microsoft Windows でコントロール パネルを使用して Commerce Scale Unit コンポーネントをアンインストールします。

1. Windows ロゴ キーを押し、検索ボックスに **コントロール パネル** と入力します。 検索結果で、**コントロール パネル** を選択します。
2. コントロール パネルで、**プログラム** &gt; **プログラムのアンインストール** を選択します。
3. **プログラムと機能** ウィンドウで、**Microsoft Dynamics 365 Commerce Scale Unit** を選択してから、プログラムの一覧で **アンインストール** を選択します。
4. アンインストールがプログラムの削除を完了するまで待ちます。


[!INCLUDE[footer-include](../../includes/footer-banner.md)]