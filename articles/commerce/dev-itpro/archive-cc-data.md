---
title: クレジット カード トランザクション データのアーカイブ
description: この記事では、クレジット カード トランザクションをアーカイブに保存することでデータベースの領域を解放できる、Microsoft Dynamics 365 Commerce のアーカイブ ジョブについて説明します。
author: BrianShook
ms.date: 11/04/2022
ms.topic: article
ms.prod: ''
ms.technology: ''
audience: IT Pro
ms.reviewer: v-chgriffin
ms.search.region: Global
ms.author: brshoo
ms.search.validFrom: 2019-01-01
ms.dyn365.ops.version: AX 7.0.1
ms.custom: 141393
ms.assetid: e23e944c-15de-459d-bcc5-ea03615ebf4c
ms.search.industry: Retail
ms.openlocfilehash: 46248135ab44404e4e3f2b48dff5d3bc28881027
ms.sourcegitcommit: 9e2e54ff7d15aa51e58309da3eb52366328e199d
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 11/04/2022
ms.locfileid: "9746114"
---
# <a name="archive-credit-card-transaction-data"></a>クレジット カード トランザクション データのアーカイブ

[!include [banner](../includes/banner.md)]
[!include [banner](../includes/preview-banner.md)]

この記事では、クレジット カード トランザクションをアーカイブに保存することでデータベースの領域を解放できる、Microsoft Dynamics 365 Commerce のアーカイブ ジョブについて説明します。 このジョブは、コマース バージョン 10.0.17 リリース時点で使用できます。

クレジット カードの認証ごとに、認証バイナリ ラージ オブジェクト ([auth BLOB](#key-terms)) がデータベースに格納されます。 Auth BLOB には、認証に関連するデータが含まれます。 時間が経過すると、これらの auth BLOB は増加し、データベースの容量を大量に得ることができます。 この記事に説明されているジョブを使用すると、Azure Blob Storage にエクスポートしてデータベースからデータを削除することで、auth BLOB データをアーカイブすることができます。

アーカイブ ジョブのパラメータは、トランザクションの日数に基づいて指定されます。 つまり、ジョブの **最小トランザクションの日数** フィールドが **365** 日に設定されている場合、たとえば 365 日以上経過しているクレジット カード認証に関するすべての XML データが、ジョブの実行時にアーカイブの対象になります。

> [!IMPORTANT]
> アーカイブしたデータを簡単に復元できません。 したがって、[リンクされた払戻し](#key-terms) の対象となるトランザクションはアーカイブする必要はありません。 たとえば、販売者の返品ポリシーで、2 日以内に同じクレジット カードへの払戻しをトランザクションで許可している場合、ジョブの **トランザクションの最小期間** フィールドは 730 日 (2年) に設定する必要があります。 この場合、730 日後にトランザクションが戻された場合、リンクされた払戻しを実行する必要がある XML は検出されません。 したがって、顧客はクレジット カードまたはクレジット メモやギフト カードなどの他の支払方法に対する[スタンドアロンの払戻し](#key-terms) を通じて、払戻しを受け取る必要があります。

## <a name="key-terms"></a>重要な用語

| 相談 | 説明 |
|---|---|
| Auth BLOB | クレジット カード プロセッサが支払要求に対して返す応答。 この応答は XML ファイルに格納され、時間の節約に基いてデータベースの容量を大量に使用できます。 |
| リンクされた払戻 | 前のトランザクションを参照する払戻し要求。 クレジット カード プロセッサは、リンクされた払戻しのリスクを伴と見なし、関連する手数料が低くなります。 |
| スタンドアロンの払戻し | 以前のトランザクションを参照しない払戻し要求。 スタンドアロンの払戻ではリスクが高く、処理手数料も高くなります。 |

## <a name="document-management-dependency"></a>ドキュメント管理の依存関係

アーカイブ ジョブを実行すると、ドキュメント管理を使用して、zip ファイル内の古いクレジット カード認証に関する XML データがエクスポートされます。 ドキュメント管理が環境で設定されていない場合、アーカイブ ジョブを正常に実行できません。 詳細については、[ドキュメント管理のコンフィギュレーション](../../fin-ops-core/fin-ops/organization-administration/configure-document-management.md) を参照してください。

アーカイブ ジョブでは、**トランザクションの最小日数** の値で定義されている条件を満たすすべてのクレジット カード支払データが処理されます。 ジョブが有効であり、定義された基準に基づいて大量のレコードを処理する必要がある場合、ジョブの実行に数日かかる場合があります。 ただし、支払のバックログがアーカイブされた後は、ジョブの実行に時間はかかりません。

## <a name="data-that-is-in-scope-for-archiving"></a>アーカイブの対象範囲にあるデータ

アーカイブ ジョブはデータを **RetailTransactionPaymentTrans** タブの **PaymentAuthorization**、**PaymentCaptureToken** および **PaymentCardToken** フィールドにアーカイブします。 アーカイブされたトランザクションには、これらのフィールドに関連付けられたデータは存在しないが、リンクされた払戻しは一度も行わずに返品できます。

## <a name="batch-job-setup"></a>バッチ ジョブの設定

**小売とコマース \> 小売とコマース IT \> クリーン アップ \> クレジット カード トランザクション データのアーカイブ** で、Commerce headquarters のアーカイブ ジョブにアクセスできます。 

### <a name="parameters-section"></a>パラメーター セクション

**クレジット カード トランザクション データ のアーカイブ** ポップアップ メニューの **パラメーター** セクションには、次のパラメーターが含まれます:
  - **トランザクションの最小期日経過日数 (日)** - このパラメーターを設定する必要があります。 アーカイブの対象となるクレジット カード認証の日数を入力します。 入力する値は、顧客が元のクレジット カード認証にリンクされている払戻しを受け取ることができる期間である必要があります。 たとえば、フィールドを 365 日に設定した場合、販売者のポリシーによっては、366 日後のトランザクションに対する返品は払戻しの対象となる場合があります。 ただし、リンクされた払戻しを実行するために必要なデータは、アーカイブ後は Dynamics で使用できため、処理された払戻しはスタンドアロンの払戻しである必要があります。
  - **アーカイブせずにデータを削除する** - このパラメーターが **はい** に設定されている場合、Commerce は、トランザクションの最小期日経過日数 (日) の条件を満たす、すべてのトランザクション レコードのトランザクションおよび署名のキャプチャ データを削除 (アーカイブなし) します。
  - **対応するトランザクション日付** - このパラメーターは、**トランザクションの最小期日経過日数 (日)** パラメーターの現在の値に対応する過去の日付を表示する参照フィールドです。 表示されている日付よりも古いレコードは、ジョブによって影響を受します。
  - **圧縮を使用** - このパラメーターが **はい** に 設定されている場合、Commerce はトークンを圧縮してストレージ領域を確保します。 詳細については、以下の [トークン圧縮によるストレージ管理の強化](#further-storage-management-with-token-compression) を参照してください。

### <a name="run-in-the-background-section"></a>バックグラウンドで実行セクション

**クレジット カード トランザクション データのアーカイブ** ポップアップ メニューの **バックグラウンドで実行** セクションは、バッチ ジョブのバッチ機能およびスケジュールを制御し、バッチ ジョブに対して設定できる次のパラメーターを含みます:

- **バッチ処理** - このパラメーターは既定で **はい** に設定され、オフにできません。
- **定期処理** - **定期処理 \> 定期的なアイテムの定義** タブのパラメーターを使用すると、ジョブを実行する定期的なタイミング構成を設定できます。
- **警告** - **警告 \> バッチ ジョブ警告** タブのパラメーターを使用すると、バッチ ジョブに関連するさまざまなイベントに対して警告を構成できます。
- **タスクの説明** - このパラメーターは、バッチ ジョブ表示ラベルを指定します。
- **バッチ グループ** - このパラメーターを使用すると、ワークロードを複数のサーバーに配分するバッチ グループを指定できます。
- **プライベート** - このパラメータが **はい** に設定されている場合、Commerce は他のユーザーがバッチ ジョブを処理することを制限します。 フォームを構成したユーザーだけがジョブを実行できます。
- **重要なジョブ** - このパラメーターを **はい** に設定すると、ジョブの処理能力が優先されます。
- **監視カテゴリ** - 監視カテゴリを割り当てると、監視中にさまざまな種類のジョブを識別しやすくなります。

次の図では、**クレジット カード トランザクション データをアーカイブ** ダイアログ ボックスのパラメータ設定例を示しています。

![クレジット カード トランザクション データのアーカイブ ダイアログ ボックスのパラメーター設定。](media/PAYMENTS/Batch1.png)

**最小トランザクションの日数** フィールドおよびバッチ詳細が設定された後、**次へ** を選び、エクスポートされるデータ サンプルを表示します。 次の図は、例を示します。 このサンプルのデータは限られていますが、アーカイブの対象となるすべてのデータをエクスポートできます。

![エクスポートされるデータのサンプル。](media/PAYMENTS/Batch2.png)

> [!IMPORTANT]
> アーカイブの対象となるデータには、カード所有者の名前など、個人を特定できる顧客情報が含まれます。 この機密データは、地域の規制要件に従って処理する必要があります。

次の図に示すように、アーカイブする必要があるデータのパラメーターを確認した後、データがアーカイブされ、簡単に復元できないことを理解していることを確認するメッセージが表示されます。

![確認用メッセージボックス。](media/PAYMENTS/Batch3.png)

**はい** を選び、アーカイブ ジョブが有効になると、**トランザクションの最小日数** 値よりも古いクレジット カードの認証に関するすべての XML データはアーカイブの対象になります。

## <a name="further-storage-management-with-token-compression"></a>トークン圧縮によるストレージ管理の強化

基になるストレージ テーブルの占有領域を減らするには、**支払トークンの圧縮** 機能を有効にすることで、トークンを圧縮できます。 この機能フラグを有効にすると、システムは格納されている支払プロパティ トークンで圧縮を使用できます。 

> [!IMPORTANT]
> **支払トークンの圧縮** 機能を使用するには、システムが Commerce バージョン 10.0.25 以降および販売時点管理 (POS) バージョン 9.35 以降を実行している必要があります。

Headquarters で **支払トークンの圧縮** 機能を有効にするには、次の手順を実行します。

1. **ワークスペース \> 機能管理** に移動します。 
1. **すべて** で **支払トークンの圧縮** 機能を検索します。
1. 機能を選択し、プロパティ ウィンドウで **今すぐ有効にする** を選択します。

**支払トークンの圧縮** 機能を有効にすると、**クレジット カード トランザクション データのアーカイブ** パラメーター セクションの **圧縮を使用** プロパティを **はい** に設定できます。

## <a name="additional-resources"></a>追加リソース

[支払に関するよく寄せられる質問](/dynamics365/unified-operations/retail/dev-itpro/payments-retail)

[Adyen 向け Dynamics 365 Payment Connector](adyen-connector.md?tabs=8-1-3)

[チェックアウト モジュール](../add-checkout-module.md)


[!INCLUDE[footer-include](../../includes/footer-banner.md)]
