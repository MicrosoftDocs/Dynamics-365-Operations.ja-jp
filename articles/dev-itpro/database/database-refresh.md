---
title: "サンドボックス データベース更新の要求"
description: "このトピックでは、サンドボックスのユーザー受け入れテスト (UAT) 環境で、Microsoft Dynamics 365 for Finance and Operations のデータベースの更新を要求する方法について説明します。"
author: LaneSwenka
manager: AnnBe
ms.date: 11/13/2018
ms.topic: article
ms.prod: 
ms.service: dynamics-ax-platform
ms.technology: 
audience: IT Pro, Developer
ms.reviewer: margoc
ms.search.scope: Operations
ms.custom: 257614
ms.assetid: 558598db-937e-4bfe-80c7-a861be021db1
ms.search.region: Global
ms.author: laneswenka
ms.search.validFrom: 2016-02-28
ms.dyn365.ops.version: AX 7.0.0
ms.translationtype: HT
ms.sourcegitcommit: bb9311abfe2acada9b8e6738e3f3932c5ef686cc
ms.openlocfilehash: e411dc702d59b81a095359b642ad36e0937ab231
ms.contentlocale: ja-jp
ms.lasthandoff: 12/04/2018

---

# <a name="request-sandbox-database-refreshes"></a>サンドボックス データベース更新の要求

[!include [banner](../includes/banner.md)]
[!include [banner](../includes/preview-banner.md)]

Microsoft Dynamics Lifecycle Services (LCS) を使用して、サンドボックス ユーザー承認テスト (UAT) 環境に対して、Microsoft Dynamics 365 for Finance and Operations のデータベースのリフレッシュを要求することができます。 データベースの更新では、対象となるサンドボックス UAT 環境に、本番環境のトランザクション データベースをコピーできます。 このプロセスには、財務報告データベースのコピーが含まれます。 別のサンドボックス環境を使用する場合は、その環境から対象のサンドボックス UAT 環境にデータベースをコピーすることもできます。

この機能により、生産データを使用して UAT 環境で予定されているコード変更をテストできます。 また、デバッグの目的で、生産データベースを UAT 環境にコピーすることもできます。

> [!Important]
> 生産報告を目的としてサンドボックス環境に生産のデータをコピーすることはできません。  

## <a name="database-refresh-via-self-service-public-preview"></a>セルフ サービスによるデータベースの更新 (パブリック プレビュー)
人手または手動のプロセスに依存しないでお客様にアプリケーション ライフサイクル管理機能を提供することを目標として、Lifecycle Services チームは自動化されたデータベースの更新アクションを導入しました。 別の環境のデータでサンドボックス環境を更新するには、パブリック プレビューに含まれるセルフ サービス アクションの一部としてこのアクションを実行できます。 このプロセスについては以下で概要を説明します。また、このプロセスは、完全にサポートされる機能です。

1. LCS にサインインしてパブリック プレビュー機能を有効にし、ホーム画面で **プレビュー機能の管理** タイルを選択します。 **別の環境からのデータベースの復元** 機能を検索し、**プレビュー機能有効** を **True** に設定します。
2. ターゲット サンドボックスの **環境の詳細** ページにアクセスし、**メンテナンス** > **データベースの移動** メニューのオプションをクリックします。
3. **データベースの選択** オプションを選択し、ソース環境を選択します。
4. 警告に注意し、ソース環境からコピーされていないデータの要素の一覧を確認します。
5. 更新操作がすぐに開始されます。
6. 更新操作が完了したら、パッケージ展開、データベース移動、アップグレードなどの別のサービス操作を実行する前に、工程で**サインオフ**する必要があります。

### <a name="refresh-operation-failed"></a>更新操作が失敗しました
失敗した場合、**ロールバック**を実行するオプションを使用できます。  工程が最初に失敗した後にロールバック オプションをクリックすると、対象となるサンドボックス環境が更新の開始前の状態に戻されます。 Azure SQL ポイントインタイム復元機能により、データベースを復元できるようになります。 新しく更新されたデータでデータベースの同期を完了できないをターゲット サンドボックスにカスタマイズがある場合は、これがよく必要になります。  

失敗の根本原因を特定するには、ロールバック操作を開始する前に、使用可能なボタンを使用して Runbook ログをダウンロードします。

### <a name="data-elements-that-arent-copied-during-refresh"></a>更新中にはコピーされないデータ要素
実稼働環境をサンドボックス環境に、またはサンドボックス環境を別のサンドボックス環境に更新するときは、ターゲット環境にコピーされない特定のデータベース要素があります。  これは、データが環境固有であるか、非製造環境から実際の電子メールが送信されるなどの運用上の問題が発生する可能性があるためです。  これらのデータ要素として次のものがあります。

* LogisticsElectronicAddress テーブル内の電子メール アドレス。
* BatchJobHistory、BatchHistory、および BatchConstraintHistory テーブルのバッチ ジョブ履歴。
* SysEmailSMTPPassword テーブルの SMTP パスワード。
* SysEmailParameters テーブルの SMTP 中継サーバー。
* メール プロバイダーは、Exchange プロバイダーを使用して誤った発信メールを防ぐために SysEmailParameters テーブルで SMTP にリセットされます。
* PrintMgmtSettings と PrintMgmtDocInstance テーブルの印刷管理設定。
* SysServerConfig、SysServerSessions、SysCorpNetPrinters、SysClientSessions、BatchServerConfig、および BatchServerGroup テーブル内の環境固有のレコード。
* DocuValue テーブル内のドキュメント添付ファイル。
* 管理者と Microsoft サービス アカウントを除くすべてのユーザーが無効になります。
* すべてのバッチ ジョブは、[保留] 状態に設定されます。

### <a name="environment-administrator"></a>環境管理者
対象となる環境のシステム管理者アカウント ('Admin' の UserId) は、Lifecycle Services から値 Administrator にリセットされます。  これがどのアカウントになるかをプレビューするには、LCS でターゲット サンドボックスの **環境の詳細** ページにアクセスします。  環境が最初に展開されたときに選択された **環境管理者** フィールドの値は、トランザクション データベース内のシステム管理者となるように更新されます。 これは、環境のテナントが環境管理者のテナントとなることも意味します。  別のアカウントを使用することを要求する場合、ターゲット サンドボックスを割り当て解除して削除し、別のアカウントを選択して再展開する必要があります。 この後、データを復元するためにデータベースの更新操作をもう 1 回実行することができます。

## <a name="database-refresh-via-service-request"></a>サービス要求を通じたデータベース更新

> [!NOTE]
> 2018 年 10 月の時点で、同じ環境内の別の更新を開始する前に、データベース更新要求をサインオフする必要があります。 これは、データベース移動操作の将来の自動化をサポートするためです。 サインオフするには、**環境の詳細** ページにアクセスし、**サインオフ** ボタンをクリックします。 将来に向けて多くのデータベース更新サービス要求を作成できますが、各要求間でサインオフする必要があります。
>
> 2019 年 1 月 31 日より後のサービスの日付では、データベースの更新のためのサービス要求は認められなくなります。  この日付の跡、すべての更新処理が上記のセルフサービス アクション経由で実行されます。

Microsoft サービス エンジニアリング チームは、環境をオフラインにして、更新を実行し、環境をオンラインに戻します。 ダウンタイム期間が約 2 時間であると予測することができます。 ユーザーが要求を入力してから、マイクロソフトのサービス エンジニアが措置を講じるまでの時間が、ユーザーの環境のダウンタイムよりも長くなります。 今後、データベース更新を実行するために使用できるセルフ サービスのメソッドを提供する予定です。

1. LCS のプロジェクト ホーム ページで、**サービス要求** を選択します。
2. **サービス要求**ページの、ツールバーで**追加**を選択し、**データベースの更新**を選択します。
3. **データベース更新の要求**ダイアログ ボックスで、これらの手順に従います。

    1. **環境名**フィールドで、更新する環境を選択します。
    2. **データベース** フィールドでは、更新するデータベースは常に Microsoft Dynamics AX データベースまたは Finance and Operations データベースです。 エンティティ格納などの他のデータベースでは、データベースの更新が現在サポートされていません。
    3. チェック ボックスを隣に置いたステートメントを注意深く読んで確認してください。

4. 要求を送信した後、作業項目のリストに戻ります。 ここで、要求のステータスを表示し、または再スケジューリングし、または要求をキャンセルできます。
5. サインオフまたはロールバックを待機している事前サービス要求が環境にないことを確認します。 環境の詳細ページに移動し、完了した更新やパッケージの展開をサインオフします。
6. サービス エンジニア リング チームがお客様の要求を達成できることを確認したとき、その要求のステータスは **要求受入済** に変更されます。 この時点で、次のいずれかの手順を実行できます。

    - サービス エンジニア リング チームによる更新が完了するまで待ちます。 復元が完了したら、ステータスが **"成功"** に変更されます。
    - ID を選択するか、要求を選択してツール バーで **再スケジューリング** を選択することにより、リクエストを再スケジューリングします。 ダウンタイム ウィンドウの日時を変更することができます。
    - 要求を選択し、ツールバーの**キャンセル**を選択して、要求をキャンセルします。

## <a name="conditions-of-a-database-refresh"></a>データベース更新の条件
データベース更新の操作の要件および条件の一覧を次に示します。

- パッケージの展開や事前データベース更新など、環境の詳細ページから以前のサービス操作を*サインオフする必要があります*。
- 要求は、要求を完了するためにリソースを確実に使用できるようにするため、目的のダウンタイム期間の 5 時間前までに送信する必要があります。
- 更新により、ターゲット環境の既存のデータベースが消去されます。 更新が完了すると、既存のデータベースを復元することはできません。
- 更新プロセスが完了するまで、ターゲット環境は使用できなくなります。
- リフレッシュは、Finance and Operations and Financial Reporting データベースにのみ影響します。
- Azure blob storage のドキュメントは、ある環境から別の環境にコピーされません。 つまり、添付されたドキュメント処理ドキュメントとチームプレートは変更されず、現在の状態にとどまります。
- 管理者ユーザー、およびその他の内部サービス ユーザー アカウントを除くすべてのユーザーは無効になります。 このプロセスにより、他のユーザーをシステムに戻す前に、管理者ユーザーがデータを削除または難読化できます。
- 管理者ユーザーは、特定のサービスまたは URL に統合エンドポイントを再接続するなど、必要な構成の変更を加える必要があります。
- 定期的にインポートおよびエクスポート ジョブされるすべてのデータ管理フレームワークは完全に処理され復元が開始される前にターゲット システムで停止する必要があります。 さらに、すべての定期的なインポートおよびエクスポート ジョブが完全に処理された後に、データベースをソースから選択することをお勧めします。 これにより、いずれかのシステムから Azure ストレージにオーファン ファイルが存在しないことが保証されます。 これは、データベースがターゲット環境にリストアされた後にオーファン ファイルを処理できないため重要です。 復元後、統合ジョブを再開することができます。
- 実行するように設定されていたすべてのバッチは**源泉**状態として設定され、環境が再コンフィギュレーションされる前にバッチは実行を停止します。
- SMTP サーバー構成、すべての電子メール アドレス、およびすべての **印刷管理**設定 (ネットワーク プリンターを含む) が削除されました。
- LCS でプロジェクト所有者または環境マネージャーのロールを持つユーザーは、すべての非実稼働環境の SQL とマシンの資格情報にアクセスできます。

## <a name="steps-to-complete-after-a-database-refresh-for-environments-that-use-retail-functionality"></a>Retail 機能を使用する環境のデータベース更新後に実行する手順
[!include [environment-reprovision](../includes/environment-reprovision.md)]

## <a name="known-issues"></a>既知の問題

### <a name="incompatible-version-of-financial-reporting-between-source-and-target-environments"></a>ソース環境とターゲット環境間での財務報告の互換性のないバージョン
財務報告のバージョンがソースおよびターゲット環境間で異なる場合は、データベースの更新プロセス (セルフサービスまたはサービス要求経由) を正常に完了できません。 この問題を解決するには、財務報告の最新バージョンが存在するように両方の環境を更新します。

* 実装プロジェクトで**アセット ライブラリ**にアクセスし、**ソフトウェア展開可能パッケージ** をクリックします。
* **インポート** ボタンをクリックし、最新の Microsoft Dynamics 財務報告バイナリ更新プログラム パッケージを検索して、インポート対象としてこれを選択します。
* ソース環境とターゲット環境の両方で最新バージョンが確実に使用されるように、両方の環境にこのパッケージを適用します。

### <a name="incompatible-application-versions-between-source-and-target-environments"></a>ソース環境とターゲット環境間での互換性のないアプリケーション バージョン
ソースおよびターゲット環境のアプリケーション リリースが同じでない場合は、データベースの更新プロセス (セルフサービスまたはサービス要求経由) を正常に完了できません。 これは、データ アップグレード プロセスが、更新などのデータベース移動操作によって実行されず、データ損失が発生する可能性があるためです。  

新しいアプリケーション バージョンにサンドボックス UAT 環境をアップグレードする場合 (たとえば、7.3 から 8.1)、必ずアップグレードを開始する前にデータベースの更新アクションを実行してください。 サンドボックスが新しいバージョンにアップグレードされると、サンドボックス UAT 環境に古い実稼働環境データベースを復元することはできません。  

逆に、実稼働環境がターゲット サンドボックスよりも新しい場合、更新前にターゲット サンドボックスをアップグレードするか、更新の実行前にそのまま割り当て解除、削除、および再展開する必要があります。

