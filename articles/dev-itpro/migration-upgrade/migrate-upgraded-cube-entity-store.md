---
title: アップグレードした AX 2012 R3 販売キューブのエンティティ格納への移行
description: このチュートリアルでは、アップグレードされた Microsoft Dynamics AX 2012 R3 キューブ スキーマを、Microsoft Dynamics 365 for Finance and Operations のエンティティ格納に移行します。 例として、Dynamics AX 2012 R3 に含まれていた販売キューブを使用します。
author: MilindaV2
manager: AnnBe
ms.date: 06/20/2017
ms.topic: article
ms.prod: ''
ms.service: dynamics-ax-platform
ms.technology: ''
audience: Developer, IT Pro
ms.reviewer: robinr
ms.search.scope: Operations
ms.custom: 94203
ms.assetid: e992cdd8-abe8-42d0-97ad-6165822abbba
ms.search.region: Global
ms.author: milindav
ms.search.validFrom: 2016-05-31
ms.dyn365.ops.version: Platform update 1
ms.openlocfilehash: b889fb0c59745cc38c8e21ee6f2d926033c76295
ms.sourcegitcommit: 574d4dda83dcab94728a3d35fc53ee7e2b90feb0
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 05/22/2019
ms.locfileid: "1595475"
---
# <a name="migrate-upgraded-ax-2012-r3-sales-cubes-to-the-entity-store"></a>アップグレードした AX 2012 R3 販売キューブのエンティティ格納への移行

[!include [banner](../includes/banner.md)]

このチュートリアルでは、アップグレードされた Microsoft Dynamics AX 2012 R3 キューブ スキーマを、Microsoft Dynamics 365 for Finance and Operations のエンティティ格納に移行します。 例として、Dynamics AX 2012 R3 に含まれていた販売キューブを使用します。

エンティティ格納は、次の図に示すように、ほぼリアルタイムの Microsoft Power BI 統合シナリオをサポートします。 エンティティ格納と Power BI 統合の概要については、「[エンティティ格納と Power BI の統合](https://blogs.msdn.microsoft.com/dynamicsaxbi/2016/06/09/power-bi-integration-with-entity-store-in-dynamics-ax-7-may-update/)」を参照してください。 [![Power BI アークテクチャ ダイアグラム](./media/powerbiarchitecture.png)](./media/powerbiarchitecture.png)

## <a name="new-power-bi-features-included-in-the-may-2016-and-november-2016-updates"></a>2016 年 5 月および 2016 年 11 月の更新プログラムに含まれる Power BI の新機能
このチュートリアルでは、Dynamics 365 for Operations の 2016 年 5 月以降の更新プログラムが必要です。 このチュートリアルでは、次の新しい機能を使用します。

-   エンティティ格納で集計測定をステージングし、Dynamics AX のデータを更新します。 メモリ内リアルタイムの集計測定値には、このオプションの方を選択する可能性があります。
    -   Dynamics AX 2012 キューブをアップグレードします。
    -   集計の測定は非常に大規模です。
    -   データの新しさ (待機時間) は、数分から数時間まで報告することができます。
-   定期的な更新をスケジュールするには、バッチ フレームワークを使用します。 このリリースでは、完全な更新のみが有効になります。
-   開発者/テスト環境で Power BI デスクトップを使用してレポートを作成します。
-   Power BI コンテンツを作成するときに、直接クエリ オプションを活用できます。 たとえば、データ更新のメカニズムとして OData に依存せず、大きなモデルを作成できます。
-   Lifecycle Services (LCS) を使用してレポートを開発環境から実稼働環境に移行します。
-   パートナーまたは ISV として、Power BI コンテンツを LCS ソリューションの一部として顧客に配布することができます。
-   **11 月の更新 (プラットフォーム リリース 1611) 以降を使用している場合**、このドキュメントのいくつかの手順は、エンティティ ストアを更新するプロセスの一部です。手動で実行する必要はありません。

## <a name="change-upgraded-aggregate-measurement-properties"></a>アップグレードされた集計の測定プロパティの変更
コード アップグレード プロセスの一環として、Dynamics AX 2012 のアプリケーション オブジェクト ツリー (AOT) からの分析サービス プロジェクトを新しい集計測定メタデータ形式に移行することができます。

1.  Visual Studio を起動し、アプリケーション スイートで新しいプロジェクトを作成します。

    > [!NOTE]
    > モデルを作成し、カスタマイズされた集計測定をそのモデルに含めることができます。 詳細については、[カスタマイズ: オーバーレイおよび拡張機能](../extensibility/customization-overlayering-extensions.md) を参照してください。

2.  アプリケーション エクスプローラを開きます。 **分析** &gt; **分析視点** &gt; **集計の測定**と移動します。 Finance and Operations の現在のバージョンに同梱されている測定だけでなく、Dynamics AX 2012 R3 からアップグレードされた集計の測定のセットが表示されます。
3.  **SalesCube** を選択します。 右クリックし、**プロジェクトで複製** を選択します。
4.  **SalesCubeCopy** という名前の集計の測定がプロジェクトに追加されます。
5.  この測定値の名前を変更します。 ソリューション エクスプローラーで、**SalesCubeCopy** を選択します。 右クリックし、**名前の変更** を選択します。 **SalesCubeV2** という新しい名前を入力します。
6.  Aggregate measurement designer を起動するには、**SalesCubeV2** をダブルクリックします。 Dynamics AX 2012 から移行された集計の測定の構造体を確認します。
7.  Dynamics AX 2012 の Sales キューブは、販売に関連する広範な分野を包含していました。 この場合、アップグレードしたメタデータを使用してより小規模で焦点を絞った Power BI モデルを作成しましょう。 **販売注文明細行**のメジャー グループを展開し、メジャー リストおよび分析コードの参照を確認します。

    > [!NOTE]
    > モデリング機能を活用することで、このモデルをすばやく機能拡張することができます。 改善の提案:
    >
    > -   メジャー グループ (または分析コード) をモデル化するために使用されたビュー/テーブルをエンティティに置き換えます。 基になるビューを使用してエンティティをモデリングして、対応するエンティティでビューを置き換えることができます。 これにより、インクリメンタル リフレッシュおよびセキュリティなど、今後登場する機能を活用できます。
    > -   属性ノードに対応するフィールドを追加することで、不要な分析コードの参照を削除します。 たとえば、メジャー グループの**サイズ**フィールドが十分に説明され、サイズの分析コード参照は削除されます。 これにより、クエリのランタイム パフォーマンスとリフレッシュ時間が向上します。

8.  集計測定デザイナーで **SalesCubeV2** ルート ノードを選択します。 右クリックし、**プロパティ** を選択します。
9.  アップグレード中に、集計の測定はレガシ プロパティ フラグ **SSASCube** に設定されます。 サポートされる使用法の 2 つのタイプのいずれかに、このプロパティを変更する必要があります。 以前は、**InMemoryRealTime** は集計測定値の使用方法としてサポートされていました。 **StagedEntityStore** は新しい使用タイプとしてサポートされています。

    > [!NOTE]
    > 埋め込み BI シナリオおよび Power BI 統合に集計の測定を使用する場合は、用途プロパティを InMemoryRealTime に変更します。 Power BI または Cortana Intelligence との統合に対してのみ集計測定を使用している場合は、**StagedEntityStore** を選択します。

10. プロジェクトを保存します。 ソリューション エクスプローラーでプロジェクトを選択し、**リビルド** を選択します。
11. 再構築操作を完了した後、プロジェクトを保存し、Visual Studio を閉じます。 これで開発作業は完了です。 レポート作成者またはパワー ユーザーとしてレポートを作成します。

## <a name="refresh-the-entity-store"></a>エンティティ格納を更新
管理者は、クライアントを使用して集計測定の更新をコンフィギュレーションできます。

1.  Dynamics AX クライアントを起動して、**システム管理** &gt; **設定** &gt; **エンティティ格納**に移動します。 **エンティティ格納** フォームには、エンティティ格納に配置するために使用できる集計測定の一覧が表示されます。
2.  **売上キューブ** (Dynamics AX 2012 からアップグレードされた) がエンティティ格納への配置に使用できないことを確認します。 **SalesCubeV2**、前の手順で作成したものをエンティティ格納に展開できます。
3.  リストから **SalesCubeV2** を選択し、**更新** ボタンをクリックします。 **更新** ダイアログ ボックスが表示されます。 **バックグラウンドで実行**タブを展開します。
4.  **タスクの説明** フィールドにわかりやすい名前を入力します。 必要に応じて、**定期的なアイテム** タブを選択し、1 回限りの更新ではなく定期的なスケジュールを作成できます。 **OK** をクリックします。
5.  エンティティ ストア内の集計測定値をリフレッシュするためのバッチ ジョブが作成されます。

## <a name="authoring-a-report-on-sales-by-state-with-power-bi-desktop"></a>Power BI desktop を使用して都道府県別売上レポートの作成
このステップでは、「[Microsoft Power BI Desktop](https://www.microsoft.com/download/details.aspx?id=45331)」からダウンロードできる Power BI デスクトップ ツールをインストールする必要があります。

1.  Power BI デスクトップを起動します。 更新を適用することが必要な場合があります。 ウェルカム ページが表示されます。 **データの取得**をクリックします。
2.  または、Power BI デスクトップが起動したとき、**ホーム**タブの**データの取得** &gt; **SQL Server** を選択します。
3.  **SQL Server データベース** ダイアログ ボックスで、サーバー名とエンティティ ストア データベースの名前を入力します。 開発環境を配置する場合は、“.” を入力できます。 サーバー名として、および **AxDW** をデータベースとして。 テスト環境で作業している場合、システム管理者からこれらのパラメータを取得する必要があります。
4.  **DirectQuery** オプションを選択します。 この練習では、エンティティ格納に直接実行される Power BI レポートを作成します。 **インポート** オプションを使用した場合、Power BI ではエンティティ格納のデータがキャッシュされるため、Power BI モデルを定期的に更新する必要があります。 **エンティティ格納を使用して書かれたレポートでは、インポート モードは現在サポートされていません**。 **OK** をクリックします。
5.  次に、**ナビゲーター** ダイアログ ボックスが表示されます。 ナビゲーターで、レポートの対象となるテーブルとビューをエンティティ格納から選択できます。 検索ボックスで**販売**を入力します。 以前に作成された **SalesCubeV2** 集計測定に関連するエンティティがフィルタリングされます。

    > [!NOTE]
    > エンティティ ストアは作成された集計の測定をステージします。 それぞれの集計測定内のエンティティには接頭語が付けられて別々のテーブルとして保管されますが、Power BI デスクトップを使用すると複数の集計測定からのデータを結合することができます。

6.  都道府県別の売上を表示するレポートを作成します。 ナビゲーターから **SalesCubeV2\_Customer** および **SalesCubeV2\_CustomerInvoices** を選択し、**読み込み** をクリックします。
7.  選択したエンティティ (右端) に**フィールド**が存在する Power BI デザイナーが、使用可能な視覚化とともに表示されます。

### <a name="create-a-surrogate-key-that-links-customers-and-invoices-applies-to-platform-versions-before-november-2016-update"></a>顧客と請求書をリンクする代理キーを作成する (2016 年 11 月アップデート以前のプラットフォームに適用)

> [!NOTE]
> プラットフォームの 2016 年 11 月以降のリリースで作業している場合は、この手順を実行する必要はありません。 代理キーは、エンティティ格納にステージングされる集計測定で生成されます。 Power BI デスクトップでは、複数のフィールド (複合キーとも呼ばれます) を使用してテーブル結合を関連付けることができません。 **SalesCubeV2\_Customer** エンティティでは、代理キー (AX RecID など) が定義されていません。 次に、請求書に顧客エンティティを関連付けできる代理キーを作成します。

1.  **SalesCubeV2\_CustomerInvoices** エンティティの横にある省略記号 (...) アイコンを選択します。 右クリックし、**新しい列** を選択します。
2.  **フォーミュラ エディタ**ウィンドウに次の式を入力します。

```
FKCustomer = CONCATENATE(CONCATENATE(SalesCubeV2_CustomerInvoices[DATAAREAID], "-"), SalesCubeV2_CustomerInvoices[ORDERACCOUNT])
```

> [!NOTE]
> フィールド名または関数の最初の数文字を入力すると、エディターに候補フィールドの一覧が表示されます。 これは、先行入力機能と呼ばれます。 この式をコピーして貼り付けるか、タイプ先行機能を使用することができます。

1.  完了すると、式は次のようになるはずです。

[![Power BI フォーミュラ](./media/powerbiformula.png)](./media/powerbiformula.png)

1.  新しいフィールド **FKCustomer** が **SalesCubeV2\_CustomerInvoices** テーブルのフィールドの一覧に表示されていることに注意します。 このフィールドは 2 つのテーブルを関連付けるために使用されるので、フィールドを右クリックして**非表示**オプションを選択するとエンド ユーザーから非表示にすることができます。
2.  次に、**SalesCubeV2\_Customer** テーブルに類似したフィールドを作成します。 **SalesCubeV2\_Customer** エンティティの横にある省略記号 (...) アイコンを選択します。 右クリックし、**新しい列** を選択します。
3.  **フォーミュラ エディタ**ウィンドウに次の式を入力します。

```
FKCustomer = CONCATENATE(CONCATENATE(SalesCubeV2_Customer[DATAAREAID], "-"), SalesCubeV2_Customer[CUSTOMER])
```

1.  フィールド **FKCustomer** が **SalesCubeV2\_Customer** テーブルのフィールドの一覧に表示されていることに注意します。 このフィールドは 2 つのテーブルの関連付けに使用されるため、フィールドを右クリックして**非表示**オプションを選択するとエンド ユーザーから非表示にすることができます。

### <a name="relate-invoices-and-customers"></a>請求書および顧客を関連付ける

> [!NOTE]
> 2016 年 11 月以降のバージョン プラットフォームでは、既にエンティティ ストア内で作成された代理キーを関連付けることができます。 それ以外の場合は、手動で作成した代理キーを関連付ける必要があります。 次に、**SalesCubeV2\_CustomerInvoices** と **SalesCubeV2\_Customers** のエンティティのリレーションシップを作成します。

1.  Power BI リボンの**関係の管理**ボタンをクリックします。 **リレーションシップの管理** ダイアログ ボックスが表示されます。 **新規**ボタンをクリックします。
2.  **関係の作成**ダイアログ ボックスで、**SalesCubeV2CustomerInvoices** をドロップダウン リストの最初のテーブルとして選択します。 右にスクロールし、関連する列として **FKCustomer** フィールドを選択します。
3.  2 番目のドロップダウン リストで、**SalesCubeV2Customer** をテーブルとして選択します。 右にスクロールし、関連する列として **FKCustomer** を選択します。
4.  **この関係を有効にする** オプションがまだオンになっていない場合はオンにします。 **OK** をクリックして続行します。
5.  新しく作成されたリレーションシップは **リレーションシップの管理** ダイアログ ボックスでわかります。 **閉じる**ボタンをクリックします。

### <a name="create-a-sales-by-state-report"></a>都道府県別売上レポートを作成する

1.  顧客グループによる売上を示すレポートを作成するには、**SalesCubeV2\_CustomerIncoices** テーブルから **CustomerInvoiceAmountAccountingCurrency** フィールドをドラッグして、Power BI デスクトップ キャンバスにドロップします。 次に、**SalesCubeV2\_Customer** テーブルの **CustomerGroupName** フィールドを同じグリッドにドラッグします。
2.  グラフの種類をドーナツ グラフに変更します。 次のようなレポートが表示されます。

[![Power BI ドーナツ グラフ](./media/doughnut-chart-1024x733.png)](./media/doughnut-chart.png)

1.  Power BI デスクトップを使用して、追加のビジュアルを作成することができます。 保存するとき、ファイルに **PBIX** 拡張子が付いていることがわかります。
2.  レポートをデスクトップに保存します。
3.  この時点でレポートは (環境のデータで) 完全に機能しており、Power BI デスクトップを引き続き使用するか、このレポートを PowerBI.com にアップロードしてデータの検索を続行できます。
4.  次に、LCS を使用してこのレポートを実稼働環境に移行し、生産データとともにこのレポートを表示して、他のユーザーと共有できるようにします。

## <a name="publish-the-report-and-the-model"></a>レポートおよびモデルを公開
レポートとモデルの発行には、Lifecycle Services へのレポートのアップロード、集計単位の実稼動環境への移行、適切な LCS ライブラリをポイントするためのクライアントの構成、実稼働環境でのレポートの発行が必要です。

### <a name="upload-the-report-to-lifecycle-services"></a>レポートを Lifecycle Services にアップロード

Microsoft Dynamics Lifecycle Services (LCS) は、開発者から実稼働環境に開発コンポーネントを移行するために使用するツールです。 2016 年 5 月の更新プログラムで、LCS は環境間の PBIX ファイルの移行 (エンティティ格納を使用して作成) をサポートします。

1.  開発環境から [LCS](https://lcs.dynamics.com/) を起動します。 LCS 環境で、プロジェクトを作成していない場合は、プロジェクトを作成します。
2.  右にスクロールし、**アセット ライブラリ** アイコンを確認します。 アイコンをクリックし、**アセット ライブラリ**を起動します。

アセット ライブラリを使用して、プロジェクトに **Power BI レポート モデル** (PBIX ファイル) を実装コンポーネントとして追加できることに注意します。

1.  プラス記号 (+) を選択し、新しい資産を追加します。
2.  名前と説明を入力します。 **アップロード**をクリックし、前の手順で保存したファイルを探します。
3.  ファイルを正常にアップロードした後、**確定**をクリックします。 ファイルが実装アセットとして LCS にアップロードされることを確認します。 LCS は、バージョン管理をサポートして、Power BI レポートをリリースします。 他の実装コンポーネントに対するのと同じ方法で、複数のバージョンを管理してレポートを他環境に公開することができます。 PBIX ファイルを LCS プロジェクト内の資産として追加したため、そのプロジェクトを使用して配備した環境はこのレポートにアクセスできます。
4.  必要に応じて、すべてのプロジェクトが共用資産にアクセスできるように、このレポートを発行することができます。 パートナーまたは ISV であり、お客様とこのレポートを共有する場合は、グローバル ライブラリにこの資産を共有し、顧客が資産をそれぞれの LCS プロジェクトにインポートできるようにします。 これを行うには、**マイライブラリに保存** オプションを選択します。

### <a name="migrate-the-aggregate-measurement-to-a-production-environment"></a>集計の測定の実稼働環境への移行

1.  開発環境で修正した集計測定を実稼働環境に移行する必要があります。 配置可能パッケージを生成の指示に従うことができます。 create-apply-deployable-package.md.
2.  モデルを正常に公開した後、このチュートリアルの**エンティティ ストアを更新**セクションの説明している手順に従って実行し、エンティティ ストアはデータを更新できるようにします。

### <a name="configure-an-lcs-project"></a>LCS プロジェクトをコンフィギュレーションする

まだ実行していない場合は、環境と LCS プロジェクトを関連付けることで、Finance and Operations がプロジェクト内の資産を消費できるようにします。

1.  Power BI レポートの配置に使用するインスタンスからクライアントを起動します。 これは通常、データ セットのレポートを表示するテストまたは本番のインスタンスであり、レポート開発者として作業したものとは異なります。
2.  **システム管理**&gt;**設定**&gt;**システム パラメーター**を開きます。 **ヘルプ** タブを選択します。**Lifecycle Services のヘルプ構成** ボックスの一覧を使って、PBIX ファイルをアップロードした LCS プロジェクトを選択します。 **保存**をクリックします。

    > [!NOTE]
    > このフォームには、現在のユーザーがアクセスできる LCS プロジェクトのみが表示されます。 このステップが管理者によって実行される場合、管理者がプロジェクトにアクセスする必要があるか、または PBIX コンポーネントが管理者がアクセスできるプロジェクトにインポートする必要があります。

### <a name="publish-power-bi-reports-to-a-production-environment"></a>Power BI レポートを実稼働環境に公開

1.  クライアントから**システム管理**&gt;**設定**&gt;**PowerBI の配置**を開きます。 LCS にアップロードしたファイルが分かります。
2.  **売上報告書** ファイルを選択し、メニュー バーで **Power BI ファイルの配置**オプションを選択します。

    > [!NOTE]
    > PowerBI.com サービスへの公開に同意するよう求められる場合があります。 同意するには、リンクをクリックしてください。 同意が完了すると、元のブラウザー ウィンドウに戻り、**閉じる** ボタンをクリックする必要があります。

3.  ファイルを正常に公開した後、Power BI レポートは PowerBI.com サブスクリプションに表示されます。 レポートが実稼働環境にあるエンティティ格納を現在指さしていることがわかります。

## <a name="continuing-with-powerbicom"></a>PowerBI.com での継続
管理者またはパワーユーザーは、エンティティ格納を使用して実稼動環境に Power BI レポートを作成し公開することに成功しています。 Power BI 機能を使用して、いくつかの追加手順を実行することができます。

-   必要に応じて、データセットにレコード レベルのセキュリティを適用して、Power BI での表示が許可されていないデータの表示をユーザーに制限することができます。
-   組織のコンテンツ パックを作成して、グループ内のユーザーの間で共有することができます。
    -   PowerBI.com インスタンスから、データベース、レポート、およびダッシュボードを、新しいコンテンツパックとして、選択したユーザーのグループにエクスポートすることができます。
    -   組織のコンテンツ パックは、データセット レベルで定義した任意のレコード レベルのセキュリティ ルールに従うことに注意してください。
-   Power BI タイルまたはレポートを追加することによって、自分のワークスペースをパーソナライズできます。


<a name="additional-resources"></a>追加リソース
--------

[集計データのモデリングと使用](../analytics/model-aggregate-data.md)



