---
title: ビジネス イベント
description: このトピックは、外部システムが Dynamics 365 for Finance and Operations から通知を受信するためのメカニズムを提供するビジネス イベントに関する情報を提供します。
author: Sunil-Garg
manager: AnnBe
ms.date: 06/24/2019
ms.topic: article
ms.prod: ''
ms.service: dynamics-ax-applications
ms.technology: ''
audience: IT Pro
ms.reviewer: sericks
ms.search.scope: Operations, Core
ms.search.region: Global for most topics. Set Country/Region name for localizations
ms.author: sunilg
ms.search.validFrom: Platform update 24
ms.dyn365.ops.version: 2019-02-28
ms.openlocfilehash: bc8eb0eb5be4df23a9aece50904fb214523c9d72
ms.sourcegitcommit: d599bc1fc60a010c2753ca547219ae21456b1df9
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 06/25/2019
ms.locfileid: "1702738"
---
# <a name="business-events"></a>ビジネス イベント

[!include[banner](../includes/banner.md)]

ビジネス イベントは外部システムが Microsoft Dynamics 365 for Finance and Operations から通知を受信するメカニズムを提供します。 これにより、システムは、ビジネス イベントに対してビジネス アクションを実行できます。

ビジネス プロセスの実行時に、ビジネス イベントが発生します。 ビジネス プロセス中には、それに参加するユーザーは、ビジネス プロセスを構成するタスクを完了するビジネス アクションを実行します。 

Finance and Operations では、ユーザーが実行するビジネス アクションは、ワークフロー アクションまたは非ワークフロー アクションのいずれかにすることを選択できます。 購買要求の承認はワークフロー アクションの例で、発注書の確認は非ワークフロー アクションの例です。 どちらのタイプのアクションも、統合および通知のシナリオで、外部システムが使用できるビジネス イベントを生成できます。 

## <a name="prerequisites"></a>必要条件

- ビジネス イベントは Microsoft Flow およびAzureメッセージング サービスにて利用できます。 したがって、ビジネス イベントを使用する際には、顧客が該当するアセットのサブスクリプションを契約している必要があります。

> [!IMPORTANT]
> ビジネス イベントを Finance and Operations からデータをエクスポートするためのメカニズムと考えることはできません。 定義上は、ビジネス イベントは簡易で軽快であることになっています。 データ エクスポートのシナリオを実行するために大量のペイロードを搭載することは想定していません。

## <a name="business-events-that-are-implemented-in-finance-and-operations"></a>Finance and Operationsに実装されているビジネス イベント

Finance and Operations では、ビジネス イベントは、最初から用意されているいくつかのビジネス プロセスに実装されます。 これらのビジネス イベントには、ワークフローおよび非ワークフロー ビジネス イベントの両方が含まれます。 詳細については [アプリケーション ビジネス イベント](app-business-events.md)、[ワークフロー ビジネス イベント](business-events-workflow.md)、[ビジネス イベントとしての警告](alerts-business-events.md) を参照してください。

開発者は、拡張機能を使用して、新しいビジネス イベントを実装する必要があります。 詳細については、「[ビジネス イベント開発者ドキュメント](business-events-dev-doc.md)」を参照してください。

## <a name="business-event-catalog"></a>ビジネス イベント カタログ

ビジネスイベントカタログには、**システム管理 > > ビジネスイベント**を設定するためにアクセスできます。 ビジネス イベント カタログには、使用している Finance and Operations のインスタンスで使用できるビジネス イベントが一覧表示されます。 カタログは、どのビジネス イベントが使用可能かを示し、カテゴリ、ビジネス イベントのIDおよび名前でフィルタ処理することができるため、便利です。

ビジネス イベントのカテゴリは、Finance and Operationsにおいて、そのソースを識別します。 ワークフロー システムから生成されたビジネス イベントは、**ワークフロー** カテゴリに割り当てられます。 他のモジュールから生成されたビジネス イベントについては、モジュール名はカテゴリ名として使用されます。 

ビジネス イベント カタログは、配置時のデータベースの同期中に作成されます。 したがって、ユーザーは、カタログでビジネス イベントの完全な一覧を確認することになります。 ただし、カタログの明示的な更新が必要な場合は、**管理 \> 再構築ビジネス イベント カタログ**を選択します。

![ビジネス イベント カタログ](../media/businesseventscatalog.png)

各ビジネス イベントについて、ビジネス イベント カタログは説明を表示します。 この説明は、ビジネス イベントおよびビジネス プロセス内のコンテキストを理解するのに役立ちます。 カタログには、イベントに送信されるデータ フィールドの一覧も表示されます。

外部の統合システムが開発中にビジネス イベントのペイロードのスキーマを必要とする場合、**ダウンロード スキーマ**を選択して JavaScript Object Notation (JSON) スキーマをダウンロードします。

簡単に言うと、ビジネス イベント カタログは、実装に必要なビジネス イベントを識別するのに役立ちます。 各ビジネス イベントのスキーマを識別することもできます。

次のステップでは、エンドポイントを管理します。

## <a name="business-events-processing"></a>RFID 業務プロセス
Finance and Operations では、ほぼリアルタイムでビジネスイベントを処理する専用のバッチスレッドが割り当てられます。 スレッドの最大数は、システムで使用可能なスレッドの合計を超えることはできません (**System administration > Server configuration**)。 スレッドはすべてのバッチ処理と共有されているリソースであるため、ビジネスイベントのスレッド割り当てを変更する場合は注意が必要です。 ビジネスイベントに割り当てられるスレッドの合計数は、ビジネスイベント パラメータ テーブル内のパラメータを使用して管理されています。 この設定は、ユーザーインターフェイス (UI) 上では非表示となっており、運用環境においてはデータベースへのアクセスが必要となるため、この変更を行うにはサポート案件として対応する必要があります。

従来のビジネスイベントでのバッチ処理ジョブは利用可能となっており、必要に応じて利用することで専用処理を運用する際の問題を軽減する回避策となります。 ユーザーの混乱を回避するために、ビジネスイベントでのバッチ処理を設定するメニューは削除されています。 メニュー上表示されてはいませんが、バッチ UI から BusinessEventsBundleBatchProcessor クラスを使用することでバッチジョブを手動で作成できます。 回避策として必要不可欠な場合を除き、この手動バッチジョブを実行しないように留意してください。 このバッチジョブが古いプラットフォームのいずれかで設定されていた場合は、最新のプラットフォームに更新された際にこのバッチが無効となり、専用処理が自動で実行されます。 この挙動は、ビジネスイベント パラメータ テーブル の パラメータ を使用して管理されており、ここでは手動バッチジョブが初期設定では無効になっているためです。

## <a name="managing-endpoints"></a>エンドポイントの管理

エンドポイントを使用して、Finance and Operations がビジネス イベントを送る必要がある宛先を管理できます。 次のタイプのエンドポイントが現在サポートされています。 したがって、すぐにこれらのメッセージングおよびイベント ブローカーのエンドポイントを作成できます。

- Azure Service Bus キュー
- Azure Service Bus トピック
- Azure Event Grid
- Azure イベント ハブ
- HTTPS
- Microsoft Flow

消費者にビジネス イベントを組織化して配布するため、複数のエンドポイントが必要になる場合があります。 このようなシナリオをサポートするため、複数のエンドポイントを作成することができます。

Azure ベースのエンドポイントは、顧客の Azure サブスクリプションに含まれている必要があります。 たとえば、イベント グリッドをエンドポイントとして使用する場合は、エンドポイントが顧客の Azure サブスクリプションに含まれている必要があります。

Finance and Operations はエンドポイントを提供しません。 用意されているイベントをエンドポイントに送信するだけです。 顧客が Azure サブスクリプションでこれらのエンドポイントを使用している場合、追加費用が発生する可能性があります。

![ビジネス イベントのエンドポイント](../media/businesseventsendpoint.png)

### <a name="create-an-azure-service-bus-queue-endpoint"></a>Azure Service Bus キュー エンドポイントの作成

新しいエンドポイントを作成するには、**新規作成**を選択します。 次に、**エンドポイントの種類**フィールドで、適切なエンドポイントの種類を選択します。 Service Bus キューにエンドポイントを作成するには、**Azure Service Busキュー**を選択します。

![ビジネス イベントの新規エンドポイント](../media/businesseventsnewendpoint1.png)

**次へ**を選択し、エンドポイントおよび Service Busキューの名前を指定します。 また、Azure メッセージング リソースにシークレットを提供するために、Azure Key Vault を設定する必要があります。 また、Azure Active Directory (Azure AD) アプリケーション ID およびアプリケーション シークレットを設定する必要があります。

![ビジネス イベントの新規エンドポイント](../media/businesseventsnewendpoint2.png)

**キュー名**フィールドに、Azure の Azure Service Bus キューの構成で作成した**Azure Service Bus キュー**名を入力します。  

![ビジネス イベント キュー名](../media/BusinessEventsSBQueueName.PNG)

**Azure Active Directory アプリケーションID**フィールドに、Azure ポータルの Azure AD で作成されたアプリケーションIDを入力します。

![ビジネス イベントの Azure AD のコンフィギュレーション](../media/businesseventsaad1.png)

**Azure アプリケーション シークレット** フィールドに、アプリケーションのシークレット値を入力します。

![ビジネス イベントの Azure AD のコンフィギュレーション](../media/businesseventsaad2.png)

**Key Vault DNS 名**フィールドに、Key Vault設定名を入力します。

![ビジネス イベントの Azure Key Vault のコンフィギュレーション](../media/businesseventskeyvault1.png)

**Key Vault シークレット名**フィールドに、Key Vaultに作成する必要があるエンドポイント リソースのシークレット名を入力します。

![ビジネス イベントの Azure Key Vault のコンフィギュレーション](../media/businesseventskeyvault2.png)

Azure では、**Key Vault シークレット**の値は Azure Service Busの**プライマリ接続文字列**の値になります。 この値は**共有アクセス ポリシー > RootManagedSharedAccessKey** で構成した Azure Service Bus で確認できます。

![ビジネス イベントの Azure Key Vault のキー値](../media/BusinessEventsKVSValue.PNG)

> [!IMPORTANT]
> また、登録された Azure アプリケーションは、Key Vault のアクセス ポリシーで設定された Key Vault に追加する必要があります。 この設定を完了するには、**キー、シークレット、および証明書の管理**テンプレートを選択し、アプリケーションを**プリンシパル**として選択します。

### <a name="create-an-azure-service-bus-topic-endpoint"></a>Azure Service Bus トピック エンドポイントの作成

Service Bus トピックにエンドポイントを作成するには、**新規**を選択し、次に**エンドポイントの種類**フィールドで、**Azure Service Bus トピック**を選択します。 **トピック名**フィールドは、Service Bus トピック名に設定する必要があります。 Key Vault の情報は、Azure Service Bus キュー エンドポイントの設定と同じ方法で設定されます。

### <a name="create-an-azure-event-grid-endpoint"></a>Azure イベント グリッド エンドポイントの作成

エンドポイントを作成するには、Azure ポータルで **Azure イベント グリッド トピック**を作成して構成し、次に**ビジネス イベント ワークスペース**でイベント グリッド トピックにエンドポイントを作成する必要があります。 **エンドポイント**タブに移動し、**新規**を選択し、**エンドポイントの種類**で **Azure イベント グリッド**を選択します。 **エンドポイント URL** フィールドで、**Azure イベント グリッド トピック**からURLを入力します。 これは、イベント グリッド トピックの**概要**セクションの**トピック エンドポイント**の値です。

> [!IMPORTANT]
> また、登録された Azure アプリケーションは、Key Vault のアクセス ポリシーで設定された Key Vault に追加する必要があります。 この設定を完了するには、**キー、シークレット、および証明書の管理**テンプレートを選択し、アプリケーションを**プリンシパル**として選択します。

![ビジネス イベントのイベント グリッド エンドポイントの値](../media/BusinessEventsEGTopicsEndpoint.PNG)

Key Vault の情報は、Azure Service Bus キュー エンドポイントの設定と同じ方法で設定されますが、Key Vault シークレットだけはService Bus 接続文字列ではなく、イベント グリッドの資格情報に設定する必要があります。  イベント グリッドの資格情報は、設定セクションの **Access Keys** で作成されたイベント グリッドで確認できます。 

![ビジネス イベントのイベント グリッド資格情報の値](../media/BusinessEventsEGKeyValue.PNG)

必要なエンドポイントを作成したら、次に、ビジネス イベントを有効にします。


## <a name="activating-business-events"></a>ビジネス イベントの有効化

既定では、ビジネス イベント カタログのビジネス イベントは有効ではありません。 カタログから必要なビジネス イベントを有効化することができます。 1つまたは複数のビジネス イベントを選択し、**有効化**を選択します。

![ビジネス イベントの有効化](../media/businesseventsactivation.png)

ビジネス イベントは、すべての法人または特定の法人のいずれかで有効化できます。 **法人**フィールドを空白のままにすると、選択したビジネス イベントは*すべて*の法人で有効化されます。 ビジネス イベントが特定の法人に対してのみ必要な場合は、法人ごとに個別に構成する必要があります。

有効化されるビジネス イベントにエンドポイントを割り当てる必要があります。

ビジネス プロセスの実行時にビジネス イベントが発生した場合、システムは有効化されたビジネス イベントに対してのみ、発信処理を行います。

ビジネス イベントが有効化されると、**有効なイベント**タブに表示されます。

![有効なビジネス イベント](../media/businesseventsactivetab.png)

**の有効なイベント**タブで、ビジネス イベントを無効にできます。 システムは、無効化されたイベントには発信処理を行いません。

ビジネス イベントが無効化されると、 それらは **無効なイベント** タブに表示されます。

![無効なビジネス イベント](../media/businesseventsinactivetab.png)

統合環境におけるシステムの管理活動のためにビジネス イベントの処理をある期間停止する必要がある場合、ビジネス イベントを無効にできます。

ビジネス要件を変更するときに、ビジネス イベントが不要になる場合があります。 この場合、有効なイベントの一覧から削除するのではなく、無効にできます。 この方法は、ビジネス イベントのエラーの履歴を保持する必要がある場合に役立ちます。 無効化されたビジネス イベントは、無効のまま保持する必要があるビジネスがなくなった場合、後で削除することができます。

## <a name="errors"></a>エラー

システムがビジネス イベントの発信処理を行う間にエラーが発生する場合があります。 これらのエラーにより、システムがエンドポイントにビジネス イベントを正常に送付できない可能性があります。 エラーが発生した場合、システムはビジネス イベントを正常に処理するため、何度か再試行します。 しかし、試行が全く成功しなかった場合は、ビジネス イベントはエラー ログに保存されます。

エラー ログには、**有効なイベント**、**無効なイベント**、および**エラー**タブからアクセスできます。 **エラー**タブにはすべてのビジネス イベントのすべてのエラーが表示され、他の2つのタブには特定のビジネス イベントに関連するエラーが表示されます。

**再送信**アクションを使用して、各エラーにおける発信処理を必要に応じて行うことができます。 このアクションは、発信処理ロジックを起動します。 このロジックには、再試行が含まれます。 発信処理がそれでも成功しない場合は、エラー ログにエラーが記録されます。 この場合、**エラー**タブの**最終処理時間**フィールドに、イベントの処理が発生した最終時間が表示されます。

エラーを正常に処理できない場合は、必要に応じて**ダウンロード ペイロード** オプションを使用し、イベントからペイロードをダウンロードしてオフライン処理します。

> [!NOTE]
> エンドポイントが削除され、新しいエンドポイントがビジネス イベントに関連付けられている場合は、ビジネス イベントに関連付けられているすべてのエラーは引き続き再送信できます。 この場合、システムは発信処理システムを実行し、対応するビジネス イベントに関連付けられている新しいエンドポイントに送信します。 この機能により、コンフィギュレーションのミスやその他のエラー状態から上手に復旧できます。

## <a name="business-event-consumption-models"></a>ビジネス イベント消費モデル

実装の統合の要件と統合ソリューションの設計はさまざまです。 統合の要件は、ビジネス イベントの消費モデルの識別に影響します。 簡単に言うと、ビジネス イベントを使用した統合を設計する際に、次の点を考慮する必要があります。

- ビジネス イベントは Microsoft Flow、Service Bus、イベント グリッド、その他のエンドポイント タイプを使用して消費できます。
- Microsoft Flow、Service Bus、イベント グリッド、その他のエンドポイント タイプを使用するには、顧客は独自の購読を提供する必要があります。
- ビジネス イベントは、すべての法人または特定の法人で有効化できます。
- ビジネス イベントは、一意のエンドポイントまたは同一のエンドポイントに送信できます。
- Microsoft Flow はビジネス イベントを直接購読できます。

## <a name="idempotency"></a>べき等
ビジネス イベントはペイロードに管理番号を含めることで消費側でべき等の動作を有効にします。 制御番号は増加する番号であり、重複や故障出荷を検出するために消費アプリケーションによって追跡できます。 制御番号は連番にできないため、順序番号と読み間違えられることはありません。 番号付けスペースに間隔がある可能性があります。

## <a name="filtering-in-azure-event-grid-and-azure-service-bus"></a>Azure Event Grid と Azure Service Bus でのフィルター処理
Azure Service Bus と Azure Event Grid は受信メッセージの条件を指定してトピックの購読をサポートします。 詳細については [トピック フィルターとアクション](https://docs.microsoft.com/en-us/azure/service-bus-messaging/topic-filters) および [イベント グリッド購読のイベント フィルターを理解する](https://docs.microsoft.com/en-us/azure/event-grid/event-filtering) を参照してください。

Azure Service Bus や Azure Event Grid に送信されるビジネス イベントは、この目的で使用できる次のフィールドを持ちます。 購読者はこの情報を使用して、必要に応じてさらに特定のトピックを購読できます。

-   **カテゴリ** - これはビジネス イベント カタログに表示されたビジネス イベントのカテゴリです。 複数のカテゴリから共通トピックがビジネス イベントの受信に使用されていて、購読者が関心のあるカテゴリのビジネス イベントのみを受信する必要がある場合に、これはフィルター条件として役立ちます。

-   **ビジネス イベント ID** – これはビジネス イベント カタログに表示されたビジネス イベント実装のクラス名です。 これはビジネス イベント (ビジネス イベントのインスタンスではない) を一意に識別して、したがって消費者側で受信したビジネス イベントを検証し、期待されるビジネス イベントが受信および処理されていることを検証するのに役立ちます。

-   **法人** – これはビジネス イベントが発生した法人です。 消費側でのビジネス イベントの処理および配信が法人によって推進される必要がある場合、これは消費ロジックを基準とするのに役立つ情報です。

> [!NOTE]
> ビジネス イベントで送信されるフィルター処理可能フィールドは、カスタムフィールドを含むように変更できます。 これは開発者向けの環境です。
