---
title: "オンプレミス配置への更新プログラムの適用"
description: "このトピックでは、Microsoft Dynamics 365 for Finance and Operations のオンプレミス展開に更新プログラムを適用する方法について説明します。"
author: manalidongre
manager: AnnBe
ms.date: 07/05/2018
ms.topic: article
ms.prod: 
ms.service: dynamics-ax-platform
ms.technology: 
audience: Developer, IT Pro
ms.reviewer: kfend
ms.search.scope: Operations
ms.custom: 
ms.assetid: 
ms.search.region: Global
ms.author: sarvanis
ms.search.validFrom: 2017-06-30
ms.dyn365.ops.version: Platform update 12
ms.translationtype: HT
ms.sourcegitcommit: fe0a25217e69f19c66f9e2dd8be1966a53961c03
ms.openlocfilehash: b4f190247ced2e553fd77185cb63f55b30e3241f
ms.contentlocale: ja-jp
ms.lasthandoff: 07/05/2018

---
# <a name="apply-updates-to-an-on-premises-deployment"></a>オンプレミス配置への更新プログラムの適用

[!include [banner](../includes/banner.md)]

このトピックでは、Microsoft Dynamics 365 for Finance and Operations のオンプレミス展開に、サポートされている更新を適用する方法について説明します。 オンプレミス環境でのすべての更新には Microsoft Dynamics Lifecycle Services (LCS) を通じて行われます。

## <a name="search-for-and-download-updates"></a>更新プログラムの検索とダウンロード
オンプレミス環境に適用できる更新プログラムを検索する方法の詳細については、[問題検索](../lifecycle-services/issue-search-lcs.md) を参照してください。 LCS の**環境の詳細**ページの**更新**セクションで、タイルから更新プログラムをダウンロードする方法の詳細については、[更新プログラムをダウンロード](../migration-upgrade/download-hotfix-lcs.md) を参照してください。
   
> [!NOTE]
> オンプレミス環境を更新するときは、常に**環境** 詳細ページの更新タイルから更新プログラムを選択します。 別の場所からの更新を選択した場合、更新が機能しない場合があります。 

## <a name="update-an-on-premises-deployment"></a>オンプレミス配置の更新
展開中または展開の完了後のいずれかのオンプレミス環境に対して、更新プログラムを適用することができます。

オンプレミス環境が展開されているときは、カスタム パッケージの展開を **詳細** 設定で選択することができます。 カスタマイズまたはアプリケーション X++ の更新を適用する方法の詳細については、[カスタム モデルの開発とオンプレミス環境への配置](develop-deploy-custom-models-on-premises.md) を参照してください。

オンプレミス環境の展開後にオンプレミス環境に更新を適用するには、環境の **環境の詳細** ページにある **管理** で **更新プログラムを適用** を選択します。

> [!NOTE]
> プラットフォーム更新プログラム 12 またはそれ以降の環境でのみ、展開後に更新プログラムを適用することができます。 環境には、LCS で使用可能なローカル エージェントの最新バージョンも必要です。 詳細については、「[ローカル エージェントの更新](../lifecycle-services/update-local-agent.md)」を参照してください。 プラットフォーム更新プログラム 12 よりも古いプラットフォームのバージョンを使用している場合は、すでに展開されている環境を再構成して、カスタマイズを更新したり、最新のプラットフォーム リリースに更新したりすることができます。 環境を再配置する方法の詳細については、 [オンプレミス環境を再配置](redeploy-on-prem.md) を参照してください。

## <a name="apply-application-or-binary-updates-through-lcs"></a>アプリケーションまたは LCS を通じてバイナリ更新プログラムを適用します
次の手順を使用して、X++、すべてのバイナリ、またはプラットフォーム バイナリの更新プログラムを適用できます。 

> [!IMPORTANT]
> 更新のアプリケーションには、環境のダウンタイムが必要です。 したがって、更新中に環境内でビジネス トランザクションを実行することはできません。 次の手順を完了したら、システムが使用されていないことと、公式ダウンタイム通知システムがすべてのシステム ユーザーに通知済みであることを確認します。

> [!IMPORTANT]
> 最新のプラットフォームに移動するには、常に、**環境**詳細ページの**プラットフォーム バイナリ更新プログラム**タイルからプラットフォーム更新プログラムを選択します。 別の場所からの更新を選択した場合、更新が機能しない場合があります。 

### <a name="prerequisites"></a>前提条件
- 開始する前に、Management Reporter (MR)、Microsoft Dynamics AX、および Microsoft SQL Server Reporting Services (SSRS データベース) の完全バックアップを完了してください。 コードは LCS を通じて復元されますが、データが失われないよう保証するためにデータベースを手動で復元する必要があります。
- 環境をプラットフォーム更新プログラム 12 の最新ビルドに更新します。
- ローカル エージェントを最新バージョンに更新します。 詳細については、「[ローカル エージェントの更新](../lifecycle-services/update-local-agent.md)」を参照してください。
- 更新のタイプに応じて、以下の手順を実行して配置可能パッケージを生成します。

    - **プラットフォーム バイナリ更新プログラム** – [Download updates wiki](../migration-upgrade/download-hotfix-lcs.md) の手順に従って、LCS のアセット ライブラリに直接アップデートをダウンロードまたは保存します。
    - **アプリケーションのバイナリ更新** - [ダウンロード更新 wiki](../migration-upgrade/download-hotfix-lcs.md) の手順に従って、LCS のアセット ライブラリに直接アップデートをダウンロードまたは保存します。
    - **アプリケーションの X++ 更新** - 開発環境に必要な修正プログラムをダウンロードし、[ランタイム環境に適用するためには、モデルの配置可能なパッケージを作成する](create-apply-deployable-package.md) の手順に従います。
    - **カスタマイズ** - [カスタムモデルの開発と展開](develop-deploy-custom-models-on-premises.md) の手順に従います。

### <a name="update-a-sandbox-environment"></a>サンドボックス環境の更新
1. LCS アセット ライブラリで、このトピックの「前提条件」のセクションで生成された配置可能パッケージを、 **ソフトウェア配置可能パッケージ**  タブにアップロードします。
2. LCS で、オンプレミスの実装プロジェクト開き、更新する環境の**環境の詳細**ページを開きます。
3. **管理** で、**更新プログラムを適用** を選択します。 スライダーでは、アセット ライブラリにアップロードされた更新を表示します。 アセット ライブラリで**有効**としてマークされているパッケージのみが表示されることに注意してください。

**ローカル エージェントのバージョン 2.1.0 以上を使用している場合は、以下の手順を実行する必要があります。**
1. 更新プログラムを選択し、**準備**をクリックします。 **準備**をクリックすると、サービスのオンプレミス環境を準備します。 

>[!NOTE]
> 準備中、環境の状態は**配置済み**になりますが、配置ステータス フィールドは、準備の進行状況を表示します。 パッケージを書式設定しパッケージをダウンロードするなどの手順は、準備中に実行されます。 環境は準備中に直接触れられないため、準備フェーズ中にダウンタイムは発生しません。 ユーザーは、準備時にシステムをそのまま使用できます。 

2. 準備が完了すると、**中止**および**環境の更新**ボタンが表示されます。 更新プログラムの適用を開始するには、**更新の環境**をクリックします。 準備が失敗した場合は、このトピックの後半にある「失敗した更新アプリケーションを解決する」を参照してください。
3. 確認メッセージで**はい**を選択します。 この環境でサービス操作が開始されました。 これは環境のダウンタイムの先頭です。 
4. 環境の状態は、**配置済み**から**配置中**に変更されます。 
5. 更新が完了すると、環境状態は**展開**に戻されます。 更新プログラムの適用に失敗したとき、環境状態は **失敗** に変更されます。 パッケージ アプリケーションが失敗する場合に行う操作の詳細については、このトピックで後述の「更新が失敗したアプリケーションを解決する」セクションを参照してください。
6. 環境で実行された操作を表示するには、**履歴**および**環境の詳細**ページを開きます。 展開、サービス、およびロールバックなど、環境で実行された主要なアクションのレコードを表示することもできます。

**ローカル エージェントのバージョン 2.1.0 未満を使用している場合は、以下の手順を実行する必要があります。**
1. 更新プログラムを選択し、**適用**をクリックします。
2. 確認メッセージで**はい**を選択します。 この環境でサービス操作が開始されました。 これは環境のダウンタイムの先頭です。 
3. 環境の状態が**配置済み**から**準備**に変更します。 

>[!NOTE]
> 準備中、パッケージを書式設定しパッケージをダウンロードするなどの手順は、準備中に実行されます。 環境は準備中に直接触れられないため、準備フェーズ中にダウンタイムは発生しません。 ユーザーは、準備時にシステムをそのまま使用できます。 ただし、環境が準備状態になったときに、ダウンタイムが開始されることをお勧めします。
 
4. 準備が完了したら、環境の状態は**準備中**から**配置中**に変更されます。 
5. 更新が完了すると、環境状態は**展開**に戻されます。 更新プログラムの適用に失敗したとき、環境状態は **失敗** に変更されます。 パッケージ アプリケーションが失敗する場合に行う操作の詳細については、このトピックで後述の「更新が失敗したアプリケーションを解決する」セクションを参照してください。
6. 環境で実行された操作を表示するには、**履歴**および**環境の詳細**ページを開きます。 展開、サービス、およびロールバックなど、環境で実行された主要なアクションのレコードを表示することもできます。

### <a name="update-a-production-environment"></a>実稼動環境の更新
実稼働環境を更新する前に、サンドボックス環境でパッケージ アプリケーションの更新を正常に完了する必要があります。

1. パッケージを適用しているサンドボックス環境のプロジェクトで、アセット ライブラリを開いてから、**ソフトウェア配置可能パッケージ** タブでパッケージを選択し、**リリース候補**としてマークします。
2. **環境の詳細**ページで、**メンテナンス**の下にある、**更新プログラムの適用**を選択します。 ダイアログ ボックスでは、**リリース候補**としてマークされたパッケージのみ表示されます。
3. 実稼働環境に適用されるリリース候補パッケージを選択します。 
4. 更新フローの残りの部分は、サンドボックス環境と同じです。 更新エクスペリエンスは、使用している環境で実行されているローカル エージェントのバージョンによって異なります。 常に最新バージョンで実行することをお勧めします。

## <a name="resolve-a-failed-update-application"></a>更新が失敗したアプリケーションを解決
準備が失敗すると、環境状態は**配置済み**になります。 更新プログラムの適用に失敗したとき、環境状態は**失敗**です。 最初の手順でエラーが発生した理由を特定します。 ログの場所は、エラーが発生したステージによって異なります。

- **準備段階:** **準備**段階で操作が失敗すると、ログが LCS にアップロードされます。 ログ ファイルで、**ログをダウンロード**を選択してログ ファイルをダウンロードします。 パッケージに結合の問題があった場合、エラーがログ ファイルに含まれます。
- **配置ステージ:** **配置**ステージで操作が失敗すると、ログはオンプレミス環境にあります。 この環境にサインインした後、ログとイベント ビューアーにアクセスする必要があります。

トラブルシューティング ログの使用方法の詳細については、[Dynamics 365 for Finance and Operations オンプレミスのトラブルシューティング](troubleshoot-on-prem.md) を参照してください。

ログを確認しエラーの原因を特定すると、次のいずれかの操作を実行して環境を正常な状態に復元します。 **失敗**状態の環境で実行できるアクションはありません。 まず、環境を正常な状態に戻す必要があります。

- **失敗した操作の再試行** – アプリケーションの更新に失敗した場合は、**再試行** を選択し、失敗した操作から復旧させます。
- **失敗した操作の中止** – オンプレミス環境に変更がないため、準備が失敗した場合、操作をキャンセルするオプションがあります。 **中止**を選択して準備をキャンセルします。
- **更新をロールバック** – 失敗した更新をロールバックするには、**ロールバック**を選択します。 ロールバックを開始する前に、最新の問題のない状態にデータベースを復元する必要があります。 **ロールバック** を選択すると、環境は最後の正常な状態に復元されます。 環境の状態は、**準備** に変更され、次に **配置中** に変更され、次に **配置済み** または **失敗** に変更されます。

    >[!NOTE]
    > **ロールバック** ボタンは、データベースをロールバックしません。 ユーザーは、更新プログラムの適用の前に行ったと分かっている最後のバックアップに、データベースを復元する責任があります。 このステップは、データの損失がないことを保証するために重要です。

- **状態の更新** – **準備**段階で更新アプリケーションが失敗すると、障害は LCS 側にあり、更新アプリケーションはまだ起動していません。 したがって、オンプレミス環境は良好な状態です。 LCS 環境の状態を **Deployed** に戻すには、プロジェクト ダッシュボード ページで **更新** を選択します。
- **環境の削除と再配置** - 再試行とロールバックのオプションが機能しない場合は、環境を削除して再配置する必要があります。 環境を削除するには、[プロジェクト ダッシュボード] ページで **削除** を選択します。 次に、環境を構成するオプションを表示します。

    > [!IMPORTANT]
    > このオプションは実稼働環境では使用**しない**でください。 ただし、環境を正常な状態に復元するサンドボックス環境で使用できます。 
    
    > このオプションは環境を新規に配置することを必要とするため、以前に適用された更新は失われます。 カスタマイズおよびバイナリ更新プログラムは、環境に再適用される必要があります。

