---
title: 販売注文、見積、返品のインポート時に明細行の正味金額を再計算するを参照します
description: この記事では、販売注文、見積、返品をインポートするときに、行の正味金額を再計算するかどうか、および方法について説明します。 また、さまざまなバージョンの Microsoft Dynamics 365 Supply Chain Management で動作を制御する方法も説明します。
author: Henrikan
ms.date: 06/08/2022
ms.topic: article
ms.search.form: ''
audience: Application User
ms.reviewer: kamaybac
ms.search.region: Global
ms.author: henrikan
ms.search.validFrom: 2022-06-08
ms.dyn365.ops.version: 10.0.29
ms.openlocfilehash: ce34a6be7bc3d14e23bdd8769aa71dc035b983b3
ms.sourcegitcommit: c98d55a4a6e27239ae6b317872332f01cbe8b875
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/02/2022
ms.locfileid: "9220630"
---
# <a name="recalculate-line-net-amounts-when-importing-sales-orders-quotations-and-returns"></a>販売注文、見積、返品のインポート時に明細行の正味金額を再計算するを参照します

[!include [banner](../includes/banner.md)]

この記事では、販売注文、見積、返品をインポートするときに、行の正味金額を再計算するかどうか、および方法について説明します。 また、さまざまなバージョンの Microsoft Dynamics 365 Supply Chain Management で動作を制御する方法も説明します。

## <a name="how-updates-to-net-line-amounts-are-calculated-on-import"></a>インポート時に正味行金額に対する更新を計算する方法

Supply Chain Management のバージョン 10.0.23 では、[bugfix 604418](https://fix.lcs.dynamics.com/issue/results/?q=604418) を紹介しました。 この修正では、既存の販売注文、返品、および見積の更新をインポートするときに、行の **正味金額** フィールドを更新または再計算できる条件が変更されました。 バージョン 10.0.29 では、インポート機能で *行の正味金額の計算* をオンにして、この修正を交換 できます。 この機能にも同様の効果がありますが、グローバル設定を使用することで古い動作に戻る必要があります。 新しい動作によりシステムの動作は変更されませんが、次のすべての条件が満たされた特定のシナリオで予期しない結果が生成されます。

- 既存のレコードを更新するデータは、Open Data Protocol (OData) を使用して、*販売注文明細行 V2*、*販売見積明細行 V2* または *返品注文明細行* エンティティを通じてインポートされます。このエンティティには、Excel や一部のサード パーティ統合を使用する場合も含まれます。
- 設定されている [売買契約評価ポリシー](/dynamicsax-2012/appuser-itpro/trade-agreement-evaluation-policies-white-paper) は、販売注文明細行、販売見積明細行、返品注文明細行の **正味金額** フィールドへの更新を制限するポリシーを設立します。
- インポートされたデータには、明細行の **正味金額** フィールドの変更や、1 つ以上の既存の行レコードについて明細行の **正味金額** フィールドの値が再計算される原因となる変更 (単価、数量、割引など) が含まれます。

これらの特定のシナリオでは、契約評価ポリシーの影響は、明細行の **正味金額** フィールドの更新に制限を設定します。 この制限は *変更ポリシー* と呼ばれる名前です。 このポリシーにより、ユーザー インターフェイスを使用してフィールドを編集または再計算するときに、変更を行うかどうかを確認するメッセージが表示されます。 ただし、レコードをインポートする場合は、システムが選択する必要があります。 バージョン 10.0.23 より前のバージョンでは、受信した明細行の正味金額が 0 (ゼロ) ではない限り、常に明細行の正味金額は変更されません。 ただし、新しいバージョンでは、明示的に正味金額が更新または再計算されるように明示的に指示されていない限り、システムは常に正味金額を更新または再計算します。 新しい動作はさらに論理的ですが、以前の動作を前提としてプロセスや統合を既に実行している場合は、問題が発生する可能性があります。 この記事では、必要に応して古い動作に戻す方法について説明します。

## <a name="control-calculations-of-line-net-amounts-in-versions-10029-and-later"></a>バージョン 10.0.29 以降での明細行の正味金額算定の制御

Supply Chain Management 10.0.29 では、*インポート時に明細行の正味金額を計算する* 機能が導入されました。 この機能により、**売掛金勘定パラメータ** ページに **明細行の正味金額の計算** という名前のオプションが追加されます。 このオプションを使用すると、インポート時に行の正味金額を計算するための新しい動作とレガシの動作を選択できます。

### <a name="turn-the-calculate-line-net-amount-on-import-feature-on-or-off"></a>インポート機能の明細行の正味金額の計算のオン/オフの切り替え

バージョン 10.0.29 に更新すると、既定で *インポート機能の行の正味金額の計算* が有効になっていて、新しい **行の正味金額の計算** オプションが *はい* に設定されます。 *はい* 設定は、新しい標準動作に対応します。 この動作は、この記事で後で説明するように、[CalculateLineA behavior パラメーター](#CalculateLineAmount) の機能の場合を除いて、機能がオフの場合にシステム動作と一致します。 *いいえ* の設定は、バージョン 10.0.23 以前のシステム動作と一致し、主にレガシー統合シナリオをサポートするために提供されています。

管理者は、[機能管理ワークスペース](../../fin-ops-core/fin-ops/get-started/feature-management/feature-management-overview.md) を使用して、*インポートの明細行の正味金額の計算* 機能をオンまたはオフにできます。

### <a name="set-the-calculate-line-net-amount-option"></a>明細行の正味金額の計算オプションを設定する

*インポートの明細行の正味金額の計算* 機能が有効になっている場合は、次の手順に従って **明細行の正味金額の計算** オプションを設定できます。

1. **売掛金勘定 \> 設定 \> 売掛金勘定パラメーター** に移動します。
1. **価格** タブで、**統合を通じた明細行の正味金額算定** クイックタブで、**明細行の正味金額算定** オプションを次のいずれかの値に設定します。

    - *はい* - 必要に応じて、常に明細行の金額が再計算および更新されます。 (したがって、この評価ポリシーは無視されます。)
    - *いいえ* - 任意の行の既存の正味金額または着信する正味金額が 0 (ゼロ) の場合、その行の値は他の値 (単価、数量、割引など) に基づいて再計算されます。 既存の正味金額または入金される正味金額が 0 (ゼロ) と異なる場合、その行の **正味金額** フィールドで変更ポリシーが設定されている場合は、明細行の価格、数量、または割引に対する変更によって明細行の合計の再計算が行う必要がある場合でも、フィールドの適用が再計算または更新されません。 この動作はバージョン 10.0.22 の動作に一致します。

### <a name="how-the-calculate-line-net-amount-on-import-feature-affects-the-calculatelineamount-parameter"></a><a name="CalculateLineAmount"></a>インポート機能の明細行の正味金額の計算が CalculateLineAmount パラメーターにどのような影響を与えるか

*インポートでの明細行の正味金額の計算* 機能が有効になっている場合、`SalesLine` および `SalesQuotationLine` テーブルの `CalculateLineAmount` パラメーターは無効です。 代わりに、前のセクションで説明した **行の正味金額の計算** オプションによって動作がグローバルに制御されます。 したがって、機能を有効にした場合、`CalculateLineAmount` 値で依存関係をとることはできません。

*インポート時に明細行の正味金額を計算* 機能をオフにした場合、`SalesLine` テーブルと `SalesQuotationLine` テーブルの `CalculateLineAmount` パラメーターは、次のセクションで説明するように、Supply Chain Management のバージョン 10.0.23 から 10.0.28 で機能するように動作します。

## <a name="control-line-net-amount-calculations-in-versions-10028-and-earlier"></a>バージョン 10.0.28 以前での明細行の正味金額算定の制御

[bugfix 604418](https://fix.lcs.dynamics.com/issue/results/?q=604418) がバージョン 10.0.23 で紹介された際、その他の変更 (更新された品目価格など) のために行の正味金額を編集したり再計算する必要がある場合に、各関連データ エンティティの動作を選択するになりました。 この動作を制御するには、各明細行の新しい `CalculateLineAmount` パラメーターをインポート ファイルの次のいずれかの値に設定します。

- **`CalculateLineAmount` = *1*** – 明細行の **正味金額** フィールドは、このフィールドに変更ポリシーが設定されている場合でも、受信する明細行の正味金額または既存の明細行の正味金額の値に関係なく、常に再計算および更新されます。
- **`CalculateLineAmount` = *0*** – 任意の明細行の既存の正味金額または着信する正味金額が 0 (ゼロ) の場合、その明細行の値は他の値 (単価、数量、割引など) に基づいて再計算されます。 既存の正味金額または受け取る正味金額が0 (ゼロ) と異なって、行の **正味金額** フィールドに変更ポリシーが設定されている場合、フィールドの情報は再計算または更新されません。  

システム動作は、Supply Chain Management のバージョンに依存します。

- バージョン 10.0.22 以前では、システムは常に `CalculateLineAmount` が *0* に設定されているのように動作し、`CalculateLineAmount` が *1* に設定されているかのように動作させることはできません。
- バージョン 10.0.23 から 10.0.28 では、システムは、インポート ファイルで明示的に *0* に設定されていないすべての明細行に対して、`CalculateLineAmount` が *1* に設定されているかのように動作します。
