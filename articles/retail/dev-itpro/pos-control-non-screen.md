---
title: "デザイナー ベースの画面レイアウトではない POS のビューにカスタム コントロールを追加します"
description: "このトピックでは、非画面レイアウト デザイナー ベース ビューにカスタム コントロールを追加する方法について説明します。"
author: mugunthanm
manager: AnnBe
ms.date: 12/08/2017
ms.topic: article
ms.prod: 
ms.service: dynamics-365-retail
ms.technology: 
audience: Developer
ms.reviewer: robinr
ms.search.scope: Operations, Retail
ms.custom: 83892
ms.search.region: Global
ms.author: mumani
ms.search.validFrom: 2017-12-01
ms.dyn365.ops.version: AX 7.0.0, Retail September 2017 update
ms.translationtype: HT
ms.sourcegitcommit: 5098fb3339403b6f2779dfe3bb7ef5c4ca78051f
ms.openlocfilehash: 187b1b6a8431d0a8078960e411753470b44ca761
ms.contentlocale: ja-jp
ms.lasthandoff: 08/09/2018

---


# <a name="add-custom-controls-to-pos-views-that-arent-screen-layout-designer-based"></a>デザイナー ベースの画面レイアウトではない POS のビューにカスタム コントロールを追加します

[!include [banner](../../includes/banner.md)]

カスタム コントロールを追加することにより、Dynamics 365 for Retail POS ビューに表示される情報を拡張することができます。 カスタム コントロールを使用すると、POS の既存のビューにカスタム情報を追加できます。 カスタム コントロールは、POS 拡張フレームワークを使用して実装できます。 現時点では、実行時にカスタム コントロールを目的の場所に配置することはできません。POS は POS を固定位置にロードします。

このトピックは、プラットフォーム更新プログラム 8 および Retail アプリケーション更新プログラム 4 修正プログラムを備えた、Dynamics 365 for Finance and Operations、および Dynamics 365 for Retail に適用されます。 

次のテーブルに、カスタム コントロールをサポートする非画面レイアウト デザイナーベース ビューを示します。

| POS ビュー              | カスタム コントロールのサポート | カスタム コントロールの数 |
|------------------------|------------------------|--------------------------|
| 顧客の追加/編集表示 | 有                    | 倍数                 |
| アドレスの追加/編集表示  | 有                    | 倍数                 |
| 顧客の詳細表示  | 有                    | 倍数                 |
| 製品詳細表示   | 有                    | 倍数                 |
| 価格の確認ビュー       | 有                    | 倍数                 |

次のテーブルに、カスタム コントロールをサポートする画面レイアウト デザイナー ベースビューを示します。

| POS ビュー | カスタム コントロールのサポート | カスタム コントロールの数 |
|-----------|------------------------|--------------------------|
| カート ビュー | 有                    | 10                       |

## <a name="create-the-custom-control"></a>カスタム コントロールの作成

次の例では、拡張機能を使用して既存の POS ビューの 1 つにカスタム コントロールを追加する方法を示しています。 たとえば、4 つの列を持つ、カスタム データのリストを追加することによって製品の詳細ビューで製品の使用可能な情報を表示したとします - 場所、在庫、引当済、および注文済。

カスタム コントロールは、カスタム情報を表示する HTML ページです。 対応する Typescript ファイルには、コントロールのロジックが含まれています。 

1. 管理者モードで Visual Studio 2015 を開きます。
2. **\RetailSDK\POS** から Modern POS を開きます。
3. **POS.Extensions** プロジェクトで、**ProdDetailsCustomColumnExtensions** という名前の新しいフォルダーを作成します。
4. **ProdDetailsCustomColumnExtensions** の下で **ViewExtensions** という名前の新しいフォルダーを作成します。
5. **ViewExtensions** の下で **SimpleProductDetails** という名前の新しいフォルダーを作成します。
6. **SimpleProductDetails** フォルダー内に新しい HTML ファイルを追加し、**ProductAvailabilityPanel.html** という名前をつけます。  
7. **ProductAvailabilityPanel.html** を開き、次のコードを追加します。 このコードは、POS データ リスト コントロールを追加して、製品の可用性情報とコントロールの幅を表示します。
    ```html
    <!DOCTYPE html>
    <html lang="en" xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta charset="utf-8" />
        <title></title>
    </head>
    <body>
        <!-- Note: The element ID is different than the ID generated by the POS extensibility framework. This 'template' ID is not used by the POS extensibility framework. -->
        <script id="Microsoft_Pos_Extensibility_Samples_ProductAvailabilityPanel" type="text/html">
            <h2 class="marginTop8 marginBottom8" data-bind="text: title"></h2>
            <div class="width400 grow col">
                <div id="Microsot_Pos_Extensibility_Samples_ProductAvailabilityPanel_DataList" data-bind="msPosDataList: dataList"></div>
            </div>
        </script>
    </body>
    </html>
    ```
8. **SimpleProductDetails** フォルダーに、新しい Typescript ファイルを追加し、**ProductAvailabilityPanel.ts** と名前を付けます。
9. 次の **import** 明細書を追加して、関連するエンティティおよびコンテキストをインポートします。
    ```typescript
    import {

        SimpleProductDetailsCustomControlBase,
        ISimpleProductDetailsCustomControlState,
        ISimpleProductDetailsCustomControlContext

    } from "PosApi/Extend/Views/SimpleProductDetailsView";

    import { InventoryLookupOperationRequest, InventoryLookupOperationResponse } from "PosApi/Consume/OrgUnits";
    import { ClientEntities, ProxyEntities } from "PosApi/Entities";
    import { ArrayExtensions } from "PosApi/TypeExtensions";
    import { DataList, SelectionMode } from "PosUISdk/Controls/DataList";
    ```
10. **ProductAvailabilityPanel** という名前の新しいクラスを作成し、**SimpleProductDetailsCustomControlBase** から拡張します。
    ```typescript
    export default class ProductAvailabilityPanel extends SimpleProductDetailsCustomControlBase { }
    ```
11. クラス内で、状態およびデータ リスト情報に対して次の変数を宣言します。
    ```typescript
    private static readonly TEMPLATE_ID: string = "Microsot_Pos_Extensibility_Samples_ProductAvailabilityPanel";
    public readonly orgUnitAvailabilities: ObservableArray<ProxyEntities.OrgUnitAvailability>;
    public readonly dataList: DataList<ProxyEntities.OrgUnitAvailability>;
    public readonly title: Observable<string>;
    private _state: ISimpleProductDetailsCustomControlState;
    ```
12. クラスのコンストラクターメソッドを追加して、データ リストの列を初期化します。
    ```typescript
    constructor(id: string, context: ISimpleProductDetailsCustomControlContext) {

        super(id, context);
        this.orgUnitAvailabilities = ko.observableArray([]);
        this.title = ko.observable("Product Availability");
        this.dataList = new DataList<ProxyEntities.OrgUnitAvailability>({
            columns: [

                {
                    title: "Location",
                    ratio: 31,
                    collapseOrder: 4,
                    minWidth: 100,
                    computeValue: (value: ProxyEntities.OrgUnitAvailability): string => {
                        return value.OrgUnitLocation.OrgUnitName;

                    }

                },

                {
                    title: "Inventory",
                    ratio: 23,
                    collapseOrder: 3,
                    minWidth: 60,
                    computeValue: (value: ProxyEntities.OrgUnitAvailability): string => {
                        return ArrayExtensions.hasElements(value.ItemAvailabilities) ? value.ItemAvailabilities[0].AvailableQuantity.toString() : "0";
                    }

                },

                {
                    title: "Reserved",
                    ratio: 23,
                    collapseOrder: 1,
                    minWidth: 60,
                    computeValue: (value: ProxyEntities.OrgUnitAvailability): string => {
                        return ArrayExtensions.hasElements(value.ItemAvailabilities) ? value.ItemAvailabilities[0].PhysicalReserved.toString() : "0";
                    }
                },

                {
                    title: "Ordered",
                    ratio: 23,
                    collapseOrder: 2,
                    minWidth: 60,
                    computeValue: (value: ProxyEntities.OrgUnitAvailability): string => {
                        return ArrayExtensions.hasElements(value.ItemAvailabilities) ? value.ItemAvailabilities[0].OrderedSum.toString() : "0";
                    }
                }

            ],

            itemDataSource: this.orgUnitAvailabilities,
            selectionMode: SelectionMode.None

        });

    }
    ```
13. HTML コントロールをバインドする **OnReady** メソッドを追加します。
    ```typescript
    public onReady(element: HTMLElement): void {

        ko.applyBindingsToNode(element, {
            template: {
                name: ProductAvailabilityPanel.TEMPLATE_ID,
                data: this

            }

        });
    }
    ```
14. **init** メソッドを追加して、ページが読み込まれたときに製品使用可能性の詳細を取得し、データがフェッチされ、データ リストで更新されるようにします。
    ```typescript
    public init(state: ISimpleProductDetailsCustomControlState): void {

        this._state = state;
        let correlationId: string = this.context.logger.getNewCorrelationId();
        if(!this._state.isSelectionMode) {
        this.isVisible = true;

        let request: InventoryLookupOperationRequest<InventoryLookupOperationResponse> =
            new InventoryLookupOperationRequest<InventoryLookupOperationResponse>
                (this._state.product.RecordId, correlationId);
        this.context.runtime.executeAsync(request)
            .then((result: ClientEntities.ICancelableDataResult<InventoryLookupOperationResponse>) => {

                if (!result.canceled) {
                    this.orgUnitAvailabilities(result.data.orgUnitAvailability);
                }

            }).catch((reason: any) => {
                this.context.logger.logError(JSON.stringify(reason), correlationId);

            });
    }

    }
    ```
    コード例全体を以下に示します。
    ```typescript
    import {
        SimpleProductDetailsCustomControlBase,
        ISimpleProductDetailsCustomControlState,
        ISimpleProductDetailsCustomControlContext
    } from "PosApi/Extend/Views/SimpleProductDetailsView";

    import { InventoryLookupOperationRequest, InventoryLookupOperationResponse } from "PosApi/Consume/OrgUnits";
    import { ClientEntities, ProxyEntities } from "PosApi/Entities";
    import { ArrayExtensions } from "PosApi/TypeExtensions";
    import { DataList, SelectionMode } from "PosUISdk/Controls/DataList";
    export default class ProductAvailabilityPanel extends SimpleProductDetailsCustomControlBase {

        private static readonly TEMPLATE_ID: string = "Microsot_Pos_Extensibility_Samples_ProductAvailabilityPanel";
        public readonly orgUnitAvailabilities: ObservableArray<ProxyEntities.OrgUnitAvailability>;
        public readonly dataList: DataList<ProxyEntities.OrgUnitAvailability>;
        public readonly title: Observable<string>;
        private _state: ISimpleProductDetailsCustomControlState;

        constructor(id: string, context: ISimpleProductDetailsCustomControlContext) {
            super(id, context);
            this.orgUnitAvailabilities = ko.observableArray([]);
            this.title = ko.observable("Product Availability");
            this.dataList = new DataList<ProxyEntities.OrgUnitAvailability>({

                columns: [
                    {
                        title: "Location",
                        ratio: 31,
                        collapseOrder: 4,
                        minWidth: 100,
                        computeValue: (value: ProxyEntities.OrgUnitAvailability): string => {
                            return value.OrgUnitLocation.OrgUnitName;
                        }
                    },

                    {
                        title: "Inventory",
                        ratio: 23,
                        collapseOrder: 3,
                        minWidth: 60,
                        computeValue: (value: ProxyEntities.OrgUnitAvailability): string => {
                            return ArrayExtensions.hasElements(value.ItemAvailabilities) ? 
                            value.ItemAvailabilities[0].AvailableQuantity.toString() : "0";
                        }
                    },

                    {
                        title: "Reserved",
                        ratio: 23,
                        collapseOrder: 1,
                        minWidth: 60,
                        computeValue: (value: ProxyEntities.OrgUnitAvailability): string => {
                            return ArrayExtensions.hasElements(value.ItemAvailabilities) ? 
                            value.ItemAvailabilities[0].PhysicalReserved.toString() : "0";
                        }
                    },

                    {
                        title: "Ordered",
                        ratio: 23,
                        collapseOrder: 2,
                        minWidth: 60,
                        computeValue: (value: ProxyEntities.OrgUnitAvailability): string => {
                            return ArrayExtensions.hasElements(value.ItemAvailabilities) ? 
                            value.ItemAvailabilities[0].OrderedSum.toString() : "0";
                        }

                    }

                ],

                itemDataSource: this.orgUnitAvailabilities,
                selectionMode: SelectionMode.None
            });

        }

        /**
        * Binds the control to the specified element.
        * @param {HTMLElement} element The element to which the control should be bound.
        */

        public onReady(element: HTMLElement): void {
            ko.applyBindingsToNode(element, {
                template: {
                    name: ProductAvailabilityPanel.TEMPLATE_ID,
                    data: this

                }

            });

        }

        /**
        * Initializes the control.
        * @param {ISimpleProductDetailsCustomControlState} state The initial state of the page used to initialize the control.
        */

        public init(state: ISimpleProductDetailsCustomControlState): void {
            this._state = state;
            let correlationId: string = this.context.logger.getNewCorrelationId();
            if (!this._state.isSelectionMode) {
                this.isVisible = true;
                let request: InventoryLookupOperationRequest<InventoryLookupOperationResponse> =
                    new InventoryLookupOperationRequest<InventoryLookupOperationResponse>
                        (this._state.product.RecordId, correlationId);
                this.context.runtime.executeAsync(request)
                    .then((result: ClientEntities.ICancelableDataResult<InventoryLookupOperationResponse>) => {
                        if (!result.canceled) {
                            this.orgUnitAvailabilities(result.data.orgUnitAvailability);
                        }

                    }).catch((reason: any) => {
                        this.context.logger.logError(JSON.stringify(reason), correlationId);

                    });
            }
        }
    }
    ```
15. 新しい .json ファイルを **ProdDetailsCustomColumnExtensions** フォルダーの下に作成し、**manifest.json** という名前を付けます。
16. **manifest.json** ファイルに次のコードを追加します。
    ```typescript
     {

        "$schema": "../manifestSchema.json",
            "name": "Pos_Extensibility_Samples",
                "publisher": "Microsoft",
                    "version": "7.2.0",
                        "minimumPosVersion": "7.2.0.0",
                            "components": {
            "extend": {
                "views": {
                    "SimpleProductDetailsView": {
                        "controlsConfig": {
                            "customControls": [
                                {

                                    "controlName": "productAvailabilityPanel",
                                    "htmlPath": "ViewExtensions/SimpleProductDetails/ProductAvailabilityPanel.html",
                                    "modulePath": "ViewExtensions/SimpleProductDetails/ProductAvailabilityPanel"
                                }
                            ]

                        }
                    }
                }
            }
        }
    }
    ```
17. **extensions.json** ファイルを **POS.Extensions** プロジェクトで開いて、**ProdDetailsCustomColumnExtensions** サンプルを追加し、実行時に POS に拡張機能が含まれるようにします。
    ```typescript
     {
        "extensionPackages": [
            {
                "baseUrl": "SampleExtensions2"
            },
            {
                "baseUrl": "ProdDetailsCustomColumnExtensions"
            }
        ]
    }
    ```
18. **tsconfig.json** を開いて、拡張パッケージ フォルダーを除外リストからコメント アウトします。 POS では、このファイルを使用して、拡張機能を追加または除外します。 既定では、リストに除外された拡張リストが含まれています。 POS の一部である拡張子を含める場合は、拡張子フォルダー名を追加し、以下のように拡張子リストから拡張子をコメント アウトする必要があります。
    ```typescript
     "exclude": [
        "AuditEventExtensionSample",
        "B2BSample",
        "CustomerSearchWithAttributesSample",
        "FiscalRegisterSample",
        "PaymentSample",
        "PromotionsSample",
        "SalesTransactionSignatureSample",
        "SampleExtensions",
        //"SampleExtensions2",
        //"ProdDetailsCustomColumnExtensions"
    ],
    ```
19. プロジェクトをコンパイル、およびリビルドします。

## <a name="validate-the-customization"></a>カスタマイズの検証

1. **F5** キーを押し、POS を展開してカスタマイズをテストします。
2. POS の起動後、POS にログインします。 任意の製品を検索し、製品詳細ビュー移動します。 追加したカスタム コントロールが表示されます。

