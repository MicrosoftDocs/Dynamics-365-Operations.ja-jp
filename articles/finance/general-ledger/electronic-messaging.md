---
title: 電子メッセージ
description: このトピックでは、Microsoft Dynamics 365 Finance の電子メッセージの概要および設定情報を提供します。
author: ShylaThompson
manager: AnnBe
ms.date: 11/16/2018
ms.topic: article
ms.prod: ''
ms.service: dynamics-ax-applications
ms.technology: ''
audience: Application User
ms.reviewer: roschlom
ms.search.scope: Core, Operations
ms.search.region: Global
ms.author: roschlom
ms.search.validFrom: 2018-10-28
ms.dyn365.ops.version: 8.0999999999999996
ms.openlocfilehash: b5887efc32c71759e4cb3c31e1b18c4c8b64f173
ms.sourcegitcommit: 199848e78df5cb7c439b001bdbe1ece963593cdb
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 10/13/2020
ms.locfileid: "4445291"
---
# <a name="electronic-messaging"></a>電子メッセージ

[!include [banner](../includes/banner.md)]

このトピックでは、電子メッセージの概要および設定情報を提供します。

最近では、世界中の様々な国や地域の政府および立法当局が、それらの国または地域に登録されている企業の報告要件を実施しています。 要件の目的は、それらの企業から電子フォーマットで、会計、保管、処理されたシステムから直接、データを取得できるようにするためです。

Finance の電子メッセージ機能は、Finance と、政府および立法当局が提供する公式情報の報告、送信および受信のために提供するシステムの間の様々な電子相互運用をサポートします。

電子メール機能は、**電子申告** (ER) モジュールと統合されています。 そのため、電子メッセージの ER 形式を設定することができます。 詳細については、[電子申告 (ER)](https://docs.microsoft.com/dynamics365/unified-operations/dev-itpro/analytics/general-electronic-reporting)を参照してください。

電子メッセージは、次のエンティティに基づいています。

- **電子メッセージ** – 内部でレポートおよび/または送信されるべきレポートまたは申告。 税務署に送付されるレポートがその一例です。
- **電子メッセージ項目** – レポートされるメッセージに含める必要があるレコード。
- **電子メッセージの処理** – 必要なデータを収集し、レポートを生成し、Microsoft Azure BLOB ストレージにデータを格納し、システム外部にレポートを送信し、システム外部から応答を受信し、受信した情報に基づいてデータベースを更新する一連のアクション。 チェーンのアクションはリンクされていても、リンク解除されていてもよい

次の図は、電子メッセージのデータのフローを示しています。

![電子メッセージのデータ フロー](media/electronic-messaging-data-flow.png)

電子メッセージ機能は、次のシナリオをサポートしています。

- Microsoft Excel、XML、JavaScript Object Notation (JSON)、PDF、テキスト、および Microsoft Word など、様々なタイプの関連するエクスポート ER 形式に基づいて、メッセージを手動で作成し、レポートを生成します。
- 関連するインポート ER 形式を経由して機関から要求および受信されたメッセージを、自動的に作成し処理します。
- メッセージ項目として、データ ソースからの情報を収集し処理します。 データ ソースは、Finance テーブルです。
- 追加の情報を格納し、メッセージまたはメッセージ項目に関連して特別に定義された実行可能なクラスを呼び出すことによってさまざまな値を評価します。
- メッセージ項目に収集された情報を集計し、その情報をメッセージごとに分割し、関連するエクスポート ER 形式のレポートを生成します。
- Azure Key Vault に格納されているセキュリティ情報を使用して、生成されたレポートをWeb サービスに送信します。
- 必要に応じて、Web サービスからの応答の受信、応答の解釈、Finance のデータの更新を行います。
- 生成されたすべてのレポートを格納して確認します。
- メッセージまたはメッセージ項目に対して実行されるアクションに関連するすべてのログ情報を格納して確認します。
- さまざまなメッセージの状態およびメッセージ項目の状態を使用して、処理をコントロールします。

## <a name="set-up-electronic-messaging"></a>電子メッセージの設定

電子メッセージは、さまざまなドキュメント タイプに対してさまざまな電子レポート処理を維持するのに役立ちます。 いくつかの複雑なシナリオでは、電子メッセージは、多くのメッセージの状態、メッセージ項目の状態、アクション、追加フィールド、および実行可能なクラスの組み合わせを持つように設定されています。 このようなシナリオでは、データ エンティティのパッケージをインポートすることができます。 これらのデータ エンティティのパッケージを使用する場合は、データ管理ツールを使用して法人にそれらをインポートする必要があります。 データ管理ツールの使用方法の詳細については、[データ管理](../../dev-itpro/data-entities/data-entities-data-packages.md)を参照してください。

データ エンティティのパッケージをインポートしない場合は、電子メッセージ機能を手動で設定することができます。 この場合は、次の要素を設定する必要があります。

- [番号順序](#number-sequences)
- [メッセージ項目タイプと状態](#message-item-types-and-statuses)
- [メッセージ状態](#message-statuses)
- [追加フィールド](#additional-fields)
- [実行可能なクラスの設定](#executable-class-settings)
- [レコード アクションの設定](#populate-records-actions)
- [Web アプリケーション](#web-applications)
- [Web サービスの設定](#web-service-settings)
- [メッセージ処理アクション](#message-processing-actions)
- [電子メッセージの処理](#electronic-message-processing)

次のセクションでは、これらの各要素の詳細について説明します。

### <a name="number-sequences"></a>番号順序

メッセージおよびメッセージ項目両方の番号順序を設定します。 番号順序は、メッセージおよびメッセージ項目に自動的に番号を付けるために使用されます。 割り当てられた番号は、システム内のメッセージおよびメッセージ項目の固有 ID として使用されます。 電子メッセージの番号順序は、**総勘定元帳パラメーター** ページ (**総勘定元帳** \> **元帳の設定** \> **総勘定元帳パラメーター**) で設定できます。

### <a name="message-item-types-and-statuses"></a>メッセージ項目タイプと状態

メッセージ項目タイプは、電子メッセージに使用されるレコードのタイプを識別します。 メッセージ項目タイプは、**メッセージ項目タイプ** ページ (**税** \> **設定** \> **電子メッセージ** \> **メッセージ項目タイプ**) で設定できます。

メッセージ項目の状態は、設定している処理中のメッセージ項目に適用される状態を識別します。 メッセージ項目タイプは、**メッセージ項目の状態** ページ (**税** \> **設定** \> **電子メッセージ** \> **メッセージ項目の状態**) で設定できます。

メッセージ項目の状態の **削除を許可** パラメーターは、**電子メッセージ** ページまたは **電子メッセージ項目** ページの、この状態のメッセージ項目をユーザーが削除できるかどうかを定義します。

### <a name="message-statuses"></a>メッセージ状態

メッセージの処理で使用できるメッセージ状態を設定します。 メッセージ状態は、**メッセージ状態** ページ (**税** \> **設定** \> **電子メッセージ** \> **メッセージ状態**) で設定できます。

次のテーブルは、**メッセージの状態** ページのフィールドについて説明しています。

| フィールド名          | 説明 |
|---------------------|-------------|
| メッセージ状態      | メッセージの状態の固有の名前を入力します。 メッセージの状態は、あらゆる時点での電子メッセージの状態を特徴付けるために使用されます。 入力した名前は、**電子メッセージ** ページ、および電子メッセージに関連するログに表示されます。 |
| 説明         | メッセージの状態の説明を入力します。 |
| 応答タイプ       | メッセージの状態の応答タイプを選択します。 処理中のアクションは、1 つ以上の応答タイプを生成する可能性があります。 たとえば、**Web サービス** タイプのアクションは、実行の結果に応じて **正常に実行されました** タイプ、または **技術エラー** タイプのいずれかの応答を生成する可能性があります。 この場合、両方の応答タイプに対するメッセージの状態を定義する必要があります。 アクション タイプおよび関連する応答タイプに関する詳細については、[アクション タイプを処理するメッセージ](#message-processing-action-types) を参照してください。 |
| メッセージ項目の状態 | 時には、電子メッセージの状態が関連するメッセージ項目の状態に影響を与えます。 このフィールドでメッセージ項目の状態を選択して、メッセージの状態と関連付けます。 |
| 削除の許可        | ユーザーが **電子メッセージ** ページでこの状態を持つ電子メッセージを削除できるようにする場合は、このチェック ボックスを選択します。 |

### <a name="additional-fields"></a>追加フィールド

電子メッセージ機能を使用すると、トランザクション テーブルからレコードに入力することができます。 この方法で、レポートのためにレコードを準備し、報告することができます。 ただし、トランザクション テーブルには、レポート要件を満たす方法でレコードに入力するための十分な情報がない場合があります。 レコードに対して報告する必要のあるすべての情報を記入するために、追加フィールドを設定することができます。 追加フィールドは、メッセージおよびメッセージ項目の両方に関連付けることができます。 追加フィールドは、**追加フィールド** ページ (**税**\>**設定**\>**電子メッセージ**\>**追加フィールド**) で設定できます。

次のテーブルは、**追加フィールド** ページの一般的なフィールドについて説明しています。

| フィールド       | 説明 |
|-------------|-------------|
| フィールド名  | プロセスに関連するメッセージ項目の追加属性の名前を入力します。 プロセスの作業中に、ユーザー インターフェイス (UI) にこの名前が表示されます。 プロセスに関連付けられている ER コンフィギュレーションでも使用できます。 |
| 説明 | 追加フィールドの説明を入力します。 |
| ユーザーの編集   | ユーザーが UI から追加フィールドの値を変更できるようにする場合は、このオプションを **はい** に設定します。 |
| カウンター     | 追加フィールドが電子メッセージに番号順序を含めるようにする場合は、このオプションを **はい** に設定します。 追加フィールドの値は、**電子申告のエクスポート** のアクションの実行中に自動的に入力されます。 |
| 非表示      | UI で追加フィールドを非表示にする場合は、このオプションを **はい** に設定します。 |

各追加フィールドは、処理に対して異なる値を持つことがあります。 **値** クイック タブでこれらの値を定義することができます。 次の表でフィールドについて説明します。

| フィールド                | 説明 |
|----------------------|-------------|
| フィールド値          | 報告時にメッセージまたはメッセージ項目に使用するフィールドの値を入力します。 |
| 説明          | フィールドの値の説明を入力します。 |
| 勘定タイプ         | いくつかのフィールドの値は、特定の勘定タイプに限定される可能性があります。 次の値のいずれかを選択します。**すべて**、**顧客**、または **仕入先**。 |
| アカウント コード         | **勘定タイプ** フィールドで、**顧客** または **仕入先** を選択した場合は、フィールド値の使用を、特定のグルーブまたはテーブルに限定することができます。 |
| アカウント/グループ番号 | **勘定タイプ** フィールドで、**顧客** または **仕入先** を選択し、**アカウント コード** フィールドにグループもしくはテーブルを入力した場合は、このフィールドに特定のグループまたは窓口機関を入力することができます。 |
| 開始            | 値の考慮を開始する日付を指定します。 |
| 有効期限           | 値の考慮を停止する日付を指定します。 |

既定では、**アカウント/グループ番号**、**アカウント コード**、**有効**、および **有効期限** フィールドによって定義されている条件の組み合わせは、追加フィールドの値の選択に影響を与えません。 ただし、実行可能なクラスでこれらの組み合わせを使用して、追加フィールドの値を計算する特定のロジックを実装することができます。

### <a name="executable-class-settings"></a>実行可能なクラスの設定

実行可能なクラスは、プロセスに対して何らかの評価が必要な場合に、アクションに関連して電子メッセージ処理が呼び出すことができる X++ メソッドまたはクラスです。

実行可能なクラスは、**実行可能なクラスの設定** ページ (**税**\>**設定**\>**電子メッセージ**\>**実行可能なクラスの設定**) で設定することができます。 行を作成し、次のフィールドを設定します。

| フィールド                 | 説明 |
|-----------------------|-------------|
| 実行可能なクラス      | 関連してこのクラスが呼び出されるメッセージ処理アクションの設定中に使用される名前を入力します。 |
| 説明           | 実行可能なクラスの説明を入力します。 |
| 実行可能なクラス名 | X++ 実行可能なクラスを選択します。 |
| 実行レベル       | このフィールドは、選択された実行可能なクラスに対して値が事前に定義されている必要があるため、自動的に設定されます。 このフィールドは、関連する評価が実行されるレベルを制限します。 |
| クラスの説明     | このフィールドは、選択された実行可能なクラスに対して値が事前に定義されている必要があるため、自動的に設定されます。 |

一部の実行可能なクラスには、実行可能なクラスを初めて実行する前に定義する必要のある必須パラメーターがあります。 これらのパラメーターを定義するには、アクション ウィンドウで **パラメーター** を選択し、表示されるダイアログ ボックスでフィールドを設定し、**OK** を選択します。 **OK** を選択することが重要です。 そうしないなら、パラメーターはデータベースに保存されず、実行可能なクラスは正しく呼び出されません。

### <a name="populate-records-actions"></a>レコード アクションの設定

メッセージ項目テーブルにレコードを追加してそれを電子メッセージに追加するアクションを設定するためには、レコード アクションの設定を使用します。 たとえば、電子メッセージで顧客請求書を報告する必要がある場合、顧客請求書仕訳帳テーブルの **データ ソース** フィールドにリンクされているレコード アクションの設定を設定する必要があります。 レコード アクションの設定は、**レコード アクションの設定** ページ (**税**\>**設定**\>**電子メッセージ**\>**レコード アクションの設定**) で行うことができます。 レコードをテーブルに追加するすべてのアクションに対して新しいレコードを作成し、次のフィールドを設定します。

| フィールド       | 説明 |
|-------------|-------------|
| 氏名        | プロセスでレコードに入力するアクションの名前を入力します。 |
| 説明 | レコード アクションの設定の説明を入力します。 |

**データ ソースの設定** クイック タブでは、プロセスに使用されるすべてのデータ ソースの行を追加し、次のフィールドを設定します。

| フィールド                  | 説明 |
|------------------------|-------------|
| 氏名                   | データ ソース名を入力します。 |
| メッセージ項目タイプ      | データ ソースのレコードを作成するときに使用するメッセージ項目のタイプを選択します。 |
| 勘定タイプ           | データ ソースのレコードに関連付ける勘定のタイプを選択します。 |
| マスター テーブル名      | データソースにするテーブルを選択します。 |
| ドキュメント番号フィールド  | ドキュメント番号を取得するフィールドを、選択したテーブルから選択します。 |
| ドキュメントの日付フィールド    | ドキュメント データを取得するフィールドを、選択したテーブルから選択します。 |
| ドキュメント アカウント フィールド | ドキュメント アカウントを取得するフィールドを、選択したテーブルから選択します。 |
| ユーザー クエリ             | チェック ボックスがオンになっている場合、 グリッドの上にある **クエリの編集** を選択してクエリを設定できます。 それ以外の場合は、すべてのレコードが選択されたデータ ソースから入力されます。 |

### <a name="web-applications"></a>Web アプリケーション

Web アプリケーション設定を使用して、未処理認証 (OAuth) 2.0 をサポートするように Web アプリケーションを設定します。 OAuth は、ユーザーが自分のアクセス資格情報を共有することなく、自分に代わって「安全な委任アクセス」をアプリケーションに付与できるようにするオープン標準です。 認証コードおよびアクセス トークンを取得することによって、認証プロセスを進めることもできます。 **Web アプリケーション** ページで Web アプリケーションの設定を行うことができます (**税** \> **設定** \> **電子メッセージ** \> **Web アプリケーション**)。

次のテーブルは、**Web アプリケーション** ページのフィールドについて説明しています。

| フィールド                        | 説明 |
|------------------------------|-------------|
| アプリケーション名             | Web アプリケーションの名前を入力します。 |
| 説明                  | Web アプリケーションの説明を入力します。 |
| 基準 URL                     | Web アプリケーションのベース インターネット アドレスを入力します。 |
| 認証 URL パス       | 認証用の URL を作成するために使用するパスを指定します。 |
| トークン URL パス               | トークン用 URL を作成するために使用するパスを指定します。 |
| リダイレクト URL                 | リダイレクト URL を入力します。 |
| クライアント ID                    | Web アプリケーションのクライアント ID を入力します。 |
| クライアント シークレット                | Web アプリケーションのクライアント シークレットを入力します。 |
| サーバー トークン                 | Web アプリケーションのサーバー トークンを入力します。 |
| 認証形式マッピング | 認証の要求を生成するために使用する ER 形式を選択します。 |
| インポート トークン モデル マッピング   | アクセス トークンを保存するために使用する ER インポート モデル マッピングを選択します。 |
| 許可済のスコープ                | アプリケーションへの要求に対して付与されるスコープ。 このフィールドは、自動的に更新されます。 |
| アクセス トークンの有効期限:  | アクセス トークンの有効期限が切れるまでの残り時間。 | 
| 適用                       | Web 要求の **受け入れ** プロパティを指定します。 たとえば、**application/vnd.hmrc.1.0+json** と入力します。 |
| コンテンツ タイプ                 | コンテンツ タイプを指定します。 たとえば、**application/json** と入力します。 |

さらに、認証プロセスをサポートするために、**Web アプリケーション** ページのアクション ウィンドウで次のボタンが利用できます:

- **認証コードを取得** ー Web アプリケーションの認証を初期化します。
- **アクセス トークンを取得** ー アクセス トークンの取得のプロセスを初期化します。
- **アクセス トークンを更新** ー アクセス トークンを更新します。

Web アプリケーションへのアクセス トークンが暗号化された形式でシステムのデータベースに保存されている場合、Web サービスへの要求に使用することができます。 セキュリティの目的のため、アクセス トークンへのアクセスは要求に対処するよう許可されているセキュリティ ロールのみに限定する必要があります。 セキュリティ グループの外部のユーザーが要求に対処しようとすると、選択した Web アプリケーション経由での相互運用が許可されていないことを示すエラーが表示されます。 アクセス トークンへのアクセスが必要なセキュリティ ロールを設定するには、**Web アプリケーション** ページの **セキュリティ ロール** クイック タブを使用します。 Web アプリケーションに対してセキュリティ ロールが定義されていない場合、システム管理者のみがこの Web アプリケーション経由で相互運用することができます。

### <a name="web-service-settings"></a>Web サービスの設定

Web サービス設定を使用して、Web サービスへの直接のデータ送信を設定します。 Web サービスの設定は、**Web サービスの設定** ページ (**税**\>**設定**\>**電子メッセージ**\>**Web サービスの設定**) で行うことができます。

次のテーブルは、**Web サービスの設定** ページのフィールドについて説明しています。

| フィールド                          | 説明 |
|--------------------------------|-------------|
| Web サービス                    | Web サービスの名前を入力します。 |
| 説明                    | Web サービスの説明を入力します。 |
| インターネット アドレス               | Web サービスのインターネット アドレスを入力します。 Web アプリケーションが Web サービスに指定されていて、Web サービスのインターネット アドレスがその Web アプリケーションに対して定義されたものと同じである必要がある場合、**ベース URL をコピー** ボタンを選択して、Web アプリケーションのベース URL をこのフィールドにコピーします。 |
| 証明書                    | 以前に設定した Key Vault 証明書を選択します。 |
| Web アプリケーション                | 以前に設定した Key Vault 証明書を選択します。 |
| 応答タイプ - XML        | 応答タイプが XML の場合、このオプションを **はい** に設定します。 |
| 要求メソッド                 | 要求されたメソッドを指定します。 HTTPは、特定のリソースに対して実行されるアクションを示す要求メソッドのセットを定義します。 要求メソッドは、**GET**、**POST**、または別の HTTP メソッドにすることができます。 |
| 要求ヘッダー                | 要求ヘッダーを指定する。 要求ヘッダーは、HTTP 要求で使用できる HTTP ヘッダーで、メッセージのコンテンツとは関係ありません。 |
| 適用                         | Web 要求の **受け入れ** プロパティを指定します。 |
| エンコードの承諾                | **Accept-Encoding** 値を指定します。 Accept-Encoding 要求 HTTP ヘッダーは、クライアントが理解できるコンテンツのエンコードを通知します。 このコンテンツ エンコードは、通常、圧縮アルゴリズムです。 |
| コンテンツ タイプ                   | コンテンツ タイプを指定します。 Content-Type エンティティ HTTP ヘッダーは、リソースのメディア タイプを示します。 |
| 正常な応答コード       | 要求が成功したことを示す HTTP 状態コードを指定します。 |
| 要求ヘッダー形式マッピング | Web 要求ヘッダーを生成するために使用される ER 形式を選択します。 |

### <a name="message-processing-actions"></a>メッセージ処理アクション

メッセージ処理アクションを使用して処理のアクションを作成し、そのパラメーターを設定します。 メッセージ処理のアクションは、**メッセージ処理のアクション** ページ (**税** \> **設定** \> **電子メッセージ** \> **メッセージ処理のアクション**) で設定できます。

次のテーブルで、**メッセージ処理のアクション** ページでフィールドについて説明します。

#### <a name="general-fasttab"></a>全般クイック タブ

| フィールド                       | 説明 |
|-----------------------------|-------------|
| アクション タイプ                 | アクションのタイプを選択します。 使用可能なオプションの詳細については、[メッセージ処理のアクションのタイプ](#message-processing-action-types) セクションを参照してください。 |
| 形式マッピング              | アクションに呼び出される ER フォーマットを選択します。 このフィールドは、**電子申告のエクスポート**、**電子申告のインポート** および **電子申告のエクスポート メッセージ** タイプのアクションにのみ使用できます。 |
| URL パスの形式マッピング | アクションに呼び出される ER フォーマットを選択します。 このフィールドは、**Web サービス** タイプのアクションにのみ使用できます。 これは、選択した Web サーバーに対して指定されているベース インターネット アドレスに追加される URL アドレスのパスを作成するために使用します。 |
| メッセージ項目タイプ           | アクションを評価するレコードのタイプを選択します。 このフィールドは、**メッセージ項目実行レベル**、**電子申告のエクスポート**、および **電子申告のインポート**、**Web サービス** タイプおよび他のいくつかのタイプのアクションにも使用できます。 このフィールドを空白のままにすると、メッセージの処理に定義されたすべてのメッセージ項目タイプが評価されます。 |
| 実行可能なクラス            | 以前に作成された実行可能なクラスの設定を選択します。 このフィールドは、**メッセージ項目実行レベル** および **メッセージ項目実行レベル** タイプのアクションにのみ使用できます。 |
| レコード アクションの設定     | 以前に設定されたレコード アクションの設定を選択します。 このフィールドは、**レコードの設定** タイプのアクションにのみ使用できます。 |
| Web サービス                 | 以前に設定された Web サービスを選択します。 このフィールドは、**Web サービス** タイプのアクションにのみ使用できます。 |
| ファイル名                   | アクションの結果となるファイルの名前を指定します。 このファイルは、Web サーバーからの応答または生成されるレポートです。 このフィールドは、**Web サービス** および **電子申告のエクスポート メッセージ** タイプのアクションにのみ使用できます。 |
| ダイアログの表示                 | レポート生成の前にユーザーにダイアログ ボックスを表示する必要がある場合、このオプションを **はい** に設定します。 このフィールドは、**電子申告のエクスポート メッセージ** タイプのアクションにのみ使用できます。 |

##### <a name="message-processing-action-types"></a>メッセージ処理アクション タイプ

**アクション タイプ** フィールドでは、次のオプションを使用できます。

- **メッセージを作成** – このアクションを使用して、ユーザーが **電子メッセージ** ページで手動でメッセージを作成できるようにします。 初期状態はこのタイプのアクションに設定できません。
- **レコードの設定** – **レコードの設定** タイプのアクションが事前に設定されている必要があります。 このアクション タイプをレコードの設定アクションと関連付けて、そのアクションが処理に含まれるようにします。 このアクション タイプはメッセージ処理の最初のアクションに対して (事前に電子メッセージが作成されていない場合)、または **メッセージの作成** タイプのアクションによって以前に作成されたメッセージにメッセージ項目を追加するアクションとして使用されるかのいずれかとみなされます。 したがって、このタイプのアクションでは、結果状態はメッセージ項目に対してのみ設定できます。 初期状態はメッセージにのみ設定することができます。
- **メッセージの実行レベル** – このアクション タイプを使用して、メッセージ レベルで評価する必要がある実行可能なクラスを設定します。
- **メッセージ項目実行レベル** – このアクション タイプを使用して、メッセージ項目レベルで評価する必要がある実行可能なクラスを設定します。
- **電子申告のエクスポート** ー このアクション タイプは、メッセージ項目レベルでエクスポート ER コンフィギュレーションに基づくレポートを生成するアクションに使用します。
- **電子申告のエクスポート メッセージ** – このアクション タイプは、メッセージ レベルでエクスポート ER コンフィギュレーションに基づくレポートを生成するアクションに使用します (たとえば、メッセージにメッセージ項目がない場合など)。
- **電子申告のインポート** ー このアクション タイプは、インポート ER コンフィギュレーションに基づくレポートを生成するアクションに使用します。
- **メッセージ レベルのユーザーの処理** – このアクション タイプは、メッセージ レベルのユーザーによる何らかの手動操作を想定したアクションに使用します。 たとえば、ユーザーは、メッセージの状態を更新する場合があります。
- **ユーザーの処理** – このアクション タイプは、メッセージ項目レベルのユーザーによる何らかの手動操作を想定したアクションに使用します。 たとえば、ユーザーは、メッセージ項目の状態を更新する場合があります。
- **Web サービス** – このアクション タイプは、Web サービスに生成されたレポートを送信するアクションに使用します。 イタリアの購買および販売の請求書通信レポートには、このアクション タイプは使用されません。 **Web サービス** タイプのアクションに対して、**メッセージ処理アクション** ページは確認テキストを指定できる **その他の詳細** クイック タブを含みます。 この確認テキストは、選択した Web サービスへの要求が対処される前にユーザーに表示されます。
- **検証要求** – このアクション タイプは、サーバーからの検証要求に使用します。

#### <a name="initial-statuses-fasttab"></a>初期状態 クイック タブ

> [!NOTE]
> **初期状態** クイック タブは、**メッセージの作成** の初期のアクション タイプを持つアクションでは使用できません。

| フィールド               | 説明 |
|---------------------|-------------|
| メッセージ項目の状態 | 選択されたメッセージ処理アクションを評価するメッセージ項目の状態を選択します。 |
| 説明         | 選択されたメッセージ項目の状態の説明。 |

#### <a name="result-statuses-fasttab"></a>結果状態 クイック タブ

| フィールド               | 説明 |
|---------------------|-------------|
| メッセージ状態      | 選択されたメッセージ処理アクションを評価するメッセージ状態を選択します。 このフィールドは、メッセージ レベルで評価されるメッセージ処理アクションでのみ使用できます。 たとえば、**電子申告のエクスポート** および **電子申告のインポート** タイプのアクションには使用可能ですが、**ユーザー処理** および **メッセージ項目実行レベル** タイプのアクションには使用できません。 |
| 説明         | 選択されたメッセージ状態の説明。 |
| 応答タイプ       | 選択されたメッセージ状態の応答タイプ |
| メッセージ項目の状態 | 選択されたメッセージ処理アクションが評価された後で使用可能な結果状態を選択します。 このフィールドは、メッセージ項目レベルで評価されるメッセージ処理アクションでのみ使用できます。 たとえば、**ユーザー処理** および **メッセージ項目実行レベル** タイプのアクションで使用できます。 メッセージ レベルで評価されるメッセージ処理アクションの場合、このフィールドには、選択されたメッセージ状態に対して設定されたメッセージ項目の状態が表示されます。 |

次のテーブルでは、さまざまなアクション タイプおよび応答タイプに設定する必要がある結果状態を示します。

| 電子メッセージのアクション タイプ/応答タイプ | 正常に実行されました | ビジネス エラー | 技術エラー | ユーザー定義 | キャンセル |
|----------------------------------------------|-----------------------|----------------|-----------------|--------------|--------|
| メッセージの作成                               | x                     |                |                 |              |        |
| 電子申告のエクスポート                  | x                     |                |                 |              |        |
| 電子申告のインポート                  |                       |                |                 |              |        |
| Web サービス                                  | x                     |                | x               |              |        |
| ユーザー処理                              |                       |                |                 |              |        |
| メッセージ実行レベル                      |                       |                |                 |              |        |
| レコードの設定                             |                       |                |                 |              |        |
| メッセージ項目実行レベル                 |                       |                |                 |              |        |
| 要求の検証                         | x                     | x              | x               |              |        |
| 電子申告のエクスポート メッセージ          | x                     |                |                 |              |        |
| メッセージ レベルのユーザー処理                |                       |                |                 |              |        |

### <a name="electronic-message-processing"></a>電子メッセージの処理

電子メッセージの処理は、電子メッセージ機能の基本概念です。 電子メッセージを評価するアクションを集計します。 アクションは、初期状態と結果状態を介してリンクすることができます。 または、**ユーザー処理** タイプのアクションを個別に開始することもできます。 **電子メッセージの処理** ページ (**税**\>**設定**\>**電子メッセージ**\>**電子メッセージの処理**) で、メッセージ レベルまたはメッセージ項目レベルのいずれかで処理するためにサポートする必要のある追加フィールドを選択することもできます。

**アクション** クイック タブでは、定義済みのアクションを処理に追加することができます。 アクションを個別に実行する必要があるか、または処理によって開始できるかどうかを指定することができます。 処理のアクションをユーザーだけが初期化できるように指定するには、そのアクションの **個別に実行** フィールドを **はい** に設定します。 アクションの初期状態として定義された状態にあるメッセージまたはメッセージ項目の処理によってアクションを開始する必要がある場合、**個別に実行** フィールドを **いいえ** に設定します。 **ユーザー アクション** タイプのアクションは、常に個別でのみ実行する必要があります。

場合によっては、最初のアクションが個別に実行されるように設定されていても、いくつかのアクションをシーケンスに集約する必要があります。 たとえば、ユーザーはレポートの生成を初期化する必要がありますが、レポートが生成された直後にそれを Web サービスに送信し、Web サービスからの応答をシステムに反映する必要があります。 このような状況では、常に一緒に実行する必要があるアクションの非分解シーケンスを作成することができます。 **アクション** クイック タブで、グリッドの上にある **非分解シーケンス** を選択して、シーケンスを作成します。 次に、一緒に実行する必要があるすべてのアクションに対して、**非分解シーケンス** フィールドのシーケンスを選択します。 この場合、シーケンスの最初のアクションでは **個別に実行** フィールドを **はい** に設定することができますが、他のすべてのアクションでは **いいえ** に設定します。

**メッセージ項目追加フィールド** クイック タブでは、メッセージ項目に関連する定義済み追加フィールドを追加することができます。 フィールドが関連するメッセージ項目のタイプごとに追加フィールドを追加する必要があります。

**メッセージ追加フィールド** クイック タブでは、メッセージに関連する定義済み追加フィールドを追加することができます。

**セキュリティ ロール** クイック タブでは、特定の処理のためのシステムで定義済みのセキュリティ ロールを設定することができます。 特定のロールを持つユーザーには、そのロールに対して定義されている処理のみが表示されます。

**バッチ** クイック タブを使用すると、バッチ制度で実行する処理を設定できます。

## <a name="work-with-the-electronic-messages-functionality"></a>電子メッセージ機能の使用

メッセージ レベルで作業している場合、**電子メッセージ** ページ (**税**\>**照会およびレポート**\>**電子メッセージ**\>**電子メッセージ**) が役立ちます。 データ収集 (メッセージ項目) レベルで作業をしている場合、**電子メッセージ項目** ページ (**税**\>**照会およびレポート**\>**電子メッセージ**\>**電子メッセージ項目**) が役立ちます。

### <a name="electronic-messages"></a>電子メッセージ

**電子メッセージ** ページには、ロールに基づいて利用可能な処理が表示されます。 セキュリティ ロールは、その処理設定の処理に関連付けられます。 利用可能な各処理について、関連する電子メッセージと情報がページに表示されます。

**メッセージ** クイック タブに、選択した処理に対する電子メッセージが表示されます。 選択したメッセージと定義済み処理の状態に応じて、グリッドの上にあるボタンを使用していくつかのアクションを実行することができます。

- **新規** – このボタンは、**メッセージの作成** タイプのアクションに関連付けられています。
- **削除** – このボタンは、選択されたメッセージの現在の状態に対して **削除を許可** のチェック ボックスがオンになっている場合に使用できます。
- **データの収集** ー このボタンは **レコードの設定** タイプに関連付けられています。
- **レポートの生成** – このボタンは、**電子申告エクスポート メッセージ** タイプのアクションに関連付けられています。
- **レポートの送信** – このボタンは、**Web サービス** タイプのアクションに関連付けられています。
- **応答のインポート** – このボタンは、**電子申告インポート** タイプのアクションに関連付けられています。
- **状態の更新** – このボタンは、**メッセージ レベルのユーザー処理** タイプのアクションに関連付けられています。
- **メッセージ項目** – **電子メッセージ項目** ページを開きます。

**アクション ログ** クイック タブには、選択されたメッセージに対して実行されたすべてのアクションに関する情報が表示されます。 アクションがエラーの原因になっている場合、エラーに関する情報は、関連するグリッドの明細行に関連付けられます。 エラーに関する情報を確認するには、グリッドで明細行を選択し、ページの右上隅にある **添付ファイル** ボタン (紙クリップ記号) を選択します。

**メッセージ追加フィールド** クイック タブには、処理設定のメッセージに対して定義済みのすべての追加フィールドが表示されます。 これらの追加フィールドの値も表示されます。

**メッセージ項目** クイック タブには、選択されたメッセージに関連付けられたすべてのメッセージ項目が表示されます。 選択したメッセージ項目の状態に応じて、グリッドの上にあるボタンを使用していくつかのアクションを実行することができます。

- **削除** – このボタンは、選択されたメッセージ項目の現在の状態に対して **削除を許可** のチェック ボックスがオンになっている場合に使用できます。
- **状態の更新** – このボタンは、**ユーザー処理** タイプのアクションに関連付けられています。
- **元の文書** ー 選択したメッセージ項目の元の文書を表示するページを開きます。

メッセージに対してすでに生成され受信されたすべてのレポートは、そのメッセージに添付されます。 そのメッセージに関連する添付ファイルを確認するには、メッセージを選択し、ページの右上隅にある **添付ファイル** ボタン (紙クリップ記号) を選択します。

![添付ファイル ボタン](media/attachment-icon.png)

**添付ファイル** ページには、選択したメッセージに関連するすべての添付ファイルが表示されます。 ファイルを表示するには、それを左側のリストから選択し、アクション ウィンドウの **開く** を選択します。

![開く ボタン](media/open-button.png)

以前にメッセージに対して実行された特定のアクションに関連する添付ファイルを確認することもできます。 **電子メッセージ** ページで、**メッセージ** クイック タブでメッセージを選択し、**操作ログ** クイック タブでアクションを選択し、ページの右上隅にある **添付ファイル** ボタンを選択します。

アクション ウィンドウで **処理の実行** を選択して、全体の処理もしくは特定のアクションを実行することもできます。

### <a name="electronic-message-items"></a>電子メッセージ項目

**電子メッセージ項目** ページには、すべてのメッセージ項目と各メッセージ項目に対して実行されたアクションのログが表示されます。 また、メッセージ項目に対して定義された追加フィールド、およびそれら追加フィールドの値も表示されます。

次の表で、**メッセージ項目** タブのフィールドについて説明します。

<table>
<thead>
<tr>
<th>フィールド</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td>処理中</td>
<td>メッセージ項目の作成に使用された処理の名前。</td>
</tr>
<tr>
<td>メッセージ項目</td>
<td>メッセージ項目の ID。 この ID は、<strong>総勘定元帳パラメーター</strong>ページ<strong>で定義されているメッセージ項目</strong>の番号順序に基づいて割り当てられます。</td>
</tr>
<tr>
<td>メッセージ項目の日付</td>
<td>メッセージ項目が作成された日付。</td>
</tr>
<tr>
<td>メッセージ項目タイプ</td>
<td>メッセージ項目のタイプ。 同じ処理のためにいくつかのメッセージ項目のタイプを設定できます(たとえば、<strong>仕入請求書</strong>および<strong>支払請求書</strong>)。 このフィールドは、メッセージ項目テーブルに請求書が追加された場合にのみ、自動的に入力されます。</td>
</tr>
<tr>
<td>メッセージ項目の状態</td>
<td>メッセージ項目の実際の状態。 使用可能な状態は、メッセージ項目のタイプによって異なります。 次にいくつか例を挙げます。
<ul>
<li><strong>入力済</strong> – メッセージ項目テーブルにレコードが追加されました。</li>
<li><strong>評価済</strong> – メッセージ項目の追加の属性が計算されました。</li>
<li><strong>報告済</strong> – メッセージ項目がレポートに正常に追加されました。</li>
<li><strong>除外</strong> – この状態は、エクスポート前にいくつかのメッセージ項目を除外する必要がある場合に役立ちます。</li>
</ul>
</td>
</tr>
<tr>
<td>送信日</td>
<td>生成されたレポートをシステム外部に自動的に送信する処理の場合、メッセージ項目が送信された日付。</td>
</tr>
<tr>
<td>ドキュメント番号</td>
<td>このフィールドは、レコード アクション設定の設定に基づいて自動的に入力されます。 このフィールドは、メッセージ項目テーブルに請求書が追加された場合にのみ、自動的に入力されます。</td>
</tr>
<tr>
<td>勘定番号</td>
<td>顧客または仕入先の勘定番号 (または別のフィールド値。レコードの設定アクションで定義されるフィールドによって異なります)。 このフィールドは、メッセージ項目テーブルに請求書が追加された場合にのみ、自動的に入力されます。</td>
</tr>
<tr>
<td>メッセージ</td>
<td>メッセージの番号。 この番号は、<strong>総勘定元帳パラメーター</strong> ページで定義される<strong>メッセージ</strong>番号順序に基づいて、自動的に割り当てられます。</td>
</tr>
<tr>
<td>メッセージ状態</td>
<td>電子メッセージの実際の状態。</td>
</tr>
<tr>
<td>次のアクション</td>
<td>メッセージ項目の現在の状態に対して開始できる次のアクション。</td>
</tr>
</tbody>
</table>

**追加フィールド** タブは、選択されたメッセージ項目およびその値の追加フィールドを表示します。

#### <a name="run-processing"></a>処理の実行

アクション ウィンドウで **処理の実行** を選択し、メッセージ項目に対して処理を実行します。 特定のアクションを実行するには、**処理の実行** ダイアログ ボックスで **アクションの選択** オプションを **はい** に設定し、アクションを選択します。 全体の処理を実行するには、**アクションの選択** オプションを **いいえ** に設定します。

#### <a name="generate-report"></a>レポートの生成

アクション ウィンドウで **レポートの生成** を選択し、レポートを生成します。 このボタンは、**電子報告エクスポート** タイプのアクションに関連付けられています。

#### <a name="update-status"></a>状態の更新

1 つ以上のメッセージ項目の状態を更新するには、アクション ウィンドウで **状態の更新** を選択します。 **状態の更新** ダイアログ ボックスで、**対象に含めるレコード** クイック タブを使用して更新するメッセージ項目を選択します。 選択基準が正しく定義されているか確認してください。メッセージ項目状態は、これらの基準、選択したアクションの初期状態、および指定した **新しい状態** の値に従って更新されます。 状態の更新が完了した後は、更新された項目を特定することは難しくなります。 したがって、状態の更新をロールバックすることは難しくなります。

#### <a name="electronic-messages"></a>電子メッセージ

アクション ウィンドウの **電子メッセージ** を選択し、選択したメッセージ項目に関連付けられている電子メッセージを確認します。

特定のメッセージ項目に関連するすべてのファイルを確認することもできます。 そのメッセージ項目の **メッセージ** フィールド、もしくはアクション ウィンドウの **電子メッセージ** を選択します。 **電子メッセージ** ページでファイルを確認するメッセージを選択してから、ページの右上隅にある **添付ファイル** ボタン (紙クリップ記号) を選択します。

![添付ファイル ボタン](media/attachment-icon.png)

**添付ファイル** ページには、メッセージに関連するすべての添付ファイルが表示されます。 ファイルを表示するには、それを左側のリストから選択し、アクション ウィンドウの **開く** を選択します。

![開く ボタン](media/open-button.png)

#### <a name="original-document"></a>元の文書

アクション ウィンドウの **元の文書** を選択し、選択したメッセージ項目の元の文書を開きます。

## <a name="example-set-up-and-run-processing-to-call-a-simple-er-exporting-format-to-generate-an-excel-report"></a>例: 簡易 ER エクスポート形式を呼び出して Excel レポートを生成するよう設定し、処理を実行する

ER 形式を作成してデータソースにマップし、完成させた後に、**電子申告** ワークスペースを使用してそれを実行できます。 レポートが生成され、ローカルに保存することができます。

レポート処理の次の側面をコントロールするには、電子メッセージ処理を設定する必要があります。

- レポートの作成者に関するログ情報。
- レポートの作成日時に関するログ情報。
- 以前の期間に生成されたレポートを保存します。

このセクションでは、Excel のエクスポート ER 形式に基づくレポートを生成するために電子メッセージを設定する方法を示す例を取り上げます。 この例に従う場合は、ER Excel エクスポート形式を作成し、データソースにマップし、完了している必要があります。 また、番号順序は既に電子メッセージに設定されている必要があります。

処理を構築するときは、設定する処理アクションと状態を最初に定義すると役立ちます。 次の図は、この例の処理の概要を示しています。

![処理スキーム](media/processing-scheme.png)

#### <a name="create-message-statuses"></a>メッセージ状態の作成

1. **税\>設定\>電子メッセージ\>メッセージの状態** に移動します。
2. 次のメッセージ状態を作成します。

    - 新規
    - 準備済
    - 生成済

    ![メッセージ状態](media/message-statuses.png)

3. **新しい** 状態の行で、**削除を許可** チェック ボックスをオンにし、ユーザーがこの状態にあるメッセージを削除できるようにします。

#### <a name="create-additional-fields"></a>追加フィールドの作成

1. **税\>設定\>電子メッセージ\>追加フィールド** に移動します。
2. 追加フィールドとその値を追加します。 次に例を示します。

    ![追加フィールド](media/additional-fields.png)

3. **ユーザーの編集** オプションを **はい** に設定し、ユーザーがフィールドを編集できるようにします。

#### <a name="create-message-processing-actions"></a>メッセージ処理アクションの作成

この例では、次のアクションを作成します。

- **メッセージの作成**
- **準備済に更新**
- **レポートの生成**
- **初期状態への更新** (オプション)

1. **税\>設定\>電子メッセージ\>メッセージ処理アクション** に移動します。
2. **メッセージの作成** という名前の付いたアクションを作成します。 **一般** クイック タブの **アクション タイプ** フィールドで、**メッセージの作成** を選択します。
3. **準備済に更新** という名前の付いたアクションを作成し、次のフィールドを設定します。

    - **一般** クイック タブの **アクション タイプ** フィールドで、**メッセージ レベルのユーザー処理** を選択します。
    - **初期状態** クイック タブの **メッセージ状態** フィールドで、**新規** を選択します。
    - **結果状態** クイック タブの **メッセージ状態** フィールドで、**準備済** を選択します。 **応答タイプ** フィールドに、**正常に実行されました** と入力します。

4. **レポートの生成** という名前の付いたアクションを作成し、次のフィールドを設定します。

    - **一般** クイック タブの **アクション タイプ** フィールドで、**電子申告のエクスポート** を選択します。 **形式マッピング** フィールドで、エクスポート ER 形式を選択します。 オプションは、**Excel**、**XML**、**JSON**、**Text** および **Other** です。
    - **初期状態** クイック タブの **メッセージ状態** フィールドで、**準備済** を選択します。
    - **結果状態** クイック タブの **メッセージ状態** フィールドで、**生成済** を選択します。 **応答タイプ** フィールドに、**正常に実行されました** と入力します。

    ![レポート アクションの生成](media/generate-report-action.png)

5. オプション : ユーザーがレポートを複数回再生できるようにする場合は、**初期状態への更新** アクションを作成し、次のフィールドを設定します。

    - **一般** クイック タブの **アクション タイプ** フィールドで、**メッセージ レベルのユーザー処理** を選択します。
    - **初期状態** クイック タブの **メッセージ状態** フィールドで、**生成済** を選択します。
    - **結果状態** クイック タブで、2 つのメッセージの状態ごとに個別の明細行を追加します (**準備済** および **新規**)。 両方の明細行に対して **応答タイプ** フィールドを **正常に実行されました** に設定します。

#### <a name="electronic-message-processing"></a>電子メッセージの処理

この例では、すべてのアクションを個別に実行するように設定する必要があります。 ユーザーがすべてのアクションを初期化することを前提としています。

1. **税\>設定\>電子メッセージ\>電子メッセージの処理** に移動します。
2. 処理のためにレコードを追加し、すべての定義済のアクションおよび追加フィールドを追加します。
3. オプション: **セキュリティ ロール** クイック タブで、特定のレポートへのアクセスを限定する処理のセキュリティ ロールを定義します。
4. **税\>照会およびレポート\>電子メッセージ\>電子メッセージ** に移動します。
5. **新規** を選択してメッセージを作成します。 この時点で、日付と説明を追加できます。 追加フィールドの値を必要に応じて更新することもできます。

    ![電子メッセージの作成](media/create-electronic-message.png)

**アクション ログ** のグリッドでは、クイック タブは、メッセージ上で実行されるすべてのアクションのログを自動的に入力します。

メッセージ状態を削除または更新できるようになりました。 メッセージ状態を更新するには、**状態の更新** を選択します。 **新しい状態** フィールドで **準備済** を選択してから、**OK** を選択します。

![メッセージ状態の更新](media/update-status.png)

メッセージ状態が **準備済** に更新され、**レポートの生成** を選択してレポートを生成できるようになりました。 レポートが生成され、メッセージ状態およびアクションのログは更新されます。 生成されたレポートを表示するには、ページの右上隅にある **添付ファイル** ボタン (紙クリップ記号) を選択します。


[!INCLUDE[footer-include](../../includes/footer-banner.md)]