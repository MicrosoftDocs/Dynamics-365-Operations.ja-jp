---
title: ワークスペースのタイルおよびリストのキャッシュ
description: ワークスペースが正常に機能し、応答可能である (つまり、ワークスペースに表示されるデータが期待どおりに更新され、最新の状態である) ことが重要です。 このトピックでは、タイルとリストに使用されるデータをキャッシュするためのフレームワークのサポートについて説明します。
author: jasongre
manager: AnnBe
ms.date: 06/20/2017
ms.topic: article
ms.prod: ''
ms.service: dynamics-ax-platform
ms.technology: ''
audience: Developer
ms.reviewer: sericks
ms.search.scope: Operations
ms.custom: 16341
ms.assetid: c84d7929-4662-4abb-b345-ccc539d809d0
ms.search.region: Global
ms.author: jasongre
ms.search.validFrom: 2016-02-28
ms.dyn365.ops.version: AX 7.0.0
ms.openlocfilehash: b6789a83b303c792cf20f3b4bd203bc679e63610
ms.sourcegitcommit: 9f90b194c0fc751d866d3d24d57ecf1b3c5053a1
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 02/07/2020
ms.locfileid: "3033051"
---
# <a name="tile-and-list-caching-for-workspaces"></a><span data-ttu-id="3fa41-104">ワークスペースのタイルおよびリストのキャッシュ</span><span class="sxs-lookup"><span data-stu-id="3fa41-104">Tile and list caching for workspaces</span></span>

[!include [banner](../includes/banner.md)]

<span data-ttu-id="3fa41-105">ワークスペースが正常に機能し、応答可能である (つまり、ワークスペースに表示されるデータが期待どおりに更新され、最新の状態である) ことが重要です。</span><span class="sxs-lookup"><span data-stu-id="3fa41-105">It's important that workspaces perform well, and that they be responsive (that is, the data that appears in a workspace is refreshed as expected and kept up to date).</span></span> <span data-ttu-id="3fa41-106">このトピックでは、タイルとリストに使用されるデータをキャッシュするためのフレームワークのサポートについて説明します。</span><span class="sxs-lookup"><span data-stu-id="3fa41-106">This topic discusses framework support for caching data that is used for tiles and lists.</span></span>

<a name="introduction"></a><span data-ttu-id="3fa41-107">はじめに</span><span class="sxs-lookup"><span data-stu-id="3fa41-107">Introduction</span></span>
------------

<span data-ttu-id="3fa41-108">ワークスペースは大半のユーザーにとって活動のハブとなるように意図されています。</span><span class="sxs-lookup"><span data-stu-id="3fa41-108">Workspaces are intended to be the hub of activity for most users.</span></span> <span data-ttu-id="3fa41-109">さまざまな情報源から収集された豊富な情報を表示します。</span><span class="sxs-lookup"><span data-stu-id="3fa41-109">They display a wealth of information that is collected from various sources.</span></span> <span data-ttu-id="3fa41-110">したがって、ワークスペースが正常に動作し、応答性があることを確認する必要があります (つまり、ワークスペースに表示されたデータが予想どおりに更新され、最新の状態に維持される)。</span><span class="sxs-lookup"><span data-stu-id="3fa41-110">Therefore, you must make sure that workspaces perform well and are responsive (that is, the data shown in the workspace is refreshed as expected and/or kept up to date).</span></span> <span data-ttu-id="3fa41-111">キャッシュは、パフォーマンスの低いクエリからのデータが得られた場合にワークスペースの優れたパフォーマンスを保証できるようにします。また、複数のユーザーが同じデータ セットに同時にアクセスする必要がある場合に特に便利です。</span><span class="sxs-lookup"><span data-stu-id="3fa41-111">Caching can help guarantee great workspace performance when data comes from poorly performing queries, and is especially useful when multiple users require access to the same set of data at the same time.</span></span> <span data-ttu-id="3fa41-112">たとえば、フォーム上のグリッドが複合 (つまり、低いパフォーマンス) クエリを使用する場合、フォームの以後の積荷に使用できるように結果をキャッシュすることができます。</span><span class="sxs-lookup"><span data-stu-id="3fa41-112">For example, if a grid on a form uses a complex (that is, low-performing) query, you can cache the results so that they are available for subsequent loads of the form.</span></span> <span data-ttu-id="3fa41-113">この記事では、タイルとリストに使用されるデータをキャッシュするためのフレームワークのサポートについて説明します。</span><span class="sxs-lookup"><span data-stu-id="3fa41-113">This article discusses framework support for caching data that is used for tiles and lists.</span></span> <span data-ttu-id="3fa41-114">応答しやすいワークスペースの観点から、ユーザーがワークスペースに移動した (またはそこに戻った) ときに、ワークスペース内のデータが比較的に最新の状態であることを期待します。</span><span class="sxs-lookup"><span data-stu-id="3fa41-114">In terms of a responsive workspace, when users navigate to a workspace (or return to it), they expect that the data in the workspace will be relatively up to date.</span></span> <span data-ttu-id="3fa41-115">たとえば、ユーザーがワークスペースでリストまたはタイルのデータを変更するアクションを実行する場合、ワークスペースはアクションが実行された直後 (アクションがワークスペースから直接実行された場合)、またはユーザーがワークスペース フォームに返す際に (アクションが異なるフォームで実行された場合)、その変更を反映する必要があります。</span><span class="sxs-lookup"><span data-stu-id="3fa41-115">For example, if a user takes an action that changes the data for a list or tile in a workspace, the workspace should reflect that change immediately after the action is performed (if the action was taken directly from the workspace) or when the user returns to the workspace form (if the action was taken on a different form).</span></span> <span data-ttu-id="3fa41-116">この記事では、タイルとリストの両方について、このタイプのデータ更新が (メタデータとコードの両方で) 行われるようにするための手法について説明します。</span><span class="sxs-lookup"><span data-stu-id="3fa41-116">This article describes techniques for making sure that this type of data refresh occurs (both metadata and code) for both tiles and lists.</span></span>

## <a name="count-tiles"></a><span data-ttu-id="3fa41-117">カウント タイル</span><span class="sxs-lookup"><span data-stu-id="3fa41-117">Count tiles</span></span>
### <a name="automatic-data-caching"></a><span data-ttu-id="3fa41-118">自動データ キャッシング</span><span class="sxs-lookup"><span data-stu-id="3fa41-118">Automatic data caching</span></span>

<span data-ttu-id="3fa41-119">フレームワークは、定義されたカウント タイルの背後に自動的にデータ キャッシングを設定します。</span><span class="sxs-lookup"><span data-stu-id="3fa41-119">The framework automatically sets up data caching behind any defined count tile.</span></span> <span data-ttu-id="3fa41-120">したがって、この場合には余分なコードは必要ありません。</span><span class="sxs-lookup"><span data-stu-id="3fa41-120">Therefore, no extra code is required in this case.</span></span> <span data-ttu-id="3fa41-121">タイル内の**更新頻度**のメタデータ プロパティは、タイルのカウントが自動的に更新される頻度を決定します。</span><span class="sxs-lookup"><span data-stu-id="3fa41-121">A **Refresh Frequency** metadata property on Tiles determines how often the count on the tile is automatically updated.</span></span> <span data-ttu-id="3fa41-122">次のテーブルでは、このプロパティのオプションとガイダンスについて説明しています。</span><span class="sxs-lookup"><span data-stu-id="3fa41-122">The following table describes the options and guidance for this property.</span></span>

| <span data-ttu-id="3fa41-123">先頭値</span><span class="sxs-lookup"><span data-stu-id="3fa41-123">Value</span></span>                              | <span data-ttu-id="3fa41-124">使用時</span><span class="sxs-lookup"><span data-stu-id="3fa41-124">When to use</span></span>                                                                                                                |
|------------------------------------|----------------------------------------------------------------------------------------------------------------------------|
| <span data-ttu-id="3fa41-125">できる限り速く (5 秒)</span><span class="sxs-lookup"><span data-stu-id="3fa41-125">As Fast As Permissible (5 seconds)</span></span> | <span data-ttu-id="3fa41-126">クエリの実行時間は 25 ミリ秒以下であり、常に更新された値を表示する必要があります。</span><span class="sxs-lookup"><span data-stu-id="3fa41-126">Query execution time is 25 ms or less, and there is demand to see the updated value all the time.</span></span>                          |
| <span data-ttu-id="3fa41-127">10 分</span><span class="sxs-lookup"><span data-stu-id="3fa41-127">10 Minutes</span></span>                         | <span data-ttu-id="3fa41-128">クエリの実行時間は 250 ミリ秒未満であり、更新されたデータを定期的に表示する必要があります</span><span class="sxs-lookup"><span data-stu-id="3fa41-128">Query execution time is less than 250 ms, and updated data must be seen periodically</span></span>                                       |
| <span data-ttu-id="3fa41-129">24 時間</span><span class="sxs-lookup"><span data-stu-id="3fa41-129">24 Hours</span></span>                           | <span data-ttu-id="3fa41-130">クエリの実行時間は 2000 ミリ秒未満であり、カウントの変更は予期されていないか、最新のカウントが重要です。</span><span class="sxs-lookup"><span data-stu-id="3fa41-130">Query execution time is less than 2000 ms, and/or the count isn't expected to change often or up-to-date counts are vital.</span></span> |

### <a name="refresh-management"></a><span data-ttu-id="3fa41-131">更新管理</span><span class="sxs-lookup"><span data-stu-id="3fa41-131">Refresh management</span></span>

<span data-ttu-id="3fa41-132">保留中の作業を表す値を示すカウント タイルは、かなり反応的でなければなりません。</span><span class="sxs-lookup"><span data-stu-id="3fa41-132">Count tiles that show values that represent pending work should be fairly responsive.</span></span> <span data-ttu-id="3fa41-133">理想的には、ワークスペース タイルに表示されるカウントが常に最新の 5 秒以内になるように、可能な限り早いリフレッシュ頻度をこれらのタイルに対して定義する必要があります。</span><span class="sxs-lookup"><span data-stu-id="3fa41-133">Ideally, the fastest possible refresh frequency should be defined for these tiles, so that the count that appears on a workspace tile is always within five seconds of being up to date.</span></span> <span data-ttu-id="3fa41-134">このクイック更新頻度はパフォーマンス クエリ (実行時間が 25 ミリ秒未満のクエリ) でのみ設定する必要があるため、最初の推奨事項はカウント タイルのクエリのパフォーマンスを操作して、25 ミリ秒のしきい値未満でクエリの実行を取得するために試行することです。</span><span class="sxs-lookup"><span data-stu-id="3fa41-134">Because this quick refresh rate should be set only on performant queries (queries that have an execution time of less than 25 ms), the first recommendation is that you work on query performance for count tiles, to try to get query execution under the 25-ms threshold.</span></span> <span data-ttu-id="3fa41-135">一般に、この実行速度を実現するためには、次の 2 つが必要です。</span><span class="sxs-lookup"><span data-stu-id="3fa41-135">In general, achieving this execution speed requires two things:</span></span>

-   <span data-ttu-id="3fa41-136">クエリで選択的な WHERE 条件であるクエリの条件は、できれば結果セットを 500 レコード未満に、理想的には 100 行未満に減らす必要があります。</span><span class="sxs-lookup"><span data-stu-id="3fa41-136">A selective WHERE condition on the query Preferably, the conditions on the query should reduce the result set to fewer than ~500 records, and ideally to fewer than ~100 rows.</span></span>
-   <span data-ttu-id="3fa41-137">選択的な WHERE 条件に対応できるインデックス構造</span><span class="sxs-lookup"><span data-stu-id="3fa41-137">An index structure that can act on the selective WHERE condition</span></span>

<span data-ttu-id="3fa41-138">これらの実行速度を達成するためにクエリのパフォーマンスを改善する方法については、「よくある間違いとクエリを最適化するためのヒント」セクションを参照してください。</span><span class="sxs-lookup"><span data-stu-id="3fa41-138">See the "Common mistakes and tips for query optimization" section for details about how to evaluate and improve query performance to achieve these execution speeds.</span></span> <span data-ttu-id="3fa41-139">クエリのバッキングがあり、25 ミリ秒実行速度のしきい値を満たすことができないタイルについては、タイルでの更新頻度を低い値のいずれかに設定する必要があります (たとえば、10 分または 24 時間)。</span><span class="sxs-lookup"><span data-stu-id="3fa41-139">For tiles that have backing queries and can't meet the 25-ms execution speed threshold, the refresh frequency on the tile should be set to one of the lower values (for example, 10 minutes or 24 hours).</span></span> <span data-ttu-id="3fa41-140">より効率の低いクエリ (まれである) を持つタイルの値を頻繁に更新する必要がある場合は、次のコードを追加して、キャッシュされたセットに影響するアクションが発生したときにキャッシュを手動で更新できます。</span><span class="sxs-lookup"><span data-stu-id="3fa41-140">If the values must be updated more frequently for tiles that have less-efficient queries (which should be rare), you can add the following code to manually refresh the cache when an action is taken that will affect the cached set.</span></span>

```xpp
TileDataService::forceRefresh(tilestr(<tileName>), formRun)
```

<span data-ttu-id="3fa41-141">頻繁に変更されないデータ セットの例としては、コンフィギュレーションがない製品です。</span><span class="sxs-lookup"><span data-stu-id="3fa41-141">An example of a data set that might not change often is products that have no configuration.</span></span> <span data-ttu-id="3fa41-142">このカウントを示すタイルは、10 分の更新頻度があります。</span><span class="sxs-lookup"><span data-stu-id="3fa41-142">A tile that shows this count might have a refresh frequency of 10 minutes.</span></span> <span data-ttu-id="3fa41-143">ただし、以前にコンフィギュレーションされていなかった製品に対するコンフィギュレーションが定義される場合、データ キャッシュを強制更新するよう商品フォームが計測されると、タイル カウントは依然として応答しているように見える場合があります。</span><span class="sxs-lookup"><span data-stu-id="3fa41-143">However, the tile count might still appear responsive if the products form is instrumented to force-refresh the data cache when a configuration is defined for a product that previously had no configuration.</span></span>

## <a name="workspace-lists"></a><span data-ttu-id="3fa41-144">ワークスペース リスト</span><span class="sxs-lookup"><span data-stu-id="3fa41-144">Workspace lists</span></span>
<span data-ttu-id="3fa41-145">フレームワークは自動的にカウント タイルのためのデータ キャッシュを設定しますが、データ キャッシュを使用する必要のあるリストでは手動の設定が必須です。</span><span class="sxs-lookup"><span data-stu-id="3fa41-145">Although the framework automatically sets up data caches for count tiles, manual setup is required for lists that must use data caching.</span></span> <span data-ttu-id="3fa41-146">一覧のキャッシュされたデータを導入するための高レベルの手順を次に示します。</span><span class="sxs-lookup"><span data-stu-id="3fa41-146">Here are the high-level steps for introducing cached data for a list:</span></span>

1.  <span data-ttu-id="3fa41-147">キャッシュされたデータ セットに必要なすべての列を参照するクエリを作成します。</span><span class="sxs-lookup"><span data-stu-id="3fa41-147">Create a query that references all the columns that you want in the cached data set.</span></span>
2.  <span data-ttu-id="3fa41-148">キャッシュするすべてのフィールドを含むテーブルを作成します。</span><span class="sxs-lookup"><span data-stu-id="3fa41-148">Create a table that contains all the fields that you want to cache.</span></span>
3.  <span data-ttu-id="3fa41-149">キャッシュ クエリとキャッシュ テーブルの間のマッピングを定義するクラスを作成します。</span><span class="sxs-lookup"><span data-stu-id="3fa41-149">Create a class that defines a mapping between the cache query and cache table.</span></span>
4.  <span data-ttu-id="3fa41-150">フォームのデータ ソースとしてキャッシュされたテーブルを追加/参照します。</span><span class="sxs-lookup"><span data-stu-id="3fa41-150">Add/reference the cached table as a data source on your form.</span></span>

<span data-ttu-id="3fa41-151">これらの手順はそれぞれ、次のセクションで詳細が説明され、フリート ワークスペース (予約管理) の例と対になります。</span><span class="sxs-lookup"><span data-stu-id="3fa41-151">Each of these steps is described in detail in the following sections and is paired with an example from the Fleet workspace (Reservation Management).</span></span>

### <a name="cache-query"></a><span data-ttu-id="3fa41-152">キャッシュ クエリ</span><span class="sxs-lookup"><span data-stu-id="3fa41-152">Cache query</span></span>

<span data-ttu-id="3fa41-153">最初に、キャッシュ テーブルを設定するために使用するクエリを作成する必要があります。</span><span class="sxs-lookup"><span data-stu-id="3fa41-153">First, you must create a query that will be used to populate the cache table.</span></span> <span data-ttu-id="3fa41-154">このクエリには、次の特性が必要です。</span><span class="sxs-lookup"><span data-stu-id="3fa41-154">This query should have the following characteristics:</span></span>

-   <span data-ttu-id="3fa41-155">これはキャッシュ データを取得するテーブルに対して設定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="3fa41-155">It should be against the tables that you want to get your cache data from.</span></span>
-   <span data-ttu-id="3fa41-156">実際に興味のある結果に結果を制限する必要があります。</span><span class="sxs-lookup"><span data-stu-id="3fa41-156">It should limit the results to the results that you’re actually interested in.</span></span>
-   <span data-ttu-id="3fa41-157">キャッシュするフィールドのみを選択する必要があります。</span><span class="sxs-lookup"><span data-stu-id="3fa41-157">It should select only the fields that you want to cache.</span></span> <span data-ttu-id="3fa41-158">**注記:** 無関係のフィールドを避けるには、各データソースで **DynamicFields**=**いいえ**とする必要があります。</span><span class="sxs-lookup"><span data-stu-id="3fa41-158">**Note:** Each data source should have **DynamicFields**=**No** to avoid extraneous fields.</span></span>

### <a name="cache-table"></a><span data-ttu-id="3fa41-159">キャッシュ テーブル</span><span class="sxs-lookup"><span data-stu-id="3fa41-159">Cache table</span></span>

<span data-ttu-id="3fa41-160">次に、キャッシュ クエリのフィールドと一致するフィールドのセットが含まれるテーブルを定義する必要があります。</span><span class="sxs-lookup"><span data-stu-id="3fa41-160">Next, you must define a table that contains a set of fields that match the fields from the cache query.</span></span> <span data-ttu-id="3fa41-161">これらのフィールドに加えて、**SysDataCacheContextId** (Int64) という名前のフィールドも追加する必要があります。</span><span class="sxs-lookup"><span data-stu-id="3fa41-161">In addition to those fields, you must also add a field that is named **SysDataCacheContextId** (Int64).</span></span> <span data-ttu-id="3fa41-162">このフィールドは、キャッシュ行を基本キャッシュ テーブルにマッピングするために使用されます。</span><span class="sxs-lookup"><span data-stu-id="3fa41-162">This field is used to map the cache row to the base cache tables.</span></span> <span data-ttu-id="3fa41-163">SysDataSetCacheTableMap テーブルの **Id** と **SysDataCacheContextId** フィールド間、およびキャッシュ テーブルの **RecId** と **SysDataCacheContextId** フィールド間のそれぞれのマッピングを、テーブル上で定義します。</span><span class="sxs-lookup"><span data-stu-id="3fa41-163">You'll define a mapping on the table, between the SysDataSetCacheTableMap table’s **Id** and **SysDataCacheContextId** fields and the cache table’s **RecId** and **SysDataCacheContextId** fields, respectively.</span></span> <span data-ttu-id="3fa41-164">また、キャッシュされるフィールドを使用するデータ メソッドに加え、このテーブルと他のテーブル間の関係を定義することができます。</span><span class="sxs-lookup"><span data-stu-id="3fa41-164">You can also define relations between this table and others, in addition to data methods that use the cached fields.</span></span>

### <a name="cache-class"></a><span data-ttu-id="3fa41-165">キャッシュ クラス</span><span class="sxs-lookup"><span data-stu-id="3fa41-165">Cache class</span></span>

<span data-ttu-id="3fa41-166">3 番目のステップは、キャッシュ クエリとキャッシュ テーブルの間のリレーションシップを定義するクラスを作成することです。</span><span class="sxs-lookup"><span data-stu-id="3fa41-166">The third step is to create a class that defines the relationship between the cache query and the cache table.</span></span> <span data-ttu-id="3fa41-167">このクラスでは、いくつかの属性を定義する必要があり、適切なフレームワーク データ キャッシング クラスを拡張して実装する必要があります。</span><span class="sxs-lookup"><span data-stu-id="3fa41-167">This class requires that a few attributes be defined, and it must also extend and implement the appropriate framework data caching classes.</span></span> <span data-ttu-id="3fa41-168">次のコードは、予約管理ワークスペースの対応するクラスを示しています。</span><span class="sxs-lookup"><span data-stu-id="3fa41-168">The following code shows the corresponding class from the Reservation Management workspace.</span></span>

```xpp
[SysDataSetExtension(classStr(FMPickupAndReturn)), // The name of this class
SysDataSetCacheTableExtension(tableStr(FMPickupAndReturnCache))] // The name of the cache table
class FMPickupAndReturn extends SysDataSetQuery implements SysIDataSet
{
    public SysDataCacheRefreshFrequency parmRefreshFrequency()
    {
        return 600; // Cache refresh frequency, in seconds.
    }
    public SysQueryableIdentifier parmQueryableIdentifier()
    {
        return queryStr(FMPickupAndReturnQuery); // The name of the query.
    }
    public SysDataCacheTypeId parmCacheTypeId()
    {
        return tableNum(FMPickupAndReturnCache); // The name of the table.
    }
    public static FMPickupAndReturn construct()
    {
        return new FMPickupAndReturn();
    }
}
```

<span data-ttu-id="3fa41-169">状況によっては、**parmQueryableToCacheMapping()** メソッドを実装しなければならない場合もあります。</span><span class="sxs-lookup"><span data-stu-id="3fa41-169">In some circumstances, you might also have to implement the **parmQueryableToCacheMapping()** method.</span></span> <span data-ttu-id="3fa41-170">このメソッドは、キャッシュ テーブル内の少なくとも 1 つの列名が、バッキング テーブル内の対応する列の名前と一致しない場合に必要です (たとえば、名前は同じですが異なるテーブルの 2 つのフィールドを追加する必要がある場合など)。</span><span class="sxs-lookup"><span data-stu-id="3fa41-170">This method is required when at least one column name in your cache table doesn't match the name of the corresponding column in the backing table (for example, if you must add two fields that have the same name but are from different tables).</span></span> <span data-ttu-id="3fa41-171">この場合、キャッシュ テーブルとバッキング テーブルの間で列マッピングを定義するためにこのメソッドを実装することができます。</span><span class="sxs-lookup"><span data-stu-id="3fa41-171">In this case, you can implement this method to define the column mapping between the cache table and the backing tables.</span></span> <span data-ttu-id="3fa41-172">構文は、**Query::Insert\_RecordSet()** メソッド (<https://msdn.microsoft.com/library/query.insert_recordset.aspx>) の構文と同じです。</span><span class="sxs-lookup"><span data-stu-id="3fa41-172">The syntax is the same as the syntax for the **Query::Insert\_RecordSet()** method (<https://msdn.microsoft.com/library/query.insert_recordset.aspx>).</span></span>

```xpp
public Map parmQueryableToCacheMapping()
{
    Map sourceToTargetMap = super();
    return sourceToTargetMap;
}
```

### <a name="form-implementation"></a><span data-ttu-id="3fa41-173">フォーム実装</span><span class="sxs-lookup"><span data-stu-id="3fa41-173">Form implementation</span></span>

<span data-ttu-id="3fa41-174">キャッシュ クエリ、テーブル、およびクラスを作成した後、フォーム上でキャッシュを使用できるようになります。</span><span class="sxs-lookup"><span data-stu-id="3fa41-174">After you've built your cache query, table, and class, you’re ready to use the cache on your form.</span></span> <span data-ttu-id="3fa41-175">データ ソースとして、フォームにキャッシュ テーブルを追加し、その他のデータ ソースを参照する場合と同様に、それを参照します。</span><span class="sxs-lookup"><span data-stu-id="3fa41-175">Add the cache table to your form as a data source, and reference it just as you would reference any other data source.</span></span> <span data-ttu-id="3fa41-176">フォームが正しくキャッシュを利用するには、いくつかのコードが必要です。</span><span class="sxs-lookup"><span data-stu-id="3fa41-176">In order for the form to correctly take advantage of caching, some code is required.</span></span>

1.  <span data-ttu-id="3fa41-177">**registerDatasourceOnQueryingEvent()** メソッドで、**prepareDataSet** を呼び出すデータ ソースの **OnQueryExecuting** イベントにイベント ハンドラーを追加します。</span><span class="sxs-lookup"><span data-stu-id="3fa41-177">In a **registerDatasourceOnQueryingEvent()** method, add an event handler to the data source’s **OnQueryExecuting** event that calls **prepareDataSet**,.</span></span> <span data-ttu-id="3fa41-178">これには、フォーム クラスが **SysIDataSetConsumerForm** を実装する必要があります。</span><span class="sxs-lookup"><span data-stu-id="3fa41-178">This requires that the form class implement **SysIDataSetConsumerForm**.</span></span>
2.  <span data-ttu-id="3fa41-179">**registerDatasourceOnQueryingEvent()** メソッドで、フォームでフィルタリングを使用するようにするには、**OnQueryExecuting** イベントで **applyFilter** を登録します。</span><span class="sxs-lookup"><span data-stu-id="3fa41-179">If you want the form to use filtering, as provided by a workspace-wide filter, in a **registerDatasourceOnQueryingEvent()** method, register **applyFilter** on the **OnQueryExecuting** event.</span></span> <span data-ttu-id="3fa41-180">これには、フォーム クラスが **SysIFilterConsumerForm** を実装する必要があります。</span><span class="sxs-lookup"><span data-stu-id="3fa41-180">This requires that the form class implement **SysIFilterConsumerForm**.</span></span>
3.  <span data-ttu-id="3fa41-181">フォームが、親フォームのフィルター (例えば、ワークスペース全体のフィルター) の変更時に対応する必要がある場合、**SysIFilterEventHandler** をフォーム クラスに含め、キャッシュ データ ソースで **executeQuery()** メソッドを呼び出す **onFilterChanged()** を含めます。</span><span class="sxs-lookup"><span data-stu-id="3fa41-181">If the form must react when a parent form’s filters change (for example, a workspace-wide filter), implement **SysIFilterEventHandler** on the form class, and include an **onFilterChanged()** method that calls **executeQuery()** on the cache data source.</span></span>

<span data-ttu-id="3fa41-182">次のコードは、**FMPickingUpTodayPart** フォームの例です。これは、予約管理ワークスペースのタブ付きリストの1つです。</span><span class="sxs-lookup"><span data-stu-id="3fa41-182">The following code is an example from the **FMPickingUpTodayPart** form, which is one of the tabbed lists on the Reservation Management workspace.</span></span>

```xpp
[Form]public class FMPickingUpTodayPart extends FormRun
implements SysIFilterConsumerForm, SysIDataSetConsumerForm, SysIFilterEventHandler
{
    public void registerDatasourceOnQueryingEvent()
    {    
        FMPickupAndReturnCache_DS.OnQueryExecuting += eventhandler(this.parmDataSetFormQueryEventHandler().prepareDataSet);    
        FMPickupAndReturnCache_DS.OnQueryExecuting +=eventhandler(this.parmFilterFormQueryEventHandler().applyFilter);    
    }
    public void onFilterChanged()
    {    
        FMPickupAndReturnCache_DS.executeQuery();    
    }    
}
```

### <a name="additional-examples"></a><span data-ttu-id="3fa41-183">追加の例</span><span class="sxs-lookup"><span data-stu-id="3fa41-183">Additional examples</span></span>

<span data-ttu-id="3fa41-184">前の例に加えて、**SysFoundationTestOpenHeaderDataset** を参照でき、これは **SysFoundationTestOpenHeadersFormPart** (**SysFoundationTestWorkspace** で参照されているそのもの) で使用されます。</span><span class="sxs-lookup"><span data-stu-id="3fa41-184">In addition to the previous examples, you can refer to **SysFoundationTestOpenHeaderDataset**, which is used on **SysFoundationTestOpenHeadersFormPart** (which is itself referenced in **SysFoundationTestWorkspace**).</span></span> <span data-ttu-id="3fa41-185">このフォームは、前述の同じメソッドを使用しますが、クエリ集計カウントのキャッシュも含まれています。</span><span class="sxs-lookup"><span data-stu-id="3fa41-185">This form uses the same method that is described earlier, but also includes some caching of a query aggregate count.</span></span>

### <a name="refresh-management"></a><span data-ttu-id="3fa41-186">更新管理</span><span class="sxs-lookup"><span data-stu-id="3fa41-186">Refresh management</span></span>

<span data-ttu-id="3fa41-187">ワークスペース内のデータのリストは、特にユーザー アクションによってレコードがリストで表示する基準を満たさなくなった場合に、ユーザー アクションに対して応答する必要もあります。</span><span class="sxs-lookup"><span data-stu-id="3fa41-187">Lists of data in workspaces should also be responsive to user actions, especially if those actions cause records to no longer meet the criteria for appearing in the list.</span></span> <span data-ttu-id="3fa41-188">たとえば、今日開始予定のレンタカーの一覧があります。</span><span class="sxs-lookup"><span data-stu-id="3fa41-188">For example, you have a list of car rentals that are scheduled to start today.</span></span> <span data-ttu-id="3fa41-189">従業員が顧客と一緒にそのリストからレンタル・レコードを開始するたびに、そのレコードはワークスペース・リストに表示されなくなります。</span><span class="sxs-lookup"><span data-stu-id="3fa41-189">Every time that an employee initiates a rental record from that list with a customer, that record should no longer appear in the workspace list.</span></span> <span data-ttu-id="3fa41-190">この一覧を最新の状態に保つために、2 つのメカニズムが利用できます。</span><span class="sxs-lookup"><span data-stu-id="3fa41-190">Two mechanisms are available for keeping this list up to date:</span></span>

-   <span data-ttu-id="3fa41-191">ユーザーが、一覧からレコードを削除するアクションをとると、データ ソースを更新することで、リストが直ちに更新されることを保証するコードを追加できます。</span><span class="sxs-lookup"><span data-stu-id="3fa41-191">If the user takes an action that removes the record from the list, code can be added to guarantee that the list is immediately updated by refreshing the data source.</span></span> <span data-ttu-id="3fa41-192">データ ソースがキャッシュのデータ ソースであり、更新の頻度が遅い場合は、**更新**を呼び出す前に、キャッシュ データ ソースから対応するレコードを削除すれば、キャッシュを強制的にリフレッシュする必要がなくなります。</span><span class="sxs-lookup"><span data-stu-id="3fa41-192">If the data source is a cache data source, and the refresh frequency is slow, you might want to delete the corresponding records from the cache data source before you call **refresh**, to avoid having to force-refresh the cache.</span></span>
-   <span data-ttu-id="3fa41-193">最初のオプションが要件を満たしていない場合は、時間間隔でフォーム パーツを非同期で更新できます。</span><span class="sxs-lookup"><span data-stu-id="3fa41-193">If the first option doesn't meet your requirements, you can asynchronously refresh form parts at a time interval.</span></span> <span data-ttu-id="3fa41-194">このオプションは、FormPart コントロールの **AutoRefreshInterval** プロパティを使用して設定できます。</span><span class="sxs-lookup"><span data-stu-id="3fa41-194">This option can be set up by using the **AutoRefreshInterval** property on the FormPart control.</span></span>
    -   <span data-ttu-id="3fa41-195">ユーザー操作のあるワークスペースについては、キャッシュの更新頻度をクエリ パフォーマンスに基づいて設定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="3fa41-195">For workspaces that have user interaction, the cache refresh frequency should be set based on query performance.</span></span> <span data-ttu-id="3fa41-196">この場合、現在の推奨は **AutoRefreshInterval** を設定しないことです。</span><span class="sxs-lookup"><span data-stu-id="3fa41-196">In this case, the current recommendation is to not set the **AutoRefreshInterval**.</span></span> <span data-ttu-id="3fa41-197">代わりに、ユーザーに依存してより多くのデータをもたらすためにワークスペースを手動で更新します。</span><span class="sxs-lookup"><span data-stu-id="3fa41-197">Instead, rely on the user to manually refresh the workspace to bring in more data.</span></span> <span data-ttu-id="3fa41-198">または、頻度の低い自動更新の使用を考慮します。</span><span class="sxs-lookup"><span data-stu-id="3fa41-198">Alternatively, you consider using an infrequent auto-refresh.</span></span> <span data-ttu-id="3fa41-199">ただし、この場合は、ユーザーがやり取りしている間にリストが更新される場合、ユーザーの現在の選択内容は保持されません。</span><span class="sxs-lookup"><span data-stu-id="3fa41-199">However, in this case, the user’s current selection will not be retained if the list is updated while the user is interacting with it.</span></span>
    -   <span data-ttu-id="3fa41-200">ワークスペースの小さなパーセンテージは、表示のみを目的としています (ユーザーの操作なし)。</span><span class="sxs-lookup"><span data-stu-id="3fa41-200">A small percentage of workspaces are intended for viewing purposes only (no user interaction).</span></span> <span data-ttu-id="3fa41-201">これらのワークスペースでは、**AutoRefreshInterval** プロパティをプログラムで設定して、バックアップ キャッシュの現在の更新頻度を一致させる必要があります。</span><span class="sxs-lookup"><span data-stu-id="3fa41-201">These workspaces should use set the **AutoRefreshInterval** property programmatically to match the current refresh frequency of the backing cache.</span></span> <span data-ttu-id="3fa41-202">(実行時にシステム管理者によって変更できるため、**SysIDataCacheConfiguration.parmRefreshFrequency()** を使用してキャッシュの現在の更新頻度を取得します。)</span><span class="sxs-lookup"><span data-stu-id="3fa41-202">(Use **SysIDataCacheConfiguration.parmRefreshFrequency()** to retrieve the current refresh frequency of a cache, because it can be modified by the system administrator at run time.)</span></span>
    -   <span data-ttu-id="3fa41-203">グラフがある FormParts は **AutoRefreshInterval** プロパティを設定し、定期的に更新されたグラフ データをを表示する必要があります。</span><span class="sxs-lookup"><span data-stu-id="3fa41-203">FormParts that have Charts should set the **AutoRefreshInterval** property to periodically show updated chart data.</span></span>

## <a name="common-mistakes-and-tips-for-query-optimization"></a><span data-ttu-id="3fa41-204">クエリの最適化に関するよくある間違いやヒント</span><span class="sxs-lookup"><span data-stu-id="3fa41-204">Common mistakes and tips for query optimization</span></span>
<span data-ttu-id="3fa41-205">クエリを最適化するときに考慮するいくつかの一般的なガイドラインを次に示します。</span><span class="sxs-lookup"><span data-stu-id="3fa41-205">Here a few general guidelines to consider when you optimize queries.</span></span> <span data-ttu-id="3fa41-206">これは、クエリ最適化の広範なガイドではありませんが、いくつかの簡単なガイドラインを示しています。</span><span class="sxs-lookup"><span data-stu-id="3fa41-206">This isn't an extensive guide to query optimization but provides just a few simple guiding principles.</span></span>

-   <span data-ttu-id="3fa41-207">**SQL プロファイラーを使用して、明細書を追跡してください。**</span><span class="sxs-lookup"><span data-stu-id="3fa41-207">**Trace the statement by using SQL Profiler.**</span></span> <span data-ttu-id="3fa41-208">Microsoft SQL Server プロファイラーをデータ ベースに接続し、最適化する SQL ステートメントをキャプチャします。</span><span class="sxs-lookup"><span data-stu-id="3fa41-208">Attach the Microsoft SQL Server Profiler to the database, and capture the SQL statement that you want to optimize.</span></span> <span data-ttu-id="3fa41-209">既定のインストールで提供されている調整テンプレートを使用することができます。</span><span class="sxs-lookup"><span data-stu-id="3fa41-209">You can use the tuning template that is provided in a default installation.</span></span> <span data-ttu-id="3fa41-210">興味のある明細書を入手した際は、トレースを無効にすることを忘れないでください。</span><span class="sxs-lookup"><span data-stu-id="3fa41-210">Don’t forget to disable tracing after you've obtained the statement that you're interested in.</span></span> <span data-ttu-id="3fa41-211">詳細については、「<https://msdn.microsoft.com/library/ms175047.aspx>」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="3fa41-211">For more information, see <https://msdn.microsoft.com/library/ms175047.aspx>.</span></span>
-   <span data-ttu-id="3fa41-212">**クエリ計画を常に確認します。**</span><span class="sxs-lookup"><span data-stu-id="3fa41-212">**Always look at the query plan.**</span></span> <span data-ttu-id="3fa41-213">Microsoft SQL Server Management Studio で、**実際の実行計画を含む**を有効にしたことを確認します。</span><span class="sxs-lookup"><span data-stu-id="3fa41-213">In Microsoft SQL Server Management Studio, make sure that you've enabled **Include actual Execution Plan**.</span></span> <span data-ttu-id="3fa41-214">クエリ プランを確認し、警告に注意します。</span><span class="sxs-lookup"><span data-stu-id="3fa41-214">Look at the query plan, and watch out for any warnings.</span></span> <span data-ttu-id="3fa41-215">矢印の太さは、フェッチされて次のステップに移動された行の数を示します。</span><span class="sxs-lookup"><span data-stu-id="3fa41-215">The thickness of the arrows indicate how many rows have been fetched and brought to the next step.</span></span>
-   <span data-ttu-id="3fa41-216">**CPU のミリ秒と論理 I/O を比較します。**</span><span class="sxs-lookup"><span data-stu-id="3fa41-216">**Compare CPU milliseconds and logical I/O.**</span></span> <span data-ttu-id="3fa41-217">特定の SQL ステートメントへの変更が、ステートメントを改善したかどうかを決定する良い方法の 1 つは、論理 I/O と CPU のミリ秒を確認することです。</span><span class="sxs-lookup"><span data-stu-id="3fa41-217">One good way to determine whether a change to a given SQL statement improved the statement is to look at the logical I/O and CPU milliseconds.</span></span> <span data-ttu-id="3fa41-218">これらの数値を取得するには、クエリ エディターで次のステートメントを使用します。</span><span class="sxs-lookup"><span data-stu-id="3fa41-218">To obtain these numbers, use the following statements in the query editor:</span></span>
    -   <span data-ttu-id="3fa41-219">set statistics time on</span><span class="sxs-lookup"><span data-stu-id="3fa41-219">set statistics time on</span></span>
    -   <span data-ttu-id="3fa41-220">set statistics io on</span><span class="sxs-lookup"><span data-stu-id="3fa41-220">set statistics io on</span></span>
-   <span data-ttu-id="3fa41-221">**明細書を測定するときは、常にキャッシュをクリアします。**</span><span class="sxs-lookup"><span data-stu-id="3fa41-221">**Always clear caches when you measure a statement.**</span></span> <span data-ttu-id="3fa41-222">Microsoft SQL Server がキャッシュされた実行計画を使用していないことを確認するには、命令文を再実行するときにキャッシュをフラッシュすることをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="3fa41-222">To make sure that Microsoft SQL Server isn't using a cached execution plan, it's advisable that you flush the cache when you rerun a statement.</span></span> <span data-ttu-id="3fa41-223">キャッシュをフラッシュするには、次の 2 つのコマンドを実行します。</span><span class="sxs-lookup"><span data-stu-id="3fa41-223">To flush the cache, run the following two commands:</span></span>
    -   <span data-ttu-id="3fa41-224">dbcc dropCleanBuffers</span><span class="sxs-lookup"><span data-stu-id="3fa41-224">dbcc dropCleanBuffers</span></span>
    -   <span data-ttu-id="3fa41-225">dbcc freeProcCache</span><span class="sxs-lookup"><span data-stu-id="3fa41-225">dbcc freeProcCache</span></span>
-   <span data-ttu-id="3fa41-226">**注意すべきいくつかの一般的なパターンを次に示します。**</span><span class="sxs-lookup"><span data-stu-id="3fa41-226">**Here are some common patterns to watch out for:**</span></span>
    -   <span data-ttu-id="3fa41-227">**インデックスがありません:** WHERE 条件を分析して、選択したインデックスが存在するかどうかを確認します。</span><span class="sxs-lookup"><span data-stu-id="3fa41-227">**Missing index:** Analyze your WHERE conditions, and make sure that a selective index exists.</span></span>
    -   <span data-ttu-id="3fa41-228">**同じテーブル/行の多数の処理:** 特に結合するときは、繰り返しをしないでください。</span><span class="sxs-lookup"><span data-stu-id="3fa41-228">**Processing the same table/row many times:** Especially when you do joins, try not to repeat yourself.</span></span> <span data-ttu-id="3fa41-229">同じテーブル/行を処理する必要がある回数を最小化します。</span><span class="sxs-lookup"><span data-stu-id="3fa41-229">Minimize the number of times that the same table/row must be processed.</span></span> <span data-ttu-id="3fa41-230">結果セットの一部であるはずのテーブルがあり、結果セットを絞り込むために使用されていない場合は、(特にユニオン クエリーでは) それらを可能な限り遠くに移動します。</span><span class="sxs-lookup"><span data-stu-id="3fa41-230">If you have tables that must be part of the result set but aren't used to narrow down the result set, move them as far out as possible (especially in union queries).</span></span>
-   <span data-ttu-id="3fa41-231">**データの量をテスト。**</span><span class="sxs-lookup"><span data-stu-id="3fa41-231">**Test on volume data.**</span></span> <span data-ttu-id="3fa41-232">クエリの問題を特定するには、常にボリューム データに対して実行します。</span><span class="sxs-lookup"><span data-stu-id="3fa41-232">To identify issues in your query, always run it on volume data.</span></span>




