---
title: Azure Data Lake へのエクスポートの構成
description: このトピックでは、Azure Data Lake へのエクスポートの構成に関する情報を説明します。
author: MilindaV2
manager: AnnBe
ms.date: 05/26/2020
ms.topic: article
ms.prod: ''
ms.service: dynamics-ax-platform
ms.technology: ''
audience: Developer, IT Pro
ms.reviewer: kfend
ms.search.scope: Operations
ms.custom: 96283
ms.assetid: ''
ms.search.region: Global
ms.author: milindav
ms.search.validFrom: 2020-03-03
ms.dyn365.ops.version: Platform Update 33
ms.openlocfilehash: 236efdffa0786f4fc983a0d3a2c8a1377592a067
ms.sourcegitcommit: a5009c8958037afbaa1dd4f1469255b187ced93a
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 06/15/2020
ms.locfileid: "3454999"
---
# <a name="configure-export-to-azure-data-lake"></a>Azure Data Lake へのエクスポートの構成

[!include [banner](../includes/banner.md)]

> [!NOTE]
> **Azure Data Lake へのエクスポート**機能は、Microsoft Dynamics 365 Finance and Operations アプリで対応しているすべての地域および環境では使用できない場合があります。 Life cycle services (LCS)、または Finance and Operations アプリで **Azure Data Lake へのエクスポート**の機能が見つからない場合は、ご利用の環境でこの機能を使用できません。 この機能へのアクセスを許可する場合は、機能担当チームにメールでお問い合わせください (**FnODataLakePreview@service.microsoft.com**)。 この機能をご利用頂けるよう、迅速に対応します。 現時点では、 **Azure Data Lake へのエクスポート**機能は、Tier 1 (開発者) 環境では使用できません。 この機能を有効化するには、クラウドベースの Tier 2 またはそれ以上の環境が必要です。
> Data Lakeで集計測定を使用できるようにするには、[エンティティ ストアを Data Lake として使用可能にする](entity-store-data-lake.md) に記載されている方法に従ってこの機能を引き続き使用してください。

Data Lake へのエクスポートを構成するには、ご利用の Azure サブスクリプションにストレージ アカウントを作成する必要があります。 このストレージ アカウントはデータの格納に使用されます。 続いて、ストレージ アカウントのルートへのアクセスを許可するAzure Active Directory (Azure AD) のアプリケーション ID を作成する必要があります。 Dynamics 365 Finance 、または Operations app は、Azure AD アプリケーションを使用してストレージへのアクセスや、フォルダ構造の作成や、データの書き込みを行います。 サブスクリプションにキー コンテナーを作成し、ストレージ アカウントの名前、アプリケーション ID、アプリケーションのシークレットを保存します。 Azure portal でリソースを作成するアクセス許可がない場合は、組織内でこのアクセス許可を持つユーザーの支援が必要となります。

Azure portal で行われる手順は次のとおりです。 

1. [サブスクリプションに Data Lake ストレージ (Gen2 アカウント) を作成します](#createsubscription)
2. [キー コンテナーとストレージ アカウントを含むシークレットの作成](#createkeyvault)
3. [Azure Active Directory でアプリケーションを作成する](#createapplication) 
4. [キー コンテナーにシークレットを追加する](#addsecrets)
5. [キー コンテナーのシークレットを読み取るためにアプリケーションを許可する](#authorize)
6. [アプリケーションにアクセス制御ロールを付与する](#grantaccess)

    > [!NOTE]
    > Azure portal で作業する場合は、後続の手順に対して複数の値を保存するように指示されます。 また、これらの値の一部は、Lifecycle Services (LCS) を使用して Finance and Operations アプリに提供されます。 これを行うには、LCS への管理者アクセス権が必要です。

7. [LCS の Data Lake アドインへのエクスポートのインストール](#installaddin)

## <a name="create-a-data-lake-storage-gen2-account-in-your-subscription"></a><a name="createsubscription"></a>サブスクリプションに Data Lake ストレージ（Gen2）を作成します

Data Lake ストレージ アカウントは、Finance and Operations アプリのデータを格納する目的で使用されます。 ストレージ アカウントを手動で作成するには、Azure サブスクリプションへの管理者権限を持つユーザーである必要があります。 ストレージ アカウントを作成するには、次の手順を完了してください。

1. Azure portalで、**新しいリソースの作成** を選択し、**ストレージアカウント (blob、ファイル、テーブル、キュー)** を検索して選択し ます。
2. **ストレージ アカウントを作成** ダイアログ ボックスで、次のパラメーター フィールドの値を指定します。

    - **場所:** 環境があるデータ センターを選択します。 選択したデータ センターが異なる Azure リージョンにある場合は、データ移動コストが発生する場合があります。 Microsoft Power BI やデータ ウェアハウスが別の地域にある場合は、地域間でのストレージ移動にはレプリケーションを使用することができます。
    - **パフォーマンス**: **標準**を選択することを推奨します。
    - **アカウントの種類**: 必ず**Storage V2** を選択してください。 **詳細オプション** ダイアログ ボックスに、**Data Lake ストレージ Gen2** オプションが表示されます。

3. **詳細タブ**で、 **Data Lake storage Gen2** \> **階層の名前空間** を選択し、**有効化** を選択し ます。 このオプションを無効にすると、Power BI データフローや AI Builder などのサービスを使用して Finance and Operations アプリが書き込んだデータを使用できなくなる場合があります。
4. **確認して作成** を選択します。 デプロイの完了後は、新たなリソースが Azure ポータルに表示されます。
5. 作成したストレージ アカウントから、次の情報をコピーして保持します。

    i. Azure portal で、作成したストレージ アカウントを選択します。 ストレージ<a name="storageaccount"></a>アカウント名をコピーして保存し ます。
    
    ii. 左のナビゲーション ウィンドウで、**設定**\>**アクセスキー** を選択し、キー 1 またはキー 2 から**接続文字列**をコピーします。
        

## <a name="create-a-key-vault-and-a-secret-that-contains-the-storage-account"></a>キー コンテナーとストレージ<a name="createkeyvault"></a>アカウントを含むシークレットの作成

キーボルトは、ストレージ アカウント名などの詳細情報を Finance and Operations アプリに共有する安全な手段です 。 キー コンテナーとシークレットを作成するには、次の手順を完了してください。

1. Azure portalで、**新しいリソースの作成** を選択し、**キー コンテナー** を検索して選択し ます。
2.  **場所** フィールドの、 **キー コンテナー** ダイアログ ボックスで、環境が存在するデータ センターを選択します。
3. キー コンテナーの作成後は、一覧から選択し、左側のナビゲーション ウィンドウで **概要** を選択します。 
4. <a name="dnsname"></a>**DNS名**フィールドに値を保存します。 後に、この値を使用します。
5. 左のナビゲーション ウィンドウで、 **ソークレット** > **生成/インポート**を選択します。
6.  **シークレットを作成する** ダイアログ ボックスの  **アップロード オプション** フィールドで、 **手動** を選択します。
7. シークレットの名前を入力します (例 : **storage-account-name**) 。 この名前は後述の手順で使用するたま、名前をメモしておいてください。
8. **値**フィールドに、前述の手順でで取得したストレージ アカウント名を入力します。
9.  **有効化** を選択し、 **作成**を選択します。 シークレットが作成され、キー コンテナーに追加されます。

## <a name="create-an-application-in-azure-active-directory"></a><a name="createapplication"></a>Azure Active Directory でアプリケーションを作成する

1. Azure ポータルで、 **Azure Active Directory** を選択し、 **アプリケーションの登録**を選択します。
2.  **新しいアプリケーションの登録** を選択し、以下の情報を入力します。 

    -  **名前 :** アプリの名前を入力します。
    -   **対応しているアカウントのタイプ** : 適切なオプションを選択します。

3. アプリケーションの作成後は、これを選択し、<a name="appid"></a>アプリケーション (クライアント) IDをページの先頭に保存します。 これは後で必要になります。
4. 左のナビゲーション ウィンドウで、**API のアクセス許可**を選択します。
5. **アクセス許可の追加** を選択し、**API アクセス許可の要求** ダイアログ ボックスで、**Azure キー コンテナー** を選択し ます。
6. **委任されたアクセス許可** を選択し 、**user_impersonation** を選択します。続いて**アクセス許可の追加**を選択します。
7. 左のナビゲーションウィンドウで、**証明書とシークレット** を選択し、 **新たなクライアント シークレット** を選択します。 
8. **説明**フィールドに名前を入力します。
9. **有効期限** フィールドで、オプションを選択し、**追加** を選択します。 システムがシークレットを生成します。 表示されるシークレットは、1 - 2 分で削除されるため、シークレットを迅速にコピーしてください。 <a name="secret"></a>後でキー コンテナーを設定する際に、このシークレットの値を入力する必要があります。

## <a name="add-secrets-to-the-key-vault"></a><a name="addsecrets"></a>キー コンテナーにシークレットを追加する

キーコンテナーに3つのシークレットを作成し、前述の手順で保存した値を追加します。 それぞれのシークレットに対して、前述の手順で保存したシークレット名を入力し、値を入力する必要があります。

| <a name="suggest"></a>**推奨されるシークレット名** | **シークレット値 (前述の手順で保存した値)**                                |
|---------------------------|---------------------------------------------------------------------------|
| アプリ ID                    | [作成済みの](#appid)アプリケーション オブジェクトの ID。                             |
| アプリのシークレット                | 前述の手順で入力した[クライアント シークレット](#secret)です。                                 |
| storage-account-name      | 上記手順で作成した[ストレージアカウントの名前](#storageaccount)です。 |

それぞれのシークレットごとに 1 回ずつ、以下の手順を 3 回実行する必要があります。

1. Azure portalで、上記手順で作成したキー コンテナーに移動し、左側のナビゲーション ウィンドウで **シークレット** を選択し ます。
2. **生成/インポート**を選択し、**シークレットの作成**ダイアログ ボックスの、 **アップロード オプション** フィールドで**手動**を選択します。
3. シークレットの名前を入力します。 このセクション冒頭の「推奨される名前」の表を参照してください。
4. **値**フィールドに、対応するシークレットの値をコピーして貼り付け ます。
6. **有効** を選択し、**作成**を選択します。 

シークレットの一覧に作成されたシークレットが表示されます。

## <a name="authorize-the-application-to-read-secrets-in-the-key-vault"></a><a name="authorize"></a>キー コンテナーのシークレットを読み取るためにアプリケーションを許可する

1. **Azure ポータルl**で、作成済のキー コンテナーを開きます。
2. 左の [ナビゲート] ページで、**アクセス ポリシー > 新規ポリシーの追加** を選択して、新規ポリシーを作成します。 
3. **アクセスポリシーの追加**  ダイアログの **プリンシパルの選択** フィールドで、前の手順で作成した [アプリケーションの名前](#appid)を検索します。
4. プリンシパルの一覧でアプリケーションを見つけたら、このアプリケーションを選択し、**選択** をクリックします。
5. **キーのアクセス許可**と**シークレットのアクセス許可** フィールドで、**取得** と **リスト**を選択します。  
6. **アクセスポリシーの追加** ダイアログ ボックスで、**追加**を選択します。
7. 左のナビゲート ウィンドウ、**アクセス ポリシー > 新規ポリシーの追加** を選択して、新規ポリシーを作成します。 
8. **アクセスポリシーの追加** ダイアログの **プリンシパルの選択** フィールドで、**Microsoft Dynamics ERP マイクロサービス**を検索して選択し、**選択** をクリックします。 

> [!NOTE]
> **Microsoft Dynamics ERP マイクロサービス**が見つからない場合は、このドキュメントの後半の[トラブルシューティング セクション](#troubleshooting)を参照してください。

9. **キーのアクセス許可**と**シークレットのアクセス許可** フィールドで、**取得** と **リスト**を選択します。  
10. **アクセスポリシー** ダイアログ ボックスで、**追加**を選択します。

以下のように、キー コンテナーへのアクセス権を持つ2つのアプリケーションが表示されます。

| 応募                                                   | キーのアクセス許可 | シークレットのアクセス許可 |
|---------------------------------------------------------------|-----------------|--------------------|
| 作成した[新しいアプリケーション](#appid)の表示名  | 取得、リスト表示       | 取得、リスト表示          |
| Microsoft Dynamics ERP マイクロサービス                          | 取得、リスト表示       | 取得、リスト表示          |

11.  **保存** を選択します。

## <a name="grant-access-control-roles-to-applications"></a><a name="grantaccess"></a>アプリケーションにアクセス制御ロールを付与する 

アプリケーションにストレージ アカウントの読み取り、書き込みのアクセス許可を付与する必要があります。 これらのアクセス許可は、Azure AD のロールを使用して付与されます。

1. **Azure ポータルl**で、作成済のストレージ アカウントを開きます。
2. 左側のナビゲーション ウィンドウで、**アクセス制御 (IAM)** を選択します。 
3. **アクセス制御** ページで、**ロールの割り当て** タブを選択します。
4. ページの上部の**追加** を選択し、**ロール割り当ての追加** を選択します。
5. **ロール割り当ての追加**ダイアログで、**ロール** フィールドを選択し、**所有者** を選択します。

> [!NOTE]
> フィールド対する変更、**Azure AD ユーザー、グループ、サービス プリンシパル**への**アクセス権の割り当て**は行わないでください。

6. **選択**フィールドで、前述の手順で登録したアプリケーションを選択します。
7. **保存** を選択します
8. 手順 4-7 を繰り返して、以下の表に記載した残りのロールを追加します。

|   選択するアプリケーション     |     割り当てられるロール     |
|----------------------------------|-----------------------------|
| 既に作成した[アプリケーション](#appid) | 所有者                       |
| 既に作成した[アプリケーション](#appid) | 貢献者                 |
| 既に作成した[アプリケーション](#appid) | ストレージ アカウントの共同作成者 |
| 既に作成した[アプリケーション](#appid) | ストレージ BLOB データの所有者     |
| AI Builder の承認サービス | ストレージ BLOB データの読み取り権限を持つユーザー    |

## <a name="install-the-export-to-data-lake-add-in-in-lcs"></a><a name="installaddin"></a>LCS の Data Lake アドインへにエクスポート機能をインストールする 

Finance and Operations アプリから Data Lake にデータをエクスポートするには、LCS の **Data Lake エクスポートする**アドインをインストールする必要があり ます。 このタスクを完了するには、使用する環境の LCS 環境管理者である必要があります。

これを開始する前に、次の情報を確認する必要があります。 作業の開始前に、情報を手元に保管しておいてください。

| **Data lake アドインへのエクスポートに必要な情報**   | **どこにあるか**                                                                                                                                                                                                |
|-----------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| ご利用の Azure AD テナント ID                            | Azure AD テナント ID は Azure ポータルで確認できます。 **Azure ポータル** にログインし、**Azure Active Directory**  サービスを開きます。 **プロパティ** ページを開き、**ディレクトリ ID** フィールドの値をコピーします。 |
| キー コンテナーの DNS 名                                | この名前は、あらかじめ保存しておく必要があります。 キー コンテナーの [DNS 名](#dnsname) を入力します                                                                                                               |
| ストレージ アカウントの名前を含むシークレット |  提示された名前を使用した場合は、**storage-account-name**を入力します。 これを使用していない場合は、定義した[シークレット名](#suggest)を入力します。                                                                                                                                                                                                                         |
| アプリケーション ID を含むシークレット                   |  定時された名前を使用した場合は、**app id** を入力してください。これを使用していない場合は、定義した[シークレット名](#suggest)を入力します。                                                                                       |
| アプリケーションのシークレットを含むシークレット               |  提示された名前を使用した場合は、**app-secret**を入力します。 これを使用していない場合は、定義した[シークレット名](#suggest)を入力します。                                                                                             |

1.  [LCS](https://lcs.dynamics.com) にログインし、ご利用の環境に移動します。
2.  **環境**ページで、**環境アドイン**タブを選択します。**Data lakeの エクスポート**が一覧に表示される場合は、Data Lake アドインが既にインストールされているため、この手順の残りの部分は省略することができます。 これに該当しない場合は、残りの手順を実行してください。
3.  **インストールするアドイン**を選択し、ダイアログ ボックスで、一覧から **Data lake にエクスポート** を選択します。 **Data lake にエクスポート** が表示されない場合は、この機能がご利用の環境で使用できない可能性があります。
4.  **設定のアドイン** ダイアログ ボックスで、必要な情報を入力します。 質問に答えるには、既にストレージ アカウントが作成されている必要があります。 ストレージ アカウントをまだ持っていない場合は、作成するか、管理者にアカウントの作成代行を依頼してください。
5.  チェック ボックスをオンにしてサービス条件を承認し、**インストール** を選択します。

システムが、ご利用の環境に Data Lake をインストールし構成します。 インストールと構成が完了すると、 **環境** のページに **Azure Data Lake** の一覧が表示されます。

## <a name="troubleshooting-tips"></a><a name="troubleshooting"></a>ヒントのトラブルシューティング

### <a name="cant-find-microsoft-dynamics-erp-microservices-or-ai-builder-authorization-service"></a>Microsoft Dynamics ERP マイクロサービス、または AI Builder の承認サービスが見つかりません

これらの手順を実行するには、**Azure Active Directory テナント管理者**の権限が必要です。

1. Azure portal を起動し、Azure Active Directory にアクセスします。
2. 左のメニューバーで、**管理** \> **エンタープライズ アプリケーション** を選択し、以下のアプリケーションを検索します。

| **アプリケーション**                          | **アプリ ID**                           |
|------------------------------------------|--------------------------------------|
| Microsoft Dynamics ERP マイクロサービス     | 0cdb527f-a8d1-4bf8-9436-b352c68682b2 |
| Microsoft Dynamics ERP マイクロサービス CDS | 703e2651-d3fc-48f5-942c-74274233dba8 |
| AI Builder の承認サービス         | ad40333e-9910-4b61-b281-e3aeeb8c3ef3 |


上記のアプリケーションが見つからない場合は、手順 3-7 を完了してください。

3. ローカルマシンで、[スタート] メニューを開き、 **PowerShell** を検索します。
4. **Windows PowerShell** を右クリックし、**管理者として実行** を選択します。
5. 以下のコマンドを実行して **AzureAD** モジュールをインストールします。

     >   *Install-Module -Name AzureAD*

  - NuGet プロバイダーを続行する必要がある場合は、**Y** を選択してインストールします。
  - **信頼できないリポジトリ**のメッセージが表示された場合は、**Y** を選択して続行します。

6. 追加の必要がある各アプリケーションについては、以下のコマンドを実行してアプリケーションを Azure Active Directory に追加します。

    > Connect-AzureAD New-AzureADServicePrincipal –AppId \<AppId\>

7. メッセージが表示されたら、管理者で Azure Active Directory にログインします。
