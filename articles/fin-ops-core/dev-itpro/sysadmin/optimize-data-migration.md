---
title: Finance and Operations アプリのデータ移行の最適化
description: このトピックでは、Finance and Operations アプリのデータ移行を最適化するために使用できる手順とアクションの概要を示します。
author: skaue-ms
ms.date: 04/22/2021
ms.topic: article
ms.prod: ''
ms.technology: ''
audience: IT Pro
ms.reviewer: sericks
ms.search.region: Global
ms.author: toskaue
ms.search.validFrom: 2021-01-31
ms.dyn365.ops.version: 10.0.13
ms.openlocfilehash: ef4cfb21ac8758451a980b8c75b00f35483a394acc7ec4ebaabcc5d6707c4e1d
ms.sourcegitcommit: 42fe9790ddf0bdad911544deaa82123a396712fb
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/05/2021
ms.locfileid: "6766353"
---
# <a name="optimize-data-migration-for-finance-and-operations-apps"></a>Finance and Operations アプリのデータ移行の最適化

[!include [banner](../includes/banner.md)]

データ移行は、ほとんどすべての実装で重要な成功要因です。 一部の顧客の主な関心事項は、特に大量のデータと小さな切替ウィンドウがある場合の、データ移行の速度です。 [データ移行フレームワーク](../data-entities/data-entities-data-packages.md) は、業務要件や操作の一部としてデータを移動するためにも使用されます。

このトピックの情報は、データ移行のパフォーマンスを最適化するために使用できる一連のステップとアクションを表します。

> [!NOTE]
> レベル 1 環境でのテスト結果を、レベル 2 以上のサンドボックス環境のパフォーマンスと比較または推定しないでください。

すべての標準エンティティがデータ移行用に最適化されているわけではありません。 一部のエンティティは、Open Data Protocol (OData) との統合に対して最適化されています。また、必要なエンティティをパフォーマンス要件を満たすように最適化できない場合は、[新しい最適化されたエンティティを作成](../data-entities/build-consuming-data-entities.md) することをお勧めします。 開発者は、既存のエンティティを複製することで、このプロセスを迅速化できます。

データのサブセットを使用して最適化フェーズを開始します。 たとえば、100 万のレコードをインポートする必要がある場合は、1,000 レコードから始めて、10,000 レコードに増やし、その後 100,000 レコードに増やすことを検討してください。

使用するエンティティを特定した後は、次のセクションを実行して最適化の機会を探します。

## <a name="disable-change-tracking"></a>変更追跡を無効にする

エンティティの一覧から[変更追跡を有効化または無効化](../data-entities/entity-change-track.md) できます。

1. **データ管理** ワークスペースで、**フレームワーク パラメーター** タイルを選択します。
2. **ターゲット エンティティ** ページで、グリッドでエンティティを選択し、アクション ウィンドウの **変更追跡** タブで、**変更追跡を無効にする** を選択します。

## <a name="enable-set-based-processing"></a>セットベースのプロセスを有効にする

エンティティがセットベースのプロセスをサポートしている場合は、次の手順に従います。

1. **データ管理** ワークスペースで、**フレームワーク パラメーター** タイルを選択します。
2. **ターゲット エンティティ** ページで、グリッドでエンティティを検索し、**セットベースのプロセス** 列の値を確認します。

**一般仕訳帳** エンティティに対してセットベースのプロセスを有効にする方法を示す例については、[一般仕訳帳エンティティを使用して伝票をインポートするためのベスト プラクティス](../data-entities/tips-tricks-import-general-journal-entity.md) を参照してください。 すべてのエンティティがセットベースのプロセスをサポートしているわけではありません。 たとえば、**顧客の定義** (**CustCustomerBaseEntity**) エンティティに対してセットベースのプロセスのサポートを有効にして、変更を保存しようとすると、次の警告メッセージが表示されます。

> セット操作は「顧客の定義」エンティティではサポートされていません。

セットベースのプロセスが可能なエンティティを作成する必要がある場合の重要な考慮事項を次に示します。

* データ ソースは読み取り専用に設定できません。
* データ エンティティ ビューの [**ValidTimeStateEnabled**](../dev-tools/date-effectivity.md) プロパティは **いいえ** に設定する必要があります。
* データ ソース上のすべてのテーブルで、**TableType** プロパティが **通常** に設定されている必要があります 。
* 使用される **クエリ** の [**QueryType**](../dev-ref/application-explorer-aot-properties.md#query-properties-1) を **Union** に設定することはできません。
* 主要データ ソースは会社間でデータが保存されるのを防ぐことができません。 ただし、埋め込みデータ ソースでは可能です。
* 主要データ ソースはパーティション間でデータが保存されるのを防ぐことができません。 ただし、埋め込みデータ ソースでは可能です。

## <a name="create-a-data-migration-batch-group"></a>データ移行バッチ グループの作成

切替中に、他の活動がほとんどまたは全くないト時にデータ移行を実行します。 ほとんどまたはすべての計算ノードが割り当てられているバッチ グループを構成して使用すると便利です。

バッチ グループは、**バッチ グループ** ページ (**システム管理 \> 設定 \> バッチ グループ**) で構成できます。

## <a name="enable-priority-based-batch-scheduling"></a>優先順位に基づくバッチ スケジューリングを有効にする

プラットフォーム更新プログラム 31 では、新しい[優先順位に基づくバッチ スケジューリング](priority-based-batch-scheduling.md) 機能によって、ジョブの実行方法が最適化されます。 バッチ フレームワークで競合が特定されている場合は、優先順位に基づくバッチ スケジューリングを有効にすることを検討してください。

## <a name="configure-the-maximum-number-of-batch-threads"></a>バッチ スレッドの最大数を構成する

並列処理とマルチスレッド処理をより有効に利用するために、**サーバーの構成** ページの **バッチ スレッドの最大数** フィールド (**システム管理 \> 設定 \> サーバーの構成**) を設定することにより、Application Object Server (AOS) のインスタンスごとにバッチ スレッドの最大数を構成できます。 このフィールドの値の変更には注意が必要です。 値が高すぎるとパフォーマンスに悪影響が及ぼす可能性があります。 現在、既定値は **4** です。 必要に応じて値を **8** に変更することもできます。 ただし、大幅なパフォーマンス テストを行わない限り、このフィールドを 8 を超える値に設定しないでください。

## <a name="import-in-batch-mode"></a>バッチ モードでのインポート

インポート ジョブを実行する際は、必ずバッチ モードで実行します。 それ以外の場合は、単一のスレッドがジョブの実行に使用されます。 この場合、システムではこれらの最適化の構成を十分に活用できません。

## <a name="clean-staging-tables"></a>ステージング テーブルのクリーンアップ

ステージング テーブルをクリーンアップすることをお勧めします。 [ジョブ履歴のクリーンアップ ジョブ](../data-entities/data-import-export-job.md#job-history-clean-up) をスケジュールすることでこの最適化を実現できます。 このジョブをスケジュールするには、**データ管理** ワークスペースの **ジョブ履歴クリーンアップ** タスクを選択します。

> [!NOTE]
> 最初に **機能管理** ワークスペースの **実行履歴のクリーンアップ** 機能を有効にする必要があります。


## <a name="update-statistics"></a>統計の更新

大量のデータが関係するデータ移行ジョブを実行する前に、関連するテーブルの統計の更新を検討してください。 この最適化は運用環境で自動的に処理されるので、特にサンドボックス環境に適用されます。 [LCS から特定のテーブルの統計を更新](../lifecycle-services/querycookbook.md) できます。 または、サンドボックス環境では、直接 SQL を介して **sp\_updatestats** ストアド プロシージャを使用できます。

## <a name="clean-the-data"></a>データのクリーンアップ

検証およびエラー報告に費やす時間は、移行の合計時間を増加します。 量の多い無効または不整合なデータをインポートする場合は、この点を考慮してください。 データの品質に関連するエラーを修正および削減することをお勧めします。 これにより、検証やエラー処理が不必要に実行されるのを防ぐのに役立ちます。

## <a name="configurations-to-test-during-test-runs-of-data-migration"></a>データ移行のテストの実行中にテストする構成

パフォーマンスに影響を与える可能性がある構成は次のとおりです。 したがって、シナリオに適したさまざまな値を使用して変更をテストすることをお勧めします。

### <a name="configure-entity-execution-parameters"></a>エンティティの実行パラメーターを構成します

すべてのエンティティまたは特定のエンティティの実行パラメーターを変更するには、次の手順に従います。

1. **データ管理** ワークスペースで、**フレームワーク パラメーター** タイルを選択します。
2. **エンティティ設定** タブの **データのインポート/エクスポート フレームワーク パラメーター** ページで、**エンティティの実行パラメーターを構成する** を選択します。
3. **エンティティ インポートの実行パラメーター** ページで、**インポートのしきい値レコード数** および **インポート タスク数** フィールドを目的のエンティティに適切に設定します。

#### <a name="import-threshold-record-count"></a>インポートしきい値レコード数

この値により、スレッドごとに処理されるレコード数が決まれます。 [**インポートのしきい値レコード数** を変更](../data-entities/data-import-export-job.md#parallel-imports) することで、インポートを小さいタスクに分割する方法を制御できます。

#### <a name="import-task-count"></a>インポート タスク数

このフィールドは、特定のエンティティのデータ移行ジョブに使用されるスレッドの数を定義します。 たとえば、各サーバーの **最大バッチ スレッド** フィールドが **8** に設定され、データ移行バッチ グループに 4 つのサーバーが割り当てられます。 この場合、**インポート タスク数** フィールドの合計最大値は **32** (= 8 × 4) になります。

データ エンティティがマルチスレッドをサポートしない場合、エンティティを構成しようとする場合にエラー メッセージが表示されます。 次に例を示します。

> カスタム シーケンスはエンティティ「顧客 V3」に対して定義されています。複数のタスクはサポートされていません。

### <a name="validations"></a>検証

レコードの挿入または更新の検証ロジックがシステムに組み込まれているか、個々のフィールドの検証が行われている場合があります。 データ移行の完成度が十分に高い場合は、この検証を無効にすることで、インポートに費やした時間が大幅に短縮されます (無効にできる場合)。

次の手順に従って、各エンティティの設定を変更します。

1. **データ管理** ワークスペースで、**フレームワーク パラメーター** タイルを選択します。
2. **ターゲット エンティティ** ページで、グリッドでエンティティを選択し、アクション ウィンドウで **エンティティ構造** を選択します。
3. **エンティティ構造** ページで、**ビジネス検証** および **挿入または更新メソッドでのビジネス ロジックの実行** フィールドを適切に設定します。

#### <a name="run-business-validations"></a>業務検証の実行

このチェック ボックスがオンの場合、システムはテーブルの **validateWrite()** メソッドに書き込まれるすべてのロジックを実行します。 また、関連するイベント ハンドラーも実行されます。

#### <a name="run-business-logic-in-insert-or-update-method"></a>挿入方法または更新方法のビジネス ロジックを実行

このチェック ボックスがオンの場合、システムはテーブルの **挿入 ()** または **更新 ()** メソッドに書き込まれるすべてのロジックを実行します。 また、関連するイベント ハンドラーも実行されます。

#### <a name="call-the-validatefield-method-on-the-target"></a>ターゲットの validateField メソッドを呼び出す

フィールド検証を実行するには、次の手順を実行します。

1. **データ管理** ワークスペースで、**フレームワーク パラメーター** タイルを選択します。
2. **ターゲット エンティティ** ページで、グリッドでエンティティを選択し、アクション ウィンドウで **ターゲット マッピングの変更** を選択します。
3. **ステージングをターゲットにマップ** ページで、検証を実行する必要があるフィールドの **フィールドの検証メソッドの呼び出し** チェック ボックスをオンにします。 その後、そのフィールドに対して **validateField(FieldId p1)** メソッドが呼び出されます。

### <a name="recommendations-for-optimizing-data-migration-performance"></a>データ移行のパフォーマンスを最適化するための推奨事項

データ移行のパフォーマンスを最適化するために使用する方法に関する一般的な推奨事項を次に示します。

* 大きなファイルを小さいチャンクに分割します。 この方法により、SQL オプティマイザは、新しいクエリ プランが最適かどうかを判断するための時間を確保できます。
* 適切なレベル 2 以上の環境でパフォーマンスをテストします。
* 運用前に、切替モックでのパフォーマンスをテストします。

データ移行のパフォーマンスのテストは、反復プロセスです。 特定のエンティティの最適な構成を決定するために、各テストに関する情報を収集して比較することをお勧めします。 次の設定の一部を収集して確認する必要があります。

* 使用されるバッチ グループ
* 各バッチ グループに割り当てられるバッチ サーバーの数
* バッチ サーバーごとのバッチ スレッドの最大数

各エンティティについて収集する情報の例を次に示します。

| 情報 | 説明 |
|---|---|
| エンティティ | テストされているエンティティの名前 |
| レコード数 | インポートされるレコード数 |
| ソース形式 | インポートされるデータのソース形式 |
| 無効にされた変更追跡 | はい/いいえ |
| セット ベースのプロセス | はい/いいえ |
| インポートしきい値レコード数 | レコード数 |
| インポート タスク数 | タスク数 |
| 業務検証の実行 | はい/いいえ |
| 挿入方法または更新方法のビジネス ロジックを実行 | はい/いいえ |
| "フィールドの検証" メソッドの呼び出し | はい/いいえ (潜在的なフィールドのリスト) |
| 必要なパフォーマンス | 切替ウィンドウを達成するためにインポートを完了する必要がある時間 |
| 実際のパフォーマンス | レコードのインポートに必要な実際の時間 |

パフォーマンスを最適化できる領域は他にもあります。 たとえば、特定のクエリおよびクエリ プランを分析できます。 ただし、これらのプロセスについては他のトピックで説明します。

パフォーマンスのトラブルシューティングおよび最適化の詳細については、次のトピックを参照してください。

* [Lifecycle Services (LCS) 内のツールを使用した、パフォーマンスのトラブルシューティング](../lifecycle-services/performancetroubleshooting.md)
* [クックブックの照会](../lifecycle-services/querycookbook.md)


[!INCLUDE[footer-include](../../../includes/footer-banner.md)]
