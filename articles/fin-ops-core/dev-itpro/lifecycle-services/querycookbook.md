---
title: クックブックの照会
description: このトピックでは、SQL インサイト タブのクエリについて、またパフォーマンスの問題のトラブルシューティングを行うときにそれらを使う方法について説明します。
author: meeramahabala
ms.date: 11/09/2021
ms.topic: article
ms.prod: ''
ms.technology: ''
audience: Developer, IT Pro
ms.reviewer: sericks
ms.custom: 267184
ms.assetid: eb056816-ccf4-43a5-aed3-cf72543353de
ms.search.region: Global
ms.author: meeram
ms.search.validFrom: 2016-11-30
ms.dyn365.ops.version: Version 1611
ms.openlocfilehash: af3276511f1d1fc7147861dee51ab96d38f155db
ms.sourcegitcommit: f4823a97c856e9a9b4ae14116a43c87f9482dd90
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 11/09/2021
ms.locfileid: "7779810"
---
# <a name="query-cookbook"></a>クックブックの照会 

[!include [banner](../includes/banner.md)]

このトピックでは、Lifecycle Services (LCS) の **環境の監視** ページにある **SQL インサイト** タブの下の各クエリの詳細と、パフォーマンスの問題のトラブルシューティングを行うときにそれらを使う方法を示します。 この機能の詳細については、[Lifecycle Services (LCS) でツールを使用したパフォーマンスのトラブルシューティング](performancetroubleshooting.md)を参照してください。

## <a name="current-blocking"></a>現在のブロック

### <a name="description"></a>説明
現在ブロックされているクエリ、それらをブロックしている SPID、ブロックされている期間、待機しているリソースをリストします。 これは、同じ情報の一部のグラフィカルな概要を表示するブロック ツリーを表示するためのクエリと組み合わせて使用できます。 正常なシステムでは単独でブロックするのが通常であり、過剰になったり、営業活動に悪影響を及ぼし始めたときのみ問題となります。

### <a name="next-steps"></a>次のステップ
- どのプロセスがブロックされているかを決定し、どのプロセスがブロックしているかとその理由を判別します。
- ブロックを解決するには、実行させて自然にクリアさせるか、リード ブロッカー プロセスを終了して作業をロールバックするかの 2 つのオプションのみです。 一般に、リード ブロッカーは、自然にクリアすると思われない状況 (不適切なクエリ プランの場合など) や、重要なプロセスを実行できないためにすぐに完了する必要があるような状況でのみ終了する必要があります。
- 将来同じブロックを避けるため、インデックスまたはプラン ガイドを使用したり、各種レコードでの操作中にプロセスが互いにブロックしている場合はロック エスカレーションおよびページ ロックを無効にできます。 プロセスが同じレコードで動作している場合、ブロックを回避するには、同時に同じレコード上で動作しないように、プロセスをリファクタリングまたは再スケジューリングする必要があります。

## <a name="current-blocking-tree"></a>現在のブロック ツリー

### <a name="description"></a>説明
現在ブロックしているかブロックされている SPID およびステートメントのグラフィカル表示を提供します。 これは、詳細な情報を表示するために現在のブロック クエリと組み合わせて使用できます。 正常なシステムでは単独でブロックするのが通常であり、過剰になったり、営業活動に悪影響を及ぼし始めたときのみ問題となります。

### <a name="next-steps"></a>次のステップ
- どのプロセスがブロックされているかを決定し、どのプロセスがブロックしているかとその理由を判別します。
- ブロックを解決するには、実行させて自然にクリアさせるか、リード ブロッカー プロセスを終了して作業をロールバックするかの 2 つのオプションのみです。 一般に、リード ブロッカーは、自然にクリアしないと思われる状況 (不適切なクエリ プランの場合など) や、重要なプロセスを実行できないためにすぐに完了する必要があるような状況でのみ終了する必要があります。
- 将来同じブロックを避けるため、インデックスまたはプラン ガイドを使用したり、各種レコードでの操作中にプロセスが互いにブロックしている場合はロック エスカレーションおよびページ ロックを無効にできます。 プロセスが同じレコードで動作している場合、ブロックを回避するには、同時に同じレコード上で動作しないように、プロセスをリファクタリングまたは再スケジューリングする必要があります。

## <a name="currently-running-queries"></a>現在実行中のクエリ

### <a name="description"></a>Description
このデータベースで現在実行状態またはブロック状態のすべてのクエリのリストと、各クエリの合計実行および待機時間も提供します。 実行時間が長く待機時間が短いクエリは多くの場合不適切なクエリ プランであることを示します。 待機時間が長くクエリと実行時間が短いクエリはブロックを示しています。 比較的高速な操作が何回も実行されている場合、行でこのクエリを複数回実行し、実行時間が短い頻繁に発生するクエリを探すことで見つけることができます。

### <a name="next-steps"></a>次のステップ
- 高い CPU 時間が見られる場合、クエリのクエリ プランを取得し、このクエリに使用されている他のクエリ プランの方が効率的かどうかも確認します。 新しいクエリ、クエリの変更、または最後の手段としてプラン ガイドを追加することにより、この問題に対処することを検討してください。
- 高い待機時間が見られる場合、現在のブロックおよび現在のブロック ツリーを表示してクエリがブロックされている理由を判断します。 これは、場合によっては、ロック エスカレーションまたはページ ロックを無効にすることで (これがブロックの原因の場合) 対処できます。 通常は、2 つのクエリにより同じレコードが同時に処理されないように、実行される作業を分割することにより対処されます。

## <a name="end-sql-process"></a>SQL プロセスの終了

### <a name="background"></a>バックグラウンド
SPID が非常に多くのリソースを消費して、他のプロセスの工程が低下している場合、は、SPID プロセスを終了すると便利な場合があります。 これにより、未処理トランザクションがロールバックします。つまり、データは失われませんが、プロセスの手動での再起動が必要になることがあります。 トランザクションが既に多くの作業を実行している場合、ロールバックに時間がかかり、多くのリソースを消費する可能性があることに注意してください。 したがって、このアクションは注意して使用する必要があります。

### <a name="next-steps"></a>次のステップ
- ブロック ツリーやその他のクエリから、SPID が終了するかどうかを判断する必要があります。
- 継続的な事業運営に悪影響を与えずに、SPID により実行されている処理が終了できることを確認します。
- 終了する SPID 番号を指定し、その操作をロールバックします。

## <a name="removed-features"></a>削除済みの機能
[削除済みまたは非推奨のプラットフォームの機能](../get-started/removed-deprecated-features-platform-updates.md)で述べたように、一部の Azure SQL レポートおよび Azure SQL アクションは Lifecycle Services (LCS) から削除されました。

### <a name="removed-queries"></a>削除済みのクエリ
次の項目が、LCS の **SQL インサイト** の **クエリ** タブから削除されました。

| **氏名** | **削除済** | **摘要** |
|-------------------------|-------------------------|-------------------------|
| 現在のブロック ツリー | 無 | 現在利用可能です。 |
| 現在実行中のクエリ | 無 | 現在利用可能です。 |
| 現在のブロック ステートメント | 無 | 現在利用可能です。 |
| インデックスの取得 | あり | 適用できなくなりました。</br><br>**理由**</br><ul></br><li>これはバックグラウンド のプラットフォーム プロセスで処理されるため、手動のインデックス管理は不要になりました。</li></br></ul></br>**詳細**</br><ul></br><li>システムは自動的にインデックスを調整および管理します。</li></br></ul> |
| ロックの詳細の取得 | あり | 適用できなくなりました。</br><br>**理由**</br>プラットフォームは次の点を担当します:</br><ul></br><li>データベースのワークロードを最適化し、発生する可能性があるすべてのブロックを処理します。</li></br><li>断続的な接続問題を管理し、こうしたアクションに関連する問題を回避するための再試行を提供します。</li></br></ul></br>**詳細**</br><ul></br><li>プラットフォームではワークロードと環境を最適化し、未解決のプロセス ブロックにつながるシナリオの数を減らします。</li></br><li>内部のモニタリングと検出により、可能性のある追加シナリオについてより深い根本原因の分析が行われます。</li></br></ul> |
| クエリ ID のリストの取得 | あり | 適用できなくなりました。</br><br>**理由**</br><ul></br><li>プラットフォームがクエリの調整と最適化を担当することで、個々のクエリやその計画、および実行統計に関するインサイトは不要になりました。</li></br><li>クエリ ストアの情報は複雑で、誤った解釈により、軽減策や根本原因の識別が遅れる可能性があります。</li></br></ul></br>**詳細**</br><ul></br><li>プラットフォームは個々のクエリを自動的に調整および最適化し、手動による確認の必要性を除去します。</li></br><li>パフォーマンスの問題に関してサポートに通知し、パフォーマンスの低下が確認された領域と時間枠に関する高レベルの詳細を含めます。</li></br></ul> |
| 特定のプラン ID に対する SQL クエリ プランの取得 | あり | 上と同じ。 |
| クエリ プランと実行統計の取得 | あり | 上と同じ。 |
| スロットル コンフィギュレーションの取得 | あり | 適用できなくなりました。</br><br>**理由**</br><ul></br><li>リソース ガバナー レベルでのスロットリングは、エラスティック プールに適用されなくなりました。</li></br></ul></br>**詳細**</br><ul></br><li>このレポートは適用できなくなりました。</li></br></ul> |
| 待機統計の取得 | あり | 適用できなくなりました。 </br><br>**理由**</br><ul></br><li>データベースのパフォーマンスはプラットフォームによって自動的に管理され、待機統計をモニタリングする必要はなくなりました。</li></br><li>待機統計は非常に貴重である一方で、根本原因の分析に必要なすべての情報が提供されるわけではなく、複雑さが加わることで、誤った解釈やパフォーマンス軽減策の遅れが生じる可能性があります。</li></br></ul></br>**詳細**</br><ul></br><li>プラットフォームでは、セッションの待機時間を短縮するための、監視と自動修復メカニズムを自動的に使用します。</li></br><li>パフォーマンスの問題に関してサポートに通知し、パフォーマンスの低下が確認された領域と時間枠に関する高レベルの詳細を含めます。</li></br></ul> |
| 最も高価なクエリのリスト | あり | 適用できなくなりました。 </br><br>**理由**</br><ul></br><li>プラットフォームでは、いくつかの自動調整操作で最もリソースを消費するクエリを対象としています。つまり、システムの正常性を維持するために、これらのクエリの取得は必要ではなくなりました。</li></br><li>このクエリでは、最も関心の高いクエリが表示されるのではなく、その期間で最も価値が高いクエリが表示されるだけの場合があります。 この一覧があっても、環境の問題を指摘することはできません。 これは非常に価値が高いクエリであり、カスタム クエリのトラブルシューティング対象ではありません。 より一般的なチェックを提供します。 現在のところ、10 ～ 30% の確率で失敗となります。 </li></br></ul></br>**詳細**</br><ul></br><li>プラットフォームはモニタリングを行い、セルフサービス メカニズムを自動的に使用して、最も価値の高いクエリのリソース消費を減らします。</li></br><li>パフォーマンスの問題に関してサポートに通知し、パフォーマンスの低下が確認された領域と時間枠に関する高レベルの詳細を含めます。</li></br></ul> |
| 現在の DTU (データベース トランザクションの単位) | あり | 適用できなくなりました。</br><br>**理由**</br><ul></br><li>プラットフォームがすべてのデータベースをモニタリングし、すべてのワークロードに適したリソースを提供するため、DTU レポートは必要ではなくなりました。</li></br><li>現在の DTU レポートでは、データベースの正常性を正確に把握できなくなりました。</li></br></ul></br>**詳細**</br><ul></br><li>プラットフォームはデータベースをモニタリングし、各ワークロードに利用可能なリソースを自動的に最適化します。</li></br></ul> |
| 現在の DTU の詳細 | あり | 適用できなくなりました。</br><br>**理由**</br><ul></br><li>プラットフォームがすべてのデータベースをモニタリングし、すべての顧客のワークロードに適したリソースを提供するため、DTU レポートは必要ではなくなりました。</li></br><li>現在の DTU レポートでは、データベースの正常性を正確に把握できなくなりました。</li></br></ul></br>**詳細**</br><ul></br><li>プラットフォームはデータベースをモニタリングし、顧客のワークロードに利用可能なリソースを自動的に最適化します。</li></br></ul> |

### <a name="removed-actions"></a>削除済みのアクション

次のアクションが、LCS の **SQL インサイト** の **アクション** タブから削除されました。

| Name | 削除済 | 摘要 |
|-------------------------|-------------------------|-------------------------|
| インデックスの作成 | あり | 適用できなくなりました。</br><br>**理由**</br><ul></br><li>これはバックグラウンド のプラットフォーム プロセスで処理されるため、手動のインデックス作成は不要になりました。</li></br></ul></br>**詳細**</br><ul></br><li>必要に応じてシステムの背景プロセスが処理します。</li></br></ul> |
| インデックスの削除 | あり | 適用できなくなりました。 </br><br>**理由**</br><ul></br><li>Finance and Operations ワークロードは定期的に発生するため、データ管理および管理サービス (DAMS) には含まれません。</li></br></ul></br>**詳細**</br><ul></br><li>必要に応じてシステムが自動的に調整を行います。</li></br></ul> |
| インデックスの再構築 | あり | 適用できなくなりました。</br><br>**理由**</br><ul></br><li>これはバックグラウンド のプラットフォーム プロセスで処理されるため、手動のインデックス作成は不要になりました。</li></br></ul></br>**詳細**</br><ul></br><li>必要に応じてシステムの背景プロセスが処理します。</li></br></ul> |
| 統計の更新 | あり | 適用できなくなりました。</br><br>**理由**</br><ul></br><li>プラットフォーム背景プロセスでは、インデックスと統計管理が処理されます。</li></br></ul></br>**詳細**</br><ul></br><li>プラットフォームは、インデックスと統計管理を担当します。</li></br></ul> |
| クエリ ヒントの最適化 | あり | 適用できなくなりました。</br><br>**理由**</br><ul></br><li>プラットフォームではクエリ ヒントの最適化が処理されるため、顧客は手動で調整を行う必要がありません。</li></br></ul></br>**詳細**</br><ul></br><li>プラットフォームでは、正確なヒントが自動的に検出され、最適化が必要なクエリに適用されます。</li></br></ul> |
| テーブル ヒントを追加するプラン ガイドの作成 | あり | 適用できなくなりました。</br><br>クエリ ヒントの最適化は "テーブル ヒントを追加するプラン ガイドの作成" と組み合わされます。</br><br>**理由**</br><ul></br><li>顧客が手動で時間をかけて調整するのではなく、プラットフォームがクエリの最適化を行います。</li></br><li>DAMS は、プラットフォームの自動化に有利な手作業を減らします。</li></br><li>プラットフォームでは、非効率的で管理が難しいプラン ガイドの使用を廃止しました。</li></br></ul></br>**詳細**</br><ul></br><li>プラン ガイドは廃止され、クエリ ストアを通じて強制的にヒントを与えるようになります。</li></br><li>プラットフォームでは、正確なヒントが自動的に検出され、最適化が必要なクエリに適用されます。</li></br></ul> |
| プランを強制するプラン ガイドの作成 | あり | 上と同じ。 |
| プラン ガイドの削除 | あり | 上と同じ。 |
| 現在のプラン ガイドの一覧 | あり | 適用できなくなりました。</br><br>**理由**</br><ul></br><li>顧客が手動で時間をかけて調整するのではなく、プラットフォームが最適化を行います。</li></br><li>DAMS は、プラットフォームの自動化に有利な手作業を減らします。</li></br><li>プラットフォームでは、非効率的で管理が難しいプラン ガイドの使用を廃止しました。</li></br></ul></br>**詳細**</br><ul></br><li>プラン ガイドは廃止され、クエリ ストアを通じて強制的にヒントを与えるようになります。</li></br><li>プラットフォームでは、正確なヒントが自動的に検出され、最適化が必要なクエリに適用されます。</li></br></ul> |
| SQL プロセスの終了 | 無 | 引き続き使用できます。

<!--### Removed live views

The following live views have been removed from the **Live views** tab of **SQL Insights** in LCS.

| Name | Removed | Notes |
|-------------------------|-------------------------|-------------------------|
| Common metrics (DTU) | Yes | No longer applicable.</br><br>**Reason**</br><ul></br><li>Current DTU has been removed from queries.</li></br></ul></br>**Details**</br><ul></br><li>See **Current DTU** under **Queries** above.</li></br></ul> |
| Currently executing statements | No | Remains available in LCS. |
| Blocking statements | No | Remains available in LCS. | -->
