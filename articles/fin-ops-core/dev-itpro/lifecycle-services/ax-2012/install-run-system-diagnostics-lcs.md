---
title: システム診断のインストールと実行
description: 環境を検出してデータを収集するサービスが使用できるようになる前にインストールする必要があるオンプレミス コンポーネントがシステム診断に含まれています。
author: PeterRFriis
ms.date: 10/10/2018
ms.topic: article
ms.prod: dynamics-ax-2012
ms.technology: ''
audience: Developer, IT Pro
ms.reviewer: sericks
ms.custom: 18861
ms.assetid: 075b4e28-162f-47ae-8713-392d711bdaff
ms.search.region: Global
ms.author: peterfriis
ms.search.validFrom: ''
ms.dyn365.ops.version: 2012
ms.openlocfilehash: c7b8e1488f8d236dd01c36ec21195e9336475596
ms.sourcegitcommit: 074b6e212d19dd5d84881d1cdd096611a18c207f
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/31/2021
ms.locfileid: "5745279"
---
# <a name="install-and-run-system-diagnostics"></a>システム診断のインストールと実行 

[!include [banner](../../includes/banner.md)]

Microsoft Dynamics Lifecycle Services では、Microsoft Dynamics AX 環境を検出してデータを収集するサービスが使用できるようになる前にインストールする必要があるオンプレミス コンポーネントがシステム診断に含まれています。

<a name="install-the-system-diagnostics-on-premises-component"></a>システム診断オンプレミス コンポーネントのインストール
----------------------------------------------------

システム診断オンプレミス コンポーネントをインストールするには、以下が必要です。

-   ローカル コンピューターと Microsoft Dynamics AX ビジネス データベースに特定のアクセス許可を持つサービス アカウント。
-   X509 証明書です。 既存の証明書を使用するか、インストーラーにより作成することができます。 各 X509 証明書は、単一プロジェクトに関連付けられます。 環境からの診断は、1 つのプロジェクトにのみアップロードできます。
-   Microsoft .NET 4.5 または 4.5.1

### <a name="configure-the-service-account-for-system-diagnostics"></a>システム診断用のサービス アカウントをコンフィギュレーションする

このセクションでは、Lifecycle Services 診断サービス (LCSDiagFXService.exe) が実行されるサービス アカウントに必要なアクセス許可について説明します。

-   サービス アカウントは、Microsoft Dynamics AX のユーザーで、**BusinessConnector** ロールのメンバーであるドメイン アカウントである必要があります。 可能な場合、アカウントは、.NET Business Connector プロキシに使用する同じアカウントを使用することを強くお勧めします。 詳細については、[.NET Business Connector プロキシ アカウントを指定](https://technet.microsoft.com/library/3e46dc0a-2ff4-4a06-ae61-041e52dcc774(AX.60).aspx) および [セキュリティ ロールにユーザーを割り当てる](https://technet.microsoft.com/library/214ee45b-5b99-4ea8-9454-f4297f68e38c(AX.60).aspx) を参照してください。

    | **メモ**                                                                                                                     |
    |------------------------------------------------------------------------------------------------------------------------------|
    | .NET Business Connector プロキシ アカウントを再利用する場合は、引き続きそれを **BusinessConnector** ロールのメンバーとして追加する必要があります。 |

-   Lifecycle Services 診断サービスがデータを収集できるよう、サービス アカウントには、AOS インスタンスを実行し、Microsoft Dynamics AX ビジネス データベースをホストするすべてのコンピューター上の HKEY\_LOCAL\_MACHINE ハイブ内の特定のレジストリ キーへの読み取りアクセスが必要です。
-   サービス アカウントは、Lifecycle Services 診断サービスが Windows イベントログを読み取れるように、環境内の各サーバー上の **イベント ログ リーダー** のローカル グループのメンバーである必要があります。
-   Lifecycle Services 診断サービスが SQL Server で既定の動的管理ビューを実行できるよう、サービス アカウントには、Microsoft Dynamics AX ビジネス データベース (**db\_datareader**) への読み取りアクセスと、SQL Server インスタンスに対して VIEW SERVER STATE 権限が必要です。

#### <a name="configure-read-permissions-to-the-registry"></a>レジストリへの読み取りアクセス許可をコンフィギュレーションする

AOS インスタンスまたは Microsoft Dynamics AX SQL Server ビジネス データベースをホストする環境内の各サーバーで、HKEY\_LOCAL\_MACHINE ハイブ内のレジストリ キーに対する読み取りアクセス権を、システム診断のサービス アカウントに付与する必要があります。

| **注意**                                                                                                                                                                                                                                                                                                                                                                              |
|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 次の手順には、Windows レジストリの編集が含まれます。 レジストリを誤って編集すると深刻な問題が発生し、Windows の再インストールが必要になることがあります。 Microsoft は、レジストリの編集によって発生した問題の解決については保証できません。 解決済み。 レジストリを編集する前に、レジストリ ファイル (System.dat と User.dat) のバックアップを作成する必要があります。 |

SQL Server ビジネス データベースをホストするサーバー上の Windows レジストリからデータを収集するためのアクセスを許可するには、次のようにします。
1.  **開始**、**実行** をクリックし、**regedit** と入力し、次に **Enter** を押します。
2.  **HKEY\_LOCAL\_MACHINE** を展開し、サブキー **System\CurrentControlSet\Control\PriorityControl** で移動し、右クリックおよび **アクセス許可** を選択します。
3.  Lifecycle Services 診断サービスに関連付ける必要のあるユーザーを追加します。
4.  追加したユーザーを選択し、読み取りアクセス許可を許可します。
5.  **セキュリティの詳細設定** をクリックし、アクセス許可が子オブジェクトによって継承されていることを確認します。

1 つ以上の AOS インスタンスをホストするサーバー上の Windows レジストリからデータを収集するためのアクセスを許可するには、次のようにします。
1.  **開始**、**実行** をクリックし、**regedit** と入力し **Enter** を押します。
2.  **HKEY\_LOCAL\_MACHINE** を展開し、サブキー **System\CurrentControlSet\Services\Dynamics Server\6.0** で移動し、右クリックおよび **アクセス許可** を選択します。
3.  Lifecycle Services 診断サービスに関連付ける必要のあるユーザーを追加します。
4.  追加したユーザーを選択し、読み取りアクセス許可を許可します。
5.  **セキュリティの詳細設定** をクリックし、アクセス許可が子オブジェクトによって継承されていることを確認します。
6.  データの収集元にする各環境でのすべての AOS インスタンスを繰り返します。

<table>
<colgroup>
<col width="100%" />
</colgroup>
<thead>
<tr class="header">
<th><strong>重要</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>レジストリで権限を設定するには、既に存在しているアクセス特権を削減することはできません。 セキュリティの詳細設定については、以下を参照してください。
<ul>
<li><a href="https://technet.microsoft.com/library/jj134043.aspx">Windows Server 2012 アクセス制御と承認の概要</a></li>
<li><a href="https://technet.microsoft.com/library/cc730772.aspx">Windows Server 2008 R2 セキュリティの詳細設定のプロパティ ページ - アクセス許可タブ</a></li>
</ul></td>
</tr>
</tbody>
</table>

#### <a name="edit-the-group-policy-on-the-aos"></a>AOS のグループ ポリシーを編集

Group Policy では、AOS のサービスをリモートで利用できるようにしてください。

1.  AOS インスタンスを実行するコンピューターで、**開始** &gt; **実行** をクリックして、**gpedit.msc** を入力し、**Enter** キーを押します。
2.  左ウィンドウで、**コンピューターの構成** &gt; **Windows の設定** &gt; **セキュリティ設定** &gt; **ローカル ポリシー** &gt; **セキュリティ オプション** を展開します。
3.  右ウィンドウで、**ネットワーク アクセス: リモートからアクセスできるレジストリ パスおよびサブ パス** をダブルクリックします。
4.  次のパスがリストにない場合は、リストの最後にそれを追加し、**OK** をクリックします。
    -   System\CurrentControlSet\Control\PriorityControl
    -   System\CurrentControlSet\services\Dynamics Server\6.0

#### <a name="configure-windows-event-log-and-wmi-permissions"></a>Windows イベント ログおよび WMI のアクセス許可をコンフィギュレーションする

サービス アカウントは、環境内の各サーバー上の Windows イベント ログを読み取ることができ、リモートで Windows Management Instrumentation 接続を監視できる必要があります。 詳細については、「[ローカル グループへのメンバーの追加](https://technet.microsoft.com/library/cc772524(v=WS.10).aspx)」を参照してください。

-   環境内の各サーバーでは、サービス アカウントを **イベント ログ リーダー** ローカル グループ、**配分 COM ユーザー** ローカル グループ、および **パフォーマンス ユーザーの監視** ローカル グループに追加します。

#### <a name="secure-the-remote-windows-management-instrumentation-connections"></a>Windows Management Instrumentation リモート接続をセキュリティで保護

AOS インスタンスまたは Microsoft Dynamics AX SQL Server ビジネス データベースをホストする環境内の各サーバーで、リモート Windows Management Instrumentation(WMI) 接続をセキュリティで保護されたことを確認します。

1.  **開始** &gt; **実行** の順にクリックし、**DCOMCNFG** と入力し **OK** をクリックします。
2.  **コンポーネント サービス** ダイアログ ボックスで、**コンポーネント サービス** を展開し、**コンピューター** を展開してから、**マイ コンピューター** を右クリックして **プロパティ** をクリックします。
3.  **マイ コンピューターのプロパティ** ダイアログ ボックスで、**COM セキュリティ** タブをクリックします。
4.  **起動とアクティベーションのアクセス許可** で、**制限の編集** をクリックします。
5.  **起動アクセス許可** ダイアログ ボックスで、名前またはグループが **グループまたはユーザー名** 一覧に表示されない場合は次の手順に従います。
    1.  **起動アクセス許可** ダイアログ ボックスで、**追加** をクリックします。
    2.  **ユーザー、コンピュータ、またはグループの選択** ダイアログ ボックスの **選択するオブジェクト名を入力してください** ボックスに **配分 COM ユーザー** と入力して、**名前の確認** をクリックしてから **OK** をクリックします。
    3.  **追加** をクリックします。
    4.  **選択するオブジェクト名を入力してください** ボックスに、**パフォーマンス モニター ユーザー** と入力し、**名前の確認** をクリックしてから、**OK** をクリックします。
    5.  各グループの各アクセス許可 (ローカル起動、リモート起動、ローカルの有効化、リモートの有効化) について **許可** を選択し、**OK** をクリックします。

6.  すべての名前空間に WMI コントロールのセキュリティ設定を適用します。
    1.  **開始** &gt; **実行** の順にクリックし、**wmimgmt.msc** と入力し **OK** をクリックします。
    2.  **WMI コントロール (ローカル)** を右クリックし、**プロパティ** をクリックします。
    3.  **セキュリティ** タブで、**ルート** をクリックし、**セキュリティ** をクリックして、**追加** をクリックします。
    4.  **選択するオブジェクト名の入力** で Distributed COM ユーザーを入力し、**名前の確認** をクリックしてから **OK** をクリックします。
    5.  **詳細** をクリックします。
    6.  **配布される COM ユーザー** を選択し、**編集** をクリックしてください。
    7.  **この名前空間とサブ名前空間** を選択します。
    8.  メソッドの実行、アカウントの有効化、リモートの有効化のアクセス許可について **許可** を選択し、**OK** をクリックします。

7.  パフォーマンス モニター ユーザー グループで手順 6 を繰り返し、すべてのウィンドウを閉じます。

詳細については、「[リモート WMI 接続の保護](https://msdn.microsoft.com/library/windows/desktop/aa393266(v=vs.85).aspx)」を参照してください。

#### <a name="configure-sql-server-permissions"></a>SQL Server のアクセス許可をコンフィギュレーションします

サービス アカウントは、Microsoft Dynamics AX ビジネス データベースのデータを読み取ることができ、SQL Server の既定の動的管理ビューにアクセスできる必要があります。

1.  Microsoft Dynamics AX ビジネス データベースがインストールされている SQL Server インスタンスに、ログインとしてサービス アカウントを追加します。 このステップを実行する方法の詳細については、「[ログインの作成](https://msdn.microsoft.com/library/aa337562.aspx)」を参照してください。
2.  ビジネス データベースのユーザーとしてアカウントを追加します。 このステップを実行する方法の詳細については、「[方法: データベース ユーザーの作成](https://msdn.microsoft.com/library/aa337545.aspx)」を参照してください。
3.  ビジネス データベースの db\_datareader ロールにサービス アカウントを追加します。 このステップを実行する方法の詳細については、「[ロールに参加](https://msdn.microsoft.com/library/ff877886.aspx)」を参照してください。
4.  サービス アカウントに SQL Server インスタンスの VIEW SERVER STATE 権限を付与します。
    1.  SQL Server Management Studio で、**データベース** を展開し、**Microsoft Dynamics AX** データベースを右クリックし、**プロパティ** をクリックします。
    2.  **アクセス許可** をクリックし、次に **サーバーのアクセス許可を表示** をクリックします。
    3.  **ログインまたはロール** 一覧で、アクセス許可を付与するユーザーをクリックします。
    4.  **ユーザーの明示的なアクセス許可** リストで、**サーバー状態のアクセス許可を表示** の隣にある **付与** チェック ボックスをオンにします。

### <a name="verify-that-the-net-business-connector-service-is-running-in-the-environment"></a>この環境で .NET Business connector サービスが実行されていることを確認する

Business Connector サービスは、Lifecycle Services 診断サービスがインストールされているホストで実行する必要があります。 1 つ以上の環境が見つかると、.Ne ビジネス コネクタ プロキシ アカウントは、Microsoft Dynamics AX Application Object Server (AOS) インスタンスを実行している各サーバーと同じものである必要があります。 詳細については、[.NET Business Connector のインストール](https://technet.microsoft.com/library/c67944e8-73c5-4434-94d6-84484c810333(AX.60).aspx) を参照してください。

### <a name="install-the-microsoft-dynamics-lifecycle-services-system-diagnostics"></a>Microsoft Dynamics Lifecycle Services システム診断のインストール

システム診断プログラムのオンプレミス コンポーネントをインストールするには、ローカル コンピューターの Administrator グループのメンバーである必要があります。

1.  [Lifecycle Services に移動](https://lcs.dynamics.com).
2.  プロジェクトを開いて、**システム診断** タイルをクリックします。
3.  **管理者** ページで、圧縮インストーラーをダウンロードします (**LCSDiagFX\_x64.zip.**)。
4.  Microsoft Dynamics AX クライアントを実行しているコンピュータにインストーラーを抽出します。 コンピューターが環境内の他のすべてのサーバーにネットワーク アクセスできる必要があります。.Net Business Connector プロキシ アカウントをサービス アカウントとして使用している場合は、.NET Business Connector を実行している必要があります。

    | **重要**                                                                                                                                                                                                      |
    |--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
    | 実稼働環境では、AOS インスタンスまたは SQL Server インスタンスも実行しているコンピューターではなく、クライアントのみ実行しているコンピューターにオンプレミス コンポーネントをインストールすることをお勧めします。 |

5.  **Setup.exe** を実行します。

    | **メモ**                           |
    |------------------------------------|
    | 直接 MSI ファイルを実行しないでください。 |

6.  ライセンス条項に同意します。
7.  既存のローカル X509 証明書をお持ちの場合は、**証明書タイプを選択** ページで、**既存のものを使用** をクリックします。 X509 証明書がない場合は、次の手順を実行します。
    1.  **証明書タイプの選択** ページで、**新規作成** をクリックします。
    2.  証明書の名前で使用される接頭語を入力します。
    3.  **次へ** をクリックして証明書を作成します。
    4.  指定した場所に新しい証明書が作成されたことを確認します。

8.  **システム診断** ページに戻り、証明書の場所を参照して **アップロード** をクリックします。
9.  **Microsoft Dynamics Lifecycle Services 診断サービス セットアップ ウィザード** の **新しい証明書のアップロード** ページに戻り、**証明書ファイルがアップロードされました** を選択して **次へ** をクリックします。
10. **プライベート証明書の選択** ページで、証明書の名前が表示されます。 **次へ** をクリックします。
11. **サービス アカウントの指定** ページで、サービス アカウントとパスワードを入力し、**次へ** をクリックします。
12. **変更先フォルダ** ページで、システム診断によって収集されたログを保管する場所を入力し、**次** をクリックします。
13. **OK** クリックして、システム診断をインストールおよび開始し、次に **完了** をクリックします。

2 つの実行可能プログラム、LCSDiagFXDiscovery.exe と LCSDiagFXCollector.exe がインストールされています。

## <a name="discover-environments"></a>環境を検出
1.  **開始**、**Microsoft Dynamics AX Lifecycle Services 診断サービス検索** の順にクリックします。
2.  **環境の検出** ウィンドウに、環境の名前と SQL Server のインスタンスとデータベースの完全修飾名を入力してから、**検出** をクリックします。
3.  ウィンドウの一番下にある **テストアクセス許可** ボタンをクリックします。![システム診断用のテストアクセス許可ボタン](./media/testpermissions.jpg) ページの下部にあります。
4.  **変更先フォルダ** ページで、システム診断によって収集されたログを保管する場所を入力し、**次** をクリックします。

## <a name="collect-data"></a>データを収集
必要に応じて **環境の検出** ウィンドウからデータを収集することができます。 定期的にデータを収集するジョブをスケジュールすることをお勧めします。 データ収集は、通常、5 ~ 15 分かかります。 データ収集中に発生したエラーは、Windows アプリケーション イベント ログと、インストール中に指定した場所のログ ファイルに記録されます。

1.  **環境の検出** ウィンドウで初期データ収集を実行するには、**今すぐ収集** をクリックします。 初めて環境を検出した直後に最初のコレクションを実行することをお勧めします。
2.  コレクション ジョブのスケジューリングに使用できるコレクション コマンドを生成するするには、**コレクション コマンドを生成** をクリックします。
3.  生成されたコマンドをクリップボードにコピーします。
4.  **Windows タスク スケジューラ** などのスケジュール エンジンを使用して実行するコマンドをスケジュール設定します。 **タスク スケジューラ** の使用の詳細については、[タスクのスケジュール](https://technet.microsoft.com/library/cc766428.aspx) を参照してください

## <a name="use-same-x509-certificate-for-all-environments"></a>すべての環境で同じ X509 証明書を使用する

1.  当初期間は、証明書を生成する設定を従来どおりにします
2.  MMC (Microsoft管理コンソール) を管理者として実行します。
3.  ファイル -&gt; **スナップインの追加または削除**
4.  **証明書** 項目をダブルクリックし、コンピューター アカウントと next-&gt;finish-&gt;ok を選択します。
5.  証明書 (ローカル コンピューター)-&gt;**個人**-&gt; 証明書を展開します。
6.  最初の手順 - &gt; すべてのタスク -&gt; エクスポート -&gt; 次へ -&gt; "**はい、プライベート キーをエクスポートします**" で生成された証明書を右クリックします。
7.  \*.pfx エクスポート設定で既定値のままにする
8.  セキュリティ ステップでは、エクスポートしたファイルを保護するためにドメイン アカウントまたはパスワードを使用します。
9.  次の手順でファイルをエキスポート
10. エクスポートしたファイルを新しい環境にコピーし、クリックして、**PFX のインストール** を選択します。
11. **ローカル コンピューター** を選択します。
12. 次へ -&gt; をクリックし、次の画面で、**このキーをエクスポート可能としてマーク** が設定されていることを確認します。 次へをクリックして終了
13. ここで、Lifecycle Services システム診断セットアップを実行している場合、新しい環境を選択して既存の証明書を使用します。
14. 最初の手順で生成された証明書は、クライアント証明書のルックアップに含まれており、それを選択して通常どおりに続行する必要があります:







[!INCLUDE[footer-include](../../../../includes/footer-banner.md)]
