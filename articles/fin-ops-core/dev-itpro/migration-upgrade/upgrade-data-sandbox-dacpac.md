---
title: AX 2012 からのアップグレード - レベル 2 からレベル 5 のサンドボックス環境でデータをアップグレードするための DACPAC プロセス
description: このトピックは、アップグレード時にサンドボックス環境へのリモート デスクトップ プロトコル (RDP) がないお客様を対象としています。
author: laneswenka
manager: AnnBe
ms.date: 12/02/2020
ms.topic: article
ms.prod: ''
ms.service: dynamics-ax-platform
ms.technology: ''
audience: Developer, IT Pro
ms.reviewer: sericks
ms.search.region: Global
ms.author: laswenka
ms.search.validFrom: 2017-06-16
ms.dyn365.ops.version: Platform update 20
ms.openlocfilehash: bdb22bcb8f7b52602d8eed19344c72a9f2346163
ms.sourcegitcommit: f8bac7ca2803913fd236adbc3806259a17a110f4
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 02/06/2021
ms.locfileid: "5128657"
---
# <a name="upgrade-from-ax-2012---dacpac-process-to-upgrade-data-in-sandbox-tiers-2-5-environments"></a><span data-ttu-id="a0f59-103">AX 2012 からのアップグレード - レベル 2 からレベル 5 のサンドボックス環境でデータをアップグレードするための DACPAC プロセス</span><span class="sxs-lookup"><span data-stu-id="a0f59-103">Upgrade from AX 2012 - Dacpac process to upgrade data in Sandbox Tiers 2-5 environments</span></span>

[!include [banner](../includes/banner.md)]

[!include [upgrade banner](../includes/upgrade-banner.md)]

<span data-ttu-id="a0f59-104">このトピックでは、Microsoft Dynamics AX 2012 から Finance and Operations アプリにアップグレードする際に、リモート デスクトップ プロトコル (RDP) を使用してレベル 2 からレベル 5 のサンドボックス環境にアクセスできなくなった顧客に役立つプロセス ガイドです。</span><span class="sxs-lookup"><span data-stu-id="a0f59-104">This topic is a process guide that will help customers who no longer have Remote Desktop Protocol (RDP) access to their Tier-2 through Tier-5 sandbox environments when they upgrade from Microsoft Dynamics AX 2012 to Finance and Operations apps.</span></span> <span data-ttu-id="a0f59-105">データ層アプリケーション パッケージ (DACPAC) に基づく新しいファイル形式と[データベース移動ツールキット](../database/database-movement-toolkit.md) を使用することで、AX 2012 のスキーマとデータをサンドボックス環境の既存の空のデータベースに取り込むことができます。</span><span class="sxs-lookup"><span data-stu-id="a0f59-105">By using a new file format this is based on data-tier application packages (DACPACs), and the [Database movement toolkit](../database/database-movement-toolkit.md), customers can bring their AX 2012 schema and data into an existing empty database in a sandbox environment.</span></span>

<span data-ttu-id="a0f59-106">共有サンドボックス環境で実行する前に、開発環境でデータ アップグレード プロセスを実行することを **強くお勧め** します。</span><span class="sxs-lookup"><span data-stu-id="a0f59-106">We **strongly recommend** that you run the data upgrade process in a development environment before you run it in a shared sandbox environment.</span></span> <span data-ttu-id="a0f59-107">この方法を使用すると、データを正常にアップグレードするために必要な時間全体を削減することができます。</span><span class="sxs-lookup"><span data-stu-id="a0f59-107">This approach will help reduce the overall time that is required for a successful data upgrade.</span></span> <span data-ttu-id="a0f59-108">詳細については[AX 2012からのアップグレード - データ アップグレードのためのアップグレード前のチェックリスト](prepare-data-upgrade.md) を参照してください。</span><span class="sxs-lookup"><span data-stu-id="a0f59-108">For more information, see [Upgrade from AX 2012 - Pre-upgrade checklist for data upgrade](prepare-data-upgrade.md).</span></span>

<span data-ttu-id="a0f59-109">このプロセス ガイドでは、次の手順を実行する方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="a0f59-109">In this process guide, you will learn how to complete the following steps:</span></span>

> [!div class="checklist"]
> * <span data-ttu-id="a0f59-110">サンドボックス環境データベースへのファイアウォールのアクセスを開放します。</span><span class="sxs-lookup"><span data-stu-id="a0f59-110">Open firewall access to your sandbox environment database.</span></span>
> * <span data-ttu-id="a0f59-111">すべてのオブジェクトのサンドボックス データベースを消去します。</span><span class="sxs-lookup"><span data-stu-id="a0f59-111">Clear the sandbox database of all objects.</span></span>
> * <span data-ttu-id="a0f59-112">スキーマを AX 2012 データベースからサンドボックス データベースに発行します。</span><span class="sxs-lookup"><span data-stu-id="a0f59-112">Publish the schema from your AX 2012 database to the sandbox database.</span></span>
> * <span data-ttu-id="a0f59-113">データをソース データベースからターゲット データベースに転送します。</span><span class="sxs-lookup"><span data-stu-id="a0f59-113">Transfer the data from the source database to the target database.</span></span>
> * <span data-ttu-id="a0f59-114">Microsoft Dynamics Lifecycle Services (LCS) からデータ アップグレード パッケージを適用します。</span><span class="sxs-lookup"><span data-stu-id="a0f59-114">Apply the data upgrade package from Microsoft Dynamics Lifecycle Services (LCS).</span></span>
> * <span data-ttu-id="a0f59-115">モック Go-Live 検証と実際の Go-Live で実稼働環境にデータベースをコピーします。</span><span class="sxs-lookup"><span data-stu-id="a0f59-115">Copy the database to production for mock go-live validation and actual go-live.</span></span>

## <a name="before-you-get-started"></a><span data-ttu-id="a0f59-116">開始する前に</span><span class="sxs-lookup"><span data-stu-id="a0f59-116">Before you get started</span></span>
<span data-ttu-id="a0f59-117">ネットワークの待機時間は、データ転送において重要なコンポーネントです。</span><span class="sxs-lookup"><span data-stu-id="a0f59-117">Network latency is a critical component in data transfer.</span></span> <span data-ttu-id="a0f59-118">ソース SQL Server が地理的に離れているか、サンドボックスの Azure データセンターへのネットワークの待機時間が不足している場合は、処理にさらに時間がかかるか、タイム アウトが発生する可能性があります。75 ミリ秒未満の待機時間が推奨されます。</span><span class="sxs-lookup"><span data-stu-id="a0f59-118">If your source SQL Server is geographically far away or has poor network latency to your sandbox Azure datacenter, then the process can take additional hours or potentially time out. Latency under 75 milliseconds is preferred.</span></span> <span data-ttu-id="a0f59-119">待機時間は、Azure Speed Test などのツールを使用して確認できます。</span><span class="sxs-lookup"><span data-stu-id="a0f59-119">You can find your latency using a tool such as Azure Speed Test.</span></span> <span data-ttu-id="a0f59-120">待機時間が不足している場合は、AX 2012 データベースをバックアップして、ターゲット サンドボックスと同じ Azure データセンターに配置した、クラウドでホストされている DevTest 環境に復元することを検討してください。</span><span class="sxs-lookup"><span data-stu-id="a0f59-120">If your latency is poor, you should consider backing up your AX 2012 database and restoring it on a cloud-hosted DevTest environment deployed to the same Azure datacenter as your target sandbox.</span></span> <span data-ttu-id="a0f59-121">その後、アップグレードの手順を実行できます。</span><span class="sxs-lookup"><span data-stu-id="a0f59-121">After which you can perform the upgrade steps.</span></span>

## <a name="open-firewall-access-to-your-sandbox-environment-database"></a><span data-ttu-id="a0f59-122">サンドボックス環境データベースへのファイアウォールのアクセスを開放する</span><span class="sxs-lookup"><span data-stu-id="a0f59-122">Open firewall access to your sandbox environment database</span></span>

<span data-ttu-id="a0f59-123">既定では、すべてのサンドボックス標準受け入れテスト環境でデータベース プラットフォームとして Azure SQL データベースを使用します。</span><span class="sxs-lookup"><span data-stu-id="a0f59-123">By default, all sandbox Standard Acceptance Test environments use Azure SQL Database as their database platform.</span></span> <span data-ttu-id="a0f59-124">このような環境のデータベースは、最初に配置された Application Object Server (AOS) へのアクセスを制限するファイアウォールによって保護されています。</span><span class="sxs-lookup"><span data-stu-id="a0f59-124">The databases for these environments are protected by firewalls that restrict access to the Application Object Server (AOS) that they were originally deployed with.</span></span>

<span data-ttu-id="a0f59-125">ただし、パブリック IP アドレスを使用して、ソース システムへのアクセスを許可することができます。</span><span class="sxs-lookup"><span data-stu-id="a0f59-125">However, your public IP address can be used to grant access to your source system.</span></span> <span data-ttu-id="a0f59-126">環境タイプと RDP アクセスに応じて、さまざまな方法でこのアクセス権を付与できます。</span><span class="sxs-lookup"><span data-stu-id="a0f59-126">Different methods can be used to grant this access, depending on your environment type and RDP access.</span></span> <span data-ttu-id="a0f59-127">方法に関係なく、データベースに接続するには、サーバーとデータベースを明示的に指定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="a0f59-127">Regardless of the method, connection to the database requires that the server and the database be explicitly specified.</span></span> <span data-ttu-id="a0f59-128">この情報については、LCS の環境の詳細ページを参照してください。</span><span class="sxs-lookup"><span data-stu-id="a0f59-128">You can find this information on the environment details page in LCS.</span></span> 

<span data-ttu-id="a0f59-129">ユーザー名レコード **axdbadmin** を検索して、**spartan-nam-opsprod365433\\DBOpsProd365_SandboxUAT_d2145fe** のような **{sqlServer\\sqlDatabase}** フォーマットでサーバーとデータベースを記録しておきます。</span><span class="sxs-lookup"><span data-stu-id="a0f59-129">Find the user name record for **axdbadmin**, and make a note of the server and the database in the format **{sqlServer\\sqlDatabase}**, such as **spartan-nam-opsprod365433\\DBOpsProd365_SandboxUAT_d2145fe**.</span></span> <span data-ttu-id="a0f59-130">この場合、Microsoft SQL Server Management Studio (SSMS) のサーバー値は **spartan-nam-opsprod365433.database.windows.net**、データベースの値は **DBOpsProd365_SandboxUAT_d2145fe** です。</span><span class="sxs-lookup"><span data-stu-id="a0f59-130">In this case, the server value for Microsoft SQL Server Management Studio (SSMS) is **spartan-nam-opsprod365433.database.windows.net**, and the database value is **DBOpsProd365_SandboxUAT_d2145fe**.</span></span> <span data-ttu-id="a0f59-131">データベースを指定するには、SSMS の接続ダイアログ ボックスの **オプション** を選択する必要があります。</span><span class="sxs-lookup"><span data-stu-id="a0f59-131">To specify the database, you must select **Options** in the SSMS connection dialog box.</span></span> <span data-ttu-id="a0f59-132">**axdbadmin** の資格情報 (ユーザー名とパスワード) を使用します。</span><span class="sxs-lookup"><span data-stu-id="a0f59-132">Use the **axdbadmin** credentials (user name and password).</span></span>

### <a name="microsoft-managed-environments-where-rdp-access-is-available"></a><span data-ttu-id="a0f59-133">RDP アクセスが利用可能な Microsoft が管理する環境</span><span class="sxs-lookup"><span data-stu-id="a0f59-133">Microsoft-managed environments where RDP access is available</span></span>

<span data-ttu-id="a0f59-134">サンドボックスへの RDP アクセスがある場合は、サンドボックス AOS 仮想マシン (VM) にサインインして、SSMS を開きます。</span><span class="sxs-lookup"><span data-stu-id="a0f59-134">If you have RDP access to your sandbox, sign in to the sandbox AOS virtual machine (VM), and open SSMS.</span></span> <span data-ttu-id="a0f59-135">SSMS で、サーバー、ユーザー名、およびパスワードを入力します。</span><span class="sxs-lookup"><span data-stu-id="a0f59-135">In SSMS, enter the server, user name, and password.</span></span> <span data-ttu-id="a0f59-136">**オプション** タブで、LCS の **axdbadmin** レコードから明示的にデータベース名を入力します。</span><span class="sxs-lookup"><span data-stu-id="a0f59-136">On the **Options** tab, explicitly enter the database name from the **axdbadmin** record in LCS.</span></span>

<span data-ttu-id="a0f59-137">接続したら、データベースに対してクエリを開き、次の Transact-SQL (T-SQL) コマンドで IP アドレスを入力します。</span><span class="sxs-lookup"><span data-stu-id="a0f59-137">After you're connected, open a query against the database, and enter your IP address in the following Transact-SQL (T-SQL) command.</span></span>

```sql
-- Create database-level firewall setting for IP a.b.c.d 
EXECUTE sp_set_database_firewall_rule N'AX 2012 Upgrade via RDP', 'a.b.c.d', 'a.b.c.d'; 
```

<span data-ttu-id="a0f59-138">ソース環境に戻って SSMS を開き、ユーザー受け入れテスト (UAT) データベースに対して同じ **axdbadmin** 資格情報を使用して接続を試みます。</span><span class="sxs-lookup"><span data-stu-id="a0f59-138">Back in your source environment, open SSMS, and try to connect by using the same **axdbadmin** credentials against the User Acceptance Testing (UAT) database.</span></span> <span data-ttu-id="a0f59-139">次の手順に進む前に接続できることを確認する必要があります。</span><span class="sxs-lookup"><span data-stu-id="a0f59-139">You must verify that you can connect before you move on to the next steps.</span></span>

<span data-ttu-id="a0f59-140">ファイアウォール ルールは、データベースを更新するとき、または LCS からデータベースをインポートするときに削除されることに注意してください。</span><span class="sxs-lookup"><span data-stu-id="a0f59-140">Note that firewall rules are deleted whenever you do a database refresh or whenever you do a database import from LCS.</span></span>

### <a name="microsoft-managed-environments-without-rdp-access"></a><span data-ttu-id="a0f59-141">RDP へのアクセスがない Microsoft が管理する環境</span><span class="sxs-lookup"><span data-stu-id="a0f59-141">Microsoft-managed environments without RDP access</span></span>

<span data-ttu-id="a0f59-142">[ジャストインタイム データベース アクセスの有効化](../database/database-just-in-time-JIT-access.md) のプロセスに従って、IP アドレスをデータベースの許可リストにします。</span><span class="sxs-lookup"><span data-stu-id="a0f59-142">Follow the process for [Enable just-in-time database access](../database/database-just-in-time-JIT-access.md) to allow-list your IP address to the database.</span></span>

<span data-ttu-id="a0f59-143">許可リスト エントリが期限切れになる前に、サーバー、ユーザー名、およびパスワードを入力してサンドボックス データベースに接続します。</span><span class="sxs-lookup"><span data-stu-id="a0f59-143">Before the allow-list entry expires, connect to the sandbox database by entering the server, user name, and password.</span></span> <span data-ttu-id="a0f59-144">**オプション** タブで、LCS の **axdbadmin** レコードから明示的にデータベース名を入力します。</span><span class="sxs-lookup"><span data-stu-id="a0f59-144">On the **Options** tab, explicitly enter the database name from the **axdbadmin** record in LCS.</span></span>

<span data-ttu-id="a0f59-145">接続したら、データベースに対してクエリを開き、次の Transact-SQL (T-SQL) コマンドで IP アドレスを入力します。</span><span class="sxs-lookup"><span data-stu-id="a0f59-145">After you're connected, open a query against the database, and enter your IP address in the following Transact-SQL (T-SQL) command.</span></span>

```sql
-- Create database-level firewall setting for IP a.b.c.d 
EXECUTE sp_set_database_firewall_rule N'AX 2012 Upgrade without RDP', 'a.b.c.d', 'a.b.c.d'; 
```

<span data-ttu-id="a0f59-146">ファイアウォール ルールに 2 番目のエントリが作成されます。</span><span class="sxs-lookup"><span data-stu-id="a0f59-146">A second entry is created in the firewall rules.</span></span> <span data-ttu-id="a0f59-147">このエントリは期限切れになりません。</span><span class="sxs-lookup"><span data-stu-id="a0f59-147">This entry won't expire.</span></span> <span data-ttu-id="a0f59-148">これらのファイアウォール ルールは、データベースを更新するとき、または LCS からデータベースをインポートするときに削除されることに注意してください。</span><span class="sxs-lookup"><span data-stu-id="a0f59-148">Note that these firewall rules are deleted whenever you do a database refresh or whenever you do a database import from LCS.</span></span>

### <a name="self-service-environments"></a><span data-ttu-id="a0f59-149">セルフサービス環境</span><span class="sxs-lookup"><span data-stu-id="a0f59-149">Self-service environments</span></span>

<span data-ttu-id="a0f59-150">AX 2012 のアップグレード シナリオでは、サンドボックス環境はサポートされていません。これは、サンドボックス環境では現在、データ アップグレード パッケージがサポートされていないためです。</span><span class="sxs-lookup"><span data-stu-id="a0f59-150">Unfortunately, sandbox environments of the self-service type aren't supported for AX 2012 upgrade scenarios, because they don't currently support data upgrade packages.</span></span> <span data-ttu-id="a0f59-151">Microsoft は、このサポートの追加に取り組んでおり、詳細情報が得られ次第、このトピックを更新します。</span><span class="sxs-lookup"><span data-stu-id="a0f59-151">Microsoft is working to add this support and will update this topic when more information is available.</span></span>

## <a name="clear-the-sandbox-database-of-all-objects"></a><span data-ttu-id="a0f59-152">すべてのオブジェクトのサンドボックス データベースを消去する</span><span class="sxs-lookup"><span data-stu-id="a0f59-152">Clear the sandbox database of all objects</span></span>

<span data-ttu-id="a0f59-153">これは、バージョン 5 以前の [データベース移動ツールキット](../database/database-movement-toolkit.md) では、顧客がターゲット データベースの SSMS を通じて行う必要がある明示的な手順でした。</span><span class="sxs-lookup"><span data-stu-id="a0f59-153">In versions of the [Database movement toolkit](../database/database-movement-toolkit.md) prior to Version 5, this was an explicit step that customers had to take via SSMS on the target database.</span></span> <span data-ttu-id="a0f59-154">ただし、これはバージョン 5 以降のツールキットに組み込まれており、PowerShell スクリプトを使用して処理されます。</span><span class="sxs-lookup"><span data-stu-id="a0f59-154">However, this is now incorporated into the toolkit in Version 5 and later, and is handled via the PowerShell scripts.</span></span>

## <a name="publish-the-schema-from-ax-2012-to-the-sandbox-database"></a><span data-ttu-id="a0f59-155">スキーマを AX 2012 からサンドボックス データベースに発行する</span><span class="sxs-lookup"><span data-stu-id="a0f59-155">Publish the schema from AX 2012 to the sandbox database</span></span>

<span data-ttu-id="a0f59-156">データベースが空になったため、アップグレードされていない 2012 スキーマを発行できます。</span><span class="sxs-lookup"><span data-stu-id="a0f59-156">Now that the database is empty, you can publish your non-upgraded 2012 schema.</span></span> <span data-ttu-id="a0f59-157">このステップでは、最新バージョンの[データベース移動ツールキット](../database/database-movement-toolkit.md) をソース環境にダウンロードする必要があります。</span><span class="sxs-lookup"><span data-stu-id="a0f59-157">For this step, you should download the latest version of the [Database movement toolkit](../database/database-movement-toolkit.md) into your source environment.</span></span>

<span data-ttu-id="a0f59-158">Windows PowerShell tを使用して、データベース移動ツールキット (たとえば、C:\\dbmovement-toolkit\\) を展開したフォルダーの場所にディレクトリを変更します。</span><span class="sxs-lookup"><span data-stu-id="a0f59-158">Use Windows PowerShell to change the directory to the folder location where you unzipped the Database movement toolkit (for example, C:\\dbmovement-toolkit\\).</span></span> <span data-ttu-id="a0f59-159">その後、**AX2012SchemaPublish.ps1** スクリプトを実行します。</span><span class="sxs-lookup"><span data-stu-id="a0f59-159">Then run the **AX2012SchemaPublish.ps1** script.</span></span> <span data-ttu-id="a0f59-160">次のパラメーターを使用します。</span><span class="sxs-lookup"><span data-stu-id="a0f59-160">Use the following parameters:</span></span>

* <span data-ttu-id="a0f59-161">**SourceServerName** – ソース AX 2012 データベースがホストされる場所。</span><span class="sxs-lookup"><span data-stu-id="a0f59-161">**SourceServerName** – The location where your source AX 2012 database is hosted.</span></span> <span data-ttu-id="a0f59-162">この場所は **localhost** にすることができます。</span><span class="sxs-lookup"><span data-stu-id="a0f59-162">This location can be **localhost**.</span></span>
* <span data-ttu-id="a0f59-163">**AX2012DBName** – AX 2012 データベースの名前 (たとえば、**MicrosoftDynamicsAX**)。</span><span class="sxs-lookup"><span data-stu-id="a0f59-163">**AX2012DBName** – The name of your AX 2012 database (for example, **MicrosoftDynamicsAX**).</span></span>
* <span data-ttu-id="a0f59-164">**TargetServerName** – サンドボックス データベース サーバーのサーバー値 (たとえば、**spartan-srv-12345.database.windows.net**)。</span><span class="sxs-lookup"><span data-stu-id="a0f59-164">**TargetServerName** – The server value of your sandbox database server (for example, **spartan-srv-12345.database.windows.net**).</span></span> <span data-ttu-id="a0f59-165">前のステップでこの値を取得しています。</span><span class="sxs-lookup"><span data-stu-id="a0f59-165">You retrieved this value in a previous step.</span></span>
* <span data-ttu-id="a0f59-166">**TargetDBName** – AXDB データベースの名前 (たとえば、**d365opsprod-12345**)。</span><span class="sxs-lookup"><span data-stu-id="a0f59-166">**TargetDBName** – The name of your AXDB database (for example, **d365opsprod-12345**).</span></span> <span data-ttu-id="a0f59-167">前のステップでこの値を取得しています。</span><span class="sxs-lookup"><span data-stu-id="a0f59-167">You retrieved this value in a previous step.</span></span>
* <span data-ttu-id="a0f59-168">**AxDBAdminPassword** – **axdbadmin** データベース アカウントのパスワード。</span><span class="sxs-lookup"><span data-stu-id="a0f59-168">**AxDBAdminPassword** – The password for the **axdbadmin** database account.</span></span>

![AX2012SchemaPublish.ps1 スクリプトの実行中](media/upgrade-dacpac-extract.png)

<span data-ttu-id="a0f59-170">実行時に、スクリプトによってソース データベースとターゲット データベースのクリーンアップが実行されます。</span><span class="sxs-lookup"><span data-stu-id="a0f59-170">During execution, the script performs a cleanup on the source and target databases.</span></span> <span data-ttu-id="a0f59-171">ソース データベースについては、必須ではないユーザーおよびスキーマを削除します。</span><span class="sxs-lookup"><span data-stu-id="a0f59-171">For the source database, it removes any non-essential users and non-essential schemas.</span></span> <span data-ttu-id="a0f59-172">エラーがある場合はスクリプトを停止し、エラーを確認する必要があります。</span><span class="sxs-lookup"><span data-stu-id="a0f59-172">If there are errors, it will stop the script and those errors will need to be reviewed.</span></span> <span data-ttu-id="a0f59-173">スクリプトのソースは、**Step1_CleanupSourceDB.sql** と呼ばれるツールキットで利用可能です。</span><span class="sxs-lookup"><span data-stu-id="a0f59-173">The source for the script is available in the toolkit called **Step1_CleanupSourceDB.sql**.</span></span> <span data-ttu-id="a0f59-174">ターゲット データベースについては、以前に SSMS を通じてドキュメント化した場合よりも入念な方法ですべてのオブジェクトが削除されます。</span><span class="sxs-lookup"><span data-stu-id="a0f59-174">For the target database, it removes all objects in a more thorough manner than was previously documented via SSMS.</span></span> <span data-ttu-id="a0f59-175">エラーを確認して、スクリプトを停止する必要があります。</span><span class="sxs-lookup"><span data-stu-id="a0f59-175">Any errors will need to be reviewed, and would stop the script.</span></span> <span data-ttu-id="a0f59-176">ターゲット クリーンアップのソースは、**Step0_CleanupTargetDB.sql** と呼ばれるツールキットで利用可能です。</span><span class="sxs-lookup"><span data-stu-id="a0f59-176">The source for the target cleanup is available in the toolkit called **Step0_CleanupTargetDB.sql**.</span></span>

<span data-ttu-id="a0f59-177">クリーンアップ後に、ツールキットは SqlPackage.exe を使用して、AX 2012 データベースからデータベースとスキーマの定義のみを 2012DBSource.dacpac ファイルとして作業ディレクトリに抽出します。</span><span class="sxs-lookup"><span data-stu-id="a0f59-177">After cleanup, the toolkit uses SqlPackage.exe to extract only the database and schema definitions from your AX 2012 database as a 2012DBSource.dacpac file in the working directory.</span></span> <span data-ttu-id="a0f59-178">次に、データベース移動ツールキットに含まれている Profile.publish.xml 発行プロファイルを使用して、このファイルをサンドボックス環境に発行します。</span><span class="sxs-lookup"><span data-stu-id="a0f59-178">Next, it publishes this file to your sandbox environment by using the Profile.publish.xml publishing profile that is included in the Database movement toolkit.</span></span> <span data-ttu-id="a0f59-179">この発行プロファイルでは、アップグレードに必要のない、SQL ビュー、SQL ユーザー、統計情報などのいくつかのオブジェクトの種類がスキップされます。</span><span class="sxs-lookup"><span data-stu-id="a0f59-179">This publishing profile will skip several object types, such as SQL views, SQL users, statistics, and other objects that aren't required for the upgrade.</span></span> <span data-ttu-id="a0f59-180">dacpac 発行に問題がある場合は、**PublishDiag.log** という名前の作業ディレクトリにある詳細ログを参照できます。</span><span class="sxs-lookup"><span data-stu-id="a0f59-180">If there are issues with the dacpac publish, you can find a detailed log in the working directory called **PublishDiag.log**.</span></span>

<span data-ttu-id="a0f59-181">スクリプトの実行が完了したら、SSMS を開いて、サンドボックス データベースにテーブルが表示されていることを確認します。</span><span class="sxs-lookup"><span data-stu-id="a0f59-181">When the script has finished running, open SSMS, and verify that you can see the tables in the sandbox database.</span></span> <span data-ttu-id="a0f59-182">また、テーブルが空であり、データがないことを確認します。</span><span class="sxs-lookup"><span data-stu-id="a0f59-182">Also confirm that the tables are empty and have no data.</span></span>

> [!NOTE]
> <span data-ttu-id="a0f59-183">エラーのために最初からやり直す必要がある場合、このスクリプトは、ソース データベースとターゲット データベースの両方をクリーンアップするので、再度実行するように設計されています。</span><span class="sxs-lookup"><span data-stu-id="a0f59-183">If you must start over because of an error, this script is designed to be run again as it will clean up both the source and target databases.</span></span>

### <a name="populate-legacy-stored-procedures"></a><span data-ttu-id="a0f59-184">レガシー ストアド プロシージャの設定</span><span class="sxs-lookup"><span data-stu-id="a0f59-184">Populate legacy stored procedures</span></span> 
<span data-ttu-id="a0f59-185">データ アップグレード スクリプトでは、アップグレードを実行する前に、レガシー ストアド プロシージャと関数を用意しておく必要があります。</span><span class="sxs-lookup"><span data-stu-id="a0f59-185">The data upgrade scripts require the legacy stored procedures and functions to be in place prior to running the upgrade.</span></span> <span data-ttu-id="a0f59-186">これらのスクリプトを転送するには、SSMS を使用します。</span><span class="sxs-lookup"><span data-stu-id="a0f59-186">To transfer these scripts use SSMS.</span></span>

<span data-ttu-id="a0f59-187">SSMS を開き、ソース AX 2012 データベースに接続します。</span><span class="sxs-lookup"><span data-stu-id="a0f59-187">Open SSMS, and connect to your source AX 2012 database.</span></span> <span data-ttu-id="a0f59-188">データベース名を右クリックして、**タスク > スクリプトの生成** を選択します。</span><span class="sxs-lookup"><span data-stu-id="a0f59-188">Right-click the database name, and then select **Tasks > Generate scripts**.</span></span> <span data-ttu-id="a0f59-189">**概要** ページで、**次へ** を選択します。</span><span class="sxs-lookup"><span data-stu-id="a0f59-189">On the **Introduction** page, select **Next**.</span></span> <span data-ttu-id="a0f59-190">**オブジェクトの選択** ページで、**特定のデータベース オブジェクトを選択する** オプションを選択してから、次のチェック ボックスを選択します。</span><span class="sxs-lookup"><span data-stu-id="a0f59-190">On the **Choose Objects** page, select the **Select specific database objects** option, and then select the following check boxes:</span></span>

* <span data-ttu-id="a0f59-191">ストアド プロシージャ</span><span class="sxs-lookup"><span data-stu-id="a0f59-191">Stored procedures</span></span>
* <span data-ttu-id="a0f59-192">ユーザー定義の関数</span><span class="sxs-lookup"><span data-stu-id="a0f59-192">User-defined functions</span></span>

<span data-ttu-id="a0f59-193">**スクリプティング オプションの設定** ページで、**詳細** を選択してから、値が **DROP および CREATE のスクリプト** に設定されていることを確認します。</span><span class="sxs-lookup"><span data-stu-id="a0f59-193">On the **Set Scripting Options** page, select **Advanced**, and ensure the value is set to **Script DROP and CREATE**.</span></span> <span data-ttu-id="a0f59-194">**OK** を選択してから、**新しいクエリ ウィンドウに保存** を選択します。</span><span class="sxs-lookup"><span data-stu-id="a0f59-194">Select **OK**, and then select **Save to new query window**.</span></span> <span data-ttu-id="a0f59-195">**次へ** を選択して概要へ移動します。</span><span class="sxs-lookup"><span data-stu-id="a0f59-195">Select **Next** to move through the summary.</span></span> <span data-ttu-id="a0f59-196">表示されるクエリ ウィンドウには、オブジェクトをデータベースから削除できるように、すべてのオブジェクトを正しい順序で一覧表示するスクリプトが含まれています。</span><span class="sxs-lookup"><span data-stu-id="a0f59-196">The query window that appears contains a script that lists all the objects in the correct order so that the objects can be dropped from the database.</span></span>

<span data-ttu-id="a0f59-197">生成されたスクリプトを使用して、SSMS を使用してターゲット データベースに接続し、スクリプトを実行します。</span><span class="sxs-lookup"><span data-stu-id="a0f59-197">Using the script that was generated, connect to your target database using SSMS, and execute the script.</span></span> <span data-ttu-id="a0f59-198">これにより、ターゲットの spartan データベースに AX 2012 ストアド プロシージャと関数が作成されます。</span><span class="sxs-lookup"><span data-stu-id="a0f59-198">This will create the AX 2012 stored procedures and functions in the target spartan database.</span></span>  

## <a name="transfer-data-from-ax-2012-to-the-sandbox-database"></a><span data-ttu-id="a0f59-199">AX 2012 からサンドボックス データベースにデータを転送する</span><span class="sxs-lookup"><span data-stu-id="a0f59-199">Transfer data from AX 2012 to the sandbox database</span></span>

<span data-ttu-id="a0f59-200">スキーマの配置が完了したら、データをターゲッ トテーブルに転送する必要があります。</span><span class="sxs-lookup"><span data-stu-id="a0f59-200">Now that the schema is in place, you must transfer the data to the target tables.</span></span> <span data-ttu-id="a0f59-201">この転送には、SQL にリンクされているサーバーが使用されます。</span><span class="sxs-lookup"><span data-stu-id="a0f59-201">A SQL-linked server will be used for this transfer.</span></span> <span data-ttu-id="a0f59-202">転送では、データベース移動ツールキットに含まれている Windows PowerShell バージョン 7.0 以降のインスタンスで使用可能な並列処理機能も利用されます。</span><span class="sxs-lookup"><span data-stu-id="a0f59-202">The transfer will also take advantage of parallelism features that are available in the instance of Windows PowerShell version 7.0 or later that is included in the Database Movement toolkit.</span></span>

<span data-ttu-id="a0f59-203">Windows PowerShell tを使用して、データベース移動ツールキット (たとえば、C:\\dbmovement-toolkit\\) を展開したフォルダーの場所にディレクトリを変更します。</span><span class="sxs-lookup"><span data-stu-id="a0f59-203">Use Windows PowerShell to change the directory to the folder location where you unzipped the Database movement toolkit (for example, C:\\dbmovement-toolkit\\).</span></span> <span data-ttu-id="a0f59-204">その後、**AX2012DataTransfer.ps1** スクリプトを実行します。</span><span class="sxs-lookup"><span data-stu-id="a0f59-204">Then run the **AX2012DataTransfer.ps1** script.</span></span> <span data-ttu-id="a0f59-205">次のパラメーターを使用します。</span><span class="sxs-lookup"><span data-stu-id="a0f59-205">Use the following parameters:</span></span>

* <span data-ttu-id="a0f59-206">**SourceServerName** – ソース AX 2012 データベースがホストされる場所。</span><span class="sxs-lookup"><span data-stu-id="a0f59-206">**SourceServerName** – The location where your source AX 2012 database is hosted.</span></span> <span data-ttu-id="a0f59-207">この場所は **localhost** にすることができます。</span><span class="sxs-lookup"><span data-stu-id="a0f59-207">This location can be **localhost**.</span></span>
* <span data-ttu-id="a0f59-208">**AX2012DBName** – AX 2012 データベースの名前 (たとえば、**MicrosoftDynamicsAX**)。</span><span class="sxs-lookup"><span data-stu-id="a0f59-208">**AX2012DBName** – The name of your AX 2012 database (for example, **MicrosoftDynamicsAX**).</span></span>
* <span data-ttu-id="a0f59-209">**TargetServerName** – サンドボックス データベース サーバーのサーバー値 (たとえば、**spartan-srv-12345.database.windows.net**)。</span><span class="sxs-lookup"><span data-stu-id="a0f59-209">**TargetServerName** – The server value of your sandbox database server (for example, **spartan-srv-12345.database.windows.net**).</span></span> <span data-ttu-id="a0f59-210">前のステップでこの値を取得しています。</span><span class="sxs-lookup"><span data-stu-id="a0f59-210">You retrieved this value in a previous step.</span></span>
* <span data-ttu-id="a0f59-211">**TargetDBName** – AXDB データベースの名前 (たとえば、d365opsprod-12345)。</span><span class="sxs-lookup"><span data-stu-id="a0f59-211">**TargetDBName** – The name of your AXDB database (for example, d365opsprod-12345).</span></span> <span data-ttu-id="a0f59-212">前のステップでこの値を取得しています。</span><span class="sxs-lookup"><span data-stu-id="a0f59-212">You retrieved this value in a previous step.</span></span>
* <span data-ttu-id="a0f59-213">**AxDBAdminPassword** – axdbadmin データベース アカウントのパスワード。</span><span class="sxs-lookup"><span data-stu-id="a0f59-213">**AxDBAdminPassword** – The password for the axdbadmin database account.</span></span>
* <span data-ttu-id="a0f59-214">**LinkedServerName** – 作成する SQL にリンクされているサーバーの名前 (たとえば、**AX2012Link**)。</span><span class="sxs-lookup"><span data-stu-id="a0f59-214">**LinkedServerName** – The name of the SQL-linked server to create (for example, **AX2012Link**).</span></span>
* <span data-ttu-id="a0f59-215">**DegreeOfParallelism** – 並列処理する必要があるテーブルの数 (たとえば、**3**)。</span><span class="sxs-lookup"><span data-stu-id="a0f59-215">**DegreeOfParallelism** – The number of tables that should be processed in parallel (for example, **3**).</span></span> <span data-ttu-id="a0f59-216">このスクリプトは CPU および RAM に非常に負荷がかかるため、この値はソース環境で使用できるコアの数の半分以下である必要があります。</span><span class="sxs-lookup"><span data-stu-id="a0f59-216">The value should be no more than half of the number of cores that are available in the source environment, because the script is CPU-intensive and RAM-intensive.</span></span>

![AX2012DataTransfer.ps1 スクリプトを実行中](media/upgrade-dacpac-xfer.png)

<span data-ttu-id="a0f59-218">実行中に、ソース サーバーとサンドボックス サーバー間のリンクされているサーバーがまだ存在していない場合は、スクリプトによって作成されます。</span><span class="sxs-lookup"><span data-stu-id="a0f59-218">During execution, if a linked server between the source server and the sandbox server doesn't already exist, the script creates one.</span></span> <span data-ttu-id="a0f59-219">次に、すべての AX 2012 テーブルのデータをターゲット データベースにコピーします。</span><span class="sxs-lookup"><span data-stu-id="a0f59-219">It then copies data from all the AX 2012 tables to the target database.</span></span> <span data-ttu-id="a0f59-220">**DegreeOfParallelism** パラメーターを使用して、同時複数のテーブルを処理します。</span><span class="sxs-lookup"><span data-stu-id="a0f59-220">It uses the **DegreeOfParallelism** parameter to process multiple tables at the same time.</span></span>

> [!NOTE]
> <span data-ttu-id="a0f59-221">エラーのために最初からやり直す必要がある場合は、[スキーマを AX 2012 からサンドボックス データベースに発行する](#publish-the-schema-from-ax-2012-to-the-sandbox-database) のステップに戻ります。</span><span class="sxs-lookup"><span data-stu-id="a0f59-221">If you must start over because of an error, go back to the [Publish the schema from AX 2012 to the sandbox database](#publish-the-schema-from-ax-2012-to-the-sandbox-database) step.</span></span>

## <a name="apply-the-data-upgrade-package-from-lcs"></a><span data-ttu-id="a0f59-222">LCS からデータ アップグレード パッケージを適用する</span><span class="sxs-lookup"><span data-stu-id="a0f59-222">Apply the data upgrade package from LCS</span></span>

<span data-ttu-id="a0f59-223">スキーマとデータがサンドボックス環境に移動されたので、データ アップグレード プロセスを開始できます。</span><span class="sxs-lookup"><span data-stu-id="a0f59-223">Now that the schema and the data have been moved to the sandbox environment, you can start the data upgrade process.</span></span> <span data-ttu-id="a0f59-224">前提条件として、LCS プロジェクトが AX 2012 アップグレード用に構成されていることを確認してください。</span><span class="sxs-lookup"><span data-stu-id="a0f59-224">As a prerequisite, make sure that your LCS project has been configured for AX 2012 upgrade.</span></span> <span data-ttu-id="a0f59-225">詳細については、「[AX 2012 のアップグレードとしてプロジェクトを認識する](upgrade-overview-2012.md#identify-the-project-as-an-ax-2012-upgrade)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="a0f59-225">For more information, see [Identify the project as an AX 2012 upgrade](upgrade-overview-2012.md#identify-the-project-as-an-ax-2012-upgrade).</span></span>

<span data-ttu-id="a0f59-226">環境の環境の詳細ページで、**メンテナンス** \> **更新プログラムの適用** を選択して、読み込まれるパッケージの一覧が表示されるまで待ちます。</span><span class="sxs-lookup"><span data-stu-id="a0f59-226">On the environment details page for your environment, select **Maintain** \> **Apply updates**, and wait for the list of packages to be loaded.</span></span> <span data-ttu-id="a0f59-227">一覧の一番下までスクロールすると、共有アセット ライブラリから取得されたデータ アップグレード パッケージが一覧に追加されたことを確認できます。</span><span class="sxs-lookup"><span data-stu-id="a0f59-227">If you scroll to the bottom of the list, you will see that data upgrade packages are added to it as they are pulled in from the Shared asset library.</span></span> <span data-ttu-id="a0f59-228">すべての利用可能なアップグレード パッケージが読み込まれるまでにしばらく時間がかかる場合があります。</span><span class="sxs-lookup"><span data-stu-id="a0f59-228">It might take some time for all the available upgrade packages to be loaded.</span></span>

<span data-ttu-id="a0f59-229">アップグレード先となるバージョンに一致するアップグレード パッケージを選択します。</span><span class="sxs-lookup"><span data-stu-id="a0f59-229">Select the upgrade package that matches the version that you want to upgrade to.</span></span> <span data-ttu-id="a0f59-230">たとえば、バージョン 10.0.14 にアップグレードするには、**AX2012DataUpgrade-10-0-14** を選択します。</span><span class="sxs-lookup"><span data-stu-id="a0f59-230">For example, to upgrade to version 10.0.14, select **AX2012DataUpgrade-10-0-14**.</span></span>

### <a name="troubleshooting-data-upgrade-errors"></a><span data-ttu-id="a0f59-231">データ アップグレードのエラーに関するトラブルシューティング</span><span class="sxs-lookup"><span data-stu-id="a0f59-231">Troubleshooting data upgrade errors</span></span>

<span data-ttu-id="a0f59-232">データ アップグレードのエラーをトラブルシューティングするには、いくつかの方法があります。</span><span class="sxs-lookup"><span data-stu-id="a0f59-232">There are several ways to troubleshoot data upgrade errors.</span></span> <span data-ttu-id="a0f59-233">場合によっては、LCS から配置可能パッケージ ログのエラーを表示できます。</span><span class="sxs-lookup"><span data-stu-id="a0f59-233">In some cases, you can view the error in the deployable package logs from LCS.</span></span> <span data-ttu-id="a0f59-234">たとえば、エラーがサービスの開始と停止およびデータベースの同期に関連している場合は、この方法を使用できます。</span><span class="sxs-lookup"><span data-stu-id="a0f59-234">For example, you can use this approach when the error is related to starting/stopping services and database synchronization.</span></span>

<span data-ttu-id="a0f59-235">アップグレード スクリプトの実行中にアップグレードに失敗した場合は、サンドボックス データベースの ReleaseUpdateScriptsErrorLog テーブルにエラーが表示されます。</span><span class="sxs-lookup"><span data-stu-id="a0f59-235">If the upgrade fails while an upgrade script is running, you can view the errors in the ReleaseUpdateScriptsErrorLog table in the sandbox database.</span></span> <span data-ttu-id="a0f59-236">このテーブルにアクセスするには、前の手順の情報を使用してサンドボックス データベースに接続します。</span><span class="sxs-lookup"><span data-stu-id="a0f59-236">To access this table, connect to the sandbox database by using the information in previous steps.</span></span>

<span data-ttu-id="a0f59-237">データを修正できる場合は、LCS からのアップグレードを再開できます。</span><span class="sxs-lookup"><span data-stu-id="a0f59-237">If you can fix the data, you can resume the upgrade from LCS.</span></span> <span data-ttu-id="a0f59-238">ただし、LCS からは 8 回を超えると再開できないことに注意してください。</span><span class="sxs-lookup"><span data-stu-id="a0f59-238">However, note that you can't resume from LCS more than eight times.</span></span> <span data-ttu-id="a0f59-239">サービス システムではそれ以上の試行が許可されないため、8 回以上再開しようとすると別のエラーが発生します。</span><span class="sxs-lookup"><span data-stu-id="a0f59-239">Any attempt to resume more than eight times will cause another failure, because the servicing systems don't allow more attempts.</span></span> <span data-ttu-id="a0f59-240">この場合は、**中止** ボタンを使用してアップグレード パッケージをキャンセルし、後でもう一度やり直すことができます。</span><span class="sxs-lookup"><span data-stu-id="a0f59-240">In this case, you can use the **Abort** button to cancel the upgrade package and try again later.</span></span>

> [!NOTE]
> <span data-ttu-id="a0f59-241">エラーのために最初からやり直す必要がある場合は、[スキーマを AX 2012 からサンドボックス データベースに発行する](#publish-the-schema-from-ax-2012-to-the-sandbox-database) のステップに戻ります。</span><span class="sxs-lookup"><span data-stu-id="a0f59-241">If you must start over because of an error, go back to the [Publish the schema from AX 2012 to the sandbox database](#publish-the-schema-from-ax-2012-to-the-sandbox-database) step.</span></span>

## <a name="copy-the-database-to-production-for-mock-go-live-and-actual-go-live"></a><span data-ttu-id="a0f59-242">モック Go-Live と実際の Go-Live で実稼働環境にデータベースをコピーする</span><span class="sxs-lookup"><span data-stu-id="a0f59-242">Copy the database to production for mock go-live and actual go-live</span></span>

<span data-ttu-id="a0f59-243">データのアップグレードが完了したら、サンドボックス環境の同じカスタマイズ パッケージを実稼働環境に適用します。</span><span class="sxs-lookup"><span data-stu-id="a0f59-243">After the data upgrade is completed, apply the same customization packages from your sandbox environment to your production environment.</span></span> <span data-ttu-id="a0f59-244">その後、サンドボックス環境の AXDB データベースを実稼働環境にコピーすることができます。</span><span class="sxs-lookup"><span data-stu-id="a0f59-244">You can then copy your sandbox environment AXDB database to the production environment.</span></span>

<span data-ttu-id="a0f59-245">コピー操作の実行方法については、「[サンドボックス データベースを実稼働環境にコピーする](../database/dbmovement-scenario-goldenconfig.md#copy-the-sandbox-database-to-production)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="a0f59-245">For information about how to perform the copy operation, see [Copy the sandbox database to production](../database/dbmovement-scenario-goldenconfig.md#copy-the-sandbox-database-to-production).</span></span>
