---
title: AX 2012 からのアップグレード - セルフサービス環境のデータ アップグレード
description: この記事では、セルフサービス環境で Microsoft Dynamics AX 2012 からデータ アップグレードを行う方法について説明します。
author: veeravendhan-s
ms.date: 05/05/2022
ms.topic: article
audience: IT Pro
ms.reviewer: sericks
ms.search.region: Global
ms.author: vesakkar
ms.search.validFrom: 2021-06-30
ms.openlocfilehash: ebbb105409070605bd513ac81fce5c1a465fec52
ms.sourcegitcommit: 873d66c03a51ecb7082e269f30f5f980ccd9307f
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/06/2022
ms.locfileid: "9124046"
---
# <a name="upgrade-from-ax-2012---data-upgrade-in-self-service-environments"></a>AX 2012 からのアップグレード - セルフサービス環境のデータ アップグレード

[!include[banner](../includes/banner.md)]

この Microsoft Dynamics AX 2012 データ アップグレード プロセスは、セルフ サービスの環境向けです。 この記事のセクションを次の順序で完了します。

1. **[必要条件](data-upgrade-self-service.md#prerequisites)**
2. **[データ アップグレード プロセス](data-upgrade-self-service.md#data-upgrade-process)** – AX2012DataUpgradeToolKit.exe アプリケーションを実行し、更新プロセスを完了します。
3. **[アプリケーションのレポート セクション](data-upgrade-self-service.md#reporting-section-of-the-application)** – レプリケーションの検証、レプリケーション ステータス、データ アップグレード ステータス、およびデータ アップグレード ステータスのロールバックに関するレポートをレビューします。
4. **[アプリケーションのツール セクション](data-upgrade-self-service.md#tooling-section-of-the-application)**  – このセクションでは、プロセス パラメータをリセットし、いずれかのプロセスを再起動します。

## <a name="prerequisites"></a>必要条件

1. Microsoft Dynamics Lifecycle Services (LCS) から、**AX 2012 Database Upgrade Toolkit for Dynamics 365** をダウンロードします。 共有資産ライブラリで、資産タイプとして **モデル** を選び、モデル ファイルを選択します。
2. LCS のセルフ サービス環境を作成します。 この環境は、**配置済み** 状態である必要があります。 Microsoft が管理する環境である必要があります。 クラウド ホスト型開発環境は、[AX 2012 年からのアップグレード - 開発環境でのデータ アップグレード](data-upgrade-2012.md)としてのみ使用できます。

> [!NOTE]
> 次の点に注意してください:
> 
> - Microsoft Dynamics AX 2012 データのアップグレード プロセスは、財務と運用のセルフ サービス、サンドボックス (UAT) 環境専用です。 運用環境に対して実行することは出来ません。
> - **AX 2012 Database Upgrade Toolkit for Dynamics 365** の最新バージョンを LCS からダウンロードしてください。
> - AX 2012 データ更新用にリンクされた Power Platform を配置または使用しないでください。 Power Platform 環境は、データ アップグレードの完了後に配置して使用できます。

4. まだインストールされていない場合は、[.NET Framework version 4.7.1](https://dotnet.microsoft.com/download/dotnet-framework/net471) をダウンロードし、インストールします。
5. レプリケーション機能がインストールされ、ソース SQL Server インスタンスに対して有効になっていることを確認します。 レプリケーションが有効かどうかを確認するには、次の SQL スクリプトを実行します。

    ```sql
    -- If @installed is 0, replication must be added to the SQL Server installation.

    USE master;

    GO

    DECLARE @installed int;

    EXEC @installed = sys.sp_MS_replication_installed;

    SELECT @installed;
    ```

    レプリケーション コンポーネントがインストールされていない場合は、[SQL Server レプリケーションのインストール](/sql/database-engine/install-windows/install-sql-server-replication)の手順に従いインストールします。

5. ソース データベース サーバーで SQL Server Agent を有効にして起動します。

    > [!NOTE]
    > ユーザーはソース データベースで **DB\_Owner** 権限を持ち、マスター データベースおよびソース データベースにアクセスできる必要があります。

6. **Migration Toolkit の設定:** ソース データベース テーブルの一部をターゲット データベースに複製しない場合は、IgnoreTables.xml ファイルでそれらを指定できます。 同様に、一部の関数を複製しない場合は、IgnoreFunctions.xml ファイルでそれらを指定できます。

    - **IgnoreTables.xml ファイルのパス:** Data\\IgnoreTables.xml
    - **IgnoreFunctions.xml ファイルのパス:** Data\\IgnoreFunctions.xml

    次の例は、XML ファイルのテーブルおよび関数を指定する方法を示しています。

    ```xml
    <?xml version="1.0" encoding="utf-8"?>
    <IgnoreTables>
        <Name>
            <Table>NON_AOT_TABLE1</Table>
            <Table>NON_AOT_TABLE2</Table>
            <Table>NON_AOT_TABLE3</Table>
        </Name>
    </IgnoreTables>
    ```

    > [!NOTE]
    > Ignore リストに追加するテーブルは、Microsoft Dynamics AX 2012 アプリケーション オブジェクト ツリー (AOT) に存在しないテーブルでなければなりません。 AOT に存在するテーブルを含めると、データのアップグレード中にエラーが発生します。

    ```xml
    <?xml version="1.0" encoding="utf-8"?>
    <IgnoreFunctions>
        <Name>
            <Function>if_WHSInventReserveUnionDelta</Function>
        </Name>
    </IgnoreFunctions>
    ```

    > [!IMPORTANT]
    > これらの XML ファイルで指定されたテーブルと関数はターゲット データベースに複製されないため、同じ形式に従う必要があります。
    
7. レプリケーションの待機時間/パフォーマンスを最適化するために、**App.config** ファイルで次のディストリビューターのパラメーターを更新できます。

    - **MaxBcpThreads** - 既定では、パラメーターは **6** に設定されています。 機械のコア数が 6 未満の場合は、その値をコア数に更新します。 指定できる最大値は **8** です。
    - **NumberOfPublishers** - 既定では、パラメーターは **2** に設定しています。 その値を使用することをお勧めします。
> [!NOTE]
> システムのリソース/メモリの使用率/IO 操作が高いピーク時には、レプリケーションを設定または構成しないでください。 リソースが上限まで使用されている場合 (90% 以上が既に消費されている)、システムが使用可能なリソースを見つけるためにレプリケーションが遅延する場合があります。 システム リソースの使用が最小 (オフピーク時) であるオフ時間にレプリケーションを開始することをお勧めします。 また、Go-Live の切替については、前の週末にレプリケーションを開始することをお勧めします。 

## <a name="data-upgrade-process"></a>データ アップグレード プロセス

### <a name="run-the-ax2012datamigrationexe-application"></a>AX2012DataMigration.exe アプリケーションを実行する

レプリケーション プロセスを開始する前に、LCS 環境の作成時に **配置済み** 状態になる点に注意してください。

1. **AX2012DataMigration.exe** アプリケーションを実行します。

    クラウド環境のタイプを指定できるコンソール ウィンドウが開きます。  
        - パブリック : **\[ lcs.dynamics.com \]** - GCC : **\[ gov.lcs.microsoftdynamics.us \]**    
    クラウド環境を入力すると、サインインを求めるプロンプトが表示されます。

2. LCS へのサインインに使用する資格情報を提供します。

3. 正常に認証された後コンソール ウィンドウで、**Project-Id** 値から **Environment-Id** 値を順に作成します。

    指定した値を検証するには、LCS へのログインに使用する資格情報を使用してサインインする必要があります。

    > [!NOTE]
    > **プロジェクト ID** および **環境 ID** の値は、LCS の **環境の管理** ページで確認できます。 また、**環境 ID** の値は、**環境の詳細** ページでも確認できます。

### <a name="complete-the-data-replication-and-upgrade"></a>データ レプリケーションおよびアップグレードの実施

検証が成功すると、アプリケーションには、データ アップグレード プロセスの手順に対応する一連のメニュー オプションが表示されます。 データのレプリケーションおよびアップグレードを完了するには、次の手順を順番に実行する必要があります。

1. **データ アップグレードの準備: 環境の設定活動**

    この手順では、次の情報の入力が求められます。

    - ソース データベースの詳細:

        - ソース サーバー (*サーバー名\\サーバーインスタンス* の形式)
        - ソース データベース名
        - ユーザー名
        - パスワード

    - ソース データベース サーバーの IP アドレス (許可リスト用)
    - 配布データベース パス (**D:\\SQLServer\\Data** など)
    - レプリケーション スナップショット パス **(D:\\SQLServer\\Snapshot** など)

    > [!IMPORTANT]
    > 指定した配布データベースとレプリケーション スナップショット パスには、十分な容量が必要です。 容量は、少なくともソース データベースのサイズにすることをお勧めします。 AX 2012 データベースで圧縮を使用した場合、スナップショットが圧縮されていないと必要容量が大きくなります。 パスは、コンピューターのローカル ディスクに含まれる必要があります。 共有パスの使用を避けます。
    > 
    > 仮想コンピューター (VM) またはコンピューター (手順 1. の許可リストのため) に対して静的 IP アドレスを設定することをお勧めします。 これにより、ターゲット データベースに関する接続の問題を防ぐのに役立ちます。

    この手順では、次のアクションを実行します。

    - ソース データベースへの接続を検証します。
    - AX 2012 データベースのバージョンを検証します。
    - ソースの IP アドレスを承認します。
    - ターゲット データベースを検証します。

2. **データ アップグレードの準備: データ アップグレードのターゲット環境を準備する**

    この手順により、LCS の環境の状態が **配置済み** から **レプリケーションの準備完了** に変更されます。

3. **レプリケーション : ターゲット データベースのクリーンアップ**

    この手順では、次のアクションを実行します。

    1. LCS 環境の状態を、**レプリケーションの準備完了** から **レプリケーションの処理中** に変更します。
    2. ターゲット データベースのすべての AX 製品タブレット、ビュー、ストアド プロシージャ、およびターゲット データベースのユーザー定義関数を削除します。

4. **レプリケーション: 配布の設定**

    この手順により、ソース サーバーの **システム データベース** フォルダー下に配布データベースが作成されます。 この配布データベースは、レプリケーションに使用されます。

5. **レプリケーション: 主キー テーブル用にパブリケーションを設定する**

    この手順により、ソース サーバーの **レプリケーション** フォルダーの下に主キー テーブル用のパブリケーションが作成され、ターゲット データベースに複製されます。 **ignore-table** エントリが指定されている場合、指定されたテーブルはレプリケーションから除外されます。

    **作成済パブリッシャー:** AX\_PUB\_PkTable\_\[\*\]

    > [!NOTE]
    > このレプリケーション構成ステップが完了すると、バックグラウンドで実行される SQL ジョブとして実際のデータ レプリケーションが発生します。 このジョブは完了するまでに少し時間がかかります。 レプリケーションの状態を表示するには **'rs'** オプションを指定します。 **'rs'** オプションについては、この記事の後の[アプリケーションのレポーティング セクション](data-upgrade-self-service.md#reporting-section-of-the-application) セクションで確認してください。

6. **レプリケーション: 他のオブジェクト (機能) に対するパブリケーションの設定**

    この手順により、他のオブジェクト (機能) に対するパブリケーションが作成され、ターゲット データベースに複製されます。 一部の関数を複製しない場合は、IgnoreFunctions.xml ファイルでそれらを指定できます。

    **作成されたパブリッシャー:** AX\_PUB\_OtherObjects

    > [!NOTE]
    > レプリケーションは完了までに少し時間がかかることがあります。 レプリケーションの状態を表示するには、**'rs'** オプションを指定します。
    >
    > 複製する関数がない場合、パブリケーションは作成されません。
    > 
    > このステップの **DataReplicationStatus** プロパティが完了として表示されるまで、次のステップに進まないでください。

7. **切替: 主キーのないテーブル用にパブリケーションを設定する**

    この手順では、2 つのパブリケーションを作成します。1 つは主キーのないテーブルの複製に使用され、もう 1 つはロックされたテーブルの複製に使用されます。 
    
    > [!NOTE]
    > ロックされたテーブルがない場合、パブリケーションは作成されません。

    **パブリケーションの名前:** AX\_PUB\_NoPKTable, AX\_PUB\_TABLE\_LockedTable

    主キー パブリケーションの作成中に AX サービスがスキーマ ロックを取得した場合、それらのテーブルは無視され、パブリケーションから除外されます。 これらは、一時テーブルに追加され、切替パブリケーションの作成中にレプリケーション用にマークされます。

    > [重要] このステップの **DataReplicationStatus** プロパティが完了として表示されるまで、次のステップに進まないでください。
   
    > [!NOTE]
    > **'dv'** オプションを使用して複製データを検証できます。 テーブルが不一致である場合は、この手順によりそのテーブル用のパブリケーションを作成できます。 レプリケーションに対して不一致のテーブルを除外する場合は、アプリを閉じ、それらのテーブルを **Data/IgnoreTables.xml** に追加します。 その後、アプリを再実行し **'dv'** オプションを使用します。
    > 
    > **'dv'** オプションの詳細については、この記事の後の[アプリケーションのレポート](data-upgrade-self-service.md#reporting-section-of-the-application) セクションを参照してください。
 
8. **切替: レプリケーションの設定の削除**

    この手順では、ソース データベース、配布データベース、およびレプリケーション スナップショットに作成されたすべてのパブリケーションを削除します。

    > [!NOTE]
    > 例外を発生させずに **スナップショット** フォルダーを削除するには、ソース データベースで次のスクリプトを実行します。 このスクリプトを実行しなくても、受信した例外メッセージは無視できます。
    >
    > ```sql
    > EXEC master.dbo.sp_configure 'show advanced options', 1
    >
    > RECONFIGURE WITH OVERRIDE
    > 
    > EXEC master.dbo.sp_configure 'xp_cmdshell', 1
    > 
    > RECONFIGURE WITH OVERRIDE
    > ```

9. **レプリケーション後: 環境の状態をレプリケート済に更新する**

    この手順では、LCS 環境の状態を、**レプリケーションの処理中** から **レプリケーション完了** に変更します。

10. **データ アップグレード: トリガー アップグレード**

    このステップは、データ アップグレードをトリガーします。 アクションが成功した際、LCS 環境の状態を **レプリケーション完了** から **データ アップグレードの処理中** に変更します。

    この時点で、データ アップグレード トリガーだけが発生します。 実際のデータ アップグレードは、セルフサービス環境で行われます。 データ アップグレードのステータスを確認するには、**'ds'** オプションを使用します。 オプションの詳細については、記事の後半で [アプリケーションのレポーティング セクション](data-upgrade-self-service.md#reporting-section-of-the-application) セクションを参照してください。

    データのアップグレードに成功すると、**'ds'** オプションは **AX 2012 アップグレード トポロジ (LCS) ステータス: 配置済み** として示され、アップグレード ステップは **完了** 状態になります。

    データのアップグレードに失敗すると、**'ds'** オプションは **AX 2012 アップグレード トポロジ (LCS) ステータス: 失敗** として示され、ひとつ以上のアップグレード ステップは **失敗** 状態になります。 **メニュー オプション (10)** ツールには、**再開** ステータスが表示されます。

    失敗の理由を解決して修正した後、**再開** 操作を実行できます。 アクションが成功した際、LCS 環境の状態を **失敗** から **データ アップグレードの処理中** に変更します。

    > [!NOTE]
    > データ アップグレードが正常に終了するまで、この手順を繰り返します。

11. **データ アップグレードのロールバック : ロールバックのトリガー**

    この手順は、データ アップグレードのロールバックをトリガーします。 これにより、アップグレードがトリガーされる前の状態にデータがロールバックされ、LCS 環境の状態が **レプリケート済み** に設定されます。 これにより、環境が **失敗** から **レプリケート済み** に変わります。
    
    この時点では、ロールバックをトリガーしたのみです。 ロールバックのステータスを表示するには、**'rbs'** オプションを使用します。 オプションの詳細については、この記事で後述する[アプリケーションのレポート セクション](data-upgrade-self-service.md#reporting-section-of-the-application)を参照してください。
    
    ロールバックに成功した場合、**'rbs'** オプションは、**AX 2012 年のアップグレード トポロジ (LCS) ステータス: レプリケート済** と表示されます。

    ロールバックに失敗した場合、**'rbs'** オプションは、**AX 2012 年のアップグレード トポロジ (LCS) ステータス: 失敗** と表示されます。

データ アップグレード プロセスの詳細については、[AX 2012 – データ アップグレード FAQ からアップグレード](upgrade-faq.md) を参照してください。 この記事では、Microsoft Dynamics AX 2012からのアップグレードの際、データ アップグレードについてよく寄せられる質問に回答します。

## <a name="reporting-section-of-the-application"></a>アプリケーションのレポート セクション

次のオプションを使用して、レプリケーションの検証、レプリケーション ステータス、データ アップグレードのステータス、データ アップグレード ステータスのロールバックに関するレポートを確認できます。

- **dv) レポート:** レプリケーションを検証します。

    このオプションは、ソース サーバー データベースとターゲット サーバー データベースのテーブルとレコードの数を比較した後、レポートを表示します。 このオプションは、手順 7 が完了した後にのみ使用できます。
    
    テーブルが不一致である場合は、この手順によりそのテーブル用のパブリケーションを作成できます。 レプリケーションに対して不一致のテーブルを除外する場合は、アプリを閉じ、それらのテーブルを **Data/IgnoreTables.xml** に追加します。 その後、アプリを再実行し **'dv'** オプションを使用します。

    レポート データは、**output/PostValidationInfo.csv** で確認できます。

- **rs) レポート:** レプリケーション ステータスを取得します。

    このオプションは、作成されたパブリケーションのレプリケーション プロセスのレポートを表示します。 このオプションは、手順 5 が開始された後 (任意のパブリケーションのレプリケーション プロセス中) にのみ使用できます。

- **ds) レポート:** データ アップグレードのステータスを取得します。

    このオプションは、データ アップグレード プロセスのレポートを表示します。 このオプションは、手順 10 を開始した後にのみ使用できます。
    
- **rbs) レポート:** ロールバックのステータスを取得します。

    このオプションは、ロールバック プロセスのレポートを表示します。 このオプションは、手順 11 を開始した後にのみ使用できます。

## <a name="tooling-section-of-the-application"></a>アプリケーションのツール セクション

- **レプリケーションのリセット:** すべてのレプリケーション構成を削除することで、レプリケーションの設定をリセットします。 パブリケーションおよび配布データベースが削除されます。 すべての **レプリケーション** および **切替** メニュー オプションのステータスが、**完了** モードから **リセット** モードにリセットされ、レプリケーションを最初からやり直すのに役立ちます。
- **すべてリセット:** すべてのメニュー オプションをリセットし、レプリケーションの設定を削除します。 すべてのオプションの状態は、**リセット** に変更されます。
- **クリア:** 環境設定の活動をクリアします。 **プロジェクト ID** の値、**環境 ID** の値、ソース データベースの詳細など、すべての情報がキャッシュからクリアされます。
- **ヘルプ:** 更新されたステータスでデータ アップグレード移行オプションを表示します。
- **終了:** アプリケーションを閉じます。
- **Set-failed:** 環境を削除したい場合—および環境が **PreparingForReplication**、**ReadyForReplication** または **Replicating & Replicated)** の状態にある場合—このオプションを使い **失敗** に環境状態を設定し、その後環境は LCS から削除されます。

## <a name="troubleshooting"></a>トラブルシューティング

問題解決の情報については、[Dynamics 365 Finance + Operations セルフ サービス環境への問題解決アップグレード](troubleshoot-self-service-env.md) を参照してください。

## <a name="learn-about-the-replication-configuration-and-status-via-sql-server-management-studio"></a>SQL Server Management Studio 経由でのレプリケーションの構成とステータスについて

SSMS で、オブジェクト エクスプローラーに **レプリケーション** フォルダーが含まれる場合、レプリケーション機能がサーバーにインストールされ、使用可能になります。

データ アップグレード プロセスの手順 3 が完了したら、**レプリケーション** フォルダー下にコンフィギュレーションされたパブリッシャーが表示されます。 レプリケーション ステータスを確認するには、**レプリケーション** フォルダーを選択したまま (または右クリック)、**レプリケーション モニターの起動** を選択します。

- レプリケーション モニターには、レプリケーション用に作成されたすべてのパブリッシャーを表示できます。
- **スナップショット** タブには、スナップショットのステータスが表示されます。
- 詳細ログ/トランザクションを表示するには、グリッド品目をダブルタップ (またはダブルクリック) します。
- ターゲットへのデータ レプリケーションを表示するには、**すべてのサブスクリプション** タブで、グリッド品目のサブスクリプションをダブルタップ (またはダブルクリック) します。


