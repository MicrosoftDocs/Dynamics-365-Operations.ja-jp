---
title: AX 2012 からのアップグレード - セルフサービス環境のデータ アップグレード
description: このトピックでは、セルフサービス環境で Microsoft Dynamics AX 2012 からデータ アップグレードを行う方法について説明します。
author: sarvanisathish
ms.date: 06/09/2021
ms.topic: article
audience: IT Pro
ms.reviewer: sericks
ms.search.region: Global
ms.author: tfehr
ms.search.validFrom: 2021-06-30
ms.openlocfilehash: 159b9c0419434fe4b59593e364a79df0c1c20f22
ms.sourcegitcommit: 655b0e16c7aef6182cd58bc816b901470e1bb2ce
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 06/10/2021
ms.locfileid: "6222498"
---
# <a name="upgrade-from-ax-2012---data-upgrade-in-self-service-environments"></a>AX 2012 からのアップグレード - セルフサービス環境のデータ アップグレード

[!include[banner](../includes/banner.md)]

> [!IMPORTANT]
> このトピックに記載されている一部またはすべての機能は、プレビュー リリースの一部として使用可能です。 コンテンツおよび機能は、変更されることがあります。

## <a name="prerequisites"></a>必要条件

1. まだインストールされていない場合、[.NET Core ソフトウェア開発キット (SDK)](https://dotnet.microsoft.com/download/dotnet/thank-you/sdk-3.1.409-windows-x64-installer) をダウンロードしてインストールしてください。
2. Microsoft Dynamics Lifecycle Services (LCS) でセルフサービス環境を作成します。 この環境は、**配置済み** 状態である必要があります。
3. レプリケーション機能がインストールされ、ソース SQL Server インスタンスに対して有効になっていることを確認します。 レプリケーションが有効かどうかを確認するには、次の SQL スクリプトを実行します。

    ```sql
    -- If @installed is 0, replication must be added to the SQL Server installation.

    USE master;

    GO

    DECLARE @installed int;

    EXEC @installed = sys.sp_MS_replication_installed;

    SELECT @installed;
    ```

    レプリケーション コンポーネントがインストールされていない場合は、[SQL Server レプリケーションのインストール](/sql/database-engine/install-windows/install-sql-server-replication?view=sql-server-ver15)の手順に従いインストールします。

4. ソース データベース サーバーで SQL Server Agent を有効にして起動します。

    > [!NOTE]
    > ユーザーはソース データベースで **DB\_Owner** 権限を持ち、マスター データベースおよびソース データベースにアクセスできる必要があります。

5. **Migration Toolkit の設定:** ソース データベース テーブルの一部をターゲット データベースに複製しない場合は、IgnoreTables.xml ファイルでそれらを指定できます。 同様に、一部の関数を複製しない場合は、IgnoreFunctions.xml ファイルでそれらを指定できます。

    - **IgnoreTables.xml ファイルのパス:** Data\\IgnoreTables.xml
    - **IgnoreFunctions.xml ファイルのパス:** Data\\IgnoreFunctions.xml

    次の例は、XML ファイルのテーブルおよび関数を指定する方法を示しています。

    ```xml
    <?xml version="1.0" encoding="utf-8"?>
    <IgnoreTables>
        <Name>
            <Table>USERADDHISTORYLIST</Table>
            <Table>TAXRECONCILIATIONREPORTTMP</Table>
            <Table>CASELOG</Table>
            <Table>SHAREDCATEGORYROLETYPE</Table>
            <Table>VATCSREPORTXMLATTRIBUTE_CZ</Table>
        </Name>
    </IgnoreTables>
    ```

    ```xml
    <?xml version="1.0" encoding="utf-8"?>
    <IgnoreFunctions>
        <Name>
            <Function>if_WHSInventReserveUnionDelta</Function>
        </Name>
    </IgnoreFunctions>
    ```

    > [!WARNING]
    > これらの XML ファイルで指定されたテーブルと関数はターゲット データベースに複製されないため、同じ形式に従う必要があります。

> [!NOTE]
> 上記の手順のいずれかが任意の時点で失敗した場合は、このトピック後半の[例外](#exceptions)を参照してください。

## <a name="configure-replication"></a>レプリケーションの構成

レプリケーション プロセスを開始する前に、LCS 環境の作成時に **配置済み** 状態になる点に注意してください。

1. **AX2012DataUpgradeToolKit.exe** アプリケーションを実行します。

    コンソール ウィンドウが開き、認証用の Microsoft サインイン ページにリダイレクトされます。

2. LCS へのサインインに使用する資格情報を提供します。

    認証に成功すると、ブラウザに以下のメッセージが表示されます。「認証が完了しました。 アプリケーションに戻ることができます。 このブラウザー タブを自由に閉じることができます。」

    これでブラウザー タブを閉じることができます。

3. コンソール ウィンドウに **プロジェクト ID** の値を入力し、**入力** を選択します。 次に、**環境 ID** の値を指定し、**入力** を選択します。

    > [!NOTE]
    > **プロジェクト ID** および **環境 ID** の値は、LCS の **環境の管理** ページで確認できます。 また、**環境 ID** の値は、**環境の詳細** ページでも確認できます。

アプリケーションは LCS 環境に接続し、ターゲット データベースへの接続を検証します。

検証が成功すると、アプリケーションには、データ アップグレード プロセスの手順に対応する一連のメニュー オプションが表示されます。 データのレプリケーションおよびアップグレードを完了するには、次の手順を順番に実行する必要があります。

1. **データ アップグレードの準備: 環境の設定活動**

    この手順では、次の情報の入力が求められます。

    - ソース データベースの詳細:

        - ソース サーバー (*サーバー名\\サーバーインスタンス* の形式)
        - ソース データベース名
        - ユーザー名
        - パスワード

    - ソース データベース サーバーの IP アドレス (許可リスト用)
    - 配布データベース パス (**D:\\SQLServer\\Data** など)
    - レプリケーション スナップショット パス **(D:\\SQLServer\\Snapshot** など)

    > [!WARNING]
    > 指定した配布データベースとレプリケーション スナップショット パスには、十分な容量が必要です。 容量は、少なくともソース データベースのサイズにすることをお勧めします。

    この手順では、次のアクションを実行します。

    - ソース データベースへの接続を検証します。
    - AX 2012 データベースのバージョンを検証します。
    - ソースの IP アドレスを承認します。
    - ターゲット データベースを検証します。

2. **データ アップグレードの準備: データ アップグレードのターゲット環境を準備する**

    この手順により、LCS の環境の状態が **配置済み** から **レプリケーションの準備完了** に変更されます。

3. **レプリケーション : ターゲット データベースのクリーンアップ**

    この手順では、次のアクションを実行します。

    1. LCS 環境の状態を、**レプリケーションの準備完了** から **レプリケーションの処理中** に変更します。
    2. ターゲット データベースのテーブル、ビュー、ストアド プロシージャ、およびユーザー定義関数のデータベース所有者 (dbo) オブジェクトを削除します。

4. **レプリケーション: 配布の設定**

    この手順により、ソース サーバーの **システム データベース** フォルダー下に配布データベースが作成されます。 この配布データベースは、レプリケーションに使用されます。

5. **レプリケーション: 主キー テーブル用にパブリケーションを設定する**

    この手順により、ソース サーバーの **レプリケーション** フォルダーの下に主キー テーブル用のパブリケーションが作成され、ターゲット データベースに複製されます。 **ignore-table** エントリが指定されている場合、指定されたテーブルはレプリケーションから除外されます。

    **作成済みパブリッシャー:** AXDB\_PUB\_TABLE\_Obj\_\[\*\]

    > [!NOTE]
    > このレプリケーション構成ステップが完了すると、バックグラウンドで実行される SQL ジョブとして実際のデータ レプリケーションが発生します。 このジョブは完了するまでに少し時間がかかります。 レプリケーションの状態を表示するには **'rs**' オプションを指定します。

6. **レプリケーション: 他のオブジェクト (機能) に対するパブリケーションの設定**

    この手順により、他のオブジェクト (機能) に対するパブリケーションが作成され、ターゲット データベースに複製されます。 一部の関数を複製しない場合は、IgnoreFunctions.xml ファイルでそれらを指定できます。

    **作成されたパブリッシャー:** AX\_PUB\_OtherObjects

    > [!NOTE]
    > レプリケーションは完了までに少し時間がかかることがあります。 レプリケーションの状態を表示するには、**'rs'** オプションを指定します。
    >
    > 複製する関数がない場合、パブリケーションは作成されません。

    > [!WARNING]
    > このステップの **DataReplicationStatus** プロパティが完了として表示されるまで、次のステップに進まないでください。

7. **切替: 主キーのないテーブル用にパブリケーションを設定する**

    この手順では、2 つのパブリケーションを作成します。1 つは主キーのないテーブルの複製に使用され、もう 1 つはロックされたテーブルの複製に使用されます。

    **パブリケーションの名前:** AX\_PUB\_NoPKTable, AX\_PUB\_TABLE\_LockedTable

    主キー パブリケーションの作成中に AX サービスがスキーマ ロックを取得した場合、それらのテーブルは無視され、パブリケーションから除外されます。 これらは、一時テーブルに追加され、切替パブリケーションの作成中にレプリケーション用にマークされます。

    > [!WARNING]
    > このステップの **DataReplicationStatus** プロパティが完了として表示されるまで、次のステップに進まないでください。

8. **切替: 主キーのないパブリケーションおよび一時テーブルの削除**

    この手順では、次のアクションを実行します。

    1. ソース データベースの主キーのないテーブルに対して作成された一時テーブルをクリーンアップします。
    2. **AX\_PUB\_NoPKTable** というパブリケーションを削除します。

9. **切替: 主キーのないテーブルに対する制約の作成**

    この手順では、ソース データベースから主キーのないテーブルの制約を抽出し、それらをターゲット データベースに作成します。

10. **切替: レプリケーションの設定の削除**

    この手順では、ソース データベース、配布データベース、およびレプリケーション スナップショットに作成されたすべてのパブリケーションを削除します。

    > [!NOTE]
    > 例外を発生させずに **スナップショット** フォルダーを削除するには、ソース データベースで次のスクリプトを実行します。 このスクリプトを実行しなくても、受信した例外メッセージは無視できます。
    >
    > ```sql
    > EXEC master.dbo.sp_configure 'show advanced options', 1
    >
    > RECONFIGURE WITH OVERRIDE
    > 
    > EXEC master.dbo.sp_configure 'xp_cmdshell', 1
    > 
    > RECONFIGURE WITH OVERRIDE
    > ```

11. **レプリケーション後: 環境の状態をレプリケート済に更新する**

    この手順では、LCS 環境の状態を、**レプリケーションの処理中** から **レプリケーション完了** に変更します。

12. **データ アップグレード: トリガー アップグレード**

    この手順では、次のアクションを実行します。

    1. データのアップグレードの実行中に、LCS 環境の状態を **レプリケーション完了** から **データ アップグレードの処理中** に変更します。
    2. データのアップグレード完了後に、LCS 環境の状態を **データ アップグレードの処理中** から **配置済み** に変更します。

    この時点で、データ アップグレード プロセスが完了します。 プロセス内のすべての手順の状態が完了と表示されます。

データのアップグレードに失敗すると、LCS 環境の状態は **失敗** し、失敗した手順のメニュー オプションの状態がコンソール アプリケーションで **再開** になります。 この場合、失敗した手順を再開します。 その後、LCS 環境の状態は、**サービス** に変更されます。

## <a name="reporting-section-of-the-application"></a>アプリケーションのレポート セクション

次のオプションを使用して、レプリケーションの検証、レプリケーション ステータス、およびデータ アップグレードのステータスに関するレポートを確認できます。

- **dv) レポート:** レプリケーションを検証します。

    このオプションは、ソース サーバー データベースとターゲット サーバー データベースのテーブルとレコードの数を比較した後、レポートを表示します。 このオプションは、手順 12 が完了した後にのみ使用できます。

    レポート データは、**output/PostValidationInfo.csv** で確認できます。

- **rs) レポート:** レプリケーション ステータスを取得します。

    このオプションは、作成されたパブリケーションのレプリケーション プロセスのレポートを表示します。 このオプションは、手順 3 が開始された後 (任意のパブリケーションのレプリケーション プロセス中) にのみ使用できます。

- **ds) レポート:** データ アップグレードのステータスを取得します。

    このオプションは、データ アップグレード プロセスのレポートを表示します。 このオプションは、手順 12 を開始した後にのみ使用できます。

## <a name="tooling-section-of-the-application"></a>アプリケーションのツール セクション

- **リセット:** すべてのレプリケーション構成を削除することで、レプリケーションの設定をリセットします。 パブリケーションおよび配布データベースが削除されます。 すべてのメニュー オプションのステータスが **完了** から **リセット** モードにリセットされ、レプリケーションを最初からやり直すのに役立ちます。

- **すべてリセット:** すべてのメニュー オプションをリセットします。

    **リセット** オプションおよび **クリア** オプションが実行されます。 すべてのオプションが、**開始されていません** に変更されます。

- **クリア:** 環境設定の活動をクリアします。 **プロジェクト ID** の値、**環境 ID** の値、ソース データベースの詳細など、すべての情報がキャッシュからクリアされます。 手順 1 のステータスが **開始されていません** に変更されます。
- **ヘルプ:** データ アップグレードの移行を表示します。 メニュー オプション ステータスは、更新されたステータスと共に表示されます。
- **終了:** アプリケーションを閉じます。

## <a name="learn-about-the-replication-configuration-and-status-via-sql-server-management-studio"></a>SQL Server Management Studio 経由でのレプリケーションの構成とステータスについて

SQL Server Management Studio (SSMS) で、オブジェクト エクスプローラーに **レプリケーション** フォルダーが含まれる場合、レプリケーション機能がサーバーにインストールされ、使用可能になります。

データ アップグレード プロセスの手順 3 が完了したら、**レプリケーション** フォルダー下にコンフィギュレーションされたパブリッシャーが表示されます。 レプリケーション ステータスを確認するには、**レプリケーション** フォルダーを選択したまま (または右クリック)、**レプリケーション モニターの起動** を選択します。

- レプリケーション モニターには、レプリケーション用に作成されたすべてのパブリッシャーを表示できます。
- **スナップショット** タブには、スナップショットのステータスが表示されます。
- 詳細ログ/トランザクションを表示するには、グリッド品目をダブルタップ (またはダブルクリック) します。
- ターゲットへのデータ レプリケーションを表示するには、**すべてのサブスクリプション** タブで、グリッド品目のサブスクリプションをダブルタップ (またはダブルクリック) します。

## <a name="exceptions"></a>例外

- ソース データベース サーバーに配布データベースが既に存在する場合は、次の手順に従って削除します。

    1. ソース データベース サーバーで、**レプリケーション** フォルダーを展開し、**ローカル パブリケーション** フォルダーを選択したまま (または右クリック)、**スクリプトの生成** を選択します。

        **SQLスクリプトの生成** という名前のタブが開きます。

    2. **コンポーネントをドロップまたは無効にする** オプションを選択し、**スクリプトの生成** フィールドで、**新しいクエリ ウィンドウを開く** を選択します。

        新しいクエリ ウィンドウでスクリプトが開きます。

    3. ソース データベースで、スクリプトを実行します。

- パブリケーションを作成すると、スナップショットの作成が失敗し、「データベース MicrosoftDynamicsAX のオブジェクトのプリフェッチに失敗しました」というエラー メッセージが表示される場合があります。

    この例外を修正するには、次の手順に従ってください。

    1. **レプリケーション** フォルダーを選択したまま (または右クリック)、**レプリケーション モニターの起動** を選択します。
    2. 失敗したパブリケーションを選択したまま (または右クリック)、**スナップショットの生成** を選択します。
    3. スナップショットが生成された後は、**'rs'** オプションを使用してレプリケーションのステータスを表示できます。
