---
title: サンドボックス環境への生産データベースのポイントインタイム復元
description: このトピックでは、Microsoft Dynamics Lifecycle Services を使用して生産データベースのポイントインタイム復元を実行する方法について説明します。
author: LaneSwenka
manager: AnnBe
ms.date: 12/15/2020
ms.topic: article
ms.prod: ''
ms.service: dynamics-ax-applications
ms.technology: ''
audience: IT Pro, Developer
ms.reviewer: sericks
ms.search.region: Global
ms.author: laswenka
ms.search.validFrom: 2020-02-29
ms.dyn365.ops.version: Platform update 33
ms.openlocfilehash: a76420d5563c08562ca07ea98f4d81f7658508a5
ms.sourcegitcommit: f8bac7ca2803913fd236adbc3806259a17a110f4
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 02/06/2021
ms.locfileid: "5130795"
---
# <a name="point-in-time-restore-of-the-production-database-to-a-sandbox-environment"></a>サンドボックス環境への生産データベースのポイントインタイム復元

[!include [banner](../includes/banner.md)]

Microsoft Dynamics Lifecycle Services (LCS) を使用すると、ユーザー受け入れテスト(UAT)のサンドボックス環境に対して、本番データベースのポイント イン タイム復元(PITR)を実行できます。 Microsoft は、業務および財務報告用のデータベースの[自動バックアップ](https://docs.microsoft.com/azure/sql-database/sql-database-automated-backups)を、実稼働環境の場合は 28 日間、サンドボックス環境の場合は 7 日間維持します。

> [!IMPORTANT]
> Microsoft は、実稼働レポートを目的とした実稼働データのサンドボックス環境へのコピーには対応していません。

## <a name="self-service-point-in-time-restore-production-to-sandbox"></a>セルフ サービスによる実稼働環境からサンドボックスへのポイント イン タイム復元

Lifecycle Services チームは、手動または手動のプロセスに依存しないデータ アプリケーション ライフサイクル 管理 (DataALM) 機能を顧客に提供するために、データベースの自動更新アクションを導入しました。 セルフ サービス データベースの更新‎を実行するプロセスの概要を次に示します。

1. 対象とするサンドボックスの **環境詳細** ページに移動し、 **管理** \> **データベースの移動** ボタンを選択します。
2. **実稼働環境からサンドボックス環境へのポイント イン タイム復元** オプションを選択し、対象とする時点を選択します。
3. 警告に注意し、元の環境の前の時点からコピーされていないデータ要素のリストを確認します。
4. 復元操作がすぐに開始されます。

> [!IMPORTANT]
> セルフ サービスのポイントインタイム復元 (PITR) は、異なる地域にある環境間ではサポートされていません。 詳細については、このトピックで後述する「既知の問題」を参照してください。

### <a name="restore-operation-failure"></a>失敗した操作の復元

復元操作が正常に行われない場合は、ロールバックできます。 操作の最初の失敗をした後に **ロールバック** オプションを選択すると、対象となるサンドボックス環境がインポートの開始前の状態に戻されます。 ロールバックは Azure SQL Database の PITR 機能によって実現しています。 対象とするサンドボックス環境に存在するカスタマイズが、新たに更新されたデータでデータベースの同期を完了できない場合に、これらが必要になります。

失敗の根本原因を特定するには、ロールバック操作を開始する前に、使用可能なボタンを使用して Runbook ログをダウンロードします。

### <a name="data-elements-that-arent-copied-during-restore-copy"></a>復元のコピー処理の過程でコピーされなかったデータ要素

実稼働環境をサンドボックス環境に、またはサンドボックス環境を別のサンドボックス環境に更新する際に、対象の環境にコピーされない特定のデータベース要素が存在します。 次にいくつか例を挙げます。

* LogisticsElectronicAddress テーブル内の電子メール アドレス。
* BatchJobHistory、BatchHistory、および BatchConstraintHistory テーブルのバッチ ジョブ履歴。
* SysEmailParameters テーブルの シンプル メール トランスファー プロトコル (SMTP) リレーサーバー。
* PrintMgmtSettings と PrintMgmtDocInstance テーブルの印刷管理設定。
* SysServerConfig、SysServerSessions、SysCorpNetPrinters、SysClientSessions、BatchServerConfig、および BatchServerGroup テーブル内の環境固有のレコード。
* DocuValue テーブル内のドキュメント添付ファイル。 これらの添付ファイルには、ソース環境で上書きされたすべての Microsoft Office テンプレートが含まれます。
* 管理者以外のすべてのユーザーは **無効** のステータスに設定されます。
* すべてのバッチ ジョブは、 **保留** 状態に設定されます。
* すべてのユーザーのパーティション値は "初期" パーティション レコード ID にリセットされます。
* 別のデータベースサーバーでは解読できないため、すべての Microsoft 暗号化フィールドはクリアされます。 次の例は、sysemailsmtppasswordテーブルの **パスワード** フィールドです。

これらの要素は、環境固有のものであるためコピーされません。 この例には、BatchServerConfigおよびSysCorpNetPrintersの各レコードが含まれます。 その他の要素は、サポート チケットのデータ量が多くなる懸念があるためコピーされません。 たとえば、簡易メール転送プロトコル (SMTP) は UAT 環境でも有効になっているため、重複する電子メールが送信されてしまう可能性があります。また、バッチ ジョブも有効になっており、無効な統合メッセージが送信されてしまう可能性もあるため、管理者が更新後クリーンアップを行う前にユーザーが有効化してしまう可能性があります。

### <a name="environment-administrator"></a>環境管理者

対象の環境のシステム管理者アカウント (**Admin** の **UserId** 値を持つアカウント) が、対象の環境に存在する web.config ファイルで検出された値にリセットされます。 この値は、LCS の管理者アカウントの値と一致している必要があります。 このアカウントをプレビューするには、LCS で対象とするサンドボックス環境の **環境の詳細**  ページに移動します。 環境が最初に展開されたときに選択された **環境管理者** フィールドの値は、トランザクション データベースのシステム管理者アカウントと一致するように更新されます。 したがって、環境のテナントは、環境管理者のテナントにもなります。

環境で管理者ユーザー プロビジョニング ツールを使用して、web.config ファイルの値を変更した場合、この値は LCS の値と一致しない可能性があります。 別のアカウントを使用する必要がある場合は、対象のサンドボックス環境の割り当てを解除して削除し、再度展開して別のアカウントを選択する必要があります。 その後、別のデータベース更新アクションを実行してデータを復元できます。

あるテナントから別のテナントに環境を更新することはできません。 この制限は、onmicrosoft.com テナントにも適用されます。 ソース環境とターゲット環境の管理者アカウントが、同じテナント ドメインからのものであることを確認する必要があります。

### <a name="conditions-for-doing-a-pitr-copy-of-a-production-environment-to-a-sandbox-environment"></a>運用環境の PITR コピーをサンドボックス環境にコピーする条件

データベース更新の操作の要件および条件の一覧を次に示します。

- 更新処理では、実行対象のデータベースで削除が実行されます。
- ターゲット環境は、データベースのコピーがターゲット サーバーに達するまで使用可能です。 その時点以降は、更新プロセスが完了するまで、ターゲット環境はオフラインになります。
- リフレッシュは、アプリケーションおよび Financial Reporting データベースにのみ影響します。
- Azure blob storage のドキュメントは、環境間でのコピーができません。 したがって、添付されたドキュメントを処理するドキュメントとテンプレートは変更されず、現在の状態のままとなります。
- 管理者ユーザー、およびその他の内部サービス ユーザー アカウントを除くすべてのユーザーは使用できなくなります。 そのため、管理者ユーザーは他のユーザーがシステムに復帰する前にデータの削除や難読化することができます。
- 管理者ユーザーは、特定のサービスまたは URL に統合エンドポイントを再接続するなど、必要な構成の変更を加える必要があります。
- 定期的なインポートおよびエクスポート ジョブを持つすべてのデータ管理フレームワークは、復元を開始する前に、対象のシステムを完全に処理して停止する必要があります。 さらに、すべての定期的なインポートおよびエクスポート ジョブが完全に処理された後に、データベースをソースから選択することをお勧めします。 このようにして、Azure ストレージ内のいずれのシステムからも孤立ファイルがないことを確認してください。 対象の環境でデータベースを復元した後は、孤立したファイルを処理できないため、この手順は重要となります。 復元後、統合ジョブを再開することができます。
- ビジネス イベントは、同じ終了点が使用されないように、データベースが復元される環境で終了ポイントを削除して再構成する必要があります。 また、ビジネスイベントを非アクティブにし、環境で構成されていた新しいエンドポイントに対して、再度有効化する必要があります。
- LCSにてプロジェクトの所有者、または環境マネージャの役割を持つすべてのユーザーは、本稼働以外のすべての環境の SQL およびマシンの資格情報にアクセスできます。
- データベースが Spartan で管理されていない場合は、データベースを同じ地理上の Azure リージョンでホストする必要があります。  SQL server の完全修飾アドレスの一部に ' spartan ' が含まれていれば、データベースは Spartan に管理されています。
- 実行元の環境で割り当てられたデータベースの容量は、実行対象の環境のデータベースの最大容量よりも小さくする必要があります。

## <a name="steps-to-complete-after-a-restore-is-done-for-environments-that-use-commerce-functionality"></a>コマース機能を使用する環境で復元後に実行する手順

[!include [environment-reprovision](../includes/environment-reprovision.md)]

## <a name="known-issues"></a>既知の問題

### <a name="restore-is-denied-for-environments-that-run-platform-update-20-or-earlier"></a>プラットフォーム 更新プログラム 20 以前が稼働している環境では、復元は拒否されます

現在、環境がプラットフォーム更新プログラム 20 またはそれ以前を実行している場合は、データベースの更新プロセスを完了することはできません。 詳細については、[現在サポートされているプラットフォーム更新の一覧](../migration-upgrade/versions-update-policy.md) を参照してください。

### <a name="the-source-and-target-environments-have-incompatible-versions-of-financial-reporting"></a>実行元の環境と実行対象の環境に互換性のないバージョンの Financial Reporting が存在します

実行対象とする環境の Financial Reporting のバージョンが実行元の環境のバージョンよりも古い場合は、データベースの更新プロセス (セルフ サービスまたはサービス リクエスト経由) が正常に完了できません。 この問題を解決するには、両方の環境で財務報告が最新バージョンとなるように更新を行ってください。

実行対象と実行元の環境にインストールされているバージョンを確認するには、**環境の詳細** ページの **詳細バージョン情報を表示する** のリンクを確認してください。 続いて、**MRApplicationService** を検索し、実行対象の環境のバージョンが実行元の環境のバージョンと同じであるか、高いバージョンであることを確認します。

<img src="media/FinancialReporting_Binaries2.png" width="500px" alt="MRApplicationService">

バージョン 8.1 またはそれ以降を使用しているお客様は、次の手順を実行する必要があります。

1. **更新** のタイルメニューを開き、UAT環境を更新します。 更新内容をプロジェクトの資産ライブラリに保存します。
2. パッケージを UAT 環境に適用します。
3. エラーが解決されたことを確認してください。

バージョン 8.0 またはそれ以前を使用しているお客様は、次の手順を実行する必要があります。

1. 実行元の環境の環境履歴を確認してください。 具体的には、「プラットフォームおよびアプリケーションのバイナリ パッケージ」のいずれかが実行元の環境に展開されていることを確認します。実行対象の環境ではありませんのでご注意ください。
2. バイナリ パッケージを実行対象の環境に適用します。
3. エラーが解決されたことを確認してください。

### <a name="the-source-and-target-environments-have-incompatible-application-versions"></a>実行元の環境と実行対象の環境間での互換性のないアプリケーション バージョンが存在します

実行元の環境のアプリケーション リリースと実行対象の環境のアプリケーション リリースが異なる場合は、データベースの更新プロセス (セルフ サービスまたはサービスリクエスト経由) を完了できません。 これは、データの更新プロセスが、更新などのデータベースの移動操作によって実行されず、データ損失が発生する可能性があるためです。

新しいアプリケーション バージョンにサンドボックス UAT 環境をアップグレードする場合は (たとえば、7.3 から 8.1 など)、必ずアップグレードを開始する前にデータベースの更新アクションを実行してください。 サンドボックス環境が新しいバージョンにアップグレードされた後は、サンドボックス UAT 環境に古い実稼働環境データベースを復元することはできません。

逆に、実稼働環境が実行対象のサンドボックス環境よりも新しい場合は、更新前に対象のサンドボックス環境をアップグレードするか、更新の実行前に環境の割り当て解除、削除、および再展開をする必要があります。

### <a name="the-source-and-target-are-on-different-infrastructure-microsoft-managed-vs-self-service"></a>異なるインフラストラクチャ (Microsoft による管理対セルフ サービス) 上にあるソースおよびターゲット

PITR プロセスは、異なる地域間の Microsoft による管理およびセルフ サービス環境間でサポートされていません。 たとえば、実稼働環境が Microsoft によって管理されており、米国東部 2 で、セルフ サービスのサンドボックス環境に PITR が必要な場合、米国東部では PITR はサポートされていません。 代わりに、実稼働環境をセルフ サービスに移動するか、定期的なデータベース更新を選択することもできます。

### <a name="point-in-time-restore-between-source-and-target-that-are-both-on-self-service-in-different-regions"></a>異なる地域で、両方ともセルフ サービスにあるソースとターゲット間のポイントインタイム復元
PITR プロセスは、異なる地域間のセルフ サービス環境間ではサポートされていません。 たとえば、実稼働環境が米国東部にあり、セルフ サービスのサンドボックス環境に PITR が必要な場合、西ヨーロッパでは PITR はサポートされていません。 代わりに、環境を両方とも同じ地域にするか、定期的なデータベース更新を選択することもできます。

