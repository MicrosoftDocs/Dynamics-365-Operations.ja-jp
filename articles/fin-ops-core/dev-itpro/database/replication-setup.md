---
title: AX 2012 からのアップグレード - SQL トランザクション レプリケーション
description: このトピックでは、大量の Microsoft Dynamics AX 2012 データベースを Finance and Operations アプリにアップグレードする方法を説明します。
author: sarvanisathish
ms.date: 04/26/2021
ms.topic: article
audience: IT Pro
ms.reviewer: sericks
ms.search.region: Global
ms.author: sarvanis
ms.search.validFrom: 2021-04-30
ms.openlocfilehash: b8fba9997cb77ce449b5655c5d04b1a514708a07
ms.sourcegitcommit: ab3f5d0da6eb0177bbad720e73c58926d686f168
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/26/2021
ms.locfileid: "5944765"
---
# <a name="upgrade-from-ax-2012---sql-transactional-replication"></a><span data-ttu-id="bf513-103">AX 2012 からのアップグレード - SQL トランザクション レプリケーション</span><span class="sxs-lookup"><span data-stu-id="bf513-103">Upgrade from AX 2012 - SQL Transactional Replication</span></span> 

[!include [banner](../includes/banner.md)]

[!include [upgrade banner](../includes/upgrade-banner.md)]

<span data-ttu-id="bf513-104">このトピックでは、大量の Microsoft Dynamics AX 2012 データベースを Finance and Operations アプリにアップグレードする方法を説明します。</span><span class="sxs-lookup"><span data-stu-id="bf513-104">This topic shows how to upgrade a large Microsoft Dynamics AX 2012 database to Finance and Operations apps.</span></span> <span data-ttu-id="bf513-105">このプロセスでは、SQL トランザクション レプリケーションを使用して、AX 2012 オンプレミス データベースからサンドボックス環境にスキーマとデータを取り込みます。</span><span class="sxs-lookup"><span data-stu-id="bf513-105">This process uses SQL Transactional Replication to bring the schema and data from the AX 2012 on-premises database to the sandbox environment.</span></span>

<span data-ttu-id="bf513-106">共有サンドボックス環境で実行する前に、開発環境でデータ アップグレード プロセスを実行することを強くお勧めします。</span><span class="sxs-lookup"><span data-stu-id="bf513-106">We strongly recommend that you run the data upgrade process in a development environment before you run it in a shared sandbox environment.</span></span> <span data-ttu-id="bf513-107">この方法を使用すると、データを正常にアップグレードするために必要な時間全体を削減することができます。</span><span class="sxs-lookup"><span data-stu-id="bf513-107">This approach will help reduce the overall time that is required for a successful data upgrade.</span></span> <span data-ttu-id="bf513-108">詳細については[AX 2012からのアップグレード - データ アップグレードのためのアップグレード前のチェックリスト](../migration-upgrade/prepare-data-upgrade.md) を参照してください。</span><span class="sxs-lookup"><span data-stu-id="bf513-108">For more information, see [Upgrade from AX 2012 - Pre-upgrade checklist for data upgrade](../migration-upgrade/prepare-data-upgrade.md).</span></span>

## <a name="replication-setup"></a><span data-ttu-id="bf513-109">レプリケーションの設定</span><span class="sxs-lookup"><span data-stu-id="bf513-109">Replication setup</span></span>

<span data-ttu-id="bf513-110">レプリケーションとは、データとデータベース オブジェクトをデータベース間でコピーして配布し、データベース間で同期して整合性を維持するための一連のテクノロジーです。</span><span class="sxs-lookup"><span data-stu-id="bf513-110">Replication is a set of technologies for copying and distributing data and database objects from one database to another, and then synchronizing between the databases to maintain consistency.</span></span> <span data-ttu-id="bf513-111">この移行とコピーはソース システムのオンラインで行うので、レプリケーション プロセス中に Finance and Operations サービスのダウンタイムは不要です。</span><span class="sxs-lookup"><span data-stu-id="bf513-111">This migration and copying happens with the source system online, which means there is no need for Finance and Operations service downtime during the replication process.</span></span> <span data-ttu-id="bf513-112">**Online Database Migration Toolkit** ではトランザクション レプリケーションを使用します。</span><span class="sxs-lookup"><span data-stu-id="bf513-112">The **Online Database Migration Toolkit** uses transactional replication.</span></span> <span data-ttu-id="bf513-113">通常、これはスケーラビリティと可用性を向上させるために高スループットを必要とするサーバー間のシナリオで使用されます。</span><span class="sxs-lookup"><span data-stu-id="bf513-113">This is typically used in server-to-server scenarios that require high-throughput  to improve scalability and availability.</span></span>

<span data-ttu-id="bf513-114">**Online Database Migration Toolkit** では、**共有アセット ライブラリ > モデル** の Lifecycle Services (LCS) からダウンロードできます。</span><span class="sxs-lookup"><span data-stu-id="bf513-114">The **Online Database Migration Toolkit** can be downloaded from Lifecycle Services (LCS) in **Shared asset Library > Model**.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="bf513-115">必要条件</span><span class="sxs-lookup"><span data-stu-id="bf513-115">Prerequisites</span></span>
<span data-ttu-id="bf513-116">**Online Database Migration Toolkit** には次の必要条件が必要です。</span><span class="sxs-lookup"><span data-stu-id="bf513-116">The following prerequisites are needed for the **Online Database Migration Toolkit**.</span></span>

- <span data-ttu-id="bf513-117">ソース SQL Server には、インストールされ有効になっているレプリケーション機能が必要です。</span><span class="sxs-lookup"><span data-stu-id="bf513-117">The source SQL Server should have the replication feature installed ane enabled.</span></span> <span data-ttu-id="bf513-118">レプリケーションが有効かどうかを確認するには、次の SQL スクリプトを実行します。</span><span class="sxs-lookup"><span data-stu-id="bf513-118">To check whether replication is enabled, execute the following SQL script.</span></span>

     ```sql
     -- If @installed is 0, replication must be added to the SQL Server installation. 
    USE master;
    GO  
    DECLARE @installed int;  
    EXEC @installed = sys.sp_MS_replication_installed;  
    SELECT @installed; 
     ```
     
    <span data-ttu-id="bf513-119">レプリケーション コンポーネントがインストールされていない場合は、[SQL Server レプリケーションのインストール](/sql/database-engine/install-windows/install-sql-server-replication?view=sql-server-ver15) の手順に従います。</span><span class="sxs-lookup"><span data-stu-id="bf513-119">If the replication components are not installed, follow the steps in [Install SQL Server replication](/sql/database-engine/install-windows/install-sql-server-replication?view=sql-server-ver15).</span></span> 

-   <span data-ttu-id="bf513-120">SQL Agent をソース データベース サーバーで実行する必要があります。</span><span class="sxs-lookup"><span data-stu-id="bf513-120">SQL Agent should be running in the source database server.</span></span>

-   <span data-ttu-id="bf513-121">SA 認証: ユーザーにはソース データベースとターゲット データベースでの DB_Owner 特権が必要です。</span><span class="sxs-lookup"><span data-stu-id="bf513-121">SA Authentication: A user should have DB_Owner privilege in the source database and the target database.</span></span> <span data-ttu-id="bf513-122">ソース データベースで、ユーザーは masterDb および sourceDb にアクセスできる必要があります。</span><span class="sxs-lookup"><span data-stu-id="bf513-122">In the source database, the user should have access to masterDb and sourceDb.</span></span>

-   <span data-ttu-id="bf513-123">ソース IP の許可リストに従ってターゲット ファイアウォールを更新します。</span><span class="sxs-lookup"><span data-stu-id="bf513-123">Update the target firewall by allow-listing the source IP.</span></span> <span data-ttu-id="bf513-124">これは LCS 経由で実行できます。</span><span class="sxs-lookup"><span data-stu-id="bf513-124">This can be done via LCS.</span></span> <span data-ttu-id="bf513-125">これによって 8 時間のアクセスのみが許可されます。</span><span class="sxs-lookup"><span data-stu-id="bf513-125">This only allows for 8 hours of access.</span></span> <span data-ttu-id="bf513-126">許可リストの後、8 時間以上のアクセス権があるターゲット データベースで次のストアド プロシージャを実行する必要があります。</span><span class="sxs-lookup"><span data-stu-id="bf513-126">After allow-listing, you need to execute the following stored procedure in the target database to have more than 8 hours of access.</span></span>

     ```sql
     -- Create database-level firewall setting for IP a.b.c.d 
     EXECUTE sp_set_database_firewall_rule N'AX 2012 Upgrade', 'a.b.c.d', 'a.b.c.d'; 
     ```
- <span data-ttu-id="bf513-127">以下はレプリケーションの待機時間/パフォーマンスを最適化するための、param.xml で更新できる微調整されたディストリビューターのパラメーターです。</span><span class="sxs-lookup"><span data-stu-id="bf513-127">To optimize the replication latency/performance, the following are fine-tuned distributors parameters that can be updated in the params.xml.</span></span>
    - <span data-ttu-id="bf513-128">MaxBcpThreads</span><span class="sxs-lookup"><span data-stu-id="bf513-128">MaxBcpThreads</span></span>
    - <span data-ttu-id="bf513-129">NumberOfPublishers</span><span class="sxs-lookup"><span data-stu-id="bf513-129">NumberOfPublishers</span></span>
    - <span data-ttu-id="bf513-130">ディストリビューター データベースのパス</span><span class="sxs-lookup"><span data-stu-id="bf513-130">Distributor database paths</span></span>

- <span data-ttu-id="bf513-131">ターゲット環境で AOS サービスを停止して、ターゲット データベースのレプリケーションを効率的に行います。</span><span class="sxs-lookup"><span data-stu-id="bf513-131">Stop the AOS service in the target environment, so that the target database will get replicated more efficiently.</span></span> <span data-ttu-id="bf513-132">ターゲットで AOS を実行すると、レプリケーション プロセスの速度が低下する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="bf513-132">Running the AOS in the target may cause slowdown in the replication process.</span></span> <span data-ttu-id="bf513-133">これにより、レプリケーション プロセスでスキーマ ロックやデッドロックが発生する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="bf513-133">This may cause schema lock or deadlock in the replication process.</span></span>

- <span data-ttu-id="bf513-134">ディストリビューターの設定時: このスクリプトにより、ソース サーバーにデータベースが作成されます。</span><span class="sxs-lookup"><span data-stu-id="bf513-134">When setting up Distributor: The script creates a database in the source server.</span></span> <span data-ttu-id="bf513-135">十分なスペースがあることを確認します。</span><span class="sxs-lookup"><span data-stu-id="bf513-135">Be sure you have enough space.</span></span> <span data-ttu-id="bf513-136">ソース データベースのサイズを最小限に抑えることが推奨されています。</span><span class="sxs-lookup"><span data-stu-id="bf513-136">The recommended is minimum to have the size of the source database.</span></span> <span data-ttu-id="bf513-137">params.xml では、指定されたパスでデータベースを作成できるようにディストリビューター データベースのパスを指定します。</span><span class="sxs-lookup"><span data-stu-id="bf513-137">In params.xml, specify the distributor database path so that the database can be created in the specified path.</span></span>

- <span data-ttu-id="bf513-138">params.xml の更新</span><span class="sxs-lookup"><span data-stu-id="bf513-138">Update params.xml</span></span>

    ```xml
    <?xml version="1.0" encoding="UTF-8"?>
    <! -- Database replication parameters for an AX 2012 to Dynamics 365 upgrade -->
    <Config>
      <!-- Edit the properties in this section for your source AX 2012 database -->
         <SourceDatabase>
                 <Server>SQLINSTANCE\SQLSERVERNAME</Server>
                 <Database>MicrosoftDynamicsAX</Database>
                  <UserName>ReplicationUser</UserName>
                  <Password>********************</Password>
         </SourceDatabase>
         <!-- Edit the properties in this section for your target Dynamics 365 database -->
         <TargetDatabase>
                  <Server>dbmigration.database.windows.net</Server>
                   <Database>dbms-prod</Database>
                   <UserName>axdbadmin</UserName>
                   <Password>*******************</Password>
        </TargetDatabase>
         <!-- Edit the properties in this section for your local SQL replication settings -->
        <SQLReplicationSettings>
        <!-- Ensure that you have enough space in the drive/path -->
        <SnapShotWorkingDir>D:\SQLServer\SnapShot</SnapShotWorkingDir>
             <DistributorDBDataFolder>D:\SQLServer\Data</DistributorDBDataFolder>
              <DistributorLogFolder>D:\SQLServer\Data</DistributorLogFolder>
              <!-- Based on the number of cores, you can set this, but the max this value can be is 8. This value should be between 4 to 8 -->
              <MaxBCPThreads>4</MaxBCPThreads>
              <!-- To increase the performance of the replication. This value should be between one and three. This value will be used to create the number of publishers for tables with primary keys. -->
              <NumberOfPublishers>2</NumberOfPublishers>
              <!-- Ignore DB objects xml file. The database objects listed in these files will be not be replicated. -->
               <IgnoreTablesList>\Data\ignoretables.xml</IgnoreTablesList>
               <IgnoreFunctionsList>\Data\ignorefunctions.xml</IgnoreFunctionsList>
        </SQLReplicationSettings>
    </Config>
    ```
    
- <span data-ttu-id="bf513-139">XML スキーマ: レプリケーション中に選択したテーブル、ビュー、および機能を無視するには、この情報を追加します。</span><span class="sxs-lookup"><span data-stu-id="bf513-139">XML Schema: To ignore selected tables, views, and functions during replication, add this information.</span></span>

    ```xml
    <IgnoreTables>                      <IgnoreFunctions>
        <Name>SYSDATABASELOG</Name>         <Name></Name>
    </IgnoreTables>                      </IgnoreFunctions>
    ```
    
## <a name="configuring-replication"></a><span data-ttu-id="bf513-140">レプリケーションの構成</span><span class="sxs-lookup"><span data-stu-id="bf513-140">Configuring replication</span></span>

<span data-ttu-id="bf513-141">**SQLTransactionalReplication** フォルダーには、SQL トランサクション レプリケーションを構成するのに必要なすべての Windows PowerShell スクリプトがあります。</span><span class="sxs-lookup"><span data-stu-id="bf513-141">The **SQLTransactionalReplication** folder has all the Windows PowerShell scripts that are required to configure the SQL transactional replication.</span></span> <span data-ttu-id="bf513-142">これらのスクリプトは、次の順序を使用して実行する必要があります。</span><span class="sxs-lookup"><span data-stu-id="bf513-142">These scripts should be executed using the following sequence.</span></span> <span data-ttu-id="bf513-143">プロセスが終了されるのを待つ必要があります。</span><span class="sxs-lookup"><span data-stu-id="bf513-143">Be sure to wait for the process to finish.</span></span>

1. <span data-ttu-id="bf513-144">**Replication_01_DataBaseCleanup.ps1** - ターゲット データベースが空になります。</span><span class="sxs-lookup"><span data-stu-id="bf513-144">**Replication_01_DataBaseCleanup.ps1** - Will empty the target database.</span></span>
2. <span data-ttu-id="bf513-145">**Replication_02_Distributor.ps1** - 完了時に、システム データベースの下のソース データベース サーバーで、ディストリビューター データベースが作成されます。</span><span class="sxs-lookup"><span data-stu-id="bf513-145">**Replication_02_Distributor.ps1** - Upon completion, the distributor database will get created in the source database server under the system database.</span></span>
3. <span data-ttu-id="bf513-146">**Replication_03_PublisherTables.ps1** - パブリッシャー スクリプトが正常に実行されると、パブリケーションはレプリケーション フォルダーの下に作成されます。</span><span class="sxs-lookup"><span data-stu-id="bf513-146">**Replication_03_PublisherTables.ps1** - After the publisher scripts are successfully executed, publication will be created under the replication folder.</span></span> <span data-ttu-id="bf513-147">これは完了するまでに少し時間がかかるので注意してください。</span><span class="sxs-lookup"><span data-stu-id="bf513-147">Note that this will take some time to complete.</span></span> <span data-ttu-id="bf513-148">これにより、AXDB_PUB_TABLE_Obj_[\*] というパブリッシャーが作成されます。</span><span class="sxs-lookup"><span data-stu-id="bf513-148">This creates publishers AXDB_PUB_TABLE_Obj_[\*].</span></span>

    > [!WARNING]
    > <span data-ttu-id="bf513-149">切替スクリプトを実行する前に、データ レプリケーションが完了するまで待機します。</span><span class="sxs-lookup"><span data-stu-id="bf513-149">Wait for data replication to complete before executing cutover scripts.</span></span> <span data-ttu-id="bf513-150">ステータスは次の方法で確認できます。</span><span class="sxs-lookup"><span data-stu-id="bf513-150">You can check the status in the following ways:</span></span>
    > - <span data-ttu-id="bf513-151">レプリケーション モニター: ソース サーバーで、**レプリケーター** フォルダーを右クリックし、**レプリケーション モニターの起動** を選択します。</span><span class="sxs-lookup"><span data-stu-id="bf513-151">Replication monitor: On the source server, right- click the **Replicatior** folder and select **Launch Replication Monitor**.</span></span> 
    > - <span data-ttu-id="bf513-152">レプリケーション ツールキットに埋め込まれた GetStatus.ps1 スクリプトを実行します。</span><span class="sxs-lookup"><span data-stu-id="bf513-152">Run GetStatus.ps1 script embedded in the replication toolkit.</span></span> <span data-ttu-id="bf513-153">**DataReplicationStatus** は各 AXDB_PUB_TABLE_Obj_[\*] パブリケーションに対して完了に設定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="bf513-153">**DataReplicationStatus** must be set to complete for each AXDB_PUB_TABLE_Obj_[\*] publication.</span></span>
  
4. <span data-ttu-id="bf513-154">**Replication_04_PublisherOtherObjects.ps1** - 新しいパブリケーションを作成して機能をターゲット データベースにレプリケートします。</span><span class="sxs-lookup"><span data-stu-id="bf513-154">**Replication_04_PublisherOtherObjects.ps1** - Replicates functions to the target database by creating new publication.</span></span> <span data-ttu-id="bf513-155">関数を移動しない場合は、この手順を省略できます。</span><span class="sxs-lookup"><span data-stu-id="bf513-155">This step can be omitted if you don't want to move functions.</span></span> <span data-ttu-id="bf513-156">これはすぐに完了することに注意してください。</span><span class="sxs-lookup"><span data-stu-id="bf513-156">Note that this will be completed quickly.</span></span> <span data-ttu-id="bf513-157">これにより、AX_PUB_OtherObjects というパブリッシャーが作成されます。</span><span class="sxs-lookup"><span data-stu-id="bf513-157">This creates publisher AX_PUB_OtherObjects.</span></span>
5. <span data-ttu-id="bf513-158">**CutOver_01_PublisherNoPK**.ps1 - これによりレプリケートするために 2 つのパブリケーション - 主キーのないテーブル、およびパブリケーション名を持つロックされたテーブル: AX_PUB_NoPKTable, AXDB_PUB_TABLE_Locked が作成されます</span><span class="sxs-lookup"><span data-stu-id="bf513-158">**CutOver_01_PublisherNoPK**.ps1 - This creates two publications to replicate:      - Non-primary key tables      - Locked tables with publication names: AX_PUB_NoPKTable, AXDB_PUB_TABLE_Locked</span></span>
7. <span data-ttu-id="bf513-159">**CutOver_02_PKDeletion_PostReplication.ps1** - これにより、主キーのない一時テーブルがクリーン アップされます。</span><span class="sxs-lookup"><span data-stu-id="bf513-159">**CutOver_02_PKDeletion_PostReplication.ps1** - This will clean up the temp tables created for tables with no primary keys.</span></span> <span data-ttu-id="bf513-160">AX_PUB_NoPKTable というパブリケーションを削除します。</span><span class="sxs-lookup"><span data-stu-id="bf513-160">Deletes publication AX_PUB_NoPKTable.</span></span>
8. <span data-ttu-id="bf513-161">**CutOver_03_RetrieveAndCreateNoPKConstraints.ps1** - これにより、ソースから主キーなしのテーブルの制約条件が抽出され、ターゲット データベースに作成されます。</span><span class="sxs-lookup"><span data-stu-id="bf513-161">**CutOver_03_RetrieveAndCreateNoPKConstraints.ps1** - This extracts constraints for the tables with no primary keys from the source and creates them in the target database.</span></span>
9. <span data-ttu-id="bf513-162">**CutOver_04_RemoveReplication.ps1** - データベースのレプリケーションを正常に行った後、このスクリプトを実行してレプリケーション設定情報を削除できます。</span><span class="sxs-lookup"><span data-stu-id="bf513-162">**CutOver_04_RemoveReplication.ps1** - After successful replication of the database, you can execute this script to remove replication setup information.</span></span> <span data-ttu-id="bf513-163">スナップショット フォルダーをエラーなしで削除する場合は、ソース Db で次のストアド プロシージャを実行します。</span><span class="sxs-lookup"><span data-stu-id="bf513-163">If you want to remove the snapshot folder without errors, execute the following stored procedure in the source Db.</span></span> <span data-ttu-id="bf513-164">そうしない場合、実行後に手動で削除する必要があるスナップショット フォルダーをシステムが削除できなかったというエラーが表示されます。</span><span class="sxs-lookup"><span data-stu-id="bf513-164">Otherwise, after execution you will get an error that the system was unable to remove the snapshot folders, which should be removed manually.</span></span>

```sql
EXEC master.dbo.sp_configure 'show advanced options', 1
RECONFIGURE WITH OVERRIDE
EXEC master.dbo.sp_configure 'xp_cmdshell', 1
RECONFIGURE WITH OVERRIDE
```

<span data-ttu-id="bf513-165">レプリケーション設定時に、ソース データベースに次のパブリケーションが作成されます。</span><span class="sxs-lookup"><span data-stu-id="bf513-165">The following publications will get created in the source database when setting up the replication.</span></span>

![レプリケーション設定時に、ソース データベースに作成されるパブリケーション](media/Replication.png)

## <a name="find-the-replication-status-and-get-an-exception"></a><span data-ttu-id="bf513-167">レプリケーション ステータスの検索と例外の取得</span><span class="sxs-lookup"><span data-stu-id="bf513-167">Find the replication status and get an exception</span></span>

<span data-ttu-id="bf513-168">レプリケーションのステータスを検索して例外を取得するには、PowerShell スクリプトを実行し、終了するまで待機します。</span><span class="sxs-lookup"><span data-stu-id="bf513-168">To find the replication status and get an exception, execute the PowerShell script and wait for it to finish.</span></span>

<span data-ttu-id="bf513-169">**GetStatus.ps1** - このスクリプトを実行する場合、**レプリケーション ステータス** テーブルが、スキーマの AgentId、PublicationName、Job、LastSynced、JobStatus、ReplicationStatus、および Comments と共に一覧表示されます。</span><span class="sxs-lookup"><span data-stu-id="bf513-169">**GetStatus.ps1** - When you execute this script, the **Replication status** table will be listed, along with the schema AgentId, PublicationName, Job, LastSynced, JobStatus, ReplicationStatus, and Comments.</span></span>

- <span data-ttu-id="bf513-170">AgentId - ジョブに関する例外の詳細をフェッチするために使用されます。</span><span class="sxs-lookup"><span data-stu-id="bf513-170">AgentId - Used to fetch the exception details about the job.</span></span>
- <span data-ttu-id="bf513-171">PublicationName - データをレプリケートするために作成されたパブリケーション名です。</span><span class="sxs-lookup"><span data-stu-id="bf513-171">PublicationName - The publication names created for replicating the data.</span></span> <span data-ttu-id="bf513-172">同じ情報は、レプリケーション フォルダーの下にある SQLServerExplorer で確認できます。</span><span class="sxs-lookup"><span data-stu-id="bf513-172">You can find the same information in the SQLServerExplorer under Replication folders.</span></span>
- <span data-ttu-id="bf513-173">Job - ジョブには、スナップショットとデータ レプリケーションの 2 つのタイプがあります。</span><span class="sxs-lookup"><span data-stu-id="bf513-173">Job - There are two types of jobs: Snapshot and Data Replication.</span></span>
- <span data-ttu-id="bf513-174">JobStatus - これにより、開始済、成功、処理中、アイドル、再試行、または失敗のステータスが表示されます。</span><span class="sxs-lookup"><span data-stu-id="bf513-174">JobStatus - This will display the statuses of Started, Succeeded, In Progress, Idle, Retrying, or Failed.</span></span> <span data-ttu-id="bf513-175">スナップショット ジョブでは、ステータスが 「成功」 になった後は実行されません。</span><span class="sxs-lookup"><span data-stu-id="bf513-175">For snapshot jobs, after the status is Succeeded this will no longer execute.</span></span> <span data-ttu-id="bf513-176">データ レプリケーション ジョブでは、データベースの更新情報に基づいてステータスが引き続き変更されます。</span><span class="sxs-lookup"><span data-stu-id="bf513-176">For data replication jobs, the status will continue to change based on the update information in the database.</span></span>
- <span data-ttu-id="bf513-177">ReplicationStatus - これはデータ レプリケーション ジョブにのみ適用されます。</span><span class="sxs-lookup"><span data-stu-id="bf513-177">ReplicationStatus - This applies only to the data replication jobs.</span></span> <span data-ttu-id="bf513-178">ステータスには、待機中、処理中、および完了が含まれます。</span><span class="sxs-lookup"><span data-stu-id="bf513-178">Statuses include Waiting, In Progress, and Completed.</span></span>
- <span data-ttu-id="bf513-179">Comments - JobStatus が InProgress の場合、引き続き変更されます。</span><span class="sxs-lookup"><span data-stu-id="bf513-179">Comments - This willcontinue to change when the JobStatus is InProgress.</span></span>
 
<span data-ttu-id="bf513-180">**GetException.ps1** - 例外を取得するために AgentId を指定します。</span><span class="sxs-lookup"><span data-stu-id="bf513-180">**GetException.ps1** - Provide the AgentId to get the exceptions.</span></span> <span data-ttu-id="bf513-181">AgentId はステータスから取得できます。</span><span class="sxs-lookup"><span data-stu-id="bf513-181">AgentId can be retrieved from the status.</span></span>

## <a name="find-the-replication-configuration-and-status-via-sql-server-management-studio"></a><span data-ttu-id="bf513-182">SQL Server Management Studio 経由でのレプリケーションの構成とステータスの検索</span><span class="sxs-lookup"><span data-stu-id="bf513-182">Find the replication configuration and status via SQL Server Management Studio</span></span>
<span data-ttu-id="bf513-183">SQL Server Management Studio を使用してレプリケーション ステータスの構成とステータスを検索するには、次の手順に従います。</span><span class="sxs-lookup"><span data-stu-id="bf513-183">To find the replication status configuration and status using SQL Server Management Studio, follow these steps:</span></span>

- <span data-ttu-id="bf513-184">レプリケーション機能が使用可能でサーバーにインストールされているかどうかを判断するには、オブジェクト エクスプローラーのレプリケーション フォルダーを表示する必要があります。</span><span class="sxs-lookup"><span data-stu-id="bf513-184">To determine if the replication feature is available and installed on the server, you should see the Replication folder in Object Explorer.</span></span>
   
   ![レプリケーション フォルダー](media/Replication1.png)

- <span data-ttu-id="bf513-186">**Replication_03_PublisherTables.ps1** スクリプトを実行した後、レプリケーション フォルダーの下に構成済みのパブリッシャーを表示する必要があります。</span><span class="sxs-lookup"><span data-stu-id="bf513-186">After executing the **Replication_03_PublisherTables.ps1** script, you should be able to see the publisher configured under the Replication folder.</span></span>
    
    ![レプリケーション フォルダーの下のパブリッシャーを表示する](media/Replication2.png)

- <span data-ttu-id="bf513-188">レプリケーション ステータスを確認するには、**レプリケーション** フォルダーを右クリックし、**レプリケーション モニターの起動** を選択します。</span><span class="sxs-lookup"><span data-stu-id="bf513-188">To determine the replication status, right-click the **Replication** folder and select **Launch Replication Monitor**.</span></span>
   
   ![メニューのレプリケーション モニターの起動を選択する](media/Replication3.png)

- <span data-ttu-id="bf513-190">**レプリケーション モニター** ウィンドウでは、レプリケーション用に作成されたすべてのパブリッシャーを表示できます。</span><span class="sxs-lookup"><span data-stu-id="bf513-190">In the **Replication Monitor** window, you can see all the publishers that have been created for replication.</span></span>
    
    ![レプリケーション用に作成されたすべてのパブリッシャー](media/Replication4.png)

- <span data-ttu-id="bf513-192">**スナップショット** タブを選択すると、スナップショットのステータスが表示されます。</span><span class="sxs-lookup"><span data-stu-id="bf513-192">Select the **Snapshot** tab to see the status of the snapshot.</span></span>
  
  ![スナップショット タブを選択して、スナップショットのステータスを表示する](media/Replication5.png)

- <span data-ttu-id="bf513-194">詳細ログ/トランザクションを表示するには、品目をダブルクリックします。</span><span class="sxs-lookup"><span data-stu-id="bf513-194">To view the detail log/transaction, double-click the item.</span></span>
   
   ![詳細ログ/トランザクションを表示するには、品目をダブルクリックする](media/Replication6.png)

- <span data-ttu-id="bf513-196">ターゲットへのデータ レプリケーションを表示するには、**すべてのサブスクリプション** タブを選択し、品目のサブスクリプションをダブルクリックします。</span><span class="sxs-lookup"><span data-stu-id="bf513-196">To view the data replication to the target, select the **All Subscription** tab and double-click the subscription for the item.</span></span> 

## <a name="troubleshooting"></a><span data-ttu-id="bf513-197">トラブルシューティング</span><span class="sxs-lookup"><span data-stu-id="bf513-197">Troubleshooting</span></span>

| <span data-ttu-id="bf513-198">**例外**</span><span class="sxs-lookup"><span data-stu-id="bf513-198">**Exception**</span></span> | <span data-ttu-id="bf513-199">**解決/修正**</span><span class="sxs-lookup"><span data-stu-id="bf513-199">**Solution/Fix**</span></span> |
|-------------------------|-------------------------|
| <span data-ttu-id="bf513-200">パブリケーションの作成後にスナップショットの作成に失敗し、次のエラーが発生した場合。</span><span class="sxs-lookup"><span data-stu-id="bf513-200">After creating the publication, if the snapshot creation fails with the following errors:</span></span><br></br><span data-ttu-id="bf513-201"><em>エラー メッセージ:</em></span><span class="sxs-lookup"><span data-stu-id="bf513-201"><em>Error messages:</em></span></span></br><span data-ttu-id="bf513-202"><em>Source: Microsoft.SqlServer.Smo</em></span><span class="sxs-lookup"><span data-stu-id="bf513-202"><em>Source: Microsoft.SqlServer.Smo</em></span></span></br><span data-ttu-id="bf513-203"><em>Target Site: Void PrefetchObjectsImpl(System.Type, Microsoft.SqlServer.Management.Smo.ScriptingPreferences)</em></span><span class="sxs-lookup"><span data-stu-id="bf513-203"><em>Target Site: Void PrefetchObjectsImpl(System.Type, Microsoft.SqlServer.Management.Smo.ScriptingPreferences)</em></span></span></br><span data-ttu-id="bf513-204"><em>Message: Prefetch objects failed for Database 'AxDB_ASIA'.</em></span><span class="sxs-lookup"><span data-stu-id="bf513-204"><em>Message: Prefetch objects failed for Database 'AxDB_ASIA'.</em></span></span></br><span data-ttu-id="bf513-205"><em>Stack:    at Microsoft.SqlServer.Management.Smo.Database.PrefetchObjectsImpl(Type objectType, ScriptingPreferences scriptingPreferences)</em></span><span class="sxs-lookup"><span data-stu-id="bf513-205"><em>Stack:    at Microsoft.SqlServer.Management.Smo.Database.PrefetchObjectsImpl(Type objectType, ScriptingPreferences scriptingPreferences)</em></span></span></br><span data-ttu-id="bf513-206"><em>   at Microsoft.SqlServer.Replication.Snapshot.SmoScriptingManager.ObjectPrefetchControl.DoPrefetch(Database database)</em></span><span class="sxs-lookup"><span data-stu-id="bf513-206"><em>   at Microsoft.SqlServer.Replication.Snapshot.SmoScriptingManager.ObjectPrefetchControl.DoPrefetch(Database database)</em></span></span></br><span data-ttu-id="bf513-207"><em>   at Microsoft.SqlServer.Replication.Snapshot.SmoScriptingManager.PrefetchObjects(ObjectPrefetchControl[] objectPrefetchControls)</em></span><span class="sxs-lookup"><span data-stu-id="bf513-207"><em>   at Microsoft.SqlServer.Replication.Snapshot.SmoScriptingManager.PrefetchObjects(ObjectPrefetchControl[] objectPrefetchControls)</em></span></span></br><span data-ttu-id="bf513-208"><em>   at Microsoft.SqlServer.Replication.Snapshot.SmoScriptingManager.DoPrefetchWithRetry()</em></span><span class="sxs-lookup"><span data-stu-id="bf513-208"><em>   at Microsoft.SqlServer.Replication.Snapshot.SmoScriptingManager.DoPrefetchWithRetry()</em></span></span></br><span data-ttu-id="bf513-209"><em>   at Microsoft.SqlServer.Replication.Snapshot.SmoScriptingManager.DoScripting()</em></span><span class="sxs-lookup"><span data-stu-id="bf513-209"><em>   at Microsoft.SqlServer.Replication.Snapshot.SmoScriptingManager.DoScripting()</em></span></span></br><span data-ttu-id="bf513-210"><em>   at Microsoft.SqlServer.Replication.Snapshot.SqlServerSnapshotProvider.DoScripting()</em></span><span class="sxs-lookup"><span data-stu-id="bf513-210"><em>   at Microsoft.SqlServer.Replication.Snapshot.SqlServerSnapshotProvider.DoScripting()</em></span></span></br><span data-ttu-id="bf513-211"><em>   at Microsoft.SqlServer.Replication.Snapshot.SqlServerSnapshotProvider.GenerateSnapshot()</em></span><span class="sxs-lookup"><span data-stu-id="bf513-211"><em>   at Microsoft.SqlServer.Replication.Snapshot.SqlServerSnapshotProvider.GenerateSnapshot()</em></span></span></br><span data-ttu-id="bf513-212"><em>   at Microsoft.SqlServer.Replication.SnapshotGenerationAgent.InternalRun()</em></span><span class="sxs-lookup"><span data-stu-id="bf513-212"><em>   at Microsoft.SqlServer.Replication.SnapshotGenerationAgent.InternalRun()</em></span></span></br><span data-ttu-id="bf513-213"><em>   at Microsoft.SqlServer.Replication.AgentCore.Run() (Source: Microsoft.SqlServer.Smo, Error number: 0)</em></span><span class="sxs-lookup"><span data-stu-id="bf513-213"><em>   at Microsoft.SqlServer.Replication.AgentCore.Run() (Source: Microsoft.SqlServer.Smo, Error number: 0)</em></span></span> | <span data-ttu-id="bf513-214">レプリケーション モニターからスナップショットの作成を再起動します。</span><span class="sxs-lookup"><span data-stu-id="bf513-214">From the Replication Monitor, restart the snapshot creation.</span></span> |
| <span data-ttu-id="bf513-215">サブスクリプションは無効とマークされ、再初期化する必要があります。</span><span class="sxs-lookup"><span data-stu-id="bf513-215">The subscriptions have been marked as inactive and must be reinitialized.</span></span> <span data-ttu-id="bf513-216">NoSync サブスクリプションは削除して再作成する必要があります。</span><span class="sxs-lookup"><span data-stu-id="bf513-216">NoSync subscriptions will need to be dropped and recreated.</span></span> <span data-ttu-id="bf513-217">(Source: MSSQLServer, Error number: 21074)</span><span class="sxs-lookup"><span data-stu-id="bf513-217">(Source: MSSQLServer, Error number: 21074)</span></span> | <span data-ttu-id="bf513-218">1) 次のクエリを使用してソース データベースのステータスを確認し、ステータスを特定のパブリケーションのために &quot;2&quot; に更新する</span><span class="sxs-lookup"><span data-stu-id="bf513-218">1) Check the status in the source database using the following query and update the status to &quot;2&quot; for the specific publication</span></span></br><em><br><span data-ttu-id="bf513-219">ステータスを確認して、この出力クエリから srvname を取得できる</em></span><span class="sxs-lookup"><span data-stu-id="bf513-219">Check the status, you can get the srvname from this output query</em></span></span></br><span data-ttu-id="bf513-220">**select** \* **from** syssubscriptions **WHERE** status != 2</span><span class="sxs-lookup"><span data-stu-id="bf513-220">**select** \* **from** syssubscriptions **WHERE** status != 2</span></span></br><em><br><span data-ttu-id="bf513-221">ステータスが !=2 の場合のみ更新</em></span><span class="sxs-lookup"><span data-stu-id="bf513-221">Update only if the status !=2</em></span></span></br><span data-ttu-id="bf513-222">**Update** syssubscriptions **SET** status = 2 **where** srvname = 'your target server name'</span><span class="sxs-lookup"><span data-stu-id="bf513-222">**Update** syssubscriptions **SET** status = 2 **where** srvname = 'your target server name'</span></span></br><br><span data-ttu-id="bf513-223">2) 次のクエリを使用してディストリビューター データベースのステータスを確認し、ステータスを特定のパブリケーションのために &quot;2&quot; に更新する</span><span class="sxs-lookup"><span data-stu-id="bf513-223">2) Check the status in the distributor database with the following query and update the status to &quot;2&quot; for the specific publication</span></span></br><em><br><span data-ttu-id="bf513-224">publication_id を取得するために、次のクエリを使用し、自分のパブリケーション名と一致させる</em></span><span class="sxs-lookup"><span data-stu-id="bf513-224">To get the publication_id, use this following query and match this with your publication name</em></span></span></br><span data-ttu-id="bf513-225">**SELECT** \* **FROM** MSpublications</span><span class="sxs-lookup"><span data-stu-id="bf513-225">**SELECT** \* **FROM** MSpublications</span></span></br><em><br><span data-ttu-id="bf513-226">次のクエリを使用してステータスを確認する</em></span><span class="sxs-lookup"><span data-stu-id="bf513-226">Check the status using the following query</em></span></span></br><span data-ttu-id="bf513-227">**SELECT** \* **FROM** MSsubscriptions **WHERE** status !=2 publication_id = &lt;@publicationId&gt;</span><span class="sxs-lookup"><span data-stu-id="bf513-227">**SELECT** \* **FROM** MSsubscriptions **WHERE** status !=2 publication_id = &lt;@publicationId&gt;</span></span></br><em><br><span data-ttu-id="bf513-228">特定の publication_id に対するステータスが !-2 の時に更新</em></span><span class="sxs-lookup"><span data-stu-id="bf513-228">Update if the status is !-2 for that specific publication_id</em></span></span></br><span data-ttu-id="bf513-229">**Update** MSsubscriptions **SET** status = 2 **where** publication_id = &lt;@publicationId&gt;</span><span class="sxs-lookup"><span data-stu-id="bf513-229">**Update** MSsubscriptions **SET** status = 2 **where** publication_id = &lt;@publicationId&gt;</span></span> |
| <span data-ttu-id="bf513-230">エラー メッセージ:</span><span class="sxs-lookup"><span data-stu-id="bf513-230">Error messages:</span></span></br><em><br><span data-ttu-id="bf513-231">このプロセスでは、「replicationsrv\MSSQLSERVER2016」 に対して 「sp_replcmds」 が実行できませんでした。</span><span class="sxs-lookup"><span data-stu-id="bf513-231">The process could not execute 'sp_replcmds' on 'replicationsrv\MSSQLSERVER2016'.</span></span> <span data-ttu-id="bf513-232">(Source: MSSQL_REPL, Error number: MSSQL_REPL20011)</em></span><span class="sxs-lookup"><span data-stu-id="bf513-232">(Source: MSSQL_REPL, Error number: MSSQL_REPL20011)</em></span></span></br><span data-ttu-id="bf513-233"><em>ヘルプ: http://help/MSSQL_REPL20011</em></span><span class="sxs-lookup"><span data-stu-id="bf513-233"><em>Get help: http://help/MSSQL_REPL20011</em></span></span></br><em><br><span data-ttu-id="bf513-234">プリンシパル &quot; dbo &quot; は存在しておらず、このタイプのプリンシパルはアクセス許可を借用できないかまたはアクセス許可がないために、データベース プリンシパルとして実行することができません。</span><span class="sxs-lookup"><span data-stu-id="bf513-234">Cannot execute as the database principal because the principal &quot;dbo&quot; does not exist, this type of principal cannot be impersonated, or you do not have permission.</span></span> <span data-ttu-id="bf513-235">(Source: MSSQLServer, Error number: 15517)</em></span><span class="sxs-lookup"><span data-stu-id="bf513-235">(Source: MSSQLServer, Error number: 15517)</em></span></span></br><span data-ttu-id="bf513-236"><em>ヘルプの取得: http://help/15517</em></span><span class="sxs-lookup"><span data-stu-id="bf513-236"><em>Get help: http://help/15517</em></span></span></br><em><br><span data-ttu-id="bf513-237">このプロセスでは、「replicationsrv\MSSQLSERVER2016」 に対して 「sp_replcmds」 が実行できませんでした。</span><span class="sxs-lookup"><span data-stu-id="bf513-237">The process could not execute 'sp_replcmds' on 'replicationsrv\MSSQLSERVER2016'.</span></span> <span data-ttu-id="bf513-238">(Source: MSSQL_REPL, Error number: MSSQL_REPL22037)</em></span><span class="sxs-lookup"><span data-stu-id="bf513-238">(Source: MSSQL_REPL, Error number: MSSQL_REPL22037)</em></span></span></br><span data-ttu-id="bf513-239"><em>ヘルプの取得: http://help/MSSQL_REPL22037</em></span><span class="sxs-lookup"><span data-stu-id="bf513-239"><em>Get help: http://help/MSSQL_REPL22037</em></span></span> | <span data-ttu-id="bf513-240">ソース データベースでこれを実行し、パブリケーションの作成に使用した資格情報でサインインする</span><span class="sxs-lookup"><span data-stu-id="bf513-240">Execute this in the source database and sign in with the credentials that you used to create the publication</span></span></br><span data-ttu-id="bf513-241">**EXEC** sp_changedbowner 'sa'</span><span class="sxs-lookup"><span data-stu-id="bf513-241">**EXEC** sp_changedbowner 'sa'</span></span> |
| <span data-ttu-id="bf513-242">パブリケーションを削除するには</span><span class="sxs-lookup"><span data-stu-id="bf513-242">To remove/delete a publication</span></span> | <span data-ttu-id="bf513-243">このストアド プロシージャをソース データベースで実行する;</span><span class="sxs-lookup"><span data-stu-id="bf513-243">Execute this stored procedure in the source database;</span></span></br><em><br><span data-ttu-id="bf513-244">サブスクリプションをクリーンアップする:</em></span><span class="sxs-lookup"><span data-stu-id="bf513-244">Clean the subscription:</em></span></span></br><span data-ttu-id="bf513-245">**exec** sp_subscription_cleanup @publisher = @publisherServer, @publisher_db = @publisherDb, @publication = @publicationName</span><span class="sxs-lookup"><span data-stu-id="bf513-245">**exec** sp_subscription_cleanup @publisher = @publisherServer, @publisher_db = @publisherDb, @publication = @publicationName</span></span></br><em><br><span data-ttu-id="bf513-246">サブスクリプションを削除する:</em></span><span class="sxs-lookup"><span data-stu-id="bf513-246">Drop the subscription:</em></span></span></br><span data-ttu-id="bf513-247">**exec** sp_dropsubscription @publication = @publicationName, @subscriber = N'all', @article = N'all'</span><span class="sxs-lookup"><span data-stu-id="bf513-247">**exec** sp_dropsubscription @publication = @publicationName, @subscriber = N'all', @article = N'all'</span></span></br><em><br><span data-ttu-id="bf513-248">パブリケーションを削除する:</em></span><span class="sxs-lookup"><span data-stu-id="bf513-248">Drop the publication:</em></span></span></br><span data-ttu-id="bf513-249">**exec** sp_droppublication @publication = @publicationName</span><span class="sxs-lookup"><span data-stu-id="bf513-249">**exec** sp_droppublication @publication = @publicationName</span></span> |
| <span data-ttu-id="bf513-250">パブリケーションから記事を削除するには、[sp_dropsubscription (Transact-SQL)](https://docs.microsoft.com/sql/relational-databases/system-stored-procedures/sp-dropsubscription-transact-sql?view=sql-server-ver15) を参照する</span><span class="sxs-lookup"><span data-stu-id="bf513-250">To remove an article from the publication, see [sp_dropsubscription (Transact-SQL)](https://docs.microsoft.com/sql/relational-databases/system-stored-procedures/sp-dropsubscription-transact-sql?view=sql-server-ver15)</span></span> | <span data-ttu-id="bf513-251">このストアド プロシージャをソース データベースで実行する:</span><span class="sxs-lookup"><span data-stu-id="bf513-251">Execute this stored procedure in the source database:</span></span><br><br><span data-ttu-id="bf513-252">**EXEC** sp_dropsubscription</span><span class="sxs-lookup"><span data-stu-id="bf513-252">**EXEC** sp_dropsubscription</span></span></br><span data-ttu-id="bf513-253">@publication = @publication、</span><span class="sxs-lookup"><span data-stu-id="bf513-253">@publication = @publication,</span></span></br><span data-ttu-id="bf513-254">@article = N'All',</span><span class="sxs-lookup"><span data-stu-id="bf513-254">@article = N'all',</span></span></br><span data-ttu-id="bf513-255">@subscriber = @subscriber;</span><span class="sxs-lookup"><span data-stu-id="bf513-255">@subscriber = @subscriber;</span></span></br><em><br><span data-ttu-id="bf513-256">例: </em></span><span class="sxs-lookup"><span data-stu-id="bf513-256">Example: </em></span></span></br><span data-ttu-id="bf513-257">**EXEC** sp_dropsubscription @publication = N'OtherObjects_sp', @article = N'MaintainShipCarrierRole', @subscriber = N'SPARTAN-SRV-NAM-D365OPSDEV-D5E38124F9F8.DATABASE.WINDOWS.NET';</span><span class="sxs-lookup"><span data-stu-id="bf513-257">**EXEC** sp_dropsubscription @publication = N'OtherObjects_sp', @article = N'MaintainShipCarrierRole', @subscriber = N'SPARTAN-SRV-NAM-D365OPSDEV-D5E38124F9F8.DATABASE.WINDOWS.NET';</span></span> |

