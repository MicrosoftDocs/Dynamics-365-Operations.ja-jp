---
title: アプリケーション クラスのメソッドを呼び出す ER 式の設計
description: この記事では、必要なアプリケーション クラスのメソッドを呼び出すことによって、電子申告コンフィギュレーションで既存のアプリケーション ロジックを再利用する方法について説明します。
author: kfend
ms.date: 11/02/2021
ms.topic: business-process
ms.prod: ''
ms.technology: ''
audience: Application User
ms.reviewer: kfend
ms.search.region: Global
ms.author: filatovm
ms.search.validFrom: 2016-06-30
ms.dyn365.ops.version: Version 7.0.0
ms.openlocfilehash: 21c24cee15e9a0fd11838b5b8fd816e4aaed9a93
ms.sourcegitcommit: 87e727005399c82cbb6509f5ce9fb33d18928d30
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/12/2022
ms.locfileid: "9267845"
---
# <a name="design-er-expressions-to-call-application-class-methods"></a>アプリケーション クラスのメソッドを呼び出す ER 式の設計

[!include [banner](../../includes/banner.md)]

この記事では、ER の式で必要なアプリケーション クラスのメソッドを呼び出すことによって、[電子申告 (ER)](../general-electronic-reporting.md) コンフィギュレーションで既存のアプリケーション ロジックを再利用する方法について説明します。 クラスを呼び出す引数の値は、実行時に動的に定義できます。 たとえば、解析ドキュメントの情報に基づいて値を設定し、その修正を行います。

この記事の例では、アプリケーション データ更新のために受取口座取引明細書を解析するプロセスを設計します。 受取口座取引明細書は、国際銀行番号 (IBAN) コードを含むテキスト (.txt) ファイルとして受信します。 口座取引明細書のインポート プロセスの一部として、すでに利用可能なロジックを使用して、IBAN コードの正確性を検証する必要があります。

## <a name="prerequisites"></a>必要条件

この記事の手順は、**システム管理者** または **電子レポート開発者** ロールが割り当てられているユーザーを対象としています。

これらの手順は、任意のデータ セットを使用することによって完了できます。

手順を実行するには、ファイル [SampleIncomingMessage.txt](https://download.microsoft.com/download/8/0/a/80adbc89-f23c-46d9-9241-e0f19125c04b/SampleIncomingMessage.txt) をローカルでダウンロードして保存する必要があります。

この記事では、サンプル会社 Litware, Inc. に必要な ER 構成を作成します。 したがって、この記事の手順を完了する前に、次の手順を実行する必要があります。

1. **組織管理** \> **ワークスペース** \> **電子申告** の順に移動します。
2. **ローカライズの構成** ページで、**Litware, Inc.** サンプル会社の構成 プロバイダーが使用可能であり、アクティブとマークされていることを確認します。 この構成プロバイダーが表示されない場合は、[構成プロバイダを作成し、アクティブとしてマークする](er-configuration-provider-mark-it-active-2016-11.md) に記載の手順を完了する必要があります。

## <a name="import-a-new-er-model-configuration"></a>新しい ER モデル コンフィギュレーションのインポート

1. **ローカライズ構成** ページの、**構成プロバイダー** セクションで、**Microsoft** 構成プロバイダーのタイルを選択します。
2. **リポジトリ** を選択します。
3. **ローカライズ リポジトリ** ページで、**フィルターの表示** を選択します。
4. グローバル リポジトリ レコードを選択するには、**名前** フィルター フィールドを追加します。
5. **名前** フィールドに、**グローバル** と入力します。 次に、**含む** フィルター演算子を選択します。
6. **適用** を選択します。
7. **[開く](../er-download-configurations-global-repo.md#open-configurations-repository)** を選択して、選択したリポジトリの ER コンフィギュレーションの一覧を確認します。
8. **構成リポジトリ** ページの構成ツリーで、**支払モデル** を選択します。
9. **バージョン** クイック タブで、**インポート** ボタンが利用可能な場合はそれを選択し、**はい** を選択します。

    **インポート** ボタンが利用可能でない場合は、**支払モデル** ER 構成 の選択したバージョンがすでにインポートされています。

10. **構成リポジトリ** ページを閉じ、**ローカライズ リポジトリ** ページを閉じます。

## <a name="add-a-new-er-format-configuration"></a>新しい ER 形式コンフィギュレーションを追加する

新しい ER 形式を追加して、受取口座取引明細書を TXT 形式で解析します。

1. **ローカライズ構成** ページで、**レポートの構成** タイルを選択します。
2. **コンフィギュレーション** ページでウィンドウの左側のコンフィギュレーション ツリーで、**支払モデル** を選択します。
3. **構成の作成** を選択します。 
4. ドロップダウン ダイアログ ボックスで、次の手順に従います。

    1. **新規** フィールドで、**PaymentModel データ モデルに基づいた書式** と入力します。
    2. **名前** フィールドに **口座取引明細書のインポート形式 (サンプル)** と入力します。
    3. **データのインポートのサポート** フィールドで **はい** を選択します。
    4. **構成を作成する** を選択して、構成の作成を完了します。

## <a name="design-the-er-format-configuration--format"></a>ER 形式のコンフィギュレーションをデザイン- 形式

TXT 形式の外部ファイルの予想構造を表す ER 形式を設計します。

1. 追加した **口座取引明細書インポート形式 (サンプル)** 形式コンフィギュレーションの場合、**デザイナー** を選択します。
2. **フォーマット デザイナー** ページの左ペインのフォーマット構成ツリーで、**ルートを追加** を選択します。
3. 表示されるダイアログ ボックスで、次の手順に従います:

    1. ツリーで **Text\\Sequence** を選択して、**順序** 形式コンポーネントを追加します。
    2. **名前** フィールドに、**ルート** と入力します。
    3. **特殊文字** フィールドでは、**改行 - Windows (CR LF)** を選択します。 この設定に基づいて、解析ファイル内の各明細行を別々のレコードとみなす必要があります。
    4.  **OK** を選択します。

4. **追加** を選択します。
5. 表示されるダイアログ ボックスで、次の手順に従います:

    1. ツリーで、**Text\\Sequence** を選択します。
    2. **名前** フィールドに、**行** と入力します。
    3. **多様性** フィールドで、**1 つ、多数** を選択します。 この設定に基づいて、解析ファイルに少なくとも 1 つの明細行が存在することが予想されます。
    4.  **OK** を選択します。

6. ツリーで、**Root\\Rows** を選択してから、**シーケンスの追加** を選択します。
7. 表示されるダイアログ ボックスで、次の手順に従います:

    1. **名前** フィールドに、**フィールド** と入力します。
    2. **多様性** フィールドで、**1 つのみ** を選択します。
    3.  **OK** を選択します。

8. ツリーで、**Root\\Rows\\Fields** を選択してから、**追加** を選択します。
9. 表示されるダイアログ ボックスで、次の手順に従います:

    1. ツリーで、**Text\\String** を選択します。
    2. **名前** フィールドに、**IBAN** と入力します。
    3..  **OK** を選択します。

10. **保存** を選択します。

解析ファイルの各明細行に IBAN コードのみが含まれるように構成が設定されました。

![形式デザイナー ページの口座取引明細書インポート形式 (サンプル) 形式コンフィギュレーション。](../media/design-expressions-app-class-er-01.png)

## <a name="design-the-er-format-configuration--mapping-to-a-data-model"></a>ER 形式のコンフィギュレーションをデザイン- データ モデルへのマッピング

解析ファイルの情報を使用してデータ モデルに入力する ER 形式のマッピングを設計します。

1. **形式デザイナー** の、アクション ウィンドウで、**形式をモデルにマッピング** を選択します。
2. **モデルからデータ ソースへのマッピング** ページのアクション ペインで、**新規** を選択します。
3. **定義** フィールドで、**BankToCustomerDebitCreditNotificationInitiation** を選択します。
4. **名前** フィールドに、**データ モデルにマッピング** と入力します。
5. **保存** を選択します。
6. **デザイナー** をクリックします。
7. **モデル マッピング デザイナー** ページの、**データ ソース タイプ** ツリーで、**Dynamics 365 for Operations\\Class** を選択します。
8. **データ ソース** セクションで、**ルートの追加** を選択して IBAN コード検証用の既存のアプリケーション ロジックを呼び出すデータ ソースを追加します。
9. 表示されるダイアログ ボックスで、次の手順に従います:

    1. **名前** フィールドに、**Check\_codes** と入力します。
    2. **クラス** フィールドで **ISO7064** を入力または選択します。
    3.  **OK** を選択します。

10. **データ ソース タイプ** ツリーで、次の手順に従います。

    1. **形式** データ ソースを展開します。
    2. **形式\\ルート: 順番 (ルート)** を展開します。
    3. **形式\\ルート: 順番 (ルート)\\行: 順番 1..\* (行)** を展開します。
    4. **形式\\ルート: 順番 (ルート)\\行: 順番 1..\* (行)\\フィールド: 順番 1..1 (フィールド)** を展開します。

11. **データ モデル** ツリーで、次の手順に従います。

    1. データ モデルの **支払** フィールドを展開します。
    2. **Payments\\Creditor Account(CreditorAccount)** を展開します。
    3. **Payments\\Creditor Account(CreditorAccount)\\Identification** を展開します。
    4. **Payments\\Creditor Account(CreditorAccount)\\Identification\\IBAN** を展開します。

12. 次の手順に従って、構成済み形式のコンポーネントをデータ モデルのフィールドにバインドします。

    1. **形式\\ルート: 順番 (ルート)\\行: 順番 1..\* (行)** を選択します。
    2. **支払** を選択します。
    3. **バインド** を選択します。 この設定に基づいて、解析ファイル内の各明細行を単一の支払とみなす必要があります。
    4. **形式\\ルート: 順番 (ルート)\\行: 順番 1..\* (行)\\フィールド: 順番 1..1 (フィールド)\\IBAN: 文字列 (IBAN)** を選択します。
    5. **Payments\\Creditor Account(CreditorAccount)\\Identification\\IBAN** を選択します。
    6. **バインド** を選択します。 この設定に基づいて、データ モデルの **IBAN** フィールドに、変更可能なファイルの値が入力されます。

    ![モデル マッピング デザイナー ページのデータ モデル フィールドへの形式コンポーネントのバインド。](../media/design-expressions-app-class-er-02.png)

13. **検証** タブで、無効な IBAN コードを含む解析ファイルの任意の行に対してエラー メッセージを表示する[検証](../general-electronic-reporting-formula-designer.md#Validation)ルールを追加するには、次の手順に従います。

    1. **新規** を選択し、**条件の編集** を選択します。
    2. **フォーミュラ デザイナー** ページの **データ ソース** ツリーで、**ISO7064** アプリケーション クラスを表す **Check\_codes** データ ソースを展開して、このクラスの使用可能なメソッドを表示します。
    3. **Check\_codes\\verifyMOD1271\_36** を選択します。
    4. **データソースの追加** を選択します。
    5. **フォーミュラ** フィールドに、[式](../general-electronic-reporting-formula-designer.md#Binding) **Check\_codes.verifyMOD1271\_36(format.Root.Rows.Fields.IBAN)** を入力します。
    6. **保存** を選択し、ページを閉じます。
    7. **メッセージの編集** を選択します。
    8. **フォーミュラ デザイナー** ページの **式** フィールドに、**CONCATENATE("無効な IBAN コードが検出されました:&nbsp;", format.Root.Rows.Fields.IBAN)** と入力します。
    9. **保存** を選択し、ページを閉じます。

    これらの設定に基づいて、検証条件は、アプリケーション クラス **ISO7064** の既存のメソッド **verifyMOD1271\_36** を呼び出すことで、無効な IBAN コードに対して *[FALSE](../er-formula-supported-data-types-primitive.md#boolean)* を返すように構成されています。 IBAN コードの値は、解析中のテキスト ファイルの内容に基づいて、呼び出しメソッドの引数として実行時に動的に定義されることに注意してください。

    ![モデル マッピング デザイナー ページの検証ルール。](../media/design-expressions-app-class-er-03.png)

14. **保存** を選択します。
15. **モデル マッピング デザイナー** ページを閉じ、**モデルからデータ ソースへのマッピング** ページを閉じます。

## <a name="run-the-format-mapping"></a>形式マッピングの実行

テストのために、前の手順でダウンロードした SampleIncomingMessage.txt ファイルを使用して形式マッピングを実行します。 生成された出力は選択されたテキスト ファイルからインポートされ、実際のインポート中にカスタム データ モデルに読み込まれるデータが含められます。

1. **モデルからデータソースへのマッピング** ページで、**実行** を選択します。
2. **電子レポート パラメーター** ページで、**参照** を選択し、ダウンロードした **SampleIncomingMessage.txt** ファイルを参照して選択します。
3.  **OK** を選択します。
4. **モデルからデータ ソースへのマッピング** ページに無効な IBAN コードに関するエラー メッセージが表示されます。

    ![モデルからデータ ソースへのマッピング ページで形式マッピングを実行した結果。](../media/design-expressions-app-class-er-04.png)

5. 選択ファイルからインポートされてデータ モデルにポートされたデータを表すXML 書式の出力を確認します。 インポートされたテキスト ファイルの 3 行だけがエラーなく処理されたことに注意してください。 IBAN コード オンライン 4 は無効なため、スキップされました。

    ![XML 出力。](../media/design-expressions-app-class-er-05.png)

[!INCLUDE[footer-include](../../../../includes/footer-banner.md)]
