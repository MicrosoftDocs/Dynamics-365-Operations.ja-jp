---
title: 法人ごとに指定されたパラメーターを使用するよう ER 形式を構成する
description: このトピックでは、法人ごと指定されたパラメーターを使用して電子申告 (ER) 形式を構成する方法について説明します。
author: NickSelin
ms.date: 04/02/2021
ms.topic: article
ms.prod: ''
ms.technology: ''
ms.search.form: ERSolutionTable, EROperationDesigner, ERLookupDesigner, ERComponentLookupStructureEditing
audience: Application User, Developer, IT Pro
ms.reviewer: kfend
ms.custom: ''
ms.assetid: ''
ms.search.region: Global
ms.author: nselin
ms.search.validFrom: 2019-01-01
ms.dyn365.ops.version: Release 8.1.3
ms.openlocfilehash: 2bf4d1ecad3e25299df7c87ffa2236736ddcac300a5ded779616b25920745d7e
ms.sourcegitcommit: 42fe9790ddf0bdad911544deaa82123a396712fb
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/05/2021
ms.locfileid: "6765835"
---
# <a name="configure-er-formats-to-use-parameters-that-are-specified-per-legal-entity"></a>法人ごとに指定されたパラメーターを使用するよう ER 形式を構成する

[!include[banner](../includes/banner.md)]

## <a name="overview"></a>概要

設計する電子申告 (ER) の多くの形式では、インスタンスの各法人に固有の値セット (税取引をフィルター処理するための税コードセットなど) を使用してデータをフィルター処理する必要があります。 現時点では、このタイプのフィルター処理が ER 形式で構成されている場合、ER 形式の式でデータフィルター処理ルールを指定するために、法人に依存する値 (税コードなど) が使用されます。 したがって、ER 形式は法人固有のものであり、必要なレポートを生成するには、ER 形式を実行する必要がある各法人に対して元の ER 形式の派生コピーを作成する必要があります。 運用上の用途のために配置する必要があるとき、元の (ベース) バージョンが更新され、テスト環境からエクスポートされて、実稼働用にインポートする必要がある場合は、派生 ER 形式によって、法人固有の値を取り込めるように編集する必要があります。 したがって、次のような理由から、このように構成されたこのタイプの ER ソリューションのメンテナンスは複雑で時間がかかります。

-   法人の数が多い場合は、より多くの ER 形式の構成を維持する必要があります。
-   ER の構成を保守するには、ビジネスユーザーが ER の情報を持っている必要があります。

ER アプリケーション固有のパラメーター機能を使用すると、パワーユーザーはデータフィルターを ER 形式に構成して、一連の抽象的なルールに基づくようにすることができます。 このルールセットは、ER 形式で使用可能なデータソースを使用するように構成できます。 ビジネスユーザーは ER フレームワークを超えた実際のルールを、対応する ER 形式の設定に基づいて自動的に生成されるユーザーインターフェイス (UI) と、ER 形式のデータソースからアクセスされる現在の法人データを使用して指定できます。 ER 形式に対して指定されている一連のルールは、Dynamics 365 Finance (財務) インスタンスの現在の法人からエクスポートできます。 その後、同じ財務のインスタンスまたは異なるインスタンスの別の法人に、同じ ER 形式のルールセットとしてインポートすることができます。

## <a name="prerequisites"></a>必要条件

このトピックの例を完了するには、次のいずれかの役割で、財務と同じテナントに対してプロビジョニングされている Regulatory Configuration Services (RCS) のインスタンスにアクセスできる必要があります。

- 電子申告開発者
- 電子申告機能コンサルタント
- システム管理者

[CALCULATED FIELD タイプの ER データソースのパラメーター化された呼び出しをサポート](er-calculated-field-type.md) トピックの手順を実行することをお勧めします。 これらの手順を既に完了している場合は、この後の **ER 構成を RCS にインポートする** セクションの手順を省略できます。

## <a name="import-er-configurations-into-rcs"></a>ER 構成を RCS にインポートする

次の ER コンフィギュレーションをダウンロードし、ローカルに保存します。

| **コンテンツの説明**                        | **ファイル名**                                        |
|------------------------------------------------|------------------------------------------------------|
| **ER データ モデル** 構成ファイルのサンプル    | [パラメーター化された呼び出し version.1.xml を知るためのモデル](https://download.microsoft.com/download/2/d/b/2db913a0-3622-494e-91a2-97fc494af9b9/Modeltolearnparameterizedcalls.version.1.xml)     |
| **ER メタデータ** 構成ファイルのサンプル      | [パラメーター化された呼び出し version.1.xml を知るためのメタデータ](https://download.microsoft.com/download/1/b/3/1b343968-5a47-4000-b5a8-6487698ef4c0/Metadatatolearnparameterizedcalls.version.1.xml)  |
| **ER モデル マッピング** 構成ファイルのサンプル | [パラメーター化された呼び出し version.1.1.xml を知るためのマッピング](https://download.microsoft.com/download/8/6/6/866e0ab6-2e05-4d98-9d52-d2da2038f6e4/Mappingtolearnparameterizedcalls.version.1.1.xml) |
| **ER 形式** 構成のサンプル             | [パラメーター化された呼び出し version.1.1.xml を知るための形式](https://download.microsoft.com/download/e/3/9/e392eadc-b9b4-4834-95c3-b8066dd00b9c/Formattolearnparameterizedcalls.version.1.1.xml)  |

次に、RCS インスタンスにサインインします。

この例では、Litware、Inc. サンプル会社の構成を作成します。 この手順を完了する前に、RCS で [ER 構成 プロバイダーの作成および有効なプロバイダーとしてのマーク付け](tasks/er-configuration-provider-mark-it-active-2016-11.md)トピックにある手順を完了する必要があります。

1.  既定のダッシュボードで、**電子申告** を選択します。
2.  **コンフィギュレーションをレポートする** を選択します。
3.  RCS にダウンロードした ER コンフィギュレーションを、次の順序で RCS にインポートします。データ モデル、メタデータ、モデル マッピング、フォーマット。 各 ER コンフィギュレーションについて、次の手順を実行します。

    1.  **交換** を選択します。
    2.  **XML ファイルから読み込む** を選択します。
    3.  **参照** を選択して、必要な ER コンフィギュレーションファイルを XML 形式で選択します。
    4.  **OK** を選択します。

## <a name="review-the-er-solution-that-is-provided"></a>指定された ER ソリューションを確認する

1.  コンフィギュレーション ツリーで、**モデルのコンテンツを展開しパラメーター化された呼び出し** の項目を表示します。
2.  **パラメーター化された呼び出しを知るための形式** 項目を選択します。
3.  **デザイナー** をクリックします。
4.  **展開 / 折りたたみ** を選択します。

    **パラメーター化された呼び出しを学習するための形式** の ER 形式は、(標準、減額、なし) という複数の課税レベルを提供する XML 形式の税明細書を生成するように設計されています。 各レベルには異なる数の詳細情報があります。

    ![複数レベルの ER 形式、パラメーター化された呼び出しを学習する形式。](./media/RCS-AppSpecParms-ReviewFormat.PNG)

5.  **マッピング** タブで、**モデル**、**データ**、および **概要** 品目を展開します。

    **Model.Data.Summary** データ ソースは、税トランザクションの一覧を返します。 それらのトランザクションは税コードごとに集計されます。 このデータ ソースについて **Model.Data.Summary.Level** の計算フィールドが、集計された各レコードの課税レベルのコードを返すように構成されています。 実行時に **Model.Data.Summary** データ ソースから取得できる税コードの場合、計算済みフィールドは、課税レベル コード (**標準**、**減額**、**なし**、または **その他**) テキスト値として返します。 **Model.Data.Summary.Level** 計算済みフィールドは、**Model.Data.Summary** データ ソースのレコードをフィルター処理し、**Model.Data2.Level1**、**Model.Data2.Level2**、**Model.Data2.Level3** を使用して課税レベルを表す各 XML 要素にフィルター処理されたデータを入力するために使用されます。

    ![税トランザクションの Model.Data.Summary データ ソース。](./media/RCS-AppSpecParms-ReviewFormat-Data2Fld.PNG)

    **Model.Data.Summary.Level** の計算済みフィールドは、ER 式を含むように構成されています。 税コード (**VAT19**、**InVAT19**、**VAT7**、**InVAT7**、**THIRD**、**InVAT0**) は、この構成にハードコードされています。 したがって、この ER 形式は、税コードが構成された法人に依存しています。

    ![Model.Data.Summary.Level の計算済フィールド (ハードコードが設定された税コード付き)。](./media/RCS-AppSpecParms-ReviewFormat-LevelFld.PNG)

    法人ごとに異なる税コードのセットをサポートするには、次の手順を実行する必要があります。

    - 法人ごとに ER 形式の派生バージョンを作成します。
    - 法人設定に基づいて、**Model.Data.Summary.Level** 計算済みフィールドで税コードを更新します。

6.  **形式デザイナー** ページを閉じます。

## <a name="create-a-derived-format"></a>派生形式を作成する

次に、ER アプリケーション固有のパラメーター機能を使用して、1 つの ER 形式に含まれる各法人の税コードの異なるセットをサポートします。

1.  コンフィギュレーション ツリーで、**モデルのコンテンツを展開しパラメーター化された呼び出し** の項目を表示します。
2.  **パラメーター化された呼び出しを知るための形式** 項目を選択します。
3.  **コンフィギュレーションの作成** を選択します。
4.  **名前から派生: パラメーター化された呼び出しを知るための形式、Microsoft** オプションを選択します。
5.  **名前** フィールドに、**LE データの参照方法を知るための形式** を入力します。
6.  **コンフィギュレーションの作成** を選択します。

## <a name="configure-a-derived-format"></a>派生形式のコンフィギュレーション

### <a name="add-a-format-enumeration"></a>形式列挙型の追加

次に、新しい ER 形式列挙型を追加します。 この形式の列挙型の値は、ビジネスユーザーに対して表示され、ER 形式で使用されるさまざまな課税レベルの法人固有の税コードのセットを指定します。

1.  **デザイナー** をクリックします。
2.  **形式列挙型** を選択します。
3.  **追加** を選択します。
4.  **名前** フィールドに、**課税レベルの一覧** と入力します。
5.  **保存** を選択します。
6.  **形式列挙型の値** タブで **追加** を選択します。
7.  **名前** フィールドに、**通常の課税** と入力します。
8.  **追加** を再度選択します。
9.  **名前** フィールドに、**減額課税** と入力します。
10. **追加** を再度選択します。
11. **名前** フィールドに、**非課税** と入力します。
12. **追加** を再度選択します。
13. **名前** フィールドに、**その他** と入力します。

    ![形式列挙型ページの新しいレコード。](./media/RCS-AppSpecParms-ConfigureFormat-Enum.PNG)

    ビジネスユーザーは、異なる言語を使用して、法人に依存する税コードのセットを指定する場合があるため、この列挙型の値を、財務のユーザーの優先言語として構成された言語に翻訳することをお勧めします。

14. **非課税** レコードを選択します。
15. **ラベル** フィールドをクリックします。
16. **翻訳** を選択します。
17. **テキストの翻訳** ウィンドウの **ラベル ID** フィールドに、**LBL_LEVELENUM_NO** と入力します。
18. **既定の言語のテキスト** フィールドに **非課税** と入力します。
19. **言語** フィールドで、**DE** を選択します。
20. **翻訳テキスト** フィールドで、**keine Besteuerung** と入力します。
21. **翻訳** を選択します。

    ![テキスト翻訳のスライド アウト。](./media/RCS-AppSpecParms-ConfigureFormat-EnumTranslate.PNG)

22. **保存** を選択します。
23. **形式列挙型** ページを閉じます。

### <a name="add-a-new-lookup-data-source"></a>新しいルックアップ データ ソースを追加する

次に、新しいデータソースを追加して、ビジネスユーザーが、集計された各トランザクション レコードに対して正しい課税レベルを認識するための法人依存ルールをどのように指定するかを指定します。

1.  **マッピング** タブで、**追加** を選択します。
2.  **形式列挙型\ルックアップ** を選択します。

    ビジネス ユーザーが課税レベルの認識に指定した各ルールが ER 形式列挙型の値を返すことを確認しました。 **ルックアップ** データ ソース タイプには、**形式列挙型** ブロックに加えて、**データ モデル** および **Dynamics 365 for Operations** ブロックでもアクセスできる点に注意してください。 したがって、ER データ モデルの列挙型とアプリケーションの列挙型を使用して、その型のデータ ソースに対して返される値の型を指定することができます。 **ルックアップ** データ ソースの詳細については、[ER アプリケーション固有のパラメーター機能を使用するためにルックアップ データ ソースを構成する](er-lookup-data-sources.md) を参照してください。
    
3.  **名前** フィールドに、**セレクター** と入力します。
4.  **形式列挙型** フィールドで、**課税レベルの一覧** を選択します。

    このデータ ソースで指定されているルールごとに、ビジネス ユーザーは、**課税レベルの一覧** 形式列挙型の値のいずれかを戻り値として選択する必要があることを指定しました。
    
5.  **ルックアップの編集** を選択します。
6.  **列** を選択します。
7.  **モデル** 項目を展開します。
8.  **データ** 項目を展開します。
9.  **税** 項目を展開します。
10. **Model.Data.Tax.Code** 項目を選択します。
11. **追加** ボタン (右矢印) を選択します。

    ![列のスライド アウト。](./media/RCS-AppSpecParms-ConfigureFormat-Lookup1.PNG)

    課税レベルの認識のためにこのデータ ソースで指定されている各ルールについて、ビジネス ユーザーが条件として税コードの 1 つを選択する必要があることを指定しました。 ビジネス ユーザーが選択できる税コードの一覧は、**Model.Data.Tax** データ ソースよって返されます。 このデータ ソースには **名前** フィールドが含まれているため、ビジネス ユーザーに対して表示されるルックアップの各税コード値について、税コードの名前が表示されます。
    
12. **OK** を選択します。

    ![ルックアップ デザイナー ページ。](./media/RCS-AppSpecParms-ConfigureFormat-Lookup2.PNG)

    ビジネス ユーザーは、このデータ ソースのレコードとして、複数のルールを追加することができます。 各レコードには、明細行コードで番号が付けられます。 ルールは行番号の昇順で評価されます。

    **税コード** フィールドはこのルックアップ データ ソースのルールの条件として選択されており、**税コード** は **文字列** データ型のフィールドとして設定されているため、各ルールは、データ ソースに渡される税コードと、データ ソースのレコードで定義されている税コードとを比較することによって、実行時に評価されます。

    構成された条件を満たすルールが見つかった場合、このデータ ソースは、**ルックアップの結果** フィールドに定義されているルールのルックアップ値を返します。 ルールが見つからない場合は、現在のデータ ソースが正しい値を返すことができないことをユーザーに通知する例外がスローされます。

13. **保存** を選択します。
14. **ルックアップ デザイナー** ページを閉じます。
15. **OK** を選択します。

    **文字列** データ型の **コード** パラメーターの引数としてデータ ソースに渡されたすべての税コードの **課税レベル リスト** の形式列挙型の値として、課税レベルを返す新しいデータ ソースを追加したことに注意してください。
    
    ![新しいデータ ソースが表示されたで形式デザイナー ページ。](./media/RCS-AppSpecParms-ConfigureFormat-SelectorFld.PNG)

    構成されたルールの評価は、そのルールの条件を定義するために選択されたフィールドのデータ型に依存します。 **数値** データ型または **日付** データ型のフィールドとして構成されているフィールドを選択した場合、基準は **文字列** データ型に対して既に説明した基準とは異なります。 **数値** フィールドおよび **日付** フィールドでは、ルールを値の範囲として指定する必要があります。 データ ソースに渡される値が構成された範囲内にある場合は、ルールの条件が満たされたと見なされます。
    
    次の図は、この種類の設定の例を示します。 **文字列** データ型の **Model.Data.Tax.Code** フィールドに加えて、**リアル** データ型の **Model.Tax.Summary.Base** フィールドを使用して、ルックアップ データ ソースの条件を指定します。
    
    ![追加の列を含むルックアップ デザイナー ページ。](./media/RCS-AppSpecParms-ConfigureFormat-SelectorFld2.PNG)

    このルックアップ データ ソースに対して **Model.Data.Tax.Code** フィールドおよび **Model.Tax.Summary.Base** が選択されます。このデータ ソースの各ルールは、次のように構成されます。
    
    -   表示される一覧で、**課税レベルの一覧** 形式列挙型の値を戻り値として選択する必要があります。
    -   この税コードは、このルールの条件として入力する必要があります。 **Model.Data.Tax** データ ソースによって提供される税コードのみが適用されます。
    -   税基準額の最小値と最大値は、このルールの条件として入力する必要があります。

    次は、このデータ ソースの各ルールを実行時に評価する方法を示しています。
    -   このデータ ソースに渡された **文字列** データ型のコードがルールの税コードと同等か?
    -   このデータ ソースに渡された **リアル** データ型の値が、特定の最小値と最大値の範囲内に収まっているか?

    両方の条件が満たされると、ルールが適用可能と見なされます。

### <a name="translate-the-label-of-the-lookup-data-source-that-was-added"></a>追加されたルックアップ データ ソースのラベルを翻訳する

ビジネス ユーザーは、異なる言語を使用して、法人に依存する税コードのセットを指定する場合があるため、追加するルックアップ データ ソースのラベルを翻訳し、対応するページで各ユーザーの優先言語で表示することをお勧めします。

1.  **Model.Data.Selector** データ ソースを選択します。
2.  **編集** を選択します。
3.  **ラベル** フィールドをクリックします。
4.  **翻訳** を選択します。
5.  **テキストの翻訳** ウィンドウの **ラベル ID** フィールドに、**LBL_SELECTOR_DS** と入力します。
6.  **既定の言語のテキスト** フィールドに、**税コードによる税レベルの選択** と入力します。
7.  **言語** フィールドで、**DE** を選択します。
8.  **翻訳テキスト** フィールドに,**Steuerebene für Steuerkennzeichen auswählen** と入力します。
9.  **翻訳** を選択します。
10. **OK** を選択します。

    ![データ ソース プロパティのスライド アウト。](./media/RCS-AppSpecParms-ConfigureFormat-SelectorFldTranslate.PNG)

### <a name="add-a-new-field-to-consume-the-configured-lookup"></a>新しいフィールドを追加して構成されたルックアップを使用する

1.  **Model.Data** 項目を展開します。
2.  **Model.Data.Summary** 項目を選択します。
3.  **追加** を選択します。
4.  **機能/計算済みフィールド** を選択します。
5.  **名前** フィールドに、**LevelByLookup** と入力します。
6.  **式の編集** を選択します。
7.  **数式フィールド** に、**Model.Selector(Model.Data.Summary.Code)** と入力します。
8.  **保存** を選択します。

    ![フォーミュラ デザイナー ページに Model.Selector(Model.Data.Summary.Code) を追加する。](./media/RCS-AppSpecParms-ConfigureFormat-AddLevelByLookupFld.PNG)

9.  **式の編集** ページを閉じます。
10. **OK** を選択します。

    ![新しいフォーミュラが追加されたで形式デザイナー ページ。](./media/RCS-AppSpecParms-ConfigureFormat-AddLevelByLookupFld2.PNG)

    追加した **LevelByLookup** 計算フィールドを使用すると、集計された各税トランザクション レコードの **課税レベルの一覧** 形式の列挙型の値として、課税レベルが返されることに注意してください。 レコードの税コードは **Model.Selector** のルックアップ データ ソースに渡され、このデータ ソースのルールのセットを使用して正しい課税レベルが選択されます。

### <a name="add-a-new-format-enumeration-based-data-source&quot;></a>新しい形式列挙型ベースのデータ ソースを追加する

次に、前の手順で追加した形式列挙型を参照する新しいデータ ソースを追加します。 このデータ ソースの値は、後で ER 形式の式で使用されます。

1.  **ルートの追加** を選択します。
2.  **形式列挙型\列挙型** を選択します。
3.  **名前** フィールドに、**TaxationLevel** と入力します。
4.  **形式列挙型** フィールドで、**課税レベルの一覧** を選択します。
5.  **保存** を選択します。

### <a name=&quot;modify-an-existing-field-to-start-to-use-the-lookup&quot;></a>ルックアップの使用を開始するために既存のフィールドを変更する

次に、既存の計算フィールドを変更して、構成されているルックアップ データ ソースを使用して、税コードに応じて正しい課税レベル値を取得するようにします。

1.  **Model.Data.Summary.Level** 項目を選択します。
2.  **編集** を選択します。
3.  **式の編集** を選択します。

    **Model.Data.Summary.Level** フィールドの現在の式には、次のハードコーディングされた税コードが含まれています。
    
    CASE (@.Code、&quot;VAT19&quot;、&quot;Regular&quot;、&quot;InVAT19&quot;、&quot;Regular&quot;、&quot;VAT7&quot;、&quot;Reduced&quot;、&quot;InVAT7&quot;、&quot;Reduced&quot;、&quot;THIRD&quot;、&quot;None&quot;、&quot;InVAT0&quot;、&quot;None&quot;、&quot;Other")

4.  **式** フィールドに、**CASE(@.LevelByLookup、TaxationLevel.'Regular taxation'、"Regular"、TaxationLevel.'Reduced taxation'、"Reduced"、TaxationLevel.'No taxation'、None"、"Other")** と入力します。

    ![ER 操作デザイナーのページ。](./media/RCS-AppSpecParms-ConfigureFormat-ChangeLookupFld.PNG)
    
    **Model.Data.Summary.Level** フィールドの式は、現在のレコードの税コードと、ビジネス ユーザーが **Model.Data.Selector** ルックアップ データ ソースで構成したルールのセットに基づいて、課税レベルを返すようになりました。
    
5.  **保存** を選択します。
6.  **フォーミュラ デザイナー** ページを閉じます。
7.  **OK** を選択します。
8.  **保存** を選択します。
9.  **形式デザイナー** ページを閉じます。

## <a name="complete-the-draft-version-of-a-derived-format"></a>派生形式のドラフト バージョンを完了する

1.  **バージョン** クイック タブで、**ステータスの変更** を選択します。
2.  **完了** を選択します。
3.  **OK** を選択します。

## <a name="export-completed-version-of-modified-format"></a>修正された形式の完了したバージョンをエクスポートする

1.  コンフィギュレーション ツリーで、**LE データの参照方法を検索するための形式** 項目を選択します。
2.  **バージョン** クイック タブで、ステータスが **完了** のレコードを選択します。
3.  **交換** を選択します。
4.  **XML ファイルとしてエクスポートする** を選択します。
5.  **OK** を選択します。
6.  Web ブラウザーで、**LE data.xml ファイルの参照方法を検索するための形式** をダウンロードします。 このファイルをローカルに保管します。

**LE データ形式の参照方法を検索するための形式** と、次のファイルをローカルに保管する方法については、このセクションの手順を親項目について繰り返します。

-   パラメーター化された calls.xml を知るための形式
-   パラメーター化された calls.xml を知るためのマッピング
-   パラメーター化された calls.xml を知るためのモデル

構成済みの **LE データの参照方法を検索するための形式** ER 形式を使用して、法人に依存する税コードのセットを設定し、さまざまな課税レベルで税トランザクションをフィルター処理する方法を学習するには、[法人ごとの ER 形式のパラメーターの設定](er-app-specific-parameters-set-up.md) トピックをご覧ください。

## <a name="additional-resources"></a>追加リソース

[電子申告のフォーミュラ デザイナー](general-electronic-reporting-formula-designer.md)

[法人ごとの電子申告形式のパラメーターの設定](er-app-specific-parameters-set-up.md)

[ER アプリケーション固有のパラメーター機能を使用するためにルックアップ データ ソースを構成する](er-lookup-data-sources.md)


[!INCLUDE[footer-include](../../../includes/footer-banner.md)]
