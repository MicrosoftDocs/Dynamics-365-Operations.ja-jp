---
title: 電子申告形式におけるシーケンス要素の実行の延期
description: この記事では、電子申告 (ER) 形式のシーケンス要素の実行を延期する方法について説明します。
author: kfend
ms.date: 04/23/2021
ms.topic: article
ms.prod: ''
ms.technology: ''
audience: Application User, IT Pro
ms.reviewer: kfend
ms.search.region: Global
ms.author: filatovm
ms.search.validFrom: 2019-07-01
ms.dyn365.ops.version: AX 10.0.5
ms.custom: 58771
ms.assetid: ''
ms.search.form: EROperationDesigner
ms.openlocfilehash: bb42da7b17713430c6143444d87d6fe187dd1124
ms.sourcegitcommit: 87e727005399c82cbb6509f5ce9fb33d18928d30
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/12/2022
ms.locfileid: "9281845"
---
# <a name="defer-the-execution-of-sequence-elements-in-er-formats"></a>ER 形式におけるシーケンス要素の実行の延期

[!include [banner](../includes/banner.md)]

## <a name="overview"></a>概要

[電子申告 (ER)](general-electronic-reporting.md) フレームワークのオペレーション デザイナーを使用して、テキスト形式で送信ドキュメントを生成するために使用する ER ソリューションの 形式コンポーネント を [構成](tasks/er-format-configuration-2016-11.md) することができます。 コンフィギュレーションされた形式コンポーネントの階層構造は、さまざまなタイプの形式要素で構成されます。 これらの形式要素は、生成されたドキュメントに実行時に必要な情報を入力するために使用されます。 既定では、ER 形式の実行時に、形式要素は形式階層に表示されているのと同じ順序で、上から下に 1 つずつ実行されます。 ただし、デザイン時に、コンフィギュレーションされた形式コンポーネントのすべてのシーケンス要素の実行順序を変更することができます。

コンフィギュレーションされた形式のシーケンス形式要素に対して <a name="DeferredSequenceExecution"></a> **遅延実行** オプションを有効にすることにより、その要素の実行を延期することができます。 この場合、親要素の他の要素すべてが実行されるまで、要素は実行されません。

この機能の詳細を知るには、この記事の例を実行します。

## <a name="limitations"></a>制限

**遅延実行** オプションは、テキスト形式で **送信** ドキュメントを生成するために使用される ER 形式に対してコンフィギュレーションされているシーケンス要素に対してのみサポートされます。

**遅延実行** オプションは、最大長が制限されているトリミング シーケンスとしてコンフィギュレーションされているシーケンスには適用されません。

## <a name="example-defer-the-execution-of-a-sequence-element-in-an-er-format"></a><a name="Example"></a>例: ER 形式のシーケンス要素の実行の延期

次のステップは、システム管理者または電子申告機能コンサルタント [ロール](../sysadmin/tasks/assign-users-security-roles.md) のユーザーが、実行順序が形式階層の順序とは異なるシーケンス要素を含む ER 形式をコンフィギュレーションする方法を説明します。

これらのステップは、Microsoft Dynamics 365 Finance の **USMF** 会社で実行できます。

### <a name="prerequisites"></a>必要条件

この例を完了するには、次のいずれかのロール用の Finance の **USMF** 会社にアクセスできる必要があります。

- 電子申告機能コンサルタント
- システム管理者

[ER 形式における XML 要素の実行の延期](er-defer-xml-element.md#Example)記事の例をまだ完了していない場合、次のサンプル ER ソリューションの [構成](general-electronic-reporting.md#Configuration) をダウンロードしてください。

| コンテンツの説明            | ファイル名 |
|--------------------------------|-----------|
| ER データ モデル構成    | [遅延 elements.version.1.xml を知るためのモデル](https://download.microsoft.com/download/7/6/0/760933ca-4ac3-4f50-bc0c-c35e596ee066/Modeltolearndeferredelements.version.1.xml) |
| ER モデル マッピング コンフィギュレーション | [遅延 element.version.1.1.xml を知るためのマッピング](https://download.microsoft.com/download/c/9/c/c9c4b9dd-b700-4385-a087-a84ce9fc1d0f/Mappingtolearndeferredelements.version.1.1.xml) |

開始する前に、サンプル ER ソリューションの次のコンフィギュレーションをダウンロードして保存する必要もあります。

| コンテンツの説明     |ファイル名 |
|-------------------------|----------|
| ER フォーマット構成 | [遅延シーケンスを知るための形式. バージョン .1.1.xml](https://download.microsoft.com/download/0/f/5/0f55c341-8285-4d92-a46d-475d9a010927/Formattolearndeferredsequences.version.1.1.xml) |

### <a name="import-the-sample-er-configurations"></a>サンプル ER のコンフィギュレーションのインポート

1. **組織管理** \> **ワークスペース** \> **電子申告** の順に移動します。
2. **コンフィギュレーションをレポートする** を選択します。
3. **コンフィギュレーション** ページで、**遅延要素を知るためのモデル** コンフィギュレーションがコンフィギュレーション ツリーで使用できない場合、ER データ モデル コンフィギュレーションをインポートします。

    1. **交換** を選択し、**XML ファイルから読み込む** を選択します。
    2. **参照** をクリックし、**遅延 elements.1.xml を知るためのモデル** ファイルを検索して選択し、**OK** をクリックします。

4. コンフィギュレーション ページで、**遅延要素を知るためのマッピング** コンフィギュレーションがコンフィギュレーション ツリーで使用できない場合、ER データ マッピング コンフィギュレーションをインポートします。

    1. **交換** を選択し、**XML ファイルから読み込む** を選択します。
    2. **参照** をクリックし、**遅延 elements.1.1.xml を知るためのマッピング** ファイルを検索して選択し、**OK** をクリックします。

5. ER 形式コンフィギュレーションのインポート:

    1. **交換** を選択し、**XML ファイルから読み込む** を選択します。
    2. **参照** をクリックし、**遅延 sequences.1.1.xml を知るための形式** ファイルを検索して選択し、**OK** をクリックします。

6. コンフィギュレーション ツリーで、**遅延要素を知るためのモデル** を展開します。
7. コンフィギュレーション ツリーでインポートされた ER コンフィギュレーションのリストを確認します。

    ![コンフィギュレーション ページのインポートされた ER コンフィギュレーション。](./media/ER-DeferredSequence-Configurations.png)

### <a name="activate-a-configurations-provider"></a>コンフィギュレーション プロバイダーの有効化

1. **組織管理** \> **ワークスペース** \> **電子申告** の順に移動します。
2. **ローカライズのコンフィギュレーション** ページの **コンフィギュレーション プロバイダー** セクションで、Litware, Inc. (`http://www.litware.com`) サンプル会社の [コンフィギュレーション プロバイダー](general-electronic-reporting.md#Provider) がリストに表示されていること、および有効としてマークされていることを確認します。 この構成プロバイダーがリストに表示されない場合、またはアクティブとしてマークされていない場合、[構成プロバイダーの作成および有効なプロバイダーとしてのマーク付け](./tasks/er-configuration-provider-mark-it-active-2016-11.md) 記事の手順に従ってください。

    ![ローカライズのコンフィギュレーション ページの Litware, Inc. サンプル会社。](./media/ER-DeferredSequence-ElectronicReportingWorkspace.png)

### <a name="review-the-imported-model-mapping"></a>インポートされたモデル マッピングを確認する

税トランザクションにアクセスするようにコンフィギュレーションされている ER モデル マッピング コンポーネントの設定を確認し、リクエスト時にアクセスしたデータを公開します。

1. **組織管理** \> **ワークスペース** \> **電子申告** の順に移動します。
2. **コンフィギュレーションをレポートする** を選択します。
3. **コンフィギュレーション** ページのコンフィギュレーション ツリーで、**遅延要素を知るためのモデル** を展開します。
4. **遅延要素を知るためのマッピング** コンフィギュレーションを選択します。
5. **デザイナー** を選択して、マッピングの一覧を開きます。
6. **デザイナー** を選択して、マッピングの詳細を確認します。
7. **詳細を表示** を選択します。
8. コンフィギュレーションされたデータ ソースを確認し、税トランザクションにアクセスします。

    - *テーブル レコード タイプ* の **トランザクション** データ ソースは、**TaxTrans** アプリケーション テーブルのレコードにアクセスするようにコンフィギュレーションされています。
    - *計算済フィールド* タイプの **伝票** データ ソースは、必要な伝票コード (**INV-10000349** および **INV-10000350**) をレコードのリストとして返すようにコンフィギュレーションされています。
    - **フィルター処理** された *計算済フィールド* タイプのデータソースは、**トランザクション** データ ソースから、必要な伝票の税トランザクションのみを選択するようにコンフィギュレーションされています。
    - *計算済フィールド* タイプの **\$TaxAmount** フィールドは **フィルター処理** されたデータ ソースに対して追加され、反対の符号を持つ税額を公開します。
    - **グループ化** された *グループ化* タイプのデータ ソースは、フィルター処理された **フィルター処理** データ ソースの税トランザクションをグループ化するようコンフィギュレーションされます。
    - **グループ化** されたデータ ソースの **TotalSum** 集計フィールドは、そのデータ ソースでフィルター処理されたすべての税トランザクションに対して、**フィルター処理** されたデータ ソースの **\$TaxAmount** フィールドの値を集計するようにコンフィギュレーションされています。

        ![「GroupBy」パラメーターの編集ページの TotalSum 集計フィールド。](./media/ER-DeferredSequence-GroupByParameters.png)

9. コンフィギュレーションされたデータ ソースをデータ モデルにバインドする方法、および ER 形式で利用可能になるようにアクセス データを公開する方法を確認します。

    - **フィルター処理** されたデータ ソースは、データ モデルの **Data.List** フィールドにバインドされます。
    - **フィルター処理** されたデータ ソースの **\$TaxAmount** フィールドは、データ モデルの **Data.List.Value** フィールドにバインドされます。
    - **グループ化** されたデータ ソースの **TotalSum** フィールドは、データ モデルの **Data.Summary.Total** フィールドにバインドされます。

    ![モデル マッピング デザイナーのページ。](./media/ER-DeferredSequence-ModelMapping.png)

10. **モデル マッピング デザイナー** および **モデル マッピング** のページを閉じます。

### <a name="review-the-imported-format"></a>インポートされた形式を確認する

1. **コンフィギュレーション** ツリーのコンフィギュレーション ページで、**遅延シーケンスを知るための形式** コンフィギュレーションを選択します。
2. **デザイナー** を選択して、形式の詳細を確認します。
3. **詳細を表示** を選択します。
4. 税トランザクションの詳細を含むテキスト形式で送信ドキュメントを生成するようにコンフィギュレーションされている ER フォーマット コンポーネントの設定を確認します。

    - **レポート\\明細行** シーケンス形式要素は、1 つの行で送信ドキュメントを入力するようにコンフィギュレーションされ、入れ子になったシーケンス要素から生成されます (**ヘッダー**、**レコード**、および **集計**)。

        ![形式デザイナー ページの明細行シーケンス形式要素と入れ子になった要素。](./media/ER-DeferredSequence-Format.png)

    - **レポート\\明細行\\ヘッダー** のシーケンス形式要素は、1 つの行で送信ドキュメントを入力するようにコンフィギュレーションされ、処理を開始するときに日時を表示します。
    - **レポート\\明細行\\レコード** のシーケンス形式要素は、1 つの行で送信ドキュメントを入力するようにコンフィギュレーションされ、個別の税トランザクションの詳細を表示します。 これらの税トランザクションは、セミコロンで区切られます。

        ![区切り記号としてセミコロンを使用するレコード シーケンス形式要素。](./media/ER-DeferredSequence-Format1.png)

    - **レポート\\明細行\\集計** のシーケンス形式要素は、1 つの集計行で送信ドキュメントを入力するようにコンフィギュレーションされ、処理された税トランザクションの税額の合計が含まれます。

4. **マッピング** タブで、次の詳細を確認します。

    - **レポート\\明細行\\ヘッダー** 要素は、送信ドキュメントの 1 つの行を生成するのに、データ ソースにバインドする必要はありません。
    - **Prefix1** 要素は、追加された行がレポート ヘッダー行であることを示す **P1** 記号を生成します。
    - **ExecutionDateTime** 要素は、ヘッダー行が追加された時の日時 (ミリ秒を含む) を生成します。
    - **レポート\\明細行\\レコード** 要素は、**model.Data.List** リストにバインドされ、バインド リストからすべてのレコードに対して 1 行生成します。
    - **Prefix2** 要素は、追加された行が税トランザクション詳細用であることを示す **P2** 記号を生成します。
    - **TaxAmount** 要素は、**model.Data.List.Value** (相対パス ビューに **\@.Value** として表示される) にバインドされ、現在の税トランザクションの税額を生成します。
    - **RunningTotal** 要素は、税額累計額のプレースホルダーです。 現在、バインディングも既定値もコンフィギュレーションされていないため、この要素には出力がありません。
    - **ExecutionDateTime** 要素は、現在のトランザクションがこのレポートで処理される時の日時 (ミリ秒を含む) を生成します。
    - **レポート\\明細行\\集計** 要素は、送信ドキュメントの 1 つの行を生成するのに、データ ソースにバインドする必要はありません。
    - **Prefix3** 要素は、追加された行に税額合計が含まれていることを示す **P3** 記号を生成します。
    - **TotalTaxAmount** 要素は **model.Data.Summary.Total** にバインドされ、処理された税トランザクションの税額合計を生成します。
    - **ExecutionDateTime** 要素は、集計行が追加された時の日時 (ミリ秒を含む) を生成します。

    ![フォーマット デザイナー ページのマッピング タブ。](./media/ER-DeferredSequence-Format2.png)

### <a name="run-the-imported-format"></a>インポートされた ER 形式の実行

1. **フォーマット デザイナー** ページで、**実行** を選択します。
2. Web ブラウザーからファイルをダウンロードし、確認のために開きます。

    ![ダウンロードしたサンプル レポート ファイル。](./media/ER-DeferredSequence-Run.png)

集計行 22 には、処理されたトランザクションの税額の合計が示されます。 形式は、合計を返すようバインドされている **model.Data.Summary.Total** を使用するようにコンフィギュレーションされていて、合計はモデル マッピングを使用する *GroupBy* の **グループ化** されたデータ ソースの **TotalSum** の集計を呼び出して計算されます。 この集計を計算するために、モデル マッピングは、**フィルタ処理** されるデータ ソースで選択されたすべてのトランザクションを反復処理します。 明細行 21 と 22 の実行時間を比較することにより、合計の計算に 10 ミリ秒 (ms) かかったことを特定できます。 明細行 2 と 21 の実行時間を比較することにより、すべてのトランザクション明細行の生成に 7 ミリ秒 (ms) かかったことを特定できます。 したがって、合計 17 ミリ秒必要でした。

### <a name="modify-the-format-so-that-the-summing-is-based-on-generated-output"></a>合計が生成された出力に基づくように形式を変更する

トランザクションの量が現在の例のボリュームよりも大きい場合、合計時間が増加してパフォーマンスの問題が発生する可能性があります。 形式の設定を変更することにより、これらパフォーマンスの問題を防ぐことができます。 税額にアクセスして生成されたレポートに含めることができるため、この情報を再利用して税額を合計することができます。 詳細については、[集計と合計を行うよう形式をコンフィギュレーションする](./tasks/er-format-counting-summing-1.md) を参照してください。

1. **形式** タブの **形式デザイナー** ページで、形式ツリーの **レポート** ファイル要素を選択します。
2. **出力詳細の収集** オプションを **はい** に設定します。 [データ収集](er-functions-category-data-collection.md) カテゴリの組み込み ER 機能を使用してアクセスできるデータ ソースとして既存のレポートの内容を使用することで、この形式をコンフィギュレーションできるようになりました。
3. **マッピング** タブで、**レポート\\明細行** シーケンス要素を選択します。
4. **収集したデータ キー名** の式を `WsColumn` としてコンフィギュレーションします。
5. **収集したデータ キーの値** の式を `WsRow` としてコンフィギュレーションします。

    ![形式デザイナー ページの明細行シーケンス要素。](./media/ER-DeferredSequence-Format3.png)

6. **レポート\\明細行\\レコード\\TaxAmount** 数値要素を選択します。
7. **収集したデータ キー名** の式を `SummingAmountKey` としてコンフィギュレーションします。

    ![形式デザイナー ページの TaxAmount 数値要素。](./media/ER-DeferredSequence-Format4.png)

    セル A1 の値が処理されたすべての税トランザクションからの税額の値で追記されている、この仮想ワークシートのフルフィルメントの設定を考慮することができます。

8. **レポート\\明細行\\レコード\\RunningTotal** の数値要素を選択し、**フォーミュラの編集** を選択します。
9. 組み込みの [SUMIF](er-functions-datacollection-sumif.md) ER 関数を使用して `SUMIF(SummingAmountKey, WsColumn, WsRow)` 式をコンフィギュレーションします。
10. **保存** を選択します。

    ![SUMIF 式。](./media/ER-DeferredSequence-FormulaDesigner.png)

11. **フォーミュラ デザイナー** ページを閉じます。
12. **保存** を選択して、**実行** を選択します。
13. Web ブラウザーからファイルをダウンロードし、確認します。

    ![ダウンロード済ファイル - 合計税額。](./media/ER-DeferredSequence-Run1.png)

    明細行 21 には、生成された出力をデータ ソースとして使用することにより、処理されたすべてのトランザクションに対して計算される税額の累計が含まれます。 このデータ ソースは、レポートの先頭から開始し、最後の税トランザクションまで続行します。 明細行 22 には、モデル マッピングにおいて *GroupBy* タイプのデータ ソースを使用して計算され、処理されたすべてのトランザクションの税額の合計が含まれています。 これらの値は等しくなります。 したがって、**GroupBy** の代わりに出力ベースの合計を使用できます。 明細行 2 と 21 の実行時間を比較することにより、すべてのトランザクション明細行の生成および合計に 9 ミリ秒 (ms) かかったことを特定できます。 したがって、詳細行の生成および税額の合計が懸念されるかぎり、変更された形式は元の形式よりも約 2 倍速くなります。

14. **レポート\\明細行\\集計\\TotalTaxAmount** の数値要素を選択し、**フォーミュラの編集** を選択します。
15. 既存の式の代わりに `SUMIF(SummingAmountKey, WsColumn, WsRow)` 式を入力します。
16. **保存** を選択して、**実行** を選択します。
17. Web ブラウザーからファイルをダウンロードし、確認します。

    ![編集されたフォーミュラを含むダウンロード済ファイル。](./media/ER-DeferredSequence-Run2.png)

    最後のトランザクション詳細行の税額累計は、集計行の合計値と等しくなるようになりました。

### <a name="put-values-of-output-based-summing-in-the-report-header"></a>レポート ヘッダーに出力ベースの集計を配置する

たとえば、レポートのヘッダーに税額の合計を表示する必要がある場合、形式を変更することができます。

1. **形式** タブの **形式** デザイナー ページで、**レポート\\明細行\\集計** シーケンス要素を選択します。
2. **上へ移動** を選択します。
3. **保存** を選択して、**実行** を選択します。
4. Web ブラウザーからファイルをダウンロードし、確認します。

    ![レポート ヘッダーを合計するためのダウンロード済ファイル。](./media/ER-DeferredSequence-Run3.png)

    この合計が生成された出力に基づいて計算されるようになったので、集計行 2 の税額の合計は 0 (ゼロ) と等しくなるようになりました。 明細行 2 が生成される時、生成された出力にはまだトランザクションの詳細のある行は含まれていません。 この形式をコンフィギュレーションして、すべての税トランザクションに対して **レポート\\明細行\\レコード** のシーケンス要素が実行されるまで、**レポート\\明細行\\集計** のシーケンス要素の実行を延期させることができます。

### <a name="defer-the-execution-of-the-summary-sequence-so-that-the-calculated-total-is-used"></a>集計シーケンスの実行を延期することにより、計算された合計が使用されます

1. **形式** タブの **形式** デザイナー ページで、**レポート\\明細行\\集計** シーケンス要素を選択します。
2. **遅延実行** オプションを **はい** に設定します。

    ![形式デザイナー ページの集計シーケンス要素の遅延実行オプション。](./media/ER-DeferredSequence-Format5.png)

3. **保存** を選択して、**実行** を選択します。
4. Web ブラウザーからファイルをダウンロードし、確認します。

    ![ダウンロード済ファイル - 遅延実行。](./media/ER-DeferredSequence-Run4.png)

    **レポート\\明細行\\集計** シーケンス要素は、その親要素である **レポート\\明細行** の下に入れ子になっている他のすべての品目が実行された後に実行されるようになりました。 したがって、**レポート\\明細行\\レコード** シーケンス要素が、**model.Data.List** データ ソースのすべての税トランザクションに実行された後に実行されます。 明細行 1、2、および 3 の実行時間と最後の明細行 22 の実行時間はこの事実を示しています。

## <a name="additional-resources"></a>追加リソース

- [棚卸および集計を行うための形式のコンフィギュレーション](./tasks/er-format-counting-summing-1.md)
- [パフォーマンス上の問題をトラブルシューティングするため ER 形式の追跡実行](trace-execution-er-troubleshoot-perf.md)
- [ER 形式における XML 要素の実行の延期](er-defer-xml-element.md#Example)


[!INCLUDE[footer-include](../../../includes/footer-banner.md)]
