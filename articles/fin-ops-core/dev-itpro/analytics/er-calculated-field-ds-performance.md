---
title: パラメーター化された計算フィールドのデータ ソースを追加して、ER ソリューションのパフォーマンスを向上させる
description: このトピックでは、パラメーター化された計算フィールドのデータ ソースを追加して、電子申告 (ER) ソリューションのパフォーマンスを向上させる方法について説明します。
author: NickSelin
ms.date: 04/23/2021
ms.topic: article
ms.prod: ''
ms.technology: ''
audience: Application User, Developer, IT Pro
ms.reviewer: kfend
ms.custom: ''
ms.assetid: ''
ms.search.region: Global
ms.author: nselin
ms.search.validFrom: ''
ms.dyn365.ops.version: 10.0.5
ms.openlocfilehash: e3dc83b71300387c8123f5533522c5ead7d86333
ms.sourcegitcommit: c08a9d19eed1df03f32442ddb65a2adf1473d3b6
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/06/2021
ms.locfileid: "6349187"
---
# <a name="improve-the-performance-of-er-solutions-by-adding-parameterized-calculated-field-data-sources"></a>パラメーター化された計算フィールドのデータ ソースを追加して、ER ソリューションのパフォーマンスを向上させる

[!include [banner](../includes/banner.md)]

このトピックではは、実行される [電子申告 (ER)](general-electronic-reporting.md) 形式の [パフォーマンス追跡](trace-execution-er-troubleshoot-perf.md) を取得し、それらのトレースからの情報を使用して、パラメーター化された **計算フィールド** のデータ ソースを構成することにより、パフォーマンスを向上させる方法について説明します。

ビジネス ドキュメントを生成するための ER コンフィギュレーションをデザインするプロセスの一部として、アプリケーションからデータを取得し、生成された出力に入力するために使用されるメソッドを定義します。 **計算フィールド** 型のパラメーター化された ER データ ソースをデザインすることにより、データベース呼び出し回数を減らし、ER 形式の実行の詳細を収集に関連する時間とコストを大幅に削減することができます。

## <a name="prerequisites"></a>必要条件

- このトピックの例を完了するには、次のいずれかの [ロール](../sysadmin/tasks/assign-users-security-roles.md) にアクセスできる必要があります：

    - 電子申告開発者
    - 電子申告機能コンサルタント
    - システム管理者

- この会社は、**DEMF** に設定する必要があります。
- このトピックの [付録 1](#appendix1) の手順に従って、このトピックの例を完了するために必要なサンプルの Microsoft ER ソリューションのコンポーネントをダウンロードします。
- このトピックの [付録 2](#appendix2) の手順に従って、サンプルの Microsoft ER ソリューションのパフォーマンスを向上させるために ER フレームワークを使用するために必要な ER パラメーターの最小セットを構成します。

## <a name="import-the-sample-er-solution"></a>サンプル ER ソリューションのインポート

仕入先トランザクションを示す新しいレポートを生成するため、ER ソリューションを設計する必要があるとします。 現時点では、選択した仕入先のトランザクションは **仕入先トランザクション** ページ (**買掛金勘定** \> **仕入先** \> **すべての仕入先** に移動し、仕入先を選択してから、アクション ペインの **仕入先** タブの **トランザクション** グループで、**トランザクション** を選択します) で検索できます。 ただし、XML 形式の 1 つの電子ドキュメントに、すべての仕入先トランザクションをまとめる必要があります。 このソリューションは、必要なデータ モデル、モデル マッピング、および形式コンポーネントを含むいくつかの ER コンフィギュレーションで構成されます。

最初の手順は、サンプル ER ソリューションをインポートして、仕入先トランザクション レポートを生成することです。

1. 会社用にプロビジョニングされた Microsoft Dynamics 365 Finance のインスタンスにサインインします。
2. このトピックでは、サンプル会社 **Litware, Inc.** のコンフィギュレーションを作成および変更します。 このコンフィギュレーション プロバイダーが Finance インスタンスに追加され、有効としてマークされていることを確認してください。 詳細については、[構成プロバイダーを作成して、有効としてマークする](tasks/er-configuration-provider-mark-it-active-2016-11.md) を参照してください。
3. **電子レポート** ワークスペースで、**レポート コンフィギュレーション** タイルを選択します。
4. **コンフィギュレーション** ページで、前提条件としてダウンロードした ER コンフィギュレーションを Finance に次の順序でインポートします: データ モデル、モデル マッピング、フォーマット。 各コンフィギュレーションについて、次の手順を実行します。

    1. 操作ウィンドウで、**交換** \> **XML ファイルからロード** を選択します。
    2. **参照** を選択して、ER コンフィギュレーションに適したファイルを XML 形式で選択します。
    3. **OK** を選択します。

![コンフィギュレーション ページでインポートされたコンフィギュレーション。](./media/er-calculated-field-ds-performance-imported-configurations.png)

## <a name="review-the-sample-er-solution"></a>サンプル ER ソリューションのレビュー

### <a name="review-the-model-mapping"></a>モデル マッピングを確認する

1. **コンフィギュレーション** ページのコンフィギュレーション ツリーで、**パフォーマンス向上モデル** を展開し、**パフォーマンス向上マッピング** を選択します。
2. アクション ウィンドウで、**デザイナー** を選択します。
3. **モデルからデータ ソースへのマッピング** ページのアクション ペインで、**デザイナー** を選択します。

    この ER モデル マッピングは、次のアクションを実行するように設計されています:

    - VendTrans テーブル (**Trans** データ ソース) に格納されている仕入先トランザクションの一覧を取得します。
    - すべてのトランザクションについて、VendTable テーブルから、トランザクションが転記された仕入先 (**\#Vend** データソース) のレコードを取得します。

    > [!NOTE]
    > **\#Vend** データ ソースは、既存の多対一の関係 **\@.'\>Relations'.VendTable\_AccountNum** を使用して、対応する仕入先レコードを取得するように構成されています。

    このコンフィギュレーションのモデル マッピングは、このモデルに対して作成され Finance で実行される、すべての ER 形式の基本データ モデルを実装します。 したがって、**Trans** データ ソースの内容は、抽象 **モデル** データ ソースなどの ER 形式に対して公開されます。

    ![モデル マッピング デザイナー ページの Trans データ ソース。](media/er-calculated-field-ds-performance-mapping-1.png)

4. **モデル マッピング デザイナー** ページを閉じます。
5. **モデルからデータ ソースへのマッピング** ページを閉じます。

### <a name="review-format"></a>形式の確認

1. **コンフィギュレーション** ページのコンフィギュレーション ツリーで、**パフォーマンス向上モデル** を展開し、**パフォーマンス向上形式** を選択します。
2. アクション ウィンドウで、**デザイナー** を選択します。
3. **形式デザイナー** ページの **マッピング** タブで、**展開 / 折りたたみ** を選択します。
4. **モデル**、**データ**、および **トランザクション** 項目を展開します。

    この ER 形式は、仕入先トランザクション レポートを XML 形式で生成するように設計されています。

    ![形式デザイナー ページでの形式要素の形式データ ソースと構成済みバインディング。](media/er-calculated-field-ds-performance-format.png)

5. **形式デザイナー** ページを閉じます。

## <a name="run-the-sample-er-solution-to-trace-execution"></a>サンプル ER ソリューションを実行して、実行を追跡する

ER ソリューションの最初のバージョンの設計が完了したとします。 これにより、Finance インスタンスでソリューションをテストし、実行パフォーマンスを分析します。

### <a name="turn-on-the-er-performance-trace"></a>ER パフォーマンス追跡を有効にする

1. **DEMF** 会社を選択します。
2. [ER パフォーマンス追跡を有効にする](trace-execution-er-troubleshoot-perf.md#turn-on-the-er-performance-trace) の手順に従って、ER 形式の実行中にパフォーマンス追跡を生成します。

    ![ユーザー パラメーター ダイアログ ボックス。](media/er-calculated-field-ds-performance-format-user-parameters.png)

### <a name="run-the-er-format"></a><a id="run-format"></a>ER 形式を実行する

1. **組織管理** \> **電子申告** \> **構成** の順に移動します。
2. **コンフィギュレーション** ページのコンフィギュレーション ツリーで、**パフォーマンス向上形式** を選択します。
3. アクション ウィンドウで、**実行** を選択します。

## <a name="use-the-performance-trace-to-analyze-model-mapping-performance"></a>パフォーマンス追跡を使用してモデル マッピングのパフォーマンスを分析する

1. **コンフィギュレーション** ページのコンフィギュレーション ツリーで、**パフォーマンス向上マッピング** を選択します。
2. アクション ウィンドウで、**デザイナー** を選択します。
3. **モデル マッピング** ページのアクション ペインで、**デザイナー** を選択します。
4. **モデル マッピング デザイナー** ページの、アクション ウィンドウで、**パフォーマンス追跡** を選択します。
5. 生成された最新の追跡を選択し、**OK** を選択します。

現在のモデル マッピングの一部のデータ ソース項目に関する新しい情報が利用可能になりました:

- データ ソースを使用してデータの取得に費やした実際の時間
- モデル マッピング全体の実行に費やされた合計時間の割合で表される同じ時間

![モデル マッピング デザイナー ページの実行時間の詳細。](./media/er-calculated-field-ds-performance-mapping-2.png)

**パフォーマンス統計** グリッドは、**Trans** データ ソースが VendTrans テーブルを 1 回呼び出すことを示しています。 **Trans** データ ソースの値 **\[265\]\[Q:265\]** は、265 個の仕入先トランザクションがアプリケーション テーブルから取得された、データ モデルに返されたことを示します。

また、**パフォーマンス統計** グリッドは、現在のモデル マッピングが、**\#Vend** データ ソースの実行中にデータベース要求を重複していることも示します。 この重複は、次の理由で発生します:

- 仕入先テーブルは、反復された 265 回の仕入先トランザクションごとに 2 回呼び出され、合計 530 回の呼び出しが行われます:

    - 仕入先番号を入力するために 1 回の呼び出しが行われます。
    - 仕入先名を入力するために 1 回の呼び出しが行われます。

- 仕入先テーブルは、取得したトランザクションが 5 つの仕入先に対してのみ転記されている場合でも、反復された仕入先トランザクションごとに呼び出されます。 530 回の呼び出しのうち、525 回は重複しています。 次の図は、重複する呼び出し (データベース要求) についてのメッセージを示しています。

![モデル マッピング デザイナー ページの重複データベース要求に関するメッセージ。](./media/er-calculated-field-ds-performance-mapping-2a.png)

モデル マッピングの合計実行時間 (約 8 秒) のうち、80% (約 6 秒) 以上が VendTable アプリケーション テーブルから値を取得するために費やされたことに注目してください。 この割合は、VendTransアプリケーション テーブルからの情報量と比較して、5 つの仕入先の 2 つの属性に対して大きすぎます。

すべてのトランザクションの仕入先の詳細を取得するために行われる呼び出しの数を減らし、モデル マッピングのパフォーマンスを向上させるために、**\#Vend** データ ソースにキャッシュを使用できます。

> [!NOTE]
> **Trans\\\#Vend** データ ソースは、実行時に **Trans** データ ソースの現在のトランザクションのスコープにキャッシュされます。

**\#Vend** ソース データをキャッシュすることにより、525 から 260 に重複呼び出しの数を減らしますが、重複を完全に排除することはできません。 重複を完全に削除するために、**計算フィールド** 型の新しいパラメーター化されたデータ ソースを構成できます。

## <a name="improve-the-model-mapping-based-on-information-from-the-execution-trace"></a>実行追跡からの情報に基づいてモデル マッピングを改善する

### <a name="change-the-logic-of-the-model-mapping"></a>モデル マッピングのロジックを変更する

次の手順に従って、**計算フィールド** 型のキャッシュとデータソースを使用して、データベースへの重複呼び出しを防止します。

1. **コンフィギュレーション** ページのコンフィギュレーション ツリーで、**パフォーマンス向上マッピング** を選択します。
2. アクション ウィンドウで、**デザイナー** を選択します。
3. **モデル マッピング** ページのアクション ペインで、**デザイナー** を選択します。
4. **モデル マッピング デザイナー** ページで、次の手順に従って、**テーブル レコード** 型のデータ ソースを追加し、VendTable アプリケーション テーブルのレコードにアクセスします:

    1. **データ ソース型** ペインで、**Dynamics 365 for Operations** を展開し、**テーブル レコード** を選択します。
    2. **ルートの追加** を選択します。
    3. ダイアログ ボックスで、**名前** フィールドに **Vend** と入力します。
    4. **テーブル** フィールドに、**VendTable** と入力します。
    5. **OK** を選択します。

5. **計算フィールド** 型のデータ ソースへの呼び出をパラメーター化できるのは、それらのデータ ソースがコンテナーに存在する場合にのみです。 したがって、次の手順に従って、**空コンテナー** 型のデータ ソースを追加し、**計算フィールド** 型の新しいパラメーター化されたデータ ソースを保持します:

    1. **データ ソース型** ペインで、**一般** を展開し、**空コンテナー** を選択します。
    2. **ルートの追加** を選択します。
    3. ダイアログ ボックスで、**名前** フィールドに **Box** と入力します。
    3. **OK** を選択します。

    ![モデル マッピング デザイナー ページの Box データ ソース。](./media/er-calculated-field-ds-performance-mapping-3.png)

6. **計算フィールド** 型のパラメーター化されたデータ ソースを追加するには、次の手順に従います:

    1. **データ ソース** ペインで、**Box** を選択します。
    2. **データ ソース型** ペインで、**関数** を展開し、**計算フィールド** を選択します。
    3. **追加** を選択します。
    4. ダイアログ ボックスで、**名前** フィールドに **Vend** と入力します。
    5. **式の編集** を選択します。
    6. **フォーミュラ デザイナー** ページで、**パラメーター** を選択して、このデータ ソースが呼び出されたときに入力する必要があるパラメーターを指定します。
    7. **パラメーター** ダイアログ ボックスで、**新規** を選択します。
    8. **名前** フィールドに、**parmVendAccNumber** と入力します。
    9. **タイプ** フィールドで、**文字列** を選択します。
    10. **OK** を選択します。
    11. **フォーミュラ** フィールドに、**FIRSTORNULL(FILTER(Vend, Vend.AccountNum=parmVendAccNumber))** と入力し ます。
    12. **保存** を選択し、**フォーミュラ デザイナー** ページを閉じます。
    13. **OK** を選択して新しいデータ ソースを追加します。

7. 次の手順に従って、追加されたデータ ソースを実行時にキャッシュ済みとしてマークします:

    1. **データ ソース** ペインで、**Box\\Vend** を選択します。
    2. **キャッシュ** を選択します。

    > [!NOTE]
    > **Box\\Vend** データ ソースは、実行時に **Trans** データ ソースのすべての仕入先トランザクションのスコープにキャッシュされます。

8. 次の手順に従って、ネストされた **Trans\\\#Vend** データ ソースを更新して、**Box\\Vend** データ ソースを使用するようにします。

    1. **データ ソース** ペインで、**Trans** を展開します。
    2. **Trans\\\#Vend** データ ソースを選択し、**編集** \> **フォーミュラの編集** を選択します。
    3. **フォーミュラ デザイナー** ページの **フォーミュラ** フィールドに、**Box.Vend(\@.AccountNum)** と入力します。
    4. **保存** を選択し、**フォーミュラ デザイナー** ページを閉じます。
    5. **OK** を選択して、選択したデータ ソースへの変更を完了します。

9. **保存** を選択します。

    ![モデル マッピング デザイナー ページの Vend データ ソース。](./media/er-calculated-field-ds-performance-mapping-4.png)

10. **モデル マッピング デザイナー** ページを閉じます。
11. **モデル マッピング** ページを閉じます。

### <a name="complete-the-modified-version-of-the-er-model-mapping"></a>ER モデル マッピングの変更されたバージョンを完了する

1. **コンフィギュレーション** ページの、**バージョン** クイック タブで、**パフォーマンス向上マッピング** コンフィギュレーションのバージョン **1.2** を選択します。
2. **状態の変更** \> **完了** を選択し、**OK** を選択します。

## <a name="run-the-modified-er-solution-to-trace-execution"></a>変更された ER ソリューションを実行して追跡実行する

このトピックの先のセクション [ER 形式を実行する](#run-format) の手順を繰り返して、新しいパフォーマンス追跡を生成します。

## <a name="use-the-performance-trace-to-analyze-adjustments-to-the-model-mapping"></a>パフォーマンス追跡を使用して、モデル マッピングの調整を分析する 

1. **コンフィギュレーション** ページのコンフィギュレーション ツリーで、**パフォーマンス向上マッピング** を選択します。
2. アクション ウィンドウで、**デザイナー** を選択します。
3. **モデル マッピング** ページのアクション ペインで、**デザイナー** を選択します。
4. **モデル マッピング デザイナー** ページの、アクション ウィンドウで、**パフォーマンス追跡** を選択します。
5. 生成された最新の追跡を選択し、**OK** を選択します。

モデル マッピングに対して行った調整によって、データベースへの重複するクエリが消去されたことに注意してください。 このモデル マッピングのデータベース テーブルおよびデータ ソースへの呼び出し数も減少しました。

![モデル マッピング デザイナー ページ 1 の追跡情報。](./media/er-calculated-field-ds-performance-mapping-5.png)

合計実行時間は約 20 倍 (約 8 秒から約 400 ミリ秒) に短縮されました。 したがって、ER ソリューション全体のパフォーマンスが向上しました。

![モデル マッピング デザイナー ページ 2 の追跡情報。](./media/er-calculated-field-ds-performance-mapping-5a.png)

## <a name="appendix-1-download-the-components-of-the-sample-microsoft-er-solution"></a><a name="appendix1"></a>付録 1: サンプル Microsoft ER ソリューションのコンポーネントのダウンロード

次のファイルをダウンロードして、ローカルに保存する必要があります。

| ファイル                                        | コンテンツ |
|---------------------------------------------|---------|
| Performance improvement model.version.1     | [ER データ モデル構成のサンプル](https://download.microsoft.com/download/4/6/f/46f0f3fa-782b-414a-8f7b-b6c64a388661/Performance_improvement_model.version.1.xml) |
| Performance improvement mapping.version.1.1 | [ER モデル マッピング構成のサンプル](https://download.microsoft.com/download/8/9/1/8913a763-afb8-4bf4-aaf1-95ad793ffc5a/Performance_improvement_mapping.version.1.1.xml) |
| Performance improvement format.version.1.1  | [ER フォーマット構成のサンプル](https://download.microsoft.com/download/9/0/c/90c75963-bc78-4edc-9096-556bbe281f10/Performance_improvement_format.version.1.1.xml) |

## <a name="appendix-2-configure-the-er-framework"></a><a name="appendix2"></a>付録 2: ER フレームワークを構成する

ER フレームワークを使用してサンプル Microsoft ER ソリューションのパフォーマンスを向上させる前に、ER パラメーターの最小セットを構成する必要があります。

### <a name="configure-er-parameters"></a><a id="ConfigureParameters"></a>ER パラメーターのコンフィギュレーション

1. **組織管理** \> **ワークスペース** \> **電子申告** の順に移動します。
2. **ローカライズ構成** ページの、**関連リンク** セクションで、**電子申告パラメーター** を選択します。
3. **電子申告パラメーター** ページの、**一般** タブで、**デザイン モードの有効化** オプションを **はい** に設定します。
4. **添付** タブで、次のパラメーターを設定します:

    - **コンフィギュレーション** フィールドで、**DEMF** 社の **ファイル** タイプを選択します。
    - **ジョブ アーカイブ**、**一時的**、**ベースライン**、および **その他** フィールドで、**ファイル** タイプを選択します。

ER パラメーターについては、[ER フレームワークのコンフィギュレーション](electronic-reporting-er-configure-parameters.md) を参照してください。

### <a name="activate-an-er-configuration-provider"></a><a id="ActivateProvider"></a> ER コンフィギュレーション プロバイダーをアクティブにする

追加されたすべての ER 構成は、ER 構成プロバイダーによって所有されているものとしてマークされます。 **電子申告** ワークスペースで有効化された ER 構成プロバイダーは、この目的に使用されます。 したがって、ER コンフィギュレーションに追加または編集する前に、**電子申告** ワークスペースの ER コンフィギュレーション プロバイダーを有効化する必要があります。

> [!NOTE]
> ER コンフィギュレーションの所有者のみがコンフィギュレーションを編集できます。 したがって、ER 構成を編集する前に、適切な ER 構成 プロバイダーは **電子申告** ワークスペースで有効化する必要があります。

#### <a name="review-the-list-of-er-configuration-providers"></a><a id="ReviewProvidersList"></a> ER コンフィギュレーション プロバイダーの一覧をレビュー

1. **組織管理** \> **ワークスペース** \> **電子申告** の順に移動します。
2. **ローカライズ構成** ページの、**関連リンク** セクションで、**構成プロバイダー** を選択します。
3. **構成プロバイダー テーブル** ページでは、各プロバイダー レコードの名前と URL が一意になります。 このページの内容をレビューします。 **Litware, Inc.** レコードが既に存在する場合は、次の手順をスキップし、[新しい ER コンフィギュレーション プロバイダーを追加](#ActivateProvider) します。

#### <a name="add-a-new-er-configuration-provider"></a><a id="ActivateProvider"></a> 新しい ER コンフィギュレーション プロバイダーを追加

1. **組織管理** \> **ワークスペース** \> **電子申告** の順に移動します。
2. **ローカライズ構成** ページの、**関連リンク** セクションで、**構成プロバイダー** を選択します。
3. **構成プロバイダー** ページで、**新規** を選択します。
4. **名前** フィールドに、**Litware, Inc.** と入力
5. **インターネット アドレス** フィールドで、`https://www.litware.com` を入力します。
6. **保存** を選択します。

#### <a name="activate-an-er-configuration-provider"></a><a id="ActivateAddedProvider"></a> ER コンフィギュレーション プロバイダーをアクティブにする

1. **組織管理** \> **ワークスペース** \> **電子申告** の順に移動します。
2. **ローカライズ構成** ページの **構成プロバイダー** セクションで、**Litware, Inc.** を選び、**有効に設定** を選択します。

ER 構成 プロバイダーについては、[構成 プロバイダーを作成し有効としてマークする](tasks/er-configuration-provider-mark-it-active-2016-11.md) を参照してください。

## <a name="additional-resources"></a>追加リソース

- [電子申告の概要](general-electronic-reporting.md)
- [電子申告形式の実行をトレースしてパフォーマンスの問題をトラブルシューティング](trace-execution-er-troubleshoot-perf.md)
- [計算済みフィールド タイプの ER データ ソースの、パラメーター化された呼び出しをサポートする](er-calculated-field-type.md)


[!INCLUDE[footer-include](../../../includes/footer-banner.md)]
