---
title: ドキュメントを Excel 形式で生成するためのコンフィギュレーションを設計する
description: このトピックでは、Excel テンプレートに入力する電子レポート (ER) のフォーマットを設計し、Excel 形式の出力ドキュメントを生成する方法について説明します。
author: NickSelin
ms.date: 01/05/2022
ms.topic: article
ms.prod: ''
ms.technology: ''
ms.search.form: EROperationDesigner, ERParameters
audience: Application User, Developer, IT Pro
ms.reviewer: kfend
ms.custom: 220314
ms.assetid: 2685df16-5ec8-4fd7-9495-c0f653e82567
ms.search.region: Global
ms.author: nselin
ms.search.validFrom: 2016-06-30
ms.dyn365.ops.version: Version 7.0.0
ms.openlocfilehash: 9b1c83894d93789a270ed4521ba7f80da70285ac
ms.sourcegitcommit: f5fd2122a889b04e14f18184aabd37f4bfb42974
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 01/10/2022
ms.locfileid: "7952655"
---
# <a name="design-a-configuration-for-generating-documents-in-excel-format"></a>Excel 形式でドキュメントを生成する構成を設計する

[!include[banner](../includes/banner.md)]

ER フォーマットのコンポーネント を持つ[電子レポート (ER)](general-electronic-reporting.md) フォーマットの構成を設計して、Microsoft Excel ワークブック形式の出力ドキュメントを生成するように構成することができます。 これには、特定の ERフォーマットのコンポーネントを使用する必要があります。

この機能の詳細については、[OPENXML 形式でレポートを生成する構成を設計する](tasks/er-design-reports-openxml-2016-11.md)に記載の手順に従ってください。

## <a name="add-a-new-er-format"></a>新規 ER 形式の追加

新たな ER 形式の構成を追加して、Excel ブック形式で送信ドキュメントを生成する場合は、形式の **形式のタイプ** 属性に **excel** の値を選択するか、**形式のタイプ** 属性を空白のままにしておく必要があります。

- **Excel** を選択した場合は 、Excel 形式でのみ送信ドキュメントを生成するように形式を構成することができます。
- 属性を空白のままにすると、ERフ レームワークでサポートされている任意の形式で送信ドキュメントを生成するように形式を構成することができます。

ER 形式のコンポーネントを構成するには、アクション ウィンドウで **デザイナー** を選択し、ER オペレーション デザイナーで編集用の ER 形式のコンポーネントを開きます。

![構成ページ。](./media/er-excel-format-add-format.png)

## <a name="excel-file-component"></a>Excel ファイル コンポーネント

### <a name="manual-entry"></a>手動入力

出力ドキュメントを Excel 形式で生成するには、**Excel\\ファイル** コンポーネントを、構成されたER形式に追加する必要があります。

![Excel\ファイル コンポーネント。](./media/er-excel-format-add-file-component.png)

送信ドキュメントのレイアウトを指定するには、 **Excel\\ファイル** コンポーネントに拡張子 .xlsx の Excel ワークブックを 出力ドキュメントのテンプレートとして添付します。

> [!NOTE]
> テンプレートを手動で関連付ける場合は、[ER パラメータ](electronic-reporting-er-configure-parameters.md#parameters-to-manage-documents) でこの目的に対して構成されている[ドキュメント タイプ](../../../fin-ops-core/fin-ops/organization-administration/configure-document-management.md#configure-document-types)を使用する必要があり ます。

![Excel\ファイル コンポーネントに添付ファイルを追加する。](./media/er-excel-format-add-file-component2.png)

構成された ER 形式を実行する際に添付のテンプレートがどのように入力されるかを指定するには、**Excel\\ファイル** コンポーネントに入れ子になった **シート**、**範囲**、**セル** コンポーネントを追加する必要があります。 入れ子になった各コンポーネントは、Excel の名前付きアイテムに関連付けられている必要があります。

### <a name="template-import"></a>テンプレートのインポート

新しいテンプレートを空の ER 形式にインポートするには、アクションウィンドウの **インポート** タブの **Excel からインポート** を選択します。 この例では、**Excel \\ファイル** コンポーネントが自動的に作成され、インポートされたテンプレートがそのコンポーネントに関連付けられます。 検出された Excel の名前付きアイテムの一覧に基づき、必要な ER コンポーネントもすべて自動的に作成されます。

![Excel からインポートを選択します。](./media/er-excel-format-import-template.png)

> [!NOTE]
> オプションの **シート** 要素を編集可能な形式で作成する場合は、 **Excel シート形式の要素の作成** オプションを **はい** に設定します。

## <a name="sheet-component"></a>シート コンポーネント

**シート** コンポーネントは、入力する必要がある関連付けられた Excel ブックのワークシートを示します。 Excel テンプレートのワークシートの名前は、このコンポーネントの **シート** プロパティで定義されます。

> [!NOTE]
> Excel ブックに1つのワークシートのみが存在する場合、このコンポーネントは省略可能です。

ER オペレーション デザイナーの **マッピング** タブで、**シート** コンポーネントの **有効化** プロパティを構成して、生成されるドキュメントにコンポーネントを配置するかどうかを指定することができます。

- **有効化** プロパティの式が実行時に **True** を返すように設定されている場合、または式が全く設定されていない場合は、適切なワークシートが生成されたドキュメントに配置されます。
- 実行時に **有効化** プロパティの式が **False** を返すように構成されている場合、生成されたドキュメントにはワークシートが含まれません。

![シート コンポーネントの例。](./media/er-excel-format-sheet-component.png)

## <a name="range-component"></a>範囲コンポーネント

**範囲** コンポーネントは、この ER コンポーネントによって制御される必要がある Excel の範囲を示します。 範囲の名前は、このコンポーネントの **Excel の範囲** プロパティで定義されています。

### <a name="replication"></a>レプリケーション

**レプリケーションの方向**  プロパティでは、生成されたドキュメントで範囲を繰り返すかどうか、どのように繰り返すかを指定します。

- **レプリケーションの方向** プロパティが **レプリケーションなし** に設定されている場合、該当する Excel 範囲は、生成されたドキュメント内で繰り返されません。
- **レプリケーションの方向** プロパティが **縦方向** に設定されている場合、該当する Excel 範囲が、生成されたドキュメント内で繰り返されます。 レプリケートされたすべての範囲は、Excel テンプレートの元の範囲の下部に配置されます。 繰り返される回数は、この ER コンポーネントにバインドされている **レコード リスト** タイプのデータソース内のレコード数で定義されます。
- **レプリケーションの方向** プロパティが **水平方向** に設定されている場合、該当する Excel 範囲が、生成されたドキュメント内で繰り返されます。 レプリケートされたすべての範囲は、Excel テンプレートの元の範囲の右側に配置されます。 繰り返される回数は、この ER コンポーネントにバインドされている **レコード リスト** タイプのデータソース内のレコード数で定義されます。

水平方向のレプリケーションの詳細については、[水平方向に拡張可能な範囲を使用して、Excel レポートで列を動的に追加する](tasks/er-horizontal-1.md) に記載の手順に従ってください。

### <a name="nested-components"></a>ネストされたコンポーネント

**範囲** コンポーネントは、他のネストされた ER コンポーネントを持つことができ、これは適切な Excel の名前付き範囲に値を入力する目的で使用されます。

- **テキスト** グループのいずれかのコンポーネントが値の入力に使用されている場合、その値は Excel の範囲のテキスト値として入力されます。

    > [!NOTE]
    > このパターンを使用して、アプリケーションで定義されているロケールに基づいて入力された値の書式を設定します。

- **Excel** グループの **セル** コンポーネントを使用して値を入力する場合、その値は、その **セル** コンポーネントのバインドが定義するデータ型  ( **文字列**、**実数**、**整数** など ) の値として Excel の範囲に入力されます。

    > [!NOTE]
    > このパターンを使用すると、Excel アプリケーションが、送信ドキュメントを開くローカル コンピュータのロケールに基づいて入力された値を書式設定できるようになります。

### <a name="enabling"></a>有効化

ER オペレーション デザイナーの **マッピング** タブで、**範囲** コンポーネントの **有効化** プロパティを構成して、生成されるドキュメントにコンポーネントを配置するかどうかを指定することができます。

- **有効化** プロパティの式が実行時に **True** を返すように設定されている場合、または式が全く設定されていない場合は、適切な範囲が生成されたドキュメントに入力されます。
- **有効化** プロパティの式が実行時に **True** を返すように設定されている場合、かつこの範囲が行や列全体を表していない場合、生成されたドキュメントでは適切な範囲が入力されません。
- **有効化** プロパティの式が実行時に **True** を返すように設定されている場合、かつこの範囲が行または列全体を表す場合、生成されたドキュメントにはそれらの行や列が非表示の行や列として含まれます。

### <a name="resizing"></a>サイズ変更

セルを使用してテキスト データを表示するよう Excel テンプレートを構成できます。 生成されたドキュメント内のセルのテキスト全体が確実に表示される状態を保つには、テキストがセル内で自動的に折り返されるようにそのセルを構成できます。 また、折り返されたテキストを完全に表示できない場合は高さが自動的に調整されるように、そのセルを含む行を構成できます。 詳細については、[セルでカットされるデータの固定](https://support.microsoft.com/office/fix-data-that-is-cut-off-in-cells-e996e213-6514-49d8-b82a-2721cef6144e)の「セルでテキストを折り返す」セクションを参照してください。

> [!NOTE]
> [Excel の既知の制限](https://support.microsoft.com/topic/you-cannot-use-the-autofit-feature-for-rows-or-columns-that-contain-merged-cells-in-excel-34b54dd7-9bfc-6c8f-5ee3-2715d7db4353)があるため、テキストが折り返されるようにセルを構成し、それらのセルを含む行の高さが折り返されたテキストに合わせて自動的に調整されるように構成した場合でも、マージされたセルおよびそれらを含む行に対して Excel の **自動調整** および **テキストの折り返し** 機能を使用できない場合があります。 

Dynamics 365 Finance バージョン 10.0.23 の時点では、行内のテキストを折り返すように構成されたマージ済セルが 1 つ以上その行に含まれている場合は必ず、生成されたドキュメントで、入れ子になったセルの内容に合わせて自動的に高さが調整されるように構成された各行の高さを計算することを ER に強制できます。 その場合、計算された高さを使用して行のサイズが変更され、生成されたドキュメントに行のすべてのセルが表示されます。 Excel テンプレートを使用して発信ドキュメントを生成するように構成された ER 形式を実行するときにこの機能を使用するには、次の手順に従います。

1. **組織管理** \> **ワークスペース** \> **電子申告** の順に移動します。
2. **ローカライズ構成** ページの、**関連リンク** セクションで、**電子申告パラメーター** を選択します。
3. **電子申告パラメーター** ページの、**実行時** タブで、**行の高さを自動調整する** オプションを **はい** に設定します。

単一の ER 形式に対してこのルールを変更する場合、次の手順に従って、その形式のドラフト バージョンを更新します。

1. **組織管理** \> **ワークスペース** \> **電子申告** の順に移動します。
2. **ローカライズ構成** ページの、**構成** セクションで、**レポートの構成** タイルを選択します。
3. **コンフィギュレーション** ページの左ウィンドウのコンフィギュレーション ツリーで、Excel テンプレートを使用して発信ドキュメントを生成するように設計された ER コンフィギュレーションを選択します。
4. **バージョン** クイック タブで、状態が **下書き** となっている構成のバージョンを選択します。
5. アクション ウィンドウで、**デザイナー** を選択します。
6. **フォーマット デザイナー** ページの左ペインのフォーマット ツリーで、Excel テンプレートにリンクされた Excel コンポーネントを選択します。
7. **形式** タブの **行の高さの調整** フィールドで、編集した ER形式によって生成される発信ドキュメントの行の高さの変更を、実行時に強制するかどうかを指定する値を選択します。

    - **既定** – **電子レポート パラメーター** ページの **行の高さを自動調整する** フィールドで構成された一般設定を使用します。
    - **はい** – 一般設定を上書きし、実行時に行の高さを変更します。
    - **いいえ** – 一般設定を上書きし、実行時に行の高さを変更しません。

## <a name="cell-component"></a>セルのコンポーネント

**セル** コンポーネントは、Excel の名前付きセル、図形、画像の入力に使用されます。 **セル** ER コンポーネントで入力する必要がある Excel の名前付きオブジェクトを指定するには、**セル** コンポーネントの **Excel の範囲** プロパティでそのオブジェクトの名前を指定する必要があります。

ER オペレーション デザイナーの **マッピング** タブで、**セル** コンポーネントの **有効化** プロパティを構成して、生成されるドキュメントにオブジェクトを配置するかどうかを指定することができます。

- **有効化** プロパティの式が実行時に **True** を返すように設定されている場合、または式が全く設定されていない場合は、適切なオブジェクトが生成されたドキュメントに入力されます。 この **セル** コンポーネントのバインディングによって、適切なオブジェクトに配置される値が指定されます。
- 実行時に **有効化** プロパティの式が **False** を返すように構成されている場合、生成されたドキュメントには適切なオブジェクトが含まれません。

**セル** コンポーネントがセルに値を入力するように構成されている場合は、プリミティブ データ型 ( **文字列**、**実数**、 **整数** など) の値を返すデータソースにバインドでき ます。 この場合、値は同一のデータ型の値としてセルに入力されます。

**セル** コンポーネントが Excel のシェイプで値を入力するように構成されている場合は、プリミティブ データ型 ( **文字列**、**実数**、 **整数** など) の値を返すデータソースにバインドでき ます。 この場合、値はこのシェイプのテキストとして Excel のシェイプに入力されます。 **文字列** ではないデータ型の値については、自動的にテキストへの変換が行われます。

> [!NOTE]
> [シェイプ テキスト] プロパティがサポートされている場合にのみ、**セル** コンポーネントを構成してシェイプに入力できます。

**セル** コンポーネントが Excel ピクチャに値を入力するように構成されている場合は、バイナリ形式で画像を表す **コンテナ** データ型の値を返すデータソースにバインドすることができます。 この場合、値が Excel ピクチャに画像として入力されます。

> [!NOTE]
> すべての Excel のピクチャとシェイプは、その左上隅が特定の Excel セル、または範囲に固定されていると考えられます。 Excel のピクチャまたはシェイプをレプリケートする場合は、固定されているセルまたは範囲をレプリケートされたセル、または範囲として構成する必要があります。

画像とシェイプを埋め込む方法の詳細については、[ER を使用して生成したドキュメントに画像やシェイプを埋め込む](electronic-reporting-embed-images-shapes.md)を参照してください。

## <a name="page-break-component"></a>改ページ コンポーネント

**改ページ** コンポーネントは、Excel が新たなページを開始するように強制します。 Excel の既定のページ設定を使用する場合、このコンポーネントは必要ありませんが、Excel で ER 形式のページ構造を使用する場合にはこのコンポーネントを推奨します。

## <a name="page-component"></a><a name="page-component"></a>ページのコンポーネント

### <a name="overview"></a>概要

**ページ**  コンポーネントは、Excel が ER フォーマットに従って、生成された送信文書の改ページ位置の自動修正を構成する場合に使用できます。 ER フォーマットが **ページ** コンポーネントの下にあるコンポーネントを実行すると、必要な改ページが自動的に追加されます。 このプロセスでは、生成されたコンテンツのサイズ、Excel テンプレートのページ設定、Excel テンプレートで選択されている用紙サイズが考慮されます。

生成されたドキュメントを異なるセクションに分割し、それぞれに異なるページネーションを設定する必要がある場合は、各 [シート](er-fillable-excel.md#sheet-component)コンポーネントに複数の **ページ** コンポーネントを設定することができます。

### <a name="structure"></a><a name="page-component-structure"></a>構築物

**ページ** コンポーネント配下にある最初のコンポーネントが [範囲](er-fillable-excel.md#range-component)コンポーネントで、**レプリケーション方向プロパティ** プロパティが **レプリケーションなし** に設定されている場合、この範囲は、現在の **ページ** コンポーネントの設定に基づく改ページ位置の自動修正で使用するページ ヘッダとみなされます。 このフォーマット コンポーネントに関連付けられた Excel の範囲は、現在の **ページ** コンポーネントの設定を使用して生成されたすべてのページの先頭で繰り返されます。

> [!NOTE]
> Excel テンプレートで [先頭で繰り返す行](https://support.microsoft.com/office/repeat-specific-rows-or-columns-on-every-printed-page-0d6dac43-7ee7-4f34-8b08-ffcc8b022409)が設定されている場合、改ページ位置の自動修正を正しく実行するには、この Excel 範囲のアドレスが前述の **範囲** コンポーネントに関連付けられた Excel 範囲のアドレスと同じである必要があります。

**ページ** コンポーネント配下にある最期のコンポーネントが **範囲** コンポーネントで、**レプリケーション方向プロパティ** プロパティが **レプリケーションなし** に設定されている場合、この範囲は、現在の **ページ** コンポーネントの設定に基づく改ページ位置の自動修正で使用するフッター ヘッダとみなされます。 このフォーマット コンポーネントに関連付けられた Excel の範囲は、現在の **ページ** コンポーネントの設定を使用して生成されたすべてのページの最下部で繰り返されます。

> [!NOTE]
> 改ページ位置の自動修正を正しく設定するにあたって、**範囲** コンポーネントに関連付けられた Excel の範囲は、実行時にサイズを変更してはいけません。 **セル内のテキストを折り返す** や **行の高さを自動調整する** などの Excel の[オプション](https://support.microsoft.com/office/wrap-text-in-a-cell-2a18cff5-ccc1-4bce-95e4-f0d4f3ff4e84)を使って、この範囲のセルをフォーマットすることは推奨しません。

オプションの **範囲** コンポーネントの間に他の複数の **範囲** コンポーネントを追加して、生成されたドキュメントの記入方法を指定することができます。

**ページ** コンポーネント配下の入れ子になった **範囲** コンポーネントのセットが、前述の構造に準拠していない場合、ERフォーマットデザイナーの設計時に検証[エラー](er-components-inspections.md#i17)が発生します。 このエラー メッセージでは、この問題により実行時に問題が発生する可能性があることが通知されます。

> [!NOTE]
> **範囲** コンポーネントの **レプリケーションの方向** プロパティが **レプリケーションなし** に設定されており、その範囲がページヘッダまたはページフッタを生成するように構成されている場合は、正しい出力を生成するために、**ページ** コンポーネント配下にある **範囲** コンポーネントのバインドを指定しないでください。

改ページ位置の自動修正に関連した集計を行い、ページごとの累計や合計を計算する場合は、必要な[データ収集](er-data-collection-data-sources.md)のデータソースを設定することをお勧めします。 **ページ** コンポーネントを使って生成した Excel ドキュメントのページ付けを行う方法については、[ERフォーマットをデザインしてExcelフォーマットの生成ドキュメントのページネーションを行う](er-paginate-excel-reports.md)に記載の手順を実行してください。

### <a name="limitations"></a><a name="page-component-limitations"></a>制限

Excel の改ページ位置の自動修正に **ページ** コンポーネントを使用した場合、生成されたドキュメントの最終的なページ数は、改ページ位置の自動修正が完了するまでわかりません。 そのため、ER の計算式を使って総ページ数を計算したり、生成されたドキュメントの正しいページ数を最終ページよりも前のページに印刷することはできません。

> [!TIP]
> この結果を Excel のヘッダーやフッターに反映させるには、Excel のヘッダーやフッター用の特別な[書式](/office/vba/excel/concepts/workbooks-and-worksheets/formatting-and-vba-codes-for-headers-and-footers)を使用します。

Dynamics 365 Finance のバージョン 10.0.22 では、編集可能な形式の Excel テンプレートを更新した際に、設定された **ページ** コンポーネントが考慮されないという問題がありました。 この機能は、Finance の今後のリリースでの対応が検討されています。

[条件付き書式](/office/dev/add-ins/excel/excel-add-ins-conditional-formatting)を使用するように Excel のテンプレートを設定した場合、予期しない動作をする場合があります。

### <a name="applicability"></a>適用性

**ページ** コンポーネントは、[Excel ファイル](er-fillable-excel.md#excel-file-component) フォーマットのコンポーネントが Excel のテンプレートを使用するように構成されている場合にのみ動作します。 Excel のテンプレートを Word のテンプレートに [置き換えて](tasks/er-design-configuration-word-2016-11.md)、編集可能な ER フォーマットを実行した場合、**ページ** コンポーネントは無視されます。

**ページ** コンポーネントは、 **電子レポート フレームワークで EPPlus ライブラリの使用を有効にする** 機能が有効な場合にのみ動作します。 この機能が無効になっている間に ER が **ページ** コンポーネントを処理しようとすると、実行時に例外が発生します。

> [!NOTE]
> 有効でないセルを参照する数式を 1 つ以上含む Excel テンプレートの **ページ** コンポーネントを ER フォーマットで処理すると、実行時に例外が発生します。 実行時エラーを防ぐには、[#REF! エラーの修正方法](https://support.microsoft.com/office/how-to-correct-a-ref-error-822c8e46-e610-4d02-bf29-ec4b8c5ff4be)に記載のとおり Excel のテンプレートを修正してください。

## <a name="footer-component"></a>フッター コンポーネント

**フッター** コンポーネントは、Excel ブックの生成されたワークシートの下部にフッターを入力するために使用されます。

> [!NOTE]
> このコンポーネントを各 **シート** コンポーネントに追加して、生成された Excel ブックの異なるワークシートに異なるフッターを指定できます。

個々の **フッター** コンポーネントを構成する場合、**ヘッダー/フッターの外観** プロパティを使用して、コンポーネントが使用されるページを指定できます。 使用可能な値は次のとおりです。

- **任意** - 親 Excel ワークシートの任意のページに対して構成されている **フッター** コンポーネントを実行します。
- **最初** - 親 Excel ワークシートの最初のページに対して構成されている **フッター** コンポーネントを実行します。
- **偶数** - 親 Excel ワークシートの偶数ページに対して構成されている **フッター** コンポーネントを実行します。
- **奇数** - 親 Excel ワークシートの奇数ページに対して構成されている **フッター** コンポーネントを実行します。

1つの **シート** コンポーネントに対して、それぞれ **ヘッダー/フッターの外観** プロパティに対して異なる値を持つ複数の **フッター** コンポーネントを追加できます。 この方法で、Excel ワークシートの異なるタイプのページに異なるフッターを生成できます。

> [!NOTE]
> 1つの **シート** コンポーネントに対して、それぞれ **ヘッダー/フッターの外観** プロパティに対して異なる値を持つ複数の **フッター** コンポーネントを追加できます。 それ以外の場合、[検証エラー](er-components-inspections.md#i16) が発生します。 受信したエラー メッセージで不整合が通知されます。

追加された **フッター** コンポーネントの下に、**テキスト\\列**、**テキスト\\日時**、または他のタイプの要求された入れ子のコンポーネントを追加します。 それらのコンポーネントのバインディングを構成して、ページ フッターの入力方法を指定します。

特別な[形式コード](/office/vba/excel/concepts/workbooks-and-worksheets/formatting-and-vba-codes-for-headers-and-footers) を使用して、生成されるフッターのコンテンツを正しく書式設定することもできます。 この方法を学習するには、このトピックの後半にある[例 1](#example-1) の手順に従います。

> [!NOTE]
> 形式を構成する場合は、Excel の[制限](https://support.microsoft.com/office/excel-specifications-and-limits-1672b34d-7043-467e-8e27-269d656771c3) と 1 つのヘッダーまたはフッターの最大文字数を必ず考慮してください。

## <a name="header-component"></a>ヘッダー コンポーネント

**ヘッダー** コンポーネントは、Excel ブックの生成されたワークシートの上部にヘッダーを入力するために使用されます。 **フッター** コンポーネントと同じように使用されます。

## <a name="edit-an-added-er-format"></a>追加された ER 形式の編集

### <a name="update-a-template"></a>テンプレートの更新

更新されたテンプレートを編集可能な ER 形式にインポートするには、アクションウィンドウの **インポート** タブの **Excel から更新する** を選択します。 このプロセスでは、選択された **Excel \\ファイル** コンポーネントのテンプレートが新たなテンプレートに置き換えられます。 編集可能な ER 形式の内容は、更新されたERテンプレートの内容と同期されます。

- ER 形式のコンポーネントが編集可能なフォーマットで見つからなかった場合、新たな ERフォーマットのコンポーネントがすべての Excel 名に対して自動的に作成されます。
- 必要な Excel 名が見つからない場合、すべての ER 形式のコンポーネントが編集可能な ER 形式から削除されます。

> [!NOTE]
> オプションの **シート** 要素を編集可能な ER 形式で作成する場合は、 **Excel シート形式の要素の作成** オプションを **はい** に設定し ます。
>
> 編集可能な ER 形式に元の **シート** 要素が含まれている場合は、更新した テンプレートをインポートする際に、**Excel シート形式の要素の作成**  オプションを **はい** に設定することを推奨します。 それ以外の場合、元の **シート** 要素の入れ子になった要素はすべて最初から作成されます。 したがって、再作成された形式要素のすべてのバインドは、更新された ER 形式では失われます。

![Excel から更新ダイアログ ボックスの Excel シート形式の要素オプションの作成。](./media/er-excel-format-update-template.png)

この機能の詳細については、[Excel のテンプレートを再適用することで、電子レポートの形式を変更する](modify-electronic-reporting-format-reapply-excel-template.md) に記載の手順に従っ てください。

## <a name="validate-an-er-format"></a>ER 形式の検証

編集可能な ER 形式を検証する場合は、現在使用している Excel のテンプレートに Excel 名が存在することを確認する整合性チェックが行われます。 不整合性がある場合には通知されます。 不整合がある場合は、自動的に問題を修正するオプションが表示されます。

![検証エラー メッセージ。](./media/er-excel-format-validate.png)

## <a name="control-the-calculation-of-excel-formulas"></a>Excel の数式の計算の制御

Microsoft Excel ブック形式の送信ドキュメントが生成された場合、このドキュメントの一部のセルに Excel の数式が含まれている可能性があります。 **電子レポート フレームワーク機能で EPPlus ライブラリの使用を有効にする** 機能が有効になっている場合、使用中の Excel テンプレートの **計算オプション** [パラメーター](https://support.microsoft.com/office/change-formula-recalculation-iteration-or-precision-in-excel-73fc7dac-91cf-4d36-86e8-67124f6bcce4#ID0EAACAAA=Windows) の値を変更することで、数式を計算するタイミングを制御できます。

- 生成されたドキュメントに新しい範囲やセルなどが追加されるたびに、すべての従属数式を再計算するには、**自動** を選択します。

    >[!NOTE]
    > これにより、複数の関連する数式を含む Excel テンプレートでパフォーマンスの問題が発生する可能性があります。

- ドキュメントの生成時に数式の再計算を回避するには、**手動** を選択します。

    >[!NOTE]
    > 生成されたドキュメントを Excel でプレビュー用に開くと、数式の再計算が手動で強制されます。
    > このオプションは、生成されたドキュメントに数式を含むセルの値が含まれていない可能性があるため、Excel でのプレビューなしで生成されたドキュメント (PDF の変換、電子メールなど) の使用を想定する ER 送信先を構成する場合は、使用しないでください。

## <a name="example-1-format-footer-content"></a><a name="example-1"></a>例1: フッターのコンテンツを書式設定する

1. 提供されている ER コンフィギュレーションを使用して、自由書式のドキュメントを[生成](er-generate-printable-fti-forms.md) します。
2. 生成されたドキュメントのフッターを確認します。 ドキュメントの現在のページ番号とページの合計数に関する情報が含まれることに注意してください。

    ![生成されたドキュメントのフッターを Excel 形式で確認する。](./media/er-fillable-excel-footer-1.gif)

3. ER 形式デザイナーで、確認のためにサンプルの ER 形式を[開き](er-generate-printable-fti-forms.md#features-that-are-implemented-in-the-sample-er-format) ます。

    **請求書** ワークシートのフッターは、**フッター** コンポーネントの下に存在する 2 つの **文字列** コンポーネントの設定に基づいて生成されます。

    - 最初の **文字列** コンポーネントは、Excel が特定の形式を強制的に適用する次の特別な形式コードを入力します。

        - **&C**- 中央にフッター テキストを配置する。
        - **&"Segoe UI,Regular"&8**- フッター テキストを 8 ポイントの "Segoe UI Regular" フォントで表示します。

    - 2 番目の **文字列** コンポーネントは、現在のドキュメントの現在のページ数とページの合計数を含むテキストを入力します。

    ![形式デザイナーのページでフッター ER 形式コンポーネントを確認する。](./media/er-fillable-excel-footer-2.png)

4. サンプル ER 形式をカスタマイズして、現在のページ フッターを変更します。

    1. サンプル ER 形式に基づく派生 ER 形式の **自由形式の請求書 (Excel)** を[作成](er-quick-start2-customize-report.md#DeriveProvidedFormat) します。
    2. **請求書** ワークシートの **フッター** コンポーネントのための最初の新しい **文字列** コンポーネントのペアを追加します。

        1. 左側の会社名に対応し、8 ポイントの "Segoe UI Regular" フォント (**"&L&"Segoe UI,Regular"&8"**) で表示される **文字列** コンポーネントを追加します。
        2. 会社名を入力する **文字列** コンポーネント (**model.InvoiceBase.CompanyInfo.Name**) を追加します。

    3. **請求書** ワークシートの **フッター** コンポーネントのための 2 番目の新しい **文字列** コンポーネントのペアを追加します。

        1. 右側の処理日に対応し、8 ポイントの "Segoe UI Regular" フォント (**"&R&"Segoe UI,Regular"&8"**) で表示される **文字列** コンポーネントを追加します。
        2. カスタム形式で処理日を入力する **文字列** コンポーネント を追加します (**"&nbsp;"&DATEFORMAT(SESSIONTODAY(), "yyyy-MM-dd")**)。

        ![形式デザイナーのページでフッター ER 形式コンポーネントを確認する。](./media/er-fillable-excel-footer-3.png)

    4. 派生 ER 形式の **自由書式の請求書 (Excel)** のドラフト バージョンを[完了](er-quick-start2-customize-report.md#CompleteDerivedFormat) します。

5. 印刷管理を [コンフィギュレーション](er-generate-printable-fti-forms.md#configure-print-management) して、サンプル ER 形式の代わりに派生 ER 形式の **自由書式の請求書 (Excel)** を使用します。
6. 印刷可能な FTI ドキュメントを生成し、生成されたドキュメントのフッターを確認します。

    ![生成されたドキュメントのフッターを Excel 形式で確認する。](./media/er-fillable-excel-footer-4.gif)

## <a name="example-2-fixing-the-merged-cells-epplus-issue"></a><a name="example-2"></a>例 2: EPPlus のマージされたセルの問題を修正する

ER 形式を実行して、Excel ワークブック形式の送信ドキュメントを生成することができます。 **機能管理** ワークスペースで、**電子レポート フレームワークで EPPlus ライブラリを使用する** 機能を有効にすると、[EPPlus ライブラリ](https://www.nuget.org/packages/epplus/4.5.2.1)を使用して Excel 出力が行われます。 しかし、[Excel の既知の動作](https://answers.microsoft.com/msoffice/forum/all/deleting-a-range-of-cells-that-includes-merged/8601462c-4e2c-48e0-bd23-848eecb872a9)と EPPlus ライブラリの制限により、次の例外が発生する場合があります: 「マージされたセルを削除/上書きできません。 この範囲は、部分的に他のマージされた範囲とマージされます。」 どのような Excel テンプレートがこの例外を引き起こすか、またどのようにして問題を解決するかについては、次の例を参考にしてください。

1. Excel デスクトップ アプリケーションで、新しい Excel ブックを作成します。
2. ワークシート **Sheet1** で、セル **A2** の **ReportTitle** を追加します。
3. セル **A1** と **A2** をマージします。

    ![設計された Excel ワークブックのセル A1 と A2 を統合した結果を、Excel のデスクトップ アプリケーションで確認します。](./media/er-fillable-excel-example2-1.png)

3. **構成** ページで、Excel ワークブック形式の送信ドキュメントを生成するための新しい[ER 形式](er-fillable-excel.md#add-a-new-er-format)を追加します。
4. **フォーマット デザイナー** ページで、送信ドキュメントの新しいテンプレートとして、デザインした Excel ブックを追加の ER 形式に[インポート](er-fillable-excel.md#template-import)します。
5. **マッピング** タブで、[セル](er-fillable-excel.md#cell-component) タイプの **ReportTitle** コンポーネントのバインドを構成します。
6. 構成された ER 形式を実行します。 次の例外が発生していることに注意してください: 「マージされたセルを削除/上書きできません。 この範囲は、部分的に他のマージされた範囲とマージされます。」

    ![形式デザイナー ページで、構成した ER 形式を実行した結果を確認します。](./media/er-fillable-excel-example2-2.png)

以下のいずれかの方法で問題を解決することができます:

- **簡単ですが、推奨しません:** **機能管理** ワークスペースで、**電子レポート フレームワークで EPPlus ライブラリの使用を有効化する** 機能をオフにします。 この方法は簡単ですが、一部の ER 機能は **電子レポート フレームワークで EPPlus ライブラリの使用を有効化する** 機能が有効な場合にのみサポートされるため、この方法を使用すると別の問題が発生する可能性があります。
- **推奨:** 以下の手順に従います:

    1. Excel デスクトップ アプリケーションで、次のいずれかの方法で Excel ブックを変更します:

        - ワークシート **Sheet1**、**A1** と **A2** セルのを解除します。
        - **ReportTitle** の名前の参照を **=Sheet1!$A$2** から **=Sheet1!$A$1**.に変更します。

        ![設計した Excel ワークブックの参照先を変更した結果を、Excel デスクトップアプリケーションで確認します。](./media/er-fillable-excel-example2-3.png)

    2. **形式デザイナr** ページで、変更した Excel ブックを編集可能な ER 形式に[インポート](er-fillable-excel.md#template-import)して、既存のテンプレートを更新します。
    3. 変更された ER 形式を実行します。

        ![生成されたドキュメントをデスクトップ アプリケーションの Excel で確認します。](./media/er-fillable-excel-example2-4.png)

## <a name="limitations"></a>制限

### <a name="known-epplus-library-limitations"></a>EPPlus ライブラリに関する既知の制限

#### <a name="external-data-sources"></a>外部データ ソース

テンプレートの 1 つに [外部データ ソース](https://support.microsoft.com/office/create-a-pivottable-with-an-external-data-source-db50d01d-2e1c-43bd-bfb5-b76a818a927b)を参照する PowerPivot モデルに基づいた PivotTable が含まれており、**電子報告書フレームワークで EPPlus ライブラリの使用を有効にする** 機能が有効になっている場合、そのテンプレートを使用して Excel 形式の送信ドキュメントを生成する ER 形式を実行すると、次のエラーメッセージが表示されます: 「キャッシュ ソースはワークシートではありません。」 この問題を解決するには、以下の方法があります:

- **推奨:** 使用している Excel ソリューションを再設計する:

    1. ピボットを含む部分を別の Excel ワークブック (ワークブック A) に分離します。 
    2. ER を使用して、Finance から必要な詳細情報を持つ 2 つ目の Excel ワークブック (ワークブック B) を生成します。 
    3. ワークブック B が生成されたら、すぐにワークブック A のワークブック B を参照します。

- 機能をオフにし、**電子レポート フレームワークで EPPlus ライブラリの使用を有効化して**、EPPlus 以外のオプションを使用します。 

## <a name="additional-resources"></a>追加リソース

[電子申告の概要](general-electronic-reporting.md)

[OPENXML 形式でレポートを生成するためのコンフィギュレーションを設計する](tasks\er-design-reports-openxml-2016-11.md)

[Excel テンプレートを再適用して電子申告形式を変更する](modify-electronic-reporting-format-reapply-excel-template.md)

[水平方向に拡張可能な範囲を活用して、Excel のレポートで動的に列を追加する](tasks/er-horizontal-1.md)

[ER を使用して生成されるドキュメントへの画像や図形の埋め込み](electronic-reporting-embed-images-shapes.md)

[Power BI にデータをプルするよう電子申告 (ER) を構成する](general-electronic-reporting-report-configuration-get-data-powerbi.md)


[!INCLUDE[footer-include](../../../includes/footer-banner.md)]
